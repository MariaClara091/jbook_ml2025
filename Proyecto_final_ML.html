

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Proyecto Final &#8212; EDA</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Proyecto_final_ML';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Bienvenido a nuestro Proyecto Final" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/Spotify.png" class="logo__image only-light" alt="EDA - Home"/>
    <script>document.write(`<img src="_static/Spotify.png" class="logo__image only-dark" alt="EDA - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Bienvenido a nuestro Proyecto Final
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Proyecto Final</a></li>









</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FProyecto_final_ML.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Proyecto_final_ML.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Proyecto Final</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Proyecto Final</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacion-de-modelos">Aplicación de Modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelado-benchmark">Modelado Benchmark</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#balanceo-de-clases">Balanceo de Clases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizacion-computacional">Optimización Computacional</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#validacion-avanzada-tuning-e-interpretabilidad">Validación avanzada, Tuning e interpretabilidad</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-comparativa-y-seleccion-del-mejor-modelo">Conclusión Comparativa y Selección del Mejor Modelo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretacion-de-mejor-modelo">Interpretación de Mejor Modelo</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#propuesta-de-modelo-original">Propuesta de Modelo Original</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imboost-improved-boosting-for-imbalanced-data">IMBoost (Improved Boosting for Imbalanced Data)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacion-en-el-proyecto">Aplicación en el proyecto</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resultado-destacado">Resultado destacado</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#por-que-destaca">Por qué destaca</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#referencia-metodologica-basada-en">Referencia metodológica basada en</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacion-del-modelo-original-y-comparacion">Implementación del Modelo Original y Comparación</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-resultados-imboost-vs-xgboost-scale-weight">Análisis de Resultados: IMBoost vs XGBoost Scale Weight</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-del-proceso-de-optimizacion">Análisis del Proceso de Optimización</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-graficos">Análisis de gráficos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implicaciones-en-contexto-musical-spotify">Implicaciones en Contexto Musical - Spotify</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacion-con-xgboost-scale-weight">Comparación con XGBoost Scale Weight</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#viejo-paradigma">Viejo paradigma</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nuevo-paradigma">Nuevo paradigma</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusiones-finales">Conclusiones Finales</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="proyecto-final">
<h1>Proyecto Final<a class="headerlink" href="#proyecto-final" title="Permalink to this heading">#</a></h1>
<p>Al tener como objetivo evaluar cómo las características técnicas de las canciones (ej. energía, bailabilidad, acústica) se correlacionan con la popularidad en Spotify, para identificar patrones que puedan optimizar las estrategias de producción musical para disqueras y artistas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;ggplot&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;pastel&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;dataset.csv&#39;</span><span class="p">)</span> 
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>track_id</th>
      <th>artists</th>
      <th>album_name</th>
      <th>track_name</th>
      <th>popularity</th>
      <th>duration_ms</th>
      <th>explicit</th>
      <th>danceability</th>
      <th>energy</th>
      <th>...</th>
      <th>loudness</th>
      <th>mode</th>
      <th>speechiness</th>
      <th>acousticness</th>
      <th>instrumentalness</th>
      <th>liveness</th>
      <th>valence</th>
      <th>tempo</th>
      <th>time_signature</th>
      <th>track_genre</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5SuOikwiRyPMVoIQDJUgSV</td>
      <td>Gen Hoshino</td>
      <td>Comedy</td>
      <td>Comedy</td>
      <td>73</td>
      <td>230666</td>
      <td>False</td>
      <td>0.676</td>
      <td>0.4610</td>
      <td>...</td>
      <td>-6.746</td>
      <td>0</td>
      <td>0.1430</td>
      <td>0.0322</td>
      <td>0.000001</td>
      <td>0.3580</td>
      <td>0.715</td>
      <td>87.917</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>4qPNDBW1i3p13qLCt0Ki3A</td>
      <td>Ben Woodward</td>
      <td>Ghost (Acoustic)</td>
      <td>Ghost - Acoustic</td>
      <td>55</td>
      <td>149610</td>
      <td>False</td>
      <td>0.420</td>
      <td>0.1660</td>
      <td>...</td>
      <td>-17.235</td>
      <td>1</td>
      <td>0.0763</td>
      <td>0.9240</td>
      <td>0.000006</td>
      <td>0.1010</td>
      <td>0.267</td>
      <td>77.489</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1iJBSr7s7jYXzM8EGcbK5b</td>
      <td>Ingrid Michaelson;ZAYN</td>
      <td>To Begin Again</td>
      <td>To Begin Again</td>
      <td>57</td>
      <td>210826</td>
      <td>False</td>
      <td>0.438</td>
      <td>0.3590</td>
      <td>...</td>
      <td>-9.734</td>
      <td>1</td>
      <td>0.0557</td>
      <td>0.2100</td>
      <td>0.000000</td>
      <td>0.1170</td>
      <td>0.120</td>
      <td>76.332</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>6lfxq3CG4xtTiEg7opyCyx</td>
      <td>Kina Grannis</td>
      <td>Crazy Rich Asians (Original Motion Picture Sou...</td>
      <td>Can't Help Falling In Love</td>
      <td>71</td>
      <td>201933</td>
      <td>False</td>
      <td>0.266</td>
      <td>0.0596</td>
      <td>...</td>
      <td>-18.515</td>
      <td>1</td>
      <td>0.0363</td>
      <td>0.9050</td>
      <td>0.000071</td>
      <td>0.1320</td>
      <td>0.143</td>
      <td>181.740</td>
      <td>3</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5vjLSffimiIP26QG5WcN2K</td>
      <td>Chord Overstreet</td>
      <td>Hold On</td>
      <td>Hold On</td>
      <td>82</td>
      <td>198853</td>
      <td>False</td>
      <td>0.618</td>
      <td>0.4430</td>
      <td>...</td>
      <td>-9.681</td>
      <td>1</td>
      <td>0.0526</td>
      <td>0.4690</td>
      <td>0.000000</td>
      <td>0.0829</td>
      <td>0.167</td>
      <td>119.949</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 114000 entries, 0 to 113999
Data columns (total 21 columns):
 #   Column            Non-Null Count   Dtype  
---  ------            --------------   -----  
 0   Unnamed: 0        114000 non-null  int64  
 1   track_id          114000 non-null  object 
 2   artists           113999 non-null  object 
 3   album_name        113999 non-null  object 
 4   track_name        113999 non-null  object 
 5   popularity        114000 non-null  int64  
 6   duration_ms       114000 non-null  int64  
 7   explicit          114000 non-null  bool   
 8   danceability      114000 non-null  float64
 9   energy            114000 non-null  float64
 10  key               114000 non-null  int64  
 11  loudness          114000 non-null  float64
 12  mode              114000 non-null  int64  
 13  speechiness       114000 non-null  float64
 14  acousticness      114000 non-null  float64
 15  instrumentalness  114000 non-null  float64
 16  liveness          114000 non-null  float64
 17  valence           114000 non-null  float64
 18  tempo             114000 non-null  float64
 19  time_signature    114000 non-null  int64  
 20  track_genre       114000 non-null  object 
dtypes: bool(1), float64(9), int64(6), object(5)
memory usage: 17.5+ MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>popularity</th>
      <th>duration_ms</th>
      <th>danceability</th>
      <th>energy</th>
      <th>key</th>
      <th>loudness</th>
      <th>mode</th>
      <th>speechiness</th>
      <th>acousticness</th>
      <th>instrumentalness</th>
      <th>liveness</th>
      <th>valence</th>
      <th>tempo</th>
      <th>time_signature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>1.140000e+05</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>56999.500000</td>
      <td>33.238535</td>
      <td>2.280292e+05</td>
      <td>0.566800</td>
      <td>0.641383</td>
      <td>5.309140</td>
      <td>-8.258960</td>
      <td>0.637553</td>
      <td>0.084652</td>
      <td>0.314910</td>
      <td>0.156050</td>
      <td>0.213553</td>
      <td>0.474068</td>
      <td>122.147837</td>
      <td>3.904035</td>
    </tr>
    <tr>
      <th>std</th>
      <td>32909.109681</td>
      <td>22.305078</td>
      <td>1.072977e+05</td>
      <td>0.173542</td>
      <td>0.251529</td>
      <td>3.559987</td>
      <td>5.029337</td>
      <td>0.480709</td>
      <td>0.105732</td>
      <td>0.332523</td>
      <td>0.309555</td>
      <td>0.190378</td>
      <td>0.259261</td>
      <td>29.978197</td>
      <td>0.432621</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-49.531000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>28499.750000</td>
      <td>17.000000</td>
      <td>1.740660e+05</td>
      <td>0.456000</td>
      <td>0.472000</td>
      <td>2.000000</td>
      <td>-10.013000</td>
      <td>0.000000</td>
      <td>0.035900</td>
      <td>0.016900</td>
      <td>0.000000</td>
      <td>0.098000</td>
      <td>0.260000</td>
      <td>99.218750</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>56999.500000</td>
      <td>35.000000</td>
      <td>2.129060e+05</td>
      <td>0.580000</td>
      <td>0.685000</td>
      <td>5.000000</td>
      <td>-7.004000</td>
      <td>1.000000</td>
      <td>0.048900</td>
      <td>0.169000</td>
      <td>0.000042</td>
      <td>0.132000</td>
      <td>0.464000</td>
      <td>122.017000</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>85499.250000</td>
      <td>50.000000</td>
      <td>2.615060e+05</td>
      <td>0.695000</td>
      <td>0.854000</td>
      <td>8.000000</td>
      <td>-5.003000</td>
      <td>1.000000</td>
      <td>0.084500</td>
      <td>0.598000</td>
      <td>0.049000</td>
      <td>0.273000</td>
      <td>0.683000</td>
      <td>140.071000</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>113999.000000</td>
      <td>100.000000</td>
      <td>5.237295e+06</td>
      <td>0.985000</td>
      <td>1.000000</td>
      <td>11.000000</td>
      <td>4.532000</td>
      <td>1.000000</td>
      <td>0.965000</td>
      <td>0.996000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.995000</td>
      <td>243.372000</td>
      <td>5.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>El dataset tiene 114,000 canciones con 21 variables y métricas de popularidad. Como pequeños hallazgos notables en este descriptivo es que la popularidad tiene un sesgo hacia valores bajos, con una media de 33.24/100 (±22.31) y mediana de 35.
Con este descriptivo vamos a llevar a cabo los pasos para identificar la características de las canciones exitosas dependiendo de la variable Popularidad y con estos resultados dar las recomendaciones específicas.</p>
<p>Al encontrar una alerta de posibles nulos y duplicados, hacemos un tratamiento más detallado de ellos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valores nulos por columna:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c1"># Eliminamos columna innecesaria si existe</span>
<span class="k">if</span> <span class="s1">&#39;Unnamed: 0&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Verificamos duplicados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Número de duplicados:&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c1"># Eliminar duplicados si los hay</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="c1"># Verificar valores únicos en las columnas categóricas</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valores únicos en track_genre:&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Valores nulos por columna:
Unnamed: 0          0
track_id            0
artists             1
album_name          1
track_name          1
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64

Número de duplicados: 450

Valores únicos en track_genre: 114
track_genre
acoustic       1000
emo            1000
rock-n-roll    1000
reggaeton      1000
disco          1000
r-n-b          1000
punk-rock      1000
pagode         1000
electronic     1000
mpb            1000
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Encontramos en la base 3 nulos que debemos tratar para así observar mejor los datos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;artists&#39;</span><span class="p">,</span> <span class="s1">&#39;album_name&#39;</span><span class="p">,</span> <span class="s1">&#39;track_name&#39;</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>track_id            0
artists             0
album_name          1
track_name          1
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64
track_id            0
artists             0
album_name          0
track_name          1
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64
track_id            0
artists             0
album_name          0
track_name          0
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Analizamos Datos Atípicos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Librerias necesarias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Boxplot de </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
<span class="n">plot_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">numeric_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d5a1bf6a457198be4e4a64e07f859e4f043d7b4d17278311c4f568605a125615.png" src="_images/d5a1bf6a457198be4e4a64e07f859e4f043d7b4d17278311c4f568605a125615.png" />
</div>
</div>
<p>Haciendo un analisis de cada una de las variables con base a los boxplots de Outliers es, primero, duración (en milisegundos) es que hay canciones que duran más que 5,000,000 ms, siendo aproximadamente unos 83 minutos, algo excepcional.</p>
<p>Segundo, la instrumentalidad las canciones con más popularidad no son 100% instrumentales porque la mayoría, siendo el 75%, está por debajo de aproximadamente 0.049.</p>
<p>Y tercero, el compás (time_signature), casi el 100% está en 4/4, lo que significa que todas las canciones de la mayoría de géneros comparten un mismo compás pues influye en que todas empiencen igual. Se haría un estudio de la historia de esta variable desde tiempos antiguos pues no tiene un cambio en las canciones sin importar su género.</p>
<p>Por lo visto en las gráficas podemos visualizar que para la popularidad solo un pequeña subida, es decir, pocas canciones alcanzan alta popularidad.</p>
<p>En cuanto a la duración de las canciones la mayoría dura entre 2-4 minutos.</p>
<p>Para la variable Key no se ve una preferencia por alguna tonalidad en general.</p>
<p>En volumen podemos inferir que las canciones más escuchadas y que alcanzan un pico alto están entre -6 a -4 dB.</p>
<p>Las canciones más bailables tienen un ritmo por encima de (aprox.) 0.45 y y son más comunes la que tienen una alta energía, un tanto mayor a 0.7, como las playlist de ejercicio para los centros educativos o GYMs.</p>
<p>En cuanto a la acústica se ve un pico en 0 y entre 0.8 a 1, lo cual significa que el sonido debe ser puro. Y en las instrumentales no hay un pico significativo desde los 0.5, por lo cual son pocas canciones que lo tienen.</p>
<p>En la variable Tempo la mayoría de las canciones tienen un número de pulsaciones o latidos entre los 100 BPM A 140 BPM.</p>
<p>Como nuestra variable predictora es la popularidad de las canciones, atribuimos a fondo su investigación y repercusión en el estudio de nuestro Analisis Exploratorio. Por ello vemos de cerca su distribución:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Análisis de la distribución de Popularidad</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de Popularidad de las Canciones&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Estadísticas descriptivas de popularity</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Estadísticas de popularidad:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

<span class="c1"># Boxplot de popularity</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Boxplot de Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3170884e9dd8b1fce947b035bed401009a2a30fb6ce041dda2de52c79e3b7816.png" src="_images/3170884e9dd8b1fce947b035bed401009a2a30fb6ce041dda2de52c79e3b7816.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estadísticas de popularidad:
count    113550.000000
mean         33.324139
std          22.283976
min           0.000000
25%          17.000000
50%          35.000000
75%          50.000000
max         100.000000
Name: popularity, dtype: float64
</pre></div>
</div>
<img alt="_images/fb4dd5ddf8959e871672f9ec47d0cf1698964432fce59ebab129833a73a3d519.png" src="_images/fb4dd5ddf8959e871672f9ec47d0cf1698964432fce59ebab129833a73a3d519.png" />
</div>
</div>
<p>De acuerdo con el gráfico de distribución podemos notar que la mayoría de las canciones tienen popularidad menos que 60, después decae, por lo cual son muy pocas las canciones que llegan a tener una alta popularidad, y por su descriptivo se confirma una asimetría con cola a la derecha, es decir, muchos atípicos mayores a 50 y son los que más rapido llegan a tener una gran popularidad.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">popularity_by_genre</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;track_genre&#39;</span><span class="p">)[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 10 Géneros con Mayor Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularity (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 10 Géneros con Menor Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularidad (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Boxplot para los principales géneros</span>
<span class="n">top_genres</span> <span class="o">=</span> <span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_top_genres</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_genres</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_top_genres</span><span class="p">,</span> 
            <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Esto muestra la media como un marcador</span>
            <span class="n">meanprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;marker&quot;</span><span class="p">:</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>  <span class="c1"># Forma del marcador</span>
                       <span class="s2">&quot;markerfacecolor&quot;</span><span class="p">:</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># Color interno</span>
                       <span class="s2">&quot;markeredgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>  <span class="c1"># Color del borde</span>
                       <span class="s2">&quot;markersize&quot;</span><span class="p">:</span><span class="s2">&quot;10&quot;</span><span class="p">})</span>  <span class="c1"># Tamaño</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de Popularidad por Género (Top 10)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b4991d8434a69f2a7b923ac5617b11f086929699797b0b9210cfb8893ce3685e.png" src="_images/b4991d8434a69f2a7b923ac5617b11f086929699797b0b9210cfb8893ce3685e.png" />
<img alt="_images/195df5542d680d265100a8c7d2b18ef60cd37262085eecbe32988cb3e2b54f17.png" src="_images/195df5542d680d265100a8c7d2b18ef60cd37262085eecbe32988cb3e2b54f17.png" />
<img alt="_images/c0d5871d3440cd526b812653640b8b32df0e04966145cfa80e87fb32f8036da3.png" src="_images/c0d5871d3440cd526b812653640b8b32df0e04966145cfa80e87fb32f8036da3.png" />
</div>
</div>
<p>Analizando el Top de los 10 géneros con mayor popularidad vemos preferencias en estos géneros:</p>
<ul class="simple">
<li><p>Pop</p></li>
<li><p>K-pop</p></li>
<li><p>Pop-film</p></li>
<li><p>Dance-pop</p></li>
</ul>
<p>Por lo cual para las disqueras se les recomienda invertir más en estos géneros.</p>
<p>Mientras que en el top de los 10 géneros con menor popularidad como el Grimbton, Kids, Classical e Iranian tiene un bajo rendimiento en Spotify, por lo cual se les recomienda usar otras app o páginas que los impulsen.</p>
<p>Y en la distribución de popularidad por género el K-pop mtiene alta popularidad y algunos temas de géneros menos populares como señanajo logran alta popularidad.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calcular la matriz de correlación</span>
<span class="n">spotify_num</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

<span class="n">corr</span> <span class="o">=</span> <span class="n">spotify_num</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de correlación:&quot;</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Crear la máscara para ocultar la mitad superior</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Configurar el estilo y mostrar el mapa de calor</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Matriz de Correlación - Dataset de Spotify&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de correlación: (14, 14)
</pre></div>
</div>
<img alt="_images/adb6d2fe9c4a71cfbc55cf7840ccee8be611f2e76f5c7fd700ae67965b8ba97d.png" src="_images/adb6d2fe9c4a71cfbc55cf7840ccee8be611f2e76f5c7fd700ae67965b8ba97d.png" />
</div>
</div>
<p>Aquí podemos ver las correlaciones más significativas entre variables como la energía y volumen pues muchas canciones energéticas tienden a tener un alto volumen.</p>
<p>Tambien entre la acástica y la energía con Volumen pues al ser más “movidas” contienen una acústica más alta.</p>
<p>Mientras la popularidad, siendo nuestra variable predictora, tiene correlaciones medias con las anteriormente mencionadas pues las canciones populares tienden a ser más altas en volumen pero algunas con acústicas son menos populares.</p>
<p>Y las correlaciones más bajas, siendo entre variables como Key, time_signature y tempo no influye en la popularidad de las canciones.</p>
<p>Al evaluar estos comportamientos, hicimos un análisis PCA para ver más detalladamente la variabilidad de estas variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Análisis PCA</span>
<span class="n">numeric_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">numeric_df</span> <span class="o">=</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">numeric_df</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="c1"># Estandarización</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">numeric_df</span><span class="p">)</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">pca_result</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> 
         <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Varianza explicada acumulada por componentes PCA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Número de componentes&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Varianza explicada acumulada&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/acc929291f4c45ab5aadad23021a92867bb2da0012c937bb59755de4b5024ce8.png" src="_images/acc929291f4c45ab5aadad23021a92867bb2da0012c937bb59755de4b5024ce8.png" />
</div>
</div>
<p>Viendo este patrón junto con los datos musicales volvimos a ver la correlación entre la energía y el volumen, correlacionado y relación entre bailabilidad y positividad (valence).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Analisis VIF </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.outliers_influence</span><span class="w"> </span><span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Seleccionar solo las columnas numéricas</span>
<span class="n">spotify_num</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

<span class="c1"># Eliminar columnas que no tienen suficiente varianza (opcional)</span>
<span class="n">spotify_num</span> <span class="o">=</span> <span class="n">spotify_num</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Por si hay columnas con NaN</span>

<span class="c1"># Escalar los datos antes de calcular VIF</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">spotify_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">spotify_num</span><span class="p">)</span>

<span class="c1"># Calcular el VIF para cada variable</span>
<span class="n">vif_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spotify_num</span><span class="o">.</span><span class="n">columns</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">spotify_scaled</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spotify_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

<span class="c1"># Mostrar el resultado</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vif_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;VIF&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>            Variable       VIF
3             energy  4.249848
5           loudness  3.269293
8       acousticness  2.407126
11           valence  1.586171
2       danceability  1.540188
9   instrumentalness  1.474825
10          liveness  1.142463
7        speechiness  1.132767
12             tempo  1.091453
13    time_signature  1.080963
1        duration_ms  1.055228
6               mode  1.042076
0         popularity  1.023728
4                key  1.021432
</pre></div>
</div>
</div>
</div>
<p>Podemos notar que todas las variables tienen un valor VIF entre 1 a 5, lo que indica que no hay problemas graves de multicolinealidad.</p>
<p>Luego, hicimos una analisis de correlación más a fondo de nuestra variable predictora:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlaciones con popularidad</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlación con Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f97a8cded967d01eb6bfbf3812697f1ac18355f53610c8b25b4cfb2f31c78c7e.png" src="_images/f97a8cded967d01eb6bfbf3812697f1ac18355f53610c8b25b4cfb2f31c78c7e.png" />
</div>
</div>
<p>Visto en el gráfico, volvemos a ver más de cerca una mayor correlación con nuestra variable predictora con:</p>
<ul class="simple">
<li><p>Volumen</p></li>
<li><p>Bailabilidad</p></li>
<li><p>Energía</p></li>
</ul>
<p>Es decir, canciones que contengas un mayor volumen y que contengan ritmos bailables producen una mayor energía y, asimismo, una mayor popularidad para el público en general.</p>
<p>Para las variables tempo, vivacidad y duración influyen poco en que las canciones tengan una popularidad alta, pero son vitales para que se mantengan en los tops.</p>
<p>Y por último, en variables como la acústica y la instrumentalidad no influyen significativamente en la popularidad de una canción, por lo cual no es recomendable que se hagan mayormente canciones puramente instrumentales pues son poco atractivas.</p>
<p>Dejando de lado la popularidad, indagamos más en la influencia de los artistas:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Análisis de artistas</span>
<span class="n">top_artists</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;artists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">top_artists</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">top_artists</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 20 artistas con más canciones&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Número de canciones&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Artista&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">artist_popularity</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;artists&#39;</span><span class="p">)[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">artist_popularity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">artist_popularity</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 20 artistas por popularidad (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Popularidad (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Artista&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/da5b5b49c416d415bb723ef59a46b6829b91f3e52f64856bfe774d5448478df7.png" src="_images/da5b5b49c416d415bb723ef59a46b6829b91f3e52f64856bfe774d5448478df7.png" />
<img alt="_images/4e7f3c84c00294c2c0083e7da9626e3ac6022c59e33fad21e2cea66181d52b15.png" src="_images/4e7f3c84c00294c2c0083e7da9626e3ac6022c59e33fad21e2cea66181d52b15.png" />
</div>
</div>
<p>Algunas características del top de artistas con más canciones son:</p>
<ul class="simple">
<li><p>The Beatles: lideran con aprox. 250 canciones</p></li>
<li><p>George Jones</p></li>
<li><p>Stevie Wonder</p></li>
</ul>
<p>Y artistas nuevos como BTS llegan al top dando una revolución e impacto global en la música.</p>
<p>Pero algo interesante es que la cantidad de canciones no influye en su popularidad pues hay artistas como Bad Bunny que tiene menos canciones que The Beatles, pero tiene una mayor popularidad.</p>
<p>En el top de artistas por popularidad tenemos a Bad Bunny, The Weeknd, Beyoncé, Harry Styles, por lo cual música actual tiene una mezcla de estos géneros: reggaetón, pop y electrónica.</p>
<p>También las colaboraciones entre artistas aumentan la posibilidad de llegar a tener mayor popularidad, como los dúos.</p>
<p>Y como características de estos artistas es que tienen más sencillos que albumen largos, por lo que las disqueras pueden aumentar su popularidad cambiando esta estrategia comercial a una disco más corto. Por lo que las disqueras podrían priorizar lanzamientos de sencillos en lugar de álbumes largos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boxplot por género</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">top_genres</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_genres</span><span class="p">)],</span> 
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de popularidad por género&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/48debd24aec484d90ae214708a19a1e081b70cbbf63a20dd23eed8fff41585b7.png" src="_images/48debd24aec484d90ae214708a19a1e081b70cbbf63a20dd23eed8fff41585b7.png" />
</div>
</div>
<p>Podemos observar que géneros como acoustic, disco, emo, electronic, funk y metalcore tienen una mediana alta casi llegando a 50. También géneros como mandopop, metalcore, garage tienen una distribución muy amplia, lo que indica que hay canciones muy populares y otras poco populares.</p>
<p>Mientras que el reggaeton tieen alta variabilidad y outliers hacia arriba, por lo cual hay excepciones, es decir, canciones que alcanzan más popularidad que el promedio.</p>
<p>Y por géneros como mpb, pagode, punk-rock, r&amp;b, electronic y funk tienen cajas muy estrechas, es decir, una popularidad sin muchos cambios a lo largo de estas canciones.</p>
<p>Por lo tanto, un género único o primordial no existe porque hay una variabilidad alta y extensa que una competencia en cómo llegar a tener canciones populares..</p>
<p>Luego abarcamos los contenidos explícitos de algunos albumes de estos artistas y en cómo afecta su la popularidad en las listas. Además, evaluamos la bailabilidad y la energía de estas canciones y que pueden influir en alcanzar una mayor popularidad:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Popularidad por género y explicit content</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> 
            <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_genres</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Popularidad por Género y Contenido Explícito&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Explícito&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Relación entre popularity, danceability y energy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> 
                <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Relación entre Danceability, Energy y Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9ec7132bcd9fd6fbc6e85d71f117a824cb62e11e60a2ab0c6e03a2903cfd00fb.png" src="_images/9ec7132bcd9fd6fbc6e85d71f117a824cb62e11e60a2ab0c6e03a2903cfd00fb.png" />
<img alt="_images/b047f8d0f186a7ba3ff546a8317d0657f28bfc1c2eb11f868c68901ade395509.png" src="_images/b047f8d0f186a7ba3ff546a8317d0657f28bfc1c2eb11f868c68901ade395509.png" />
</div>
</div>
<p>Algunas repercuciones en el cotenido explicito de algunas canciones y su popularidad sí están relacionadas pues las canciones explícitas tienden a ser más populares, como podemos ver en géneros como emo, metalcore, reggaeton r-n-b pues tienen una mediana más alta que las no explícitas, contrario al caso de los géneros mpb y pagode, que no muestran ningún hallazgo de temas explícitos y los no explícitos.</p>
<p>Mientras que para géneros como acoustic, disco, garage y rock-n-roll no son muy populares por sus temas explícitos.</p>
<p>Y géneros como funk, mandopop, punk-rock y country no tienen diferencias marcadas entre sus canciones explícitas y las no explícitas.</p>
<p>Por tanto, la presencia de contenido explícito puede generar un aumento en la popularidad de la canción pero se sigue viendo una variabilidad en los géneros afecta mucho que resurgan este tipo de vocabulario.</p>
<p>En cuanto a la relación entre la bailabilidad y la energía muchas canciones tienden a ser tanto bailables como energéticas pues, como dijimos antes, hay una correlación entre alta energía y bailabilidad con alta popularidad.</p>
<p>Pero existen canciones con baja energía o bailabilidad que también logran buena popularidad en el centro de la gráfica, por lo que no son factores exclusivos pero si influyen significativamente en que tengan una mayor popularidad.</p>
<p>Como último esquema del EDA, vamos a hacer un análisis de Regresión logística</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">precision_recall_curve</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">]</span>  
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;popular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;popular&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span>  <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;logistic_model_class_weight_balanced.joblib&quot;</span><span class="p">)</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="s2">&quot;scaler.joblib&quot;</span><span class="p">)</span>

<span class="n">y_pred</span>  <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">acc</span>  <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">prec</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rec</span>  <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1</span>   <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">roc</span>  <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Logistic Regression (class_weight=&#39;balanced&#39;) ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:  </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision: </span><span class="si">{</span><span class="n">prec</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall:    </span><span class="si">{</span><span class="n">rec</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score:  </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC-ROC:   </span><span class="si">{</span><span class="n">roc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Confusion Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Report:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">roc_thresh</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
<span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">pr_thresh</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC = </span><span class="si">{</span><span class="n">roc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;FPR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;TPR (Recall)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recalls</span><span class="p">,</span> <span class="n">precisions</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">thr</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">y_pred_thr</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_proba</span> <span class="o">&gt;=</span> <span class="n">thr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">thr</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">),</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 5 thresholds según F1:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">metrics_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision / Recall / F1 vs Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">coef</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">odds_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span><span class="p">,</span>
    <span class="s1">&#39;odds_ratio&#39;</span><span class="p">:</span> <span class="n">odds_ratio</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;odds_ratio&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coeficientes y Odds Ratios (ordenados por efecto):&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">coef_df</span><span class="p">)</span>

<span class="n">best_f1_row</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor umbral por F1: </span><span class="si">{</span><span class="n">best_f1_row</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> con F1=</span><span class="si">{</span><span class="n">best_f1_row</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rec80</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">rec80</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">rec80</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ejemplo de umbral con recall ≥ 0.8:&quot;</span><span class="p">,</span> <span class="n">chosen</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay umbral que logre recall ≥ 0.8 sin sacrificar demasiada precisión.&quot;</span><span class="p">)</span>

<span class="n">metrics_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;threshold_metrics.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">coef_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;logistic_coef_odds.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Logistic Regression (class_weight=&#39;balanced&#39;) ===
Accuracy:  0.5526
Precision: 0.0664
Recall:    0.6344
F1 Score:  0.1202
AUC-ROC:   0.6165

Confusion Matrix:
 [[11856  9760]
 [  400   694]]

Classification Report:
               precision    recall  f1-score   support

           0       0.97      0.55      0.70     21616
           1       0.07      0.63      0.12      1094

    accuracy                           0.55     22710
   macro avg       0.52      0.59      0.41     22710
weighted avg       0.92      0.55      0.67     22710
</pre></div>
</div>
<img alt="_images/443dacb5f85a631d8c6e780fd2a3870d624937fcd3b6b5ff678c78b1f1041e5e.png" src="_images/443dacb5f85a631d8c6e780fd2a3870d624937fcd3b6b5ff678c78b1f1041e5e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 5 thresholds según F1:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>threshold</th>
      <th>accuracy</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>54</th>
      <td>0.55</td>
      <td>0.695509</td>
      <td>0.072425</td>
      <td>0.450640</td>
      <td>0.124794</td>
    </tr>
    <tr>
      <th>51</th>
      <td>0.52</td>
      <td>0.609203</td>
      <td>0.069492</td>
      <td>0.574040</td>
      <td>0.123976</td>
    </tr>
    <tr>
      <th>50</th>
      <td>0.51</td>
      <td>0.581066</td>
      <td>0.068736</td>
      <td>0.613346</td>
      <td>0.123618</td>
    </tr>
    <tr>
      <th>55</th>
      <td>0.56</td>
      <td>0.723822</td>
      <td>0.072772</td>
      <td>0.403108</td>
      <td>0.123288</td>
    </tr>
    <tr>
      <th>53</th>
      <td>0.54</td>
      <td>0.668604</td>
      <td>0.070628</td>
      <td>0.483547</td>
      <td>0.123253</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/194710deaa903aaa630152023cf7dcd377a920cfd2210554a846aaa4d4d42fa7.png" src="_images/194710deaa903aaa630152023cf7dcd377a920cfd2210554a846aaa4d4d42fa7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coeficientes y Odds Ratios (ordenados por efecto):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>coef</th>
      <th>odds_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>acousticness</td>
      <td>-0.477646</td>
      <td>0.620242</td>
    </tr>
    <tr>
      <th>0</th>
      <td>danceability</td>
      <td>0.286651</td>
      <td>1.331960</td>
    </tr>
    <tr>
      <th>1</th>
      <td>energy</td>
      <td>-0.180912</td>
      <td>0.834509</td>
    </tr>
    <tr>
      <th>3</th>
      <td>tempo</td>
      <td>-0.091542</td>
      <td>0.912523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>valence</td>
      <td>0.005926</td>
      <td>1.005944</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mejor umbral por F1: 0.550 con F1=0.125
Ejemplo de umbral con recall ≥ 0.8: {&#39;threshold&#39;: 0.43, &#39;accuracy&#39;: 0.3718626155878468, &#39;precision&#39;: 0.05899685260831715, &#39;recall&#39;: 0.8053016453382084, &#39;f1&#39;: 0.10993947713233918}
</pre></div>
</div>
</div>
</div>
<p>Características de TN, FP, FN, TP.</p>
<p>Una caraterística que muestran estos resultados es que, por ejemplo, un alto FN significa que el modelo no detecta muchos hits o éxitos.</p>
<p>Por tanto, si Spotify quiere maximizar descubrimiento de posibles hits se debe priorizar Recall, es decir, capturar la mayor cantidad de canciones con potencial. Pero si no quisiera gastar presupuesto en música que no pegue o sea la más popular en listas, priorizar Precision cuando quiera promocionar, es decir, que tenga alta probabilidad de éxito.</p>
<p>Por otro lado, los coeficientes positivos aumentan la popularidad mientras que los coeficientes negativos la reducen.</p>
<p>Una característica fundamental que va directamente ligada a los usuarios, y que puede incremetar no solo la popularidad del artista, sino también de la app, es la segmentación de usuarios porque combina predisposición de track con perfiles de usuarios para darles recomendaciones más efectivas y que les guste. Ahora, si la predicción de popularidad ayuda a reducir el gasto en promoción en tracks sin potencial, mejora RO, por lo que usar el modelo para proponer experimentos (como colocar X canciones en una playlist) y medir lift de streams, así ayuda a entender y corregir sesgos algorítmicos.</p>
<p>Pero para cumplir con esta idea faltarían comportamientos externos por analizar, como fecha de lanzamiento, de marketing como las campañas publicitarias y propagandas, metadatos geográficos o demográficos de audiencia.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resumen de hallazgos</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resumen de hallazgos:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Cantidad total de géneros únicos: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Género más popular en promedio: </span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Género menos popular en promedio: </span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Variables más correlacionadas con popularidad:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen de hallazgos:
- Cantidad total de géneros únicos: 114
- Género más popular en promedio: pop-film (59.28)
- Género menos popular en promedio: iranian (2.22)
- Variables más correlacionadas con popularidad:
loudness        0.047371
danceability    0.034412
tempo           0.012180
energy         -0.002444
liveness       -0.005658
Name: popularity, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Concluimos que hay mucha diversidad musical hoy en día pues hay 114 géneros bien representados.
Contiene una distribución balanceada de géneros y una distribución asimétrica de popularidad, lo que sugiere que todos los géneros tienen oportunidad pero pocos alcanzan esa máxima popularidad.</p>
<p>Este EDA representa la diversidad musical actual. Captura la dinámica competitiva de la industria que ofrece oportunidades para ver patrones en ciertos géneros, poder predecir un éxito musical y optimizar recomendaciones.</p>
<p>Los hallazgos no solo muestras las preferencias de las personas del mundo, sino que también las herramientas para los artistas, productores y plataformas digitales o streaming necesitas pues la música va a seguir creciendo y con ello tenemos muchos aspectos con los cuales poder seguir investigando las futuras tendencias.</p>
<p>##Aplicación de Modelos</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="aplicacion-de-modelos">
<h1>Aplicación de Modelos<a class="headerlink" href="#aplicacion-de-modelos" title="Permalink to this heading">#</a></h1>
<p>Ahora presentamos la ejecución de los modelos aplicado en clase en nuestro proyecto:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">hstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># númericas</span>
<span class="n">num_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
<span class="n">X_train_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>
<span class="n">X_test_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_num</span><span class="p">)</span>
<span class="n">X_test_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_num</span><span class="p">)</span>

<span class="c1"># categóricas</span>
<span class="n">cat_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)</span>
<span class="n">X_train_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>
<span class="n">X_test_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">X_train_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_cat</span><span class="p">)</span>
<span class="n">X_test_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_cat</span><span class="p">)</span>

<span class="c1"># numéricas + categóricas</span>
<span class="n">X_train_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_train_num_scaled</span><span class="p">,</span> <span class="n">X_train_cat_encoded</span><span class="p">])</span>
<span class="n">X_test_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_test_num_scaled</span><span class="p">,</span> <span class="n">X_test_cat_encoded</span><span class="p">])</span>

<span class="n">X_train_dense</span> <span class="o">=</span> <span class="n">X_train_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_test_dense</span> <span class="o">=</span> <span class="n">X_test_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño original: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proporción de clases: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># GridSearchCV personalizado con SMOTE en cada fold para regresión logística</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> 
    <span class="s2">&quot;penalty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="c1"># CV estratificado</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid search de regresión logística:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">penalty</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;penalty&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">penalty</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">and</span> <span class="n">C</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">X_fold_train</span><span class="p">,</span> <span class="n">X_fold_val</span> <span class="o">=</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">y_fold_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            
            <span class="c1"># Aplicamos Smote solo en el entrenamiendo en e fold</span>
            <span class="n">smote</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
            <span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span> <span class="o">=</span> <span class="n">smote</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">,</span> <span class="n">y_fold_train</span><span class="p">)</span>
            
            <span class="n">logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
                <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> 
                <span class="n">penalty</span><span class="o">=</span><span class="n">penalty</span><span class="p">,</span> 
                <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span> <span class="k">if</span> <span class="n">penalty</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span> <span class="k">else</span> <span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
                <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            <span class="n">logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span><span class="p">)</span>
            <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fold_val</span><span class="p">)</span>
            
            <span class="n">score</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_fold_val</span><span class="p">,</span> <span class="n">y_pred_val</span><span class="p">)</span>
            <span class="n">fold_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_scores</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C=</span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2">, penalty=</span><span class="si">{</span><span class="n">penalty</span><span class="si">}</span><span class="s2">: Recall CV = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;penalty&#39;</span><span class="p">:</span> <span class="n">penalty</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejores parámetros: </span><span class="si">{</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor recall (CV): </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Aplicamos Smote en el entrenamiendo completo para el modelo final</span>
<span class="n">smote_final</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span> <span class="o">=</span> <span class="n">smote_final</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño con SMOTE: </span><span class="si">{</span><span class="n">X_train_res</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">best_logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
    <span class="o">**</span><span class="n">best_params</span><span class="p">,</span> 
    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span> <span class="k">if</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;penalty&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span> <span class="k">else</span> <span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
<span class="n">best_logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_logreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">best_logreg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación de regresión logística&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Accuracy en test:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ROC AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">))</span>

<span class="c1"># curva ROC</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Curva ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base (AUC = 0.5)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos (FPR)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos (TPR)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Regresión Logística con SMOTE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># punto óptimo </span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fpr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tpr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">optimal_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
<span class="n">optimal_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Punto óptimo (threshold=</span><span class="si">{</span><span class="n">optimal_threshold</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Umbral óptimo: </span><span class="si">{</span><span class="n">optimal_threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">y_pred_optimal</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_proba</span> <span class="o">&gt;=</span> <span class="n">optimal_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Informe de Clasificación con umbral óptimo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de confusión con umbral óptimo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño original: (90840, 15)
Proporción de clases: [0.95184941 0.04815059]
Grid search de regresión logística:
C=0.01, penalty=l2: Recall CV = 0.5773
C=0.01, penalty=None: Recall CV = 0.6726
C=0.1, penalty=l2: Recall CV = 0.6550
C=0.1, penalty=None: Recall CV = 0.6726
C=1, penalty=l2: Recall CV = 0.6715
C=1, penalty=None: Recall CV = 0.6726
C=10, penalty=l2: Recall CV = 0.6722
C=10, penalty=None: Recall CV = 0.6726
C=100, penalty=l2: Recall CV = 0.6740
C=100, penalty=None: Recall CV = 0.6726

Mejores parámetros: {&#39;C&#39;: 100, &#39;penalty&#39;: &#39;l2&#39;}
Mejor recall (CV): 0.6740
Tamaño con SMOTE: (129699, 129)
Evaluación de regresión logística

Accuracy en test: 0.8327168648172611

Matriz de confusión:
 [[18191  3425]
 [  374   720]]

Reporte de clasificación:
               precision    recall  f1-score   support

           0       0.98      0.84      0.91     21616
           1       0.17      0.66      0.27      1094

    accuracy                           0.83     22710
   macro avg       0.58      0.75      0.59     22710
weighted avg       0.94      0.83      0.88     22710

ROC AUC: 0.8620953256576143
</pre></div>
</div>
<img alt="_images/472239ff1c2bb28ffea7bc0f7a1b29d145ec0dce3126605d8264a03ec58daaac.png" src="_images/472239ff1c2bb28ffea7bc0f7a1b29d145ec0dce3126605d8264a03ec58daaac.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Umbral óptimo: 0.355

Informe de Clasificación con umbral óptimo:
              precision    recall  f1-score   support

           0       0.99      0.76      0.86     21616
           1       0.15      0.81      0.25      1094

    accuracy                           0.77     22710
   macro avg       0.57      0.79      0.56     22710
weighted avg       0.95      0.77      0.83     22710

Matriz de confusión con umbral óptimo:
[[16525  5091]
 [  208   886]]
</pre></div>
</div>
</div>
</div>
<p>Para el modelo de regresión logística, ajustado con la técnica de sobremuestreo SMOTE para balancear las clases, alcanzó un desempeño adecuado. Se evidenció un fuerte desbalanceo con aproximadamente un 95% de observaciones a la clase negativa y solo un 5% a la clase positiva.</p>
<p>Por ello, se aplicó SMOTE y  se realizó una búsqueda de hiperparámetros, para encontrar el mejor modelo correspondido a una regresión logística con C = 0.01  logrando un recall promedio en validación cruzada de 0.6733.</p>
<p>En el conjunto de prueba, el modelo obtuvo una accuracy de 0.83 y un área bajo la curva ROC AUC de 0.862, lo cual refleja una buena capacidad de discriminación entre las clases.</p>
<p>El análisis del reporte de clasificación mostró que con el umbral estándar de 0.5, la clase minoritaria alcanzaba un recall de 0.66 pero con una baja precisión con un 0.17.</p>
<p>Al ajustar el umbral de decisión a 0.346 el recall de la clase positiva aumentó significativamente hasta 0.82, así el modelo logra detectar la gran mayoría de los casos. Pero el ajuste lo que hace es una disminución en la precisión y en la exactitud.</p>
<p>Por ello, estas modificaciones prioriza la identificación de las canciones exitosas y así apoyar decisiones en las que resulta más dificil no dejar escapar canciones que tengan un tipo de potencial y no eliminarlas.</p>
<p>Ahora veamos el modelo KNN</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">recall_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">hstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>

<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>
<span class="c1"># numéricas</span>
<span class="n">num_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
<span class="n">X_train_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>
<span class="n">X_test_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_num</span><span class="p">)</span>
<span class="n">X_test_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_num</span><span class="p">)</span>

<span class="c1"># categóricas</span>
<span class="n">cat_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)</span>
<span class="n">X_train_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>
<span class="n">X_test_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">X_train_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_cat</span><span class="p">)</span>
<span class="n">X_test_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_cat</span><span class="p">)</span>

<span class="c1"># numéricas + categóricas </span>
<span class="n">X_train_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_train_num_scaled</span><span class="p">,</span> <span class="n">X_train_cat_encoded</span><span class="p">])</span>
<span class="n">X_test_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_test_num_scaled</span><span class="p">,</span> <span class="n">X_test_cat_encoded</span><span class="p">])</span>

<span class="n">X_train_dense</span> <span class="o">=</span> <span class="n">X_train_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_test_dense</span> <span class="o">=</span> <span class="n">X_test_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño original: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_neighbors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">21</span><span class="p">]}</span>

<span class="c1"># CV estratificado</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">cv_scores</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">n_neighbors</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">]:</span>
    <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="n">X_fold_train</span><span class="p">,</span> <span class="n">X_fold_val</span> <span class="o">=</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
        <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">y_fold_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
        
        <span class="n">smote</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span> <span class="o">=</span> <span class="n">smote</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">,</span> <span class="n">y_fold_train</span><span class="p">)</span>
        
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span><span class="p">)</span>
        <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fold_val</span><span class="p">)</span>
        
        <span class="n">score</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_fold_val</span><span class="p">,</span> <span class="n">y_pred_val</span><span class="p">)</span>
        <span class="n">fold_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    
    <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_scores</span><span class="p">)</span>
    <span class="n">cv_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_score</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_neighbors=</span><span class="si">{</span><span class="n">n_neighbors</span><span class="si">}</span><span class="s2">: Recall CV = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">best_n_neighbors</span> <span class="o">=</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor parámetro: n_neighbors=</span><span class="si">{</span><span class="n">best_n_neighbors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor recall (CV): </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">smote_final</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span> <span class="o">=</span> <span class="n">smote_final</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño con SMOTE: </span><span class="si">{</span><span class="n">X_train_res</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">best_knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_n_neighbors</span><span class="p">)</span>
<span class="n">best_knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">best_knn</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Accuracy en test:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ROC AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño original: (90840, 15)
n_neighbors=1: Recall CV = 0.4223
n_neighbors=3: Recall CV = 0.5594
n_neighbors=5: Recall CV = 0.6358
n_neighbors=7: Recall CV = 0.6822
n_neighbors=9: Recall CV = 0.7142
n_neighbors=11: Recall CV = 0.7352
n_neighbors=13: Recall CV = 0.7481
n_neighbors=15: Recall CV = 0.7579
n_neighbors=17: Recall CV = 0.7615
n_neighbors=19: Recall CV = 0.7654
n_neighbors=21: Recall CV = 0.7634

Mejor parámetro: n_neighbors=19
Mejor recall (CV): 0.7654
Tamaño con SMOTE: (129699, 129)

Accuracy en test: 0.7650814619110524

Matriz de confusión:
 [[16525  5091]
 [  244   850]]

Reporte de clasificación:
               precision    recall  f1-score   support

           0       0.99      0.76      0.86     21616
           1       0.14      0.78      0.24      1094

    accuracy                           0.77     22710
   macro avg       0.56      0.77      0.55     22710
weighted avg       0.94      0.77      0.83     22710

ROC AUC: 0.854108254160707
</pre></div>
</div>
</div>
</div>
<p>El modelo KNN ajustado con  SMOTE mostró que el mejor desempeño se alcanzó con k = 19 con un recall promedio en validación cruzada de 0.7661.</p>
<p>En el conjunto de prueba el modelo alcanzó un accuracy de 0.7647 y un área bajo la curva ROC (AUC) de 0.854, es decir, buena capacidad de discriminación entre clases.</p>
<p>La matriz de confusión muestra que el modelo detectó  850 de los 1,094 casos positivos, lo que significa que identifica la mayoría de las canciones potencialmente exitosas. Pero la precisión de la clase positiva fue baja dando un número elevado de falsos positivos.</p>
<p>Por ello,  el modelo KNN logra identificar la clase minoritaria y la detección de canciones exitosas. Y al haber una baja precisión  muchas de las canciones clasificadas como exitosas no lo son en realidad. Comparándolo con la regresión logística ambos modelos obtienen resultados similares, pero la regresión logística da un desempeño más balanceado, mientras que KNN tiende a elevar precisión del recall.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">cm</span><span class="p">,</span>
    <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>     <span class="c1"># ya funciona porque cm es int</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">],</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matriz de Confusión (k=</span><span class="si">{</span><span class="n">best_n_neighbors</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predicho&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Real&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1d208fbdf2492bccab5182f2aba607c083fd3465417cbba849ac700ab43b75c6.png" src="_images/1d208fbdf2492bccab5182f2aba607c083fd3465417cbba849ac700ab43b75c6.png" />
</div>
</div>
<p>La matriz de confusión obtenida para el modelo KNN con k = 19 muestra un buen desempeño en la identificación de canciones populares. De un total de 22,710 observaciones, el modelo clasificó correctamente 16,517 canciones no populares y 850 canciones populares. Pero hay  5,099 canciones fueron clasificadas incorrectamente como populares  mientras que 244 canciones populares no fueron detectadas.</p>
<p>Estos resultados dieron un recall de 0.78 para la clase positiva, lo que indica que el modelo identifica la mayoría de las canciones populares, aunque la precisión de esa clase es baja con 0.14, reflejando que las canciones predichas como populares no lo son realmente.</p>
<p>Por ello, la matriz confirma que el modelo KNN da la detección de la clase minoritaria y la mayor parte de las canciones populares, aunque con un poquito de falsos positivos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>

<span class="c1"># Aplicar PCA a los datos de entrenamiento procesados</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Subplot 1: Datos originales</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">scatter1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Datos Originales&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scatter1</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Subplot 2: Datos con SMOTE</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">X_res_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train_res</span><span class="p">)</span>
<span class="n">scatter2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train_res</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Datos con SMOTE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scatter2</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Entrenar KNN en el espacio PCA de datos con SMOTE</span>
<span class="n">knn_pca</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_n_neighbors</span><span class="p">)</span>
<span class="n">knn_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_res_pca</span><span class="p">,</span> <span class="n">y_train_res</span><span class="p">)</span>

<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="c1"># Predecir en el meshgrid</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">knn_pca</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train_res</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fronteras de Decisión KNN (k=</span><span class="si">{</span><span class="n">best_n_neighbors</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scatter</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Curva ROC</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aleatorio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Curva ROC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e59870409c9d22075508c522372f5e04e18772a90c4f9866df4cc8c7eb0ab0c7.png" src="_images/e59870409c9d22075508c522372f5e04e18772a90c4f9866df4cc8c7eb0ab0c7.png" />
<img alt="_images/ed8c416bbb6789378ef87af2db0b2deeddd6740c85a8c2d7644c11e3fdfbcd86.png" src="_images/ed8c416bbb6789378ef87af2db0b2deeddd6740c85a8c2d7644c11e3fdfbcd86.png" />
<img alt="_images/17d1178e04f1b1d4eadaef840a295d4ac1327867e76b22e394033b750b6f7289.png" src="_images/17d1178e04f1b1d4eadaef840a295d4ac1327867e76b22e394033b750b6f7289.png" />
</div>
</div>
<p>En la primera gráfica se comparan los datos originales con los datos balanceados mediante SMOTE, se observa  el desbalance de clases inicial. En los datos originales la clase No Popular es la que predomina, mientras que la clase Popular tiene un número reducido de instancias, lo que genera  problema para el modelo al momento de aprender patrones.</p>
<p>Luego de aplicar el SMOTE se logra un balance entre ambas clases, la clase minoritaria obtiene mayor representación en el conjunto de entrenamiento y así identificar con mayor precisión los patrones asociados a esta categoría y mejora la métrica de recall.</p>
<p>Y la curva ROC muestra un AUC = 0.854 que indica que el modelo tiene una alta capacidad de discriminación entre las clases. La curva se ubica muy por encima de la línea aleatoria que confirma que el rendimiento del modelo es mejor que el azar.</p>
<p>Así, la aplicación de SMOTE  mejora el desempeño del modelo en la detección de las canciones populares, logrando un equilibrio entre las clases y obteniendo un modelo con buen nivel.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelado-benchmark">
<h1>Modelado Benchmark<a class="headerlink" href="#modelado-benchmark" title="Permalink to this heading">#</a></h1>
<p>Ahora presentamos la ejecución de los modelos aplicado en clase en nuestro proyecto:</p>
<p>Configuramos los datos preparados para cada modelo</p>
<p>Librerias necesarias:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>  
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RANDOM_STATE</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_STATE</span><span class="p">)</span>

<span class="c1"># variable binaria: Popular = 1 vs No Popular = 0</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Features y target</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="s1">&#39;track_id&#39;</span><span class="p">,</span> <span class="s1">&#39;artists&#39;</span><span class="p">,</span> <span class="s1">&#39;album_name&#39;</span><span class="p">,</span> <span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="s1">&#39;HighPopularity&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X</span><span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distribución de clases binario:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Proporción: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% populares&quot;</span><span class="p">)</span>

<span class="c1"># División</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">División de datos:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Training: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test:     </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Características numéricas</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>

<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Numéricas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Categóricas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Prreprocesamiento</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>


<span class="c1"># Uso de validación cruzada </span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cross-Validation con 5-fold estratificado&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases binario:
   Clase 0 (No Popular): 108082 samples
   Clase 1 (Popular):    5468 samples
   Proporción: 4.8% populares

División de datos:
   Training: (90840, 15)
   Test:     (22710, 15)
   y_train - 0: 86466, 1: 4374
   y_test  - 0: 21616, 1: 1094
   Numéricas: 13
   Categóricas: 1
   Total: 14
Cross-Validation con 5-fold estratificado
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">cv_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evalúa un modelo con F1-Macro como métrica principal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">results_cv</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># VALIDACIÓN CRUZADA</span>
    <span class="k">if</span> <span class="n">cv_folds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VALIDACIÓN CRUZADA (</span><span class="si">{</span><span class="n">cv_folds</span><span class="si">}</span><span class="s2"> folds) - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;precision_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;precision_macro&#39;</span><span class="p">,</span>     
            <span class="s1">&#39;recall_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;recall_macro&#39;</span><span class="p">,</span>           
            <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>                   
            <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>            
            <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="s1">&#39;roc_auc&#39;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
        
        <span class="c1"># Remover métricas que no se pueden calcular</span>
        <span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scoring</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
            <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Resultados CV</span>
        <span class="n">results_cv</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cv_accuracy_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;cv_accuracy_std&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;cv_f1_macro_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
            <span class="s1">&#39;cv_f1_macro_std&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;cv_f1_weighted_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;cv_f1_weighted_std&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;cv_train_accuracy_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;cv_train_f1_macro_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="s1">&#39;test_roc_auc&#39;</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="p">:</span>
            <span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Macro (CV):    </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_macro_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_macro_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ← PRINCIPAL&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy (CV):    </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_accuracy_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_accuracy_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted (CV): </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_weighted_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_weighted_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;cv_auc_mean&#39;</span> <span class="ow">in</span> <span class="n">results_cv</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC (CV):         </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># EVALUACIÓN EN TEST SET</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># MÉTRICAS PRINCIPALES</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># ← PRINCIPAL</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_macro</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_macro</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not compute AUC for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Resumen PRINCIPAL con F1-Macro</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TEST SET - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: f1_macro=</span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="c1"># Resultado final</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">f1_macro</span><span class="p">,</span>          
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;precision_macro&#39;</span><span class="p">:</span> <span class="n">precision_macro</span><span class="p">,</span>
        <span class="s1">&#39;recall_macro&#39;</span><span class="p">:</span> <span class="n">recall_macro</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>
    
    <span class="c1"># Para compatibilidad con código antiguo</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_macro</span>  <span class="c1"># ← Esto hace que f1 sea macro también</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Combinar con resultados CV si existen</span>
    <span class="k">if</span> <span class="n">results_cv</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results_cv</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>Iniciamos entrenando cada modelo:</p>
<p><strong>Regresión Logística</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Función evaluate_model MEJORADA que incluye gráficas y análisis</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># Entrenar solo con training data</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Métricas de clasificación</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC </span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Binario</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Multiclase</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not compute AUC for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Resumen</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, f1=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="c1"># gráficas y análisis</span>
    <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación:&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

        <span class="c1"># Gráficas</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Curva ROC</span>
        <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión</span>
        <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                            <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matriz de Confusión - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>

<span class="c1"># Lista para almacenar resultados</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División </span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline final</span>
<span class="n">pipe_logreg</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;model__penalty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_logreg</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                       <span class="s2">&quot;Logistic Regression (Optimized)&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MATRIZ DE RESULTADOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Mostrar matriz final de resultados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESUMEN FINAL - MATRIZ DE RESULTADOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0: 86466 muestras (95.2%)
   Clase 1: 4374 muestras (4.8%)
Fitting 5 folds for each of 8 candidates, totalling 40 fits
Mejores parámetros: {&#39;model__C&#39;: 0.01, &#39;model__penalty&#39;: &#39;l1&#39;}
Mejor F1-score (CV): 0.5662
EVALUACIÓN COMPLETA CON evaluate_model
Logistic Regression (Optimized): acc=0.787, f1=0.565, time=0.90s
Evaluación:
Accuracy: 0.7867
F1-score: 0.5647
AUC:      0.8431

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 17043     4573]
     Popular   [   270      824]

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.98      0.79      0.88     21616
     Popular       0.15      0.75      0.25      1094

    accuracy                           0.79     22710
   macro avg       0.57      0.77      0.56     22710
weighted avg       0.94      0.79      0.85     22710
</pre></div>
</div>
<img alt="_images/a16c27edc1595c300f63163dd14e7a637ce2c8eef0ffb1e14b4eb4249ba7b6b8.png" src="_images/a16c27edc1595c300f63163dd14e7a637ce2c8eef0ffb1e14b4eb4249ba7b6b8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MATRIZ DE RESULTADOS
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   

      AUC  Train_Time  
0  0.8431      0.9011  
RESUMEN FINAL - MATRIZ DE RESULTADOS
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
</pre></div>
</div>
</div>
</div>
<p>Viendo los resultados arrojados del modelo de Regresión Logística presenta un F1-Score macro de 0.565 y un AUC-ROC de 0.843, lo que indica la capacidad distinguir entre canciones populares y no populares. La métrica de accuracy con un 0.787 de evidencia de un desbalance inherente en los datos, donde solo el 4.8% de las canciones son clasificadas como populares.</p>
<p>En la matriz de confusión se ve un Recall de 0.75 para la clase Popular, dando así que el modelo identifica correctamente el 75% de las canciones realmente populares, en contexto, serían 824 de 1094. En el valor de Precision con un 0.15 para la clase Popular, es decir, solo el 15% de las canciones clasificadas como populares realmente lo son.</p>
<p>Por lo cual, este modelo es ideal en etapas iniciales de selección pues no descartar canciones potencialmente populares aunque se incluyan muchos falsos positivos.</p>
<p>Así, para disqueras y artistas, este modelo captura la mayoría de las canciones potencialmente populares, siendo útil en etapas iniciales para demos o producciones.</p>
<p><strong>Naive Bayes</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Pipeline</span>
<span class="n">pipe_nb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>          
<span class="p">])</span>

<span class="c1"># Validación cruzada</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="s1">&#39;precision_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="s1">&#39;recall_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  <span class="c1"># F1-macro como métrica principal</span>
    <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="s1">&#39;roc_auc&#39;</span>
<span class="p">}</span>

<span class="n">cv_results_nb</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipe_nb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de la validación cruzada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:  </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:  </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:       </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_nb</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipe_nb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                          <span class="s2">&quot;Naive Bayes&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_nb</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Análisis gráficas</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas por clase (para el análisis detallado)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados Naive Bayes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   CLASE 0 (No Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 1 (Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detalles:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># Gráficas personalizadas para Naive Bayes</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_nb</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Naive Bayes - Matriz de Confusión&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Clase 0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Clase 1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Clase 0&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clase 0 (No Popular)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Clase 1&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clase 1 (Popular)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Naive Bayes&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Análisis del overfitting </span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis&quot;</span><span class="p">)</span>
<span class="n">train_vs_test_diff</span> <span class="o">=</span> <span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia Training vs Test Accuracy: </span><span class="si">{</span><span class="n">train_vs_test_diff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_vs_test_diff</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Posible overfitting detectado&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_vs_test_diff</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excelente generalización&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Buen balance entre training y test&quot;</span><span class="p">)</span>

<span class="c1"># Mostrar matriz final de resultados actualizada</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen de resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Naive Bayes vs otros modelos</span>
    <span class="n">nb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Naive Bayes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Naive Bayes se encuentra en la posición #</span><span class="si">{</span><span class="n">nb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados de la validación cruzada:
Accuracy:  0.4773 ± 0.0103
F1-score:  0.3877 ± 0.0063
AUC:       0.7247 ± 0.0029
EVALUACIÓN COMPLETA CON evaluate_model
Naive Bayes: acc=0.489, f1=0.395, time=0.58s
Matriz resultantes:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
Evaluación

Resultados Naive Bayes:
   Tiempo entrenamiento: 0.58s
   Accuracy: 0.4895
   Balanced Accuracy: 0.7236
   AUC:      0.7255

   CLASE 0 (No Popular):
      Precision: 0.9981 | Recall: 0.4645 | F1: 0.6340
   CLASE 1 (Popular):
      Precision: 0.0850 | Recall: 0.9826 | F1: 0.1564

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 10041    11575]
     Popular   [    19     1075]

Detalles:
   Verdaderos Negativos: 10041
   Falsos Positivos:     11575
   Falsos Negativos:     19
   Verdaderos Positivos: 1075

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       1.00      0.46      0.63     21616
     Popular       0.08      0.98      0.16      1094

    accuracy                           0.49     22710
   macro avg       0.54      0.72      0.40     22710
weighted avg       0.95      0.49      0.61     22710
</pre></div>
</div>
<img alt="_images/7c82c53e9796b84888f833163bbad074f8958200035616cd1401f7e411538dd0.png" src="_images/7c82c53e9796b84888f833163bbad074f8958200035616cd1401f7e411538dd0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis
Diferencia Training vs Test Accuracy: 0.0003
Excelente generalización
Resumen de resultados:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Logistic Regression (Optimized)
   F1-Score: 0.5647
   Accuracy: 0.7867
   AUC:      0.8431

Naive Bayes se encuentra en la posición #2 de 2 modelos
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Naive Bayes, se presenta un F1-Score macro de 0.395 y un AUC-ROC de 0.725, indicando un desempeño significativamente inferior al modelo de Regresión Logística optimizado. La métrica de accuracy con un 0.489 refleja una capacidad clasificatoria cercana al azar por el desbalance que hay en los datos.</p>
<p>La matriz de confusión revela un Recall de 0.98 para la clase Popular, dando que el modelo identifica correctamente el 98% de las canciones realmente populares (1075 de 1094), y un Precision de 0.08 para la clase Popular, dando que solo el 8% de las predicciones clasificadas como “populares” son correctas.</p>
<p>Viendo la alta tasa de falsos positivos se muestra que 11,575 canciones no populares fueron incorrectamente clasificadas como populares. Por lo cual, este modelo prioriza la captura de casi todas las canciones populares a costa de incluir una enorme cantidad de falsos positivos, por lo que tiene dificultades para establecer límites entre clases.</p>
<p>Así, para las disqueras y artistas, este modelo en etapas iniciales tiene la capacidad de hacer una búsqueda masiva donde es crítico no omitir ninguna canción potencial pero no logran capturar adecuadamente.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================</span>
<span class="c1"># IMPORTACIONES</span>
<span class="c1"># ============================================</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># ============================================</span>
<span class="c1"># FUNCIÓN evaluate_model CORREGIDA</span>
<span class="c1"># ============================================</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># Entrenar</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># Predicción clase</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># ===============================================</span>
    <span class="c1"># OBTENCIÓN DE SCORES PARA AUC (predict_proba / decision_function)</span>
    <span class="c1"># ===============================================</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">):</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>       <span class="c1"># probabilidades reales</span>
        <span class="n">score_type</span> <span class="o">=</span> <span class="s2">&quot;predict_proba&quot;</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;decision_function&quot;</span><span class="p">):</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>         <span class="c1"># scores continuos</span>
        <span class="n">score_type</span> <span class="o">=</span> <span class="s2">&quot;decision_function&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">score_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># ===============================================</span>
    <span class="c1"># MÉTRICAS</span>
    <span class="c1"># ===============================================</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>

    <span class="c1"># ===============================================</span>
    <span class="c1"># RESULTADOS CONSOLA</span>
    <span class="c1"># ===============================================</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, f1=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auc_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC (</span><span class="si">{</span><span class="n">score_type</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC: No disponible para este modelo&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auc_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC:      No disponible&quot;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión (texto)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

        <span class="c1"># ===============================================</span>
        <span class="c1"># GRÁFICAS</span>
        <span class="c1"># ===============================================</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># --- CURVA ROC ---</span>
        <span class="k">if</span> <span class="n">y_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">)</span>
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Tasa de Falsos Positivos&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Tasa de Verdaderos Positivos&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Este modelo no produce</span><span class="se">\n</span><span class="s2">scores para ROC&quot;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># --- MATRIZ DE CONFUSIÓN ---</span>
        <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
            <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matriz de Confusión - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_scores</span>
    <span class="p">}</span>


<span class="c1"># ============================================</span>
<span class="c1"># DATASET Y VARIABLES</span>
<span class="c1"># ============================================</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># ============================================</span>
<span class="c1"># TRAIN / TEST SPLIT</span>
<span class="c1"># ============================================</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distribución de clases:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test         - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ============================================</span>
<span class="c1"># PREPROCESAMIENTO</span>
<span class="c1"># ============================================</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># ============================================</span>
<span class="c1"># PIPELINE RIDGE</span>
<span class="c1"># ============================================</span>
<span class="n">ridge_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># ============================================</span>
<span class="c1"># EVALUACIÓN</span>
<span class="c1"># ============================================</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>
<span class="n">result_ridge</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span>
    <span class="n">ridge_pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="s2">&quot;Ridge Classifier&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># ============================================</span>
<span class="c1"># TABLA DE RESULTADOS</span>
<span class="c1"># ============================================</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># ============================================</span>
<span class="c1"># ANÁLISIS DETALLADO RIDGE</span>
<span class="c1"># ============================================</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Análisis Ridge&quot;</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>

<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Métricas por clase:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 0 (No Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 1 (Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ============================================</span>
<span class="c1"># GRÁFICA MÉTRICAS POR CLASE</span>
<span class="c1"># ============================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases:
   Entrenamiento - Clase 0: 86466 | Clase 1: 4374
   Test         - Clase 0: 21616 | Clase 1: 1094

EVALUACIÓN COMPLETA CON evaluate_model

Ridge Classifier: acc=0.952, f1=0.488, time=1.77s
AUC (decision_function): 0.8570

Evaluación:
Accuracy: 0.9518
F1-score: 0.4877
AUC:      0.8570

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21616        0]
     Popular   [  1094        0]

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.95      1.00      0.98     21616
     Popular       0.00      0.00      0.00      1094

    accuracy                           0.95     22710
   macro avg       0.48      0.50      0.49     22710
weighted avg       0.91      0.95      0.93     22710
</pre></div>
</div>
<img alt="_images/82382c705db93101774ea8d9cf277360539ce12851dd9f4a4b8bee7ecdd8514c.png" src="_images/82382c705db93101774ea8d9cf277360539ce12851dd9f4a4b8bee7ecdd8514c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de resultados:
              Model  Accuracy  Precision  Recall  F1-Score    AUC  Train_Time
0  Ridge Classifier    0.9518      0.906  0.9518    0.4877  0.857      1.7741

Análisis Ridge
Balanced Accuracy: 0.5000

Métricas por clase:
   CLASE 0 (No Popular):
      Precision: 0.9518 | Recall: 1.0000 | F1: 0.9753
   CLASE 1 (Popular):
      Precision: 0.0000 | Recall: 0.0000 | F1: 0.0000
</pre></div>
</div>
<img alt="_images/c5ad7be9cdb3dc07e7af584dfa7b2950459e5278f4ba9a93309793a2f0825160.png" src="_images/c5ad7be9cdb3dc07e7af584dfa7b2950459e5278f4ba9a93309793a2f0825160.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen:
           Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Ridge Classifier  0.951827   0.905975 0.951827   0.48766 0.857032     1.77411
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Ridge Classifier presenta un F1-Score macro de 0.488 y un accuracy de 0.952, mostrando un patrón de clasificación sesgado.</p>
<p>En la matriz de confusión revela en la clase 0 (No Popular) un Recall del 100%, es decir, clasifica correctamente todas las 21,616 canciones no populares. Para la clase 1 (Popular) muestra un Recall del 0%, siendoq que no identifica ninguna de las 1,094 canciones populares, y un Balanced Accuracy de 0.500 indicando que el modelo no supera el desempeño de un clasificador aleatorio, donde siempre predecir la clase mayoritaria, ignorando completamente la clase minoritaria, fracasando en manejar desbalance de clases.</p>
<p>Por ello, Ridge Classifier ocupa una posición baja en la comparación general. No proporciona valor predictivo para identificar canciones populares, ni logra capturar los patrones entre características técnicas y popularidad.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline </span>
<span class="n">pipe_lasso</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_lasso</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_lasso</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                             <span class="s2">&quot;Lasso Regression&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de resultados&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Verificar la forma de y_pred_proba y manejarla adecuadamente</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># CORRECCIÓN: Curva ROC con manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes modelo Lasso </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso (Coeficientes)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de resultados&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetro óptimo:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Contar características con coeficiente cero</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Características con coeficiente cero: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Porcentaje de características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>

    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso Regression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso Regression se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hiperparámetro C óptimo: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Penalización L1 ayuda a evitar overfitting y selecciona características importantes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 6 candidates, totalling 30 fits
Tiempo de entrenamiento: 479.31s
Mejores parámetros: {&#39;model__C&#39;: 0.01}
Mejor F1-score (CV): 0.5662
EVALUACIÓN COMPLETA CON evaluate_model

Lasso Regression: acc=0.787, f1=0.565, time=0.92s
AUC (predict_proba): 0.8431
Matriz de resultados:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
2  0.8431      0.9191  
Análisis de resultados
Evaluación detallada:
Accuracy:            0.7867
Balanced Accuracy:   0.7708
AUC:                 0.8431
F1-score (Weighted): 0.5647
F1-score (Macro):    0.5647

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9844
Recall - No Popular:    0.7884
F1 - No Popular:        0.8756
Precision - Popular:    0.1527
Recall - Popular:       0.7532
F1 - Popular:           0.2539

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 17043     4573]
     Popular   [   270      824]

Desglose:
   Verdaderos Negativos: 17043
   Falsos Positivos:     4573
   Falsos Negativos:     270
   Verdaderos Positivos: 824

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.79      0.88     21616
     Popular       0.15      0.75      0.25      1094

    accuracy                           0.79     22710
   macro avg       0.57      0.77      0.56     22710
weighted avg       0.94      0.79      0.85     22710
</pre></div>
</div>
<img alt="_images/e70023f4a8c197a8edd5f090fcdc856f76f34909fbc3d0d9542c1501abd92402.png" src="_images/e70023f4a8c197a8edd5f090fcdc856f76f34909fbc3d0d9542c1501abd92402.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis de resultados

Rendimiento general:
   - Accuracy: 0.787
   - AUC: 0.843 
   - F1-Score: 0.565 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 0.92s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.984 | Recall: 0.788 | F1: 0.876
   - CLASE 1 (Popular): 
        Precision: 0.153 | Recall: 0.753 | F1: 0.254

Hiperparámetro óptimo:
   - C: 0.01


Top 10 características importantes:
                          feature    coef
95           cat__track_genre_pop  2.5602
86         cat__track_genre_metal  2.1763
46       cat__track_genre_electro  2.1023
71         cat__track_genre_indie  2.0621
80         cat__track_genre_k-pop  2.0544
35         cat__track_genre_dance  2.0190
105         cat__track_genre_rock  1.9871
68         cat__track_genre_house  1.9686
17      cat__track_genre_alt-rock  1.8159
18   cat__track_genre_alternative  1.8141

Características con coeficiente cero: 57
Características retenidas: 72
Porcentaje de características eliminadas: 44.2%
Resumen:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Logistic Regression (Optimized)
   F1-Score: 0.5647
   Accuracy: 0.7867
   AUC:      0.8431

Lasso Regression se encuentra en la posición #3 de 3 modelos

Lasso:
   - Regularización L1 (Lasso) para selección de características
   - Características eliminadas: 57 de 129 (44.2%)
   - Hiperparámetro C óptimo: 0.01
   - Penalización L1 ayuda a evitar overfitting y selecciona características importantes
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Lasso Regression presenta un F1-Score macro de 0.565 y un AUC-ROC de 0.843, mostrando un desempeño idéntico al modelo de Regresión Logística optimizado. El accuracy de 0.787 mantiene el mismo patrón de desbalance observado en modelos anteriores.</p>
<p>En la matriz de confusión muestra un Recall de 0.75 para la clase Popular, identificando correctamente el 75% de las canciones populares (824 de 1094). También un Precision de 0.15 para la clase Popular, identificando solo el 15% de las predicciones como populares son correctas. Y un Balanced Accuracy de 0.771, indicando un balance razonable entre el desempeño en ambas clases.</p>
<p>Así, Lasso funciona como un filtro de alta sensibilidad como la Regresión Logística, priorizando la captura de canciones populares a costa de una baja precisión.</p>
<p>El análisis de coeficientes muestra que géneros positivamente asociados como Pop, Metal, Electro, K-Pop y Dance. Por lo cual, existe una clara preferencia por géneros contemporáneos y de alta energía en las canciones populares, eso es ventaja para estrategias de producción, como enfocarse en géneros como Pop, K-Pop y Electro aumenta probabilidad de popularidad.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">pipeline_dt</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>  
<span class="p">])</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validación cruzada para análisis de overfitting&quot;</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipeline_dt</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">],</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC (CV):       </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_dt</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipeline_dt</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                          <span class="s2">&quot;Decision Tree&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dt</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:          </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:          </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 0:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:        </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:               </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Matriz de Confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipeline_dt</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Decision Tree&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Decision Tree&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis overfitting:&quot;</span><span class="p">)</span>

<span class="n">train_test_diff_accuracy</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">train_test_diff_f1</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia Accuracy (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia F1-score (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ALTO OVERFITTING - Árbol muy complejo&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Podar el árbol o limitar profundidad máxima&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Overfitting moderado&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Considerar regularización del árbol&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Excelente generalización&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   El árbol está bien balanceado&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Comportamiento esperado para árbol de decisión&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:       </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:       </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:            </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:     </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Acc:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overfitting:    </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Información adicional del árbol</span>
<span class="n">tree_model</span> <span class="o">=</span> <span class="n">pipeline_dt</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información del árbol:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad del árbol: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de hojas: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de características: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">n_features_in_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Decision Tree vs otros modelos</span>
    <span class="n">dt_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Decision Tree&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decision Tree se encuentra en la posición #</span><span class="si">{</span><span class="n">dt_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información sobre Decision Tree</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Info:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ventaja: Fácil de interpretar y visualizar&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Desventaja: Propenso a overfitting sin regularización&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad actual: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hojas: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   POSIBLE OVERFITTING - Considerar poda del árbol&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Validación cruzada para análisis de overfitting
Accuracy (CV):  0.9246 ± 0.0010
F1-score (CV):  0.5875 ± 0.0074
AUC (CV):       0.5909 ± 0.0088
EVALUACIÓN COMPLETA CON evaluate_model

Decision Tree: acc=0.929, f1=0.602, time=9.39s
AUC (predict_proba): 0.6043
Matriz resultante.
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                    Decision Tree    0.9287     0.9270  0.9287    0.6021   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
2  0.8431      0.9191  
3  0.6043      9.3873  
Análisis

Resultados:
Accuracy:          0.9287
Balanced Accuracy: 0.5998
F1-score:          0.6021
F1 Clase 0:        0.9626
F1 Clase 1:        0.2417
AUC:               0.6043

Matriz de confusión
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20833      783]
     Popular   [   836      258]

Desglose:
   Verdaderos Negativos: 20833
   Falsos Positivos:     783
   Falsos Negativos:     836
   Verdaderos Positivos: 258

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.96      0.96      0.96     21616
     Popular       0.25      0.24      0.24      1094

    accuracy                           0.93     22710
   macro avg       0.60      0.60      0.60     22710
weighted avg       0.93      0.93      0.93     22710
</pre></div>
</div>
<img alt="_images/acc3b671c6e9d5b31b95998df0ede83676306aaabb9971f7c7dbff750b685e9c.png" src="_images/acc3b671c6e9d5b31b95998df0ede83676306aaabb9971f7c7dbff750b685e9c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis overfitting:
Diferencia Accuracy (Train-Test): 0.0721
Diferencia F1-score (Train-Test): 0.3944
 Overfitting moderado
   Recomendación: Considerar regularización del árbol
Resumen:
Accuracy:       0.9287
F1-score:       0.6021
AUC:            0.6043
F1 Clase 1:     0.2417
Balanced Acc:   0.5998
Overfitting:    0.0721
Tiempo entrenamiento: 9.39s

Información del árbol:
   - Profundidad del árbol: 80
   - Número de hojas: 4666
   - Número de características: 129
Resumen
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

 Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

Decision Tree se encuentra en la posición #4 de 4 modelos

Info:
   - Ventaja: Fácil de interpretar y visualizar
   - Desventaja: Propenso a overfitting sin regularización
   - Profundidad actual: 80
   - Hojas: 4666
   POSIBLE OVERFITTING - Considerar poda del árbol
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Decision Tree presenta un F1-Score macro de 0.604 y un accuracy de 0.929, mostrando una mejora moderada. Sin embargo, el AUC de 0.606 indica una capacidad discriminativa limitada entre clases.</p>
<p>En la matriz de confusión se muestra un Recall de 0.24 para la clase Popular, donde solo identifica el 24% de las canciones populares (263 de 1094). También un Precision de 0.25 para la clase Popular, indicando una mejora marginal en precisión (25% vs 15% en modelos lineales). Y un F1-Score de 0.96 para No Popular vs 0.25 para Popular. Por lo cual el modelo prioriza la precisión sobre la cobertura, identificando correctamente pocas canciones populares pero con mayor certeza cuando lo hace.</p>
<p>En el análisis overfitting muestra una profundidad excesiva con 80 niveles de memorización de datos, y 4,647 nodos terminales para 90,840 muestras.</p>
<p>Dando así que el modelo es útil para identificar alta certeza de canciones prometedoras pero con una búsqueda exhaustiva de talento, y con menos falsos positivos.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">pipeline_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validación cruzada para análisis de overfitting&quot;</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipeline_rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">],</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC (CV):       </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_rf</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipeline_rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                          <span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:          </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:          </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 0:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:        </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:               </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># GRÁFICAS </span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Matriz de Confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipeline_rf</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis overfitting&quot;</span><span class="p">)</span>

<span class="n">train_test_diff_accuracy</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">train_test_diff_f1</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia Accuracy (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia F1-score (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ALTO OVERFITTING - Random Forest muy complejo&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Reducir número de árboles o aumentar min_samples_split&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Overfitting moderado&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Considerar regularización de hiperparámetros&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Excelente generalización&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   El Random Forest está bien balanceado&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Comportamiento esperado para Random Forest&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:       </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:       </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:            </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:     </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Acc:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overfitting:    </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Información adicional del Random Forest</span>
<span class="n">rf_model</span> <span class="o">=</span> <span class="n">pipeline_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Info:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de árboles: </span><span class="si">{</span><span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de características: </span><span class="si">{</span><span class="n">rf_model</span><span class="o">.</span><span class="n">n_features_in_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad máxima promedio: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compaación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (mejor métrica para problemas desbalanceados)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Random Forest se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ventaja: Menos propenso a overfitting que árboles individuales&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Robustez: Maneja bien características correlacionadas&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Árboles: </span><span class="si">{</span><span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2"> árboles en el ensemble&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad promedio: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    POSIBLE OVERFITTING - Considerar ajustar hiperparámetros&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Validación cruzada para análisis de overfitting
Accuracy (CV):  0.9505 ± 0.0002
F1-score (CV):  0.5391 ± 0.0030
AUC (CV):       0.8887 ± 0.0063
EVALUACIÓN COMPLETA CON evaluate_model

Random Forest: acc=0.952, f1=0.555, time=11.62s
AUC (predict_proba): 0.9015
Matriz resultante
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                    Random Forest    0.9517     0.9330  0.9517    0.5547   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
2  0.8431      0.9191  
3  0.6043      9.3873  
4  0.9015     11.6153  
Análisis:

Resultados:
Accuracy:          0.9517
Balanced Accuracy: 0.5368
F1-score:          0.5547
F1 Clase 0:        0.9752
F1 Clase 1:        0.1343
AUC:               0.9015

Matriz de confusión
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21529       87]
     Popular   [  1009       85]

Desglose:
   Verdaderos Negativos: 21529
   Falsos Positivos:     87
   Falsos Negativos:     1009
   Verdaderos Positivos: 85

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.96      1.00      0.98     21616
     Popular       0.49      0.08      0.13      1094

    accuracy                           0.95     22710
   macro avg       0.72      0.54      0.55     22710
weighted avg       0.93      0.95      0.93     22710
</pre></div>
</div>
<img alt="_images/8b42bb5ea5233fd46658449ee2eee0c1061bb941a9ada9accfa673c65c6a2ebd.png" src="_images/8b42bb5ea5233fd46658449ee2eee0c1061bb941a9ada9accfa673c65c6a2ebd.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis overfitting
Diferencia Accuracy (Train-Test): 0.0462
Diferencia F1-score (Train-Test): 0.4427
 Comportamiento esperado para Random Forest
Resumen final
Accuracy:       0.9517
F1-score:       0.5547
AUC:            0.9015
F1 Clase 1:     0.1343
Balanced Acc:   0.5368
Overfitting:    0.0462
Tiempo entrenamiento: 11.62s

Info:
   - Número de árboles: 100
   - Número de características: 129
   - Profundidad máxima promedio: 72.7
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
Compaación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

 Random Forest se encuentra en la posición #5 de 5 modelos

Información:
   - Ventaja: Menos propenso a overfitting que árboles individuales
   - Robustez: Maneja bien características correlacionadas
   - Árboles: 100 árboles en el ensemble
   - Profundidad promedio: 72.7
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Random Forest presenta un F1-Score macro de 0.551 y un AUC-ROC de 0.902, mostrando una capacidad discriminativa excelente pero un desempeño balanceado moderado. El accuracy de 0.951 refleja el sesgo hacia la clase mayoritaria.</p>
<p>En la matriz de confusión muestra un Recall de 0.07 para la clase Popular, identificando solo el 7% de las canciones populares (81 de 1094). También un Precision de 0.47 para la clase Popular, identificando una alta precisión relativa con 47% de aciertos cuando predice “popular”. Y tiene un excelente desempeño en clase mayoritaria, teniendo un F1-Score de 0.97 para No Popular vs 0.13 para Popular.</p>
<p>Por lo cual, el modelo Random Forest actúa como un filtro conservador que solo predice como populares aquellas canciones con características muy definidas, generando muy pocos falsos positivos pero omitiendo la gran mayoría de canciones populares reales.</p>
<p>Tiene fortalezas como un AUC bueno de 0.902, que indica excelente capacidad de distinguir entre clases, solo una diferencia Train-Test de solo 0.046 en accuracy, y una alta precisión para clase minoritaria, con 47% cuando se atreve a predecir “popular”</p>
<p>Todo esto es útil para identificar súper-éxitos con alta certeza, pero solo en contextos de muy bajo riesgo como descubrimiento musical.</p>
<p><strong>XGBOOST junto con interpretabilidad LIME</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime.lime_tabular</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline </span>
<span class="n">pipe_xgb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="s2">&quot;model__max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="s2">&quot;model__learning_rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
    <span class="s2">&quot;model__subsample&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_xgb</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_xgb</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                           <span class="s2">&quot;XGBoost&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># probabilidades de clase positiva correctamente</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretabilidad con LIME - XGBOOST&quot;</span><span class="p">)</span>

<span class="n">X_train_processed</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Explainer de LIME</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">lime</span><span class="o">.</span><span class="n">lime_tabular</span><span class="o">.</span><span class="n">LimeTabularExplainer</span><span class="p">(</span>
    <span class="n">training_data</span><span class="o">=</span><span class="n">X_train_processed</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Función de predicción para LIME</span>
<span class="n">predict_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_lime_explanation</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">probability</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="c1"># Gráfico de barras de la explicación</span>
    <span class="n">exp_as_list</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exp_as_list</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exp_as_list</span><span class="p">]</span>
    
    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">]</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Influencia en la predicción&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s1">Probabilidad: </span><span class="si">{</span><span class="n">probability</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Valores de probabilidad</span>
    <span class="n">prob_values</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">predict_proba</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">prob_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probabilidad&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Probabilidades de Predicción&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prob_values</span><span class="p">):</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predicciones con LIME - Casos de ejemplo:&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Predicción correcta de clase Popular</span>
    <span class="n">popular_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">popular_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">popular_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sample_prob</span> <span class="o">=</span> <span class="n">y_pred_proba_pos</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>  
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. CASO DE ÉXITO: Canción Popular correctamente clasificada&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Probabilidad de ser popular: </span><span class="si">{</span><span class="n">sample_prob</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">exp</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
            <span class="n">X_test_processed</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span> 
            <span class="n">predict_fn</span><span class="p">,</span> 
            <span class="n">num_features</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        
        <span class="n">plot_lime_explanation</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;Caso Popular - Explicación LIME&#39;</span><span class="p">,</span> <span class="n">sample_prob</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Explicación con características más influyentes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">as_list</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Predicción correcta de clase No Popular</span>
    <span class="n">not_popular_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_popular_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">not_popular_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sample_prob</span> <span class="o">=</span> <span class="n">y_pred_proba_pos</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>  
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. CASO DE ÉXITO: Canción No Popular correctamente clasificada&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Probabilidad de ser popular: </span><span class="si">{</span><span class="n">sample_prob</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">exp</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
            <span class="n">X_test_processed</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span> 
            <span class="n">predict_fn</span><span class="p">,</span> 
            <span class="n">num_features</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        
        <span class="n">plot_lime_explanation</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;Caso No Popular - Explicación LIME&#39;</span><span class="p">,</span> <span class="n">sample_prob</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Explicación con características más influyentes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">as_list</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay probabilidades disponibles para análisis LIME&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis final:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>

    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo de entrenamiento: 81.14s
Mejores parámetros: {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 200, &#39;model__subsample&#39;: 0.8}
Mejor F1-score (CV): 0.5252
EVALUACIÓN COMPLETA CON evaluate_model

XGBoost: acc=0.953, f1=0.522, time=2.71s
AUC (predict_proba): 0.8791
Matriz resultante:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                    Random Forest    0.9517     0.9330  0.9517    0.5547   
5                          XGBoost    0.9525     0.9376  0.9525    0.5224   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
2  0.8431      0.9191  
3  0.6043      9.3873  
4  0.9015     11.6153  
5  0.8791      2.7068  
Análisis:
Evaluación detallada:
Accuracy:            0.9525
Balanced Accuracy:   0.5177
AUC:                 0.8791
F1-score (Weighted): 0.5224
F1-score (Macro):    0.5224

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21592       24]
     Popular   [  1054       40]

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.95      1.00      0.98     21616
     Popular       0.62      0.04      0.07      1094

    accuracy                           0.95     22710
   macro avg       0.79      0.52      0.52     22710
weighted avg       0.94      0.95      0.93     22710
</pre></div>
</div>
<img alt="_images/71ad8d31946379033fb01472343baffc7f9fc376db19a117fd89e5d20db02104.png" src="_images/71ad8d31946379033fb01472343baffc7f9fc376db19a117fd89e5d20db02104.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Interpretabilidad con LIME - XGBOOST
Predicciones con LIME - Casos de ejemplo:
No hay probabilidades disponibles para análisis LIME
Análisis final:

Rendimiento general:
   - Accuracy: 0.953
   - AUC: 0.879 
   - F1-Score: 0.522 
   - Balanced Accuracy: 0.518 
   - Tiempo entrenamiento: 2.71s

Hiperparámetros óptimos:
   - {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 200, &#39;model__subsample&#39;: 0.8}


Top 10 características importantes:
                        feature  importance
95         cat__track_genre_pop      0.0501
35       cat__track_genre_dance      0.0425
68       cat__track_genre_house      0.0367
46     cat__track_genre_electro      0.0348
80       cat__track_genre_k-pop      0.0325
105       cat__track_genre_rock      0.0311
45         cat__track_genre_edm      0.0271
83      cat__track_genre_latino      0.0236
86       cat__track_genre_metal      0.0194
104  cat__track_genre_reggaeton      0.0180
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Decision Tree
   F1-Score: 0.6021
</pre></div>
</div>
</div>
</div>
<p>Analizando el desemp0eño del modelo XGBoost muestra un F1-Score macro de 0.522 y un AUC-ROC de 0.879, dando una capacidad discriminativa muy buena pero un desempeño balanceado moderado. El accuracy de 0.953 refleja el patrón típico de sesgo hacia la clase mayoritaria en problemas desbalanceados.</p>
<p>En la matriz de confusión se muestra un Recall de 0.04 para la clase Popular, identificando solo el 4% de las canciones populares (40 de 1094). También un precision de 0.62 para la clase Popular, siendo una muy alta precisión con 62% de aciertos cuando predice “popular”, y solo 24 falsos positivos.</p>
<p>Así, el modelo XGBoost funciona como un filtro de tipo élite que identifica con alta certeza un pequeño subconjunto de canciones populares.</p>
<p>En el ranking de características se ven los géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con un 0.0501, un género dominante en popularidad</p></li>
<li><p>Dance con un 0.0425 como éxito comercial</p></li>
<li><p>House con un 0.0367, un género electrónico con amplia aceptación</p></li>
<li><p>Electro con un 0.0348, un tipo de música electrónica contemporánea</p></li>
<li><p>K-Pop con un 0.0325, siendo un fenómeno global emergente</p></li>
</ul>
<p>En la sección de Interpretabilidad con LIME se presentan dos casos. El primero es en la Canción Popular Correctamente Clasificada, que tiene una probabilidad de un 58.1% de ser popular, identificandose el género electro como factor positivo clave. En los factores negativos hay una ausencia de géneros alternativos como el indie, rock o pop, dando un Insight que asocia el éxito con géneros electrónicos.</p>
<p>Y el segundo caso es la Canción No Popular Correctamente Clasificada, con una probabilidad del 15.1% de ser popular. No pertenecer a pop, indie, alternative, etc.</p>
<p>Las ventajas del análisis con LIME es que el entendimiento va caso por caso, identificando de características determinantes e importancia de cada género musical. Así, las disqueras pueden usar estas explicaciones para entender por qué ciertas canciones son clasificadas como potencialmente populares.</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">resample</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño original - Train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Reducimos tamaño en train</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12000</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conjunto de entrenamiento grande (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras). Aplicando submuestra ESTRATIFICADA...&quot;</span><span class="p">)</span>
    <span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">12000</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train reducido a: </span><span class="si">{</span><span class="n">X_train_balanced</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución final en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline para SVM</span>
<span class="n">pipe_svm</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;model__kernel&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">],</span>
    <span class="s2">&quot;model__gamma&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_svm</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="c1"># Usar función evaluate_model (la tuya)</span>
<span class="n">result_svm</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                           <span class="s2">&quot;SVM&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_svm</span><span class="p">)</span>

<span class="c1"># DataFrame resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Métricas adicionales</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="c1"># FIGURAS</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># ------------------ CURVA ROC ------------------</span>
<span class="c1"># CORRECCIÓN: Usar y_pred_proba_pos en lugar de y_pred_proba[:, 1]</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aleatorio&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC - SVM&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Tasa de Falsos Positivos&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Tasa de Verdaderos Positivos&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">&quot;No hay probabilidades</span><span class="se">\n</span><span class="s2">para calcular ROC&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC - No disponible&quot;</span><span class="p">)</span>

<span class="c1"># ------------------ MATRIZ DE CONFUSIÓN ------------------</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión - SVM&quot;</span><span class="p">)</span>

<span class="c1"># ------------------ PERMUTATION IMPORTANCE ------------------</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculando Permutation Importance (puede tardar unos segundos)...&quot;</span><span class="p">)</span>

<span class="n">result_pi</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span>
    <span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">result_pi</span><span class="o">.</span><span class="n">importances_mean</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">15</span><span class="p">]</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)[</span><span class="n">sorted_idx</span><span class="p">],</span> <span class="n">result_pi</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Importancia de Características</span><span class="se">\n</span><span class="s2">(Permutation Importance)&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Impacto en F1-Macro&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># ------------------ MÉTRICAS POR CLASE ------------------</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Métricas por Clase - SVM&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span><span class="s1">&#39;F1&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Análisis detallado de resultados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANÁLISIS DETALLADO - SVM&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - F1-Score (Weighted): </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Métricas por clase:</span>
<span class="s2">   - CLASE 0 (No Popular):</span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        Recall:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        F1-Score:  </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular):</span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        Recall:    </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        F1-Score:  </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Kernel: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Gamma: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Tiempos:</span>
<span class="s2">   - Búsqueda de hiperparámetros: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   - Entrenamiento final: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión en texto</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># Comparación con otros modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPARACIÓN CON OTROS MODELOS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    
    <span class="n">svm_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SVM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SVM se encuentra en la posición #</span><span class="si">{</span><span class="n">svm_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño original - Train: (90840, 15), Test: (22710, 15)
Conjunto de entrenamiento grande (90840 muestras). Aplicando submuestra ESTRATIFICADA...
Train reducido a: (12000, 15)
Distribución final en entrenamiento:
   Clase 0 (No Popular): 11422 muestras (95.2%)
   Clase 1 (Popular):    578 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 6 candidates, totalling 30 fits
Tiempo de entrenamiento: 1057.52s
Mejores parámetros: {&#39;model__C&#39;: 10, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;}
Mejor F1-score (CV): 0.6168
EVALUACIÓN COMPLETA CON evaluate_model

SVM: acc=0.883, f1=0.600, time=34.67s
AUC (predict_proba): 0.7936
Matriz resultante:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                    Random Forest    0.9517     0.9330  0.9517    0.5547   
5                          XGBoost    0.9525     0.9376  0.9525    0.5224   
6                              SVM    0.8835     0.9316  0.8835    0.5996   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
2  0.8431      0.9191  
3  0.6043      9.3873  
4  0.9015     11.6153  
5  0.8791      2.7068  
6  0.7936     34.6723  

Calculando Permutation Importance (puede tardar unos segundos)...
</pre></div>
</div>
<img alt="_images/d74e3d0603bffcdc3bd14d685f1184d4e8a6030b390a6427b483a3d10d3eac66.png" src="_images/d74e3d0603bffcdc3bd14d685f1184d4e8a6030b390a6427b483a3d10d3eac66.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
ANÁLISIS DETALLADO - SVM
============================================================

Rendimiento general:
   - Accuracy: 0.8835
   - Balanced Accuracy: 0.6685
   - AUC: 0.7936
   - F1-Score (Macro): 0.5996
   - F1-Score (Weighted): 0.5996

Métricas por clase:
   - CLASE 0 (No Popular):
        Precision: 0.9692
        Recall:    0.9064
        F1-Score:  0.9367
   - CLASE 1 (Popular):
        Precision: 0.1889
        Recall:    0.4305
        F1-Score:  0.2625

Hiperparámetros óptimos:
   - C: 10
   - Kernel: rbf
   - Gamma: scale
   - Class weight: balanced

Tiempos:
   - Búsqueda de hiperparámetros: 1057.52s
   - Entrenamiento final: 34.67s


Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19593     2023]
     Popular   [   623      471]

Desglose:
   Verdaderos Negativos: 19593
   Falsos Positivos:     2023
   Falsos Negativos:     623
   Verdaderos Positivos: 471

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.91      0.94     21616
     Popular       0.19      0.43      0.26      1094

    accuracy                           0.88     22710
   macro avg       0.58      0.67      0.60     22710
weighted avg       0.93      0.88      0.90     22710


============================================================
COMPARACIÓN CON OTROS MODELOS
============================================================
                             Model  Accuracy  Precision  Recall  F1-Score  \
3                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
6                              SVM    0.8835     0.9316  0.8835    0.5996   
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Random Forest    0.9517     0.9330  0.9517    0.5547   
5                          XGBoost    0.9525     0.9376  0.9525    0.5224   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   

      AUC  Train_Time  
3  0.6043      9.3873  
6  0.7936     34.6723  
0  0.8431      0.9011  
2  0.8431      0.9191  
4  0.9015     11.6153  
5  0.8791      2.7068  
1  0.7255      0.5779  

SVM se encuentra en la posición #7 de 7 modelos
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo SVM presenta un F1-Score macro de 0.600 y un AUC-ROC de 0.794, mostrando un balanceado competitivo. El accuracy de 0.884 da un mejor equilibrio entre clases a pesar del desbalance.</p>
<p>En la matriz de confusión muestra un Recall de 0.43 para la clase Popular, identificando el 43% de canciones populares (471 de 1094). También un Precision de 0.19 para la clase Popular, identificando un 19% de aciertos cuando predice “popular”. Y un Balanced Accuracy de 0.669, siendo ell más alto entre todos los modelos que hemos evaluado.</p>
<p>Así, el modelo da un filtro equilibrado con mejor desempeño en identificar canciones populares y mantener una precisión razonable. Teniendo este alto recall asegura no omitir canciones prometedoras ya que el modelo identifica 471 canciones populares reales vs solo 40 a 81 en otros modelos, representando una cobertura 5-10 veces mayor del mercado potencial.</p>
<p>Para disqueras, identificar 471 representa una diferencia operativa significativa pues les dan opciones más recomendables para estrategias de descubrimiento y producción musical basadas en datos.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="balanceo-de-clases">
<h1>Balanceo de Clases<a class="headerlink" href="#balanceo-de-clases" title="Permalink to this heading">#</a></h1>
<p>Volvemos a preparar cada modelos con una configuración inicial apta para <strong>SMOTE</strong>:</p>
<p><strong>Naive Bayes</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">RocCurveDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> 
    <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">pipeline_nb</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="c1"># Optimización con GridSearchCV </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> 
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hiperparámetros&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Combinaciones: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> × </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> × </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">pipeline_nb</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">True</span>  
<span class="p">)</span>

<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parámetros óptimos:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>
<span class="n">result_nb_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                <span class="s2">&quot;Naive Bayes con SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_nb_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis con SMOTE:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 1D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 2D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_pred_proba es None&quot;</span><span class="p">)</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># CORRECCIÓN: Curva ROC con manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Resumen de métricas globales</span>
<span class="n">metrics_summary</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> 
    <span class="n">balanced_acc</span><span class="p">,</span> 
    <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">metrics_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Balanced</span><span class="se">\n</span><span class="s1">Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score</span><span class="se">\n</span><span class="s1">(Macro)&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span>

<span class="n">bars</span> <span class="o">=</span> <span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics_labels</span><span class="p">,</span> <span class="n">metrics_summary</span><span class="p">,</span> 
              <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#FF6B6B&#39;</span><span class="p">,</span> <span class="s1">&#39;#4ECDC4&#39;</span><span class="p">,</span> <span class="s1">&#39;#45B7D1&#39;</span><span class="p">,</span> <span class="s1">&#39;#96CEB4&#39;</span><span class="p">],</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Globales - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">metrics_summary</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis con SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - var_smoothing: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>

    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Naive Bayes con SMOTE vs otros modelos</span>
    <span class="n">nb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Naive Bayes con SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Naive Bayes con SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">nb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Naive Bayes con SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ventaja: Simple, rápido y con SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Estrategia SMOTE: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - k_neighbors SMOTE: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - var_smoothing: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Hiperparámetros
   Combinaciones: 15 × 4 × 3 = 180
Fitting 5 folds for each of 180 candidates, totalling 900 fits

Parámetros óptimos:
   model__var_smoothing: 1e-06
   smote__k_neighbors: 5
   smote__sampling_strategy: auto
Mejor F1-score (CV): 0.4624
EVALUACIÓN COMPLETA CON evaluate_model

Naive Bayes con SMOTE: acc=0.614, f1=0.469, time=2.18s
AUC (predict_proba): 0.7842
Matriz resultante
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                    Random Forest    0.9517     0.9330  0.9517    0.5547   
5                          XGBoost    0.9525     0.9376  0.9525    0.5224   
6                              SVM    0.8835     0.9316  0.8835    0.5996   
7            Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8            Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   

      AUC  Train_Time  
0  0.8431      0.9011  
1  0.7255      0.5779  
2  0.8431      0.9191  
3  0.6043      9.3873  
4  0.9015     11.6153  
5  0.8791      2.7068  
6  0.7936     34.6723  
7  0.7842      1.5429  
8  0.7842      2.1784  
Análisis con SMOTE:
Forma de y_pred_proba: 1D - (22710,)
Evaluación detallada:
Accuracy:            0.6140
Balanced Accuracy:   0.7708
AUC:                 0.7842
F1-score (Weighted): 0.4687
F1-score (Macro):    0.4687

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9953
Recall - No Popular:    0.5973
F1 - No Popular:        0.7466
Precision - Popular:    0.1061
Recall - Popular:       0.9442
F1 - Popular:           0.1907

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 12912     8704]
     Popular   [    61     1033]

Desglose:
   Verdaderos Negativos: 12912
   Falsos Positivos:     8704
   Falsos Negativos:     61
   Verdaderos Positivos: 1033

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       1.00      0.60      0.75     21616
     Popular       0.11      0.94      0.19      1094

    accuracy                           0.61     22710
   macro avg       0.55      0.77      0.47     22710
weighted avg       0.95      0.61      0.72     22710
</pre></div>
</div>
<img alt="_images/f91cce56cf04496aa8f4d2c302130984981ed98f437a5a69385c13930f47a17d.png" src="_images/f91cce56cf04496aa8f4d2c302130984981ed98f437a5a69385c13930f47a17d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis con SMOTE

Rendimiento general:
   - Accuracy: 0.614
   - AUC: 0.784 
   - F1-Score (Macro): 0.469 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 2.18s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.995 | Recall: 0.597 | F1: 0.747
   - CLASE 1 (Popular): 
        Precision: 0.106 | Recall: 0.944 | F1: 0.191

Hiperparámetros óptimos SMOTE:
   - Sampling strategy: auto
   - k_neighbors: 5
   - var_smoothing: 1.00e-06

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

Naive Bayes con SMOTE se encuentra en la posición #8 de 9 modelos

Información:
   - Ventaja: Simple, rápido y con SMOTE para balancear clases
   - Estrategia SMOTE: auto
   - k_neighbors SMOTE: 5
   - var_smoothing: 1.00e-06
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Naive Bayes con SMOTE presenta un F1-Score macro de 0.469, mostrando una mejora limitada respecto al Naive Bayes original que tiene un F1- Score de 0.395. Sin embargo, el balanceo produce cambios dramáticos en la distribución del desempeño por clases.</p>
<p>SMOTE genera un cambio completo en el perfil predictivo pues ahora tiene un Recall de 0.944 para la clase Popular identificando el 94.4% de canciones populares (1033 de 1094). También un Precision de 0.106 para la clase Popular, identificando solo 10.6% de aciertos cuando predice “popular”. Y un Balanced Accuracy de 0.771, siendo una mejora significativa vs el 0.500 del modelo original</p>
<p>Por lo cual, SMOTE convierte a Naive Bayes en un filtro de cobertura casi total pues captura prácticamente todas las canciones populares, pero da un aumento masivo de falsos positivos (8,692).</p>
<p>En el análisis del Trade-off SMOTE se ve que un 94% de recall para clase minoritaria vs 98% en original, una ligera reducción. En Precision Popular cambia de 8.5% a 10.6%, dando una mejora marginal, un F1-Score de 0.395 a 0.469, mejora del 19%, y un Balanced Accuracy de 0.500 a 0.771.</p>
<p>Por ello, en el contexto musical es ideal para no omitir ninguna canción potencialmente popular, pero requiere evaluación humana masiva posterior y no resuelve las limitaciones para capturar patrones complejos en datos de popularidad musical.</p>
<p><strong>Regresión Logística</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">recall_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline para Logistic Regression CON SMOTE</span>
<span class="n">pipe_logreg_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span>  
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
    <span class="s2">&quot;model__penalty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">],</span>
    <span class="s2">&quot;smote__sampling_strategy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s2">&quot;smote__k_neighbors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_logreg_smote</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_logreg_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="s2">&quot;Logistic Regression SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_logreg_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultanto&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LOGISTIC REGRESSION SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 1D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 2D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_pred_proba es None&quot;</span><span class="p">)</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># CORRECCIÓN: Curva ROC con manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Logistic Regression SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Logistic Regression SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Logistic Regression SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Logistic Regression SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis con SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Penalty: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Logistic Regression SMOTE vs otros modelos</span>
    <span class="n">logreg_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Logistic Regression SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Logistic Regression SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">logreg_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Logistic Regression SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - k_neighbors SMOTE: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Penalty: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 72 candidates, totalling 360 fits
Tiempo de entrenamiento: 1485.21s
Mejores parámetros: {&#39;model__C&#39;: 0.01, &#39;model__penalty&#39;: &#39;l1&#39;, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-score (CV): 0.6094
EVALUACIÓN COMPLETA CON evaluate_model

Logistic Regression SMOTE: acc=0.861, f1=0.603, time=2.82s
AUC (predict_proba): 0.8432
Matriz resultanto
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
Análisis LOGISTIC REGRESSION SMOTE
Forma de y_pred_proba: 1D - (22710,)
Evaluación detallada:
Accuracy:            0.8610
Balanced Accuracy:   0.7231
AUC:                 0.8432
F1-score (Weighted): 0.6032
F1-score (Macro):    0.6032

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9758
Recall - No Popular:    0.8757
F1 - No Popular:        0.9231
Precision - Popular:    0.1885
Recall - Popular:       0.5704
F1 - Popular:           0.2834

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18930     2686]
     Popular   [   470      624]

Desglose:
   Verdaderos Negativos: 18930
   Falsos Positivos:     2686
   Falsos Negativos:     470
   Verdaderos Positivos: 624

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.88      0.92     21616
     Popular       0.19      0.57      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.72      0.60     22710
weighted avg       0.94      0.86      0.89     22710
</pre></div>
</div>
<img alt="_images/6f1361c5f1a1b75e6d00ae4c01dadae78ac555690c5a8c0cf89c8aa18c85c787.png" src="_images/6f1361c5f1a1b75e6d00ae4c01dadae78ac555690c5a8c0cf89c8aa18c85c787.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis con SMOTE

Rendimiento general:
   - Accuracy: 0.861
   - AUC: 0.843 
   - F1-Score (Macro): 0.603 
   - Balanced Accuracy: 0.723 
   - Tiempo entrenamiento: 2.82s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.876 | F1: 0.923
   - CLASE 1 (Popular): 
        Precision: 0.189 | Recall: 0.570 | F1: 0.283

Hiperparámetros óptimos SMOTE:
   - Sampling strategy: 0.5
   - k_neighbors: 5
   - C: 0.01
   - Penalty: l1


Top 10 características importantes:
                       feature    coef
95        cat__track_genre_pop  3.1531
86      cat__track_genre_metal  2.6879
46    cat__track_genre_electro  2.5570
80      cat__track_genre_k-pop  2.4859
35      cat__track_genre_dance  2.4806
68      cat__track_genre_house  2.4368
105      cat__track_genre_rock  2.3726
71      cat__track_genre_indie  2.3581
17   cat__track_genre_alt-rock  2.1737
45        cat__track_genre_edm  2.1646
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Logistic Regression SMOTE
   F1-Score: 0.6032
   Accuracy: 0.8610
   AUC:      0.8432

Logistic Regression SMOTE se encuentra en la posición #10 de 11 modelos

Información:
   - SMOTE para balancear clases
   - Sampling strategy: 0.5
   - k_neighbors SMOTE: 5
   - Penalty: l1
   - Regularización C: 0.01
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Logistic Regression con SMOTE presenta un F1-Score macro de 0.604 y un AUC-ROC de 0.845, mostrando una mejora respecto a la versión sin SMOTE que tiene un F1-Score de 0.565. Esta mejora muestra una buena capacidad discriminativa base.</p>
<p>SMOTE produce un cambio estratégico fundamental en el comportamiento del modelo mostrando un Recall de 0.58 para la clase Popular, identificando el 58% de canciones populares (634 de 1094) vs 75% en original. También, un Precision de 0.19 para la clase Popular, siendo un 19% de aciertos vs 15% en original. Y un Balanced Accuracy de 0.727 vs 0.771 en original.</p>
<p>Así, SMOTE convierte a Logistic Regression en un filtro más equilibrado que sacrifica algo de recall para ganar en precision y balanced accuracy. Hay una reducción de falsos positivos de 2,707 vs 4,573 del original.</p>
<p>El análisis de coeficientes muestra cambios en los géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con un 3.13, mantiene el dominio</p></li>
<li><p>Metal con un 2.69, aumenta su importancia</p></li>
<li><p>Electro con un 2.52, misma posición</p></li>
<li><p>House con un 2.47, cambia</p></li>
<li><p>Dance con un 2.44, misma posición</p></li>
</ul>
<p>Por ello, Logistic Regression con SMOTE optimiza el balance entre capacidad predictiva y utilidad práctica, produciendo modelos que ofrecen el mejor equilibrio entre cobertura y eficiencia operativa para estrategias de producción musical.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># ==============================</span>
<span class="c1"># Definición de características</span>
<span class="c1"># ==============================</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># =============================</span>
<span class="c1"># Variable objetivo</span>
<span class="c1"># =============================</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># =============================</span>
<span class="c1"># Preprocesadores</span>
<span class="c1"># =============================</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># =============================</span>
<span class="c1"># Pipeline con SMOTE + Ridge</span>
<span class="c1"># =============================</span>
<span class="n">pipeline_ridge_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># =============================</span>
<span class="c1"># Parámetros para GridSearch</span>
<span class="c1"># =============================</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda GridSearchCV...&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_ridge_smote</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-Macro CV: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># =============================</span>
<span class="c1"># MODELO FINAL CALIBRADO</span>
<span class="c1"># =============================</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calibrando modelo para obtener probabilidades...&quot;</span><span class="p">)</span>

<span class="n">best_pipeline</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># Extraemos el preprocesador + smote + ridge</span>
<span class="n">ridge_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">,</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
<span class="p">])</span>

<span class="n">ridge_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Calibrar con método sigmoide</span>
<span class="n">calibrated_model</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">ridge_model</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)</span>
<span class="n">calibrated_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># =============================</span>
<span class="c1"># EVALUACIÓN</span>
<span class="c1"># =============================</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">calibrated_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">calibrated_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
<span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RESULTADOS RIDGE + SMOTE + CALIBRACIÓN&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Macro: </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># =============================</span>
<span class="c1"># MATRIZ DE CONFUSIÓN</span>
<span class="c1"># =============================</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="c1"># =============================</span>
<span class="c1"># GRÁFICOS</span>
<span class="c1"># =============================</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># --- Curva ROC ---</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC = </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC - Ridge Calibrado&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># --- Matriz de confusión ---</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">calibrated_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión - Ridge SMOTE&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># =============================</span>
<span class="c1"># IMPORTANCIA DE CARACTERÍSTICAS (coeficientes) - CORRECCIÓN</span>
<span class="c1"># =============================</span>
<span class="c1"># SOLUCIÓN: Usar ridge_model en lugar de calibrated_model para acceder a los coeficientes</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">ridge_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">ridge_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span>

<span class="c1"># CORRECCIÓN: Manejar diferentes formas de coef</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Si coef es 2D (para problemas multiclase), tomar la primera fila</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Si es 1D, ya está bien</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Si coef es un escalar, convertirlo a array</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coef</span><span class="p">])</span>

<span class="c1"># Asegurarnos de que coef es un array numpy</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s2">&quot;coef&quot;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TOP 10 CARACTERÍSTICAS MÁS IMPORTANTES:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># =============================</span>
<span class="c1"># GRÁFICO DE COEFICIENTES</span>
<span class="c1"># =============================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Ridge con SMOTE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># =============================</span>
<span class="c1"># MÉTRICAS ADICIONALES</span>
<span class="c1"># =============================</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANÁLISIS DETALLADO - RIDGE CON SMOTE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># CORRECCIÓN: Usar len(coef) en lugar de len(coef) que podría ser un escalar</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
<span class="n">n_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">coef</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_zero</span> <span class="o">=</span> <span class="n">n_features</span> <span class="o">-</span> <span class="n">n_nonzero</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Métricas por clase:</span>
<span class="s2">   - CLASE 0 (No Popular):</span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        Recall:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        F1-Score:  </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular):</span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        Recall:    </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">        F1-Score:  </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - Alpha: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Características seleccionadas:</span>
<span class="s2">   - Total de características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características no cero: </span><span class="si">{</span><span class="n">n_nonzero</span><span class="si">}</span>
<span class="s2">   - Características cero: </span><span class="si">{</span><span class="n">n_zero</span><span class="si">}</span>
<span class="s2">   - Porcentaje eliminado: </span><span class="si">{</span><span class="n">n_zero</span><span class="o">/</span><span class="n">n_features</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># =============================</span>
<span class="c1"># COMPARACIÓN CON OTROS MODELOS (si existe results_df)</span>
<span class="c1"># =============================</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Agregar resultados a la lista global</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;Ridge Classifier SMOTE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">),</span>
            <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_macro</span><span class="p">,</span>
            <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
            <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="k">if</span> <span class="s1">&#39;start_time&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">})</span>
        
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
            <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
            <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
            <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">COMPARACIÓN CON OTROS MODELOS:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        
        <span class="c1"># Posición en el ranking</span>
        <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
        
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nota: No se encontró la variable &#39;results&#39; para comparación global&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases entrenamiento:
Clase 0: 86466 | Clase 1: 4374

Búsqueda GridSearchCV...
Fitting 5 folds for each of 30 candidates, totalling 150 fits
Mejores parámetros: {&#39;model__alpha&#39;: 100.0, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-Macro CV: 0.5987

Calibrando modelo para obtener probabilidades...

RESULTADOS RIDGE + SMOTE + CALIBRACIÓN
Accuracy: 0.9493
F1 Macro: 0.5299
AUC:      0.8554

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21505      111]
     Popular   [  1040       54]
</pre></div>
</div>
<img alt="_images/6cb9e00daac1ef78c26b0bff3b380cff43eddf6a9e37fefb921b8bef0f69303c.png" src="_images/6cb9e00daac1ef78c26b0bff3b380cff43eddf6a9e37fefb921b8bef0f69303c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TOP 10 CARACTERÍSTICAS MÁS IMPORTANTES:
                          feature      coef
95           cat__track_genre_pop  0.475410
35         cat__track_genre_dance  0.336888
46       cat__track_genre_electro  0.323175
80         cat__track_genre_k-pop  0.310773
68         cat__track_genre_house  0.293849
86         cat__track_genre_metal  0.289010
105         cat__track_genre_rock  0.267000
71         cat__track_genre_indie  0.241241
45           cat__track_genre_edm  0.214730
18   cat__track_genre_alternative  0.208624
</pre></div>
</div>
<img alt="_images/44715d0196ecd201fda55b8583f8d860a8c3eb96aa81c423e5851d35e70989bb.png" src="_images/44715d0196ecd201fda55b8583f8d860a8c3eb96aa81c423e5851d35e70989bb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
ANÁLISIS DETALLADO - RIDGE CON SMOTE
============================================================

Rendimiento general:
   - Accuracy: 0.9493
   - Balanced Accuracy: 0.5221
   - AUC: 0.8554
   - F1-Score (Macro): 0.5299

Métricas por clase:
   - CLASE 0 (No Popular):
        Precision: 0.9539
        Recall:    0.9949
        F1-Score:  0.9739
   - CLASE 1 (Popular):
        Precision: 0.3273
        Recall:    0.0494
        F1-Score:  0.0858

Hiperparámetros óptimos:
   - Alpha: 100.0
   - Sampling strategy: 0.5
   - k_neighbors: 5

Características seleccionadas:
   - Total de características: 129
   - Características no cero: 129
   - Características cero: 0
   - Porcentaje eliminado: 0.0%


COMPARACIÓN CON OTROS MODELOS:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  

Ridge Classifier SMOTE se encuentra en la posición #12 de 12 modelos
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Ridge Classifier con SMOTE presenta un F1-Score macro de 0.594 y un accuracy de 0.842, mostrando un desempeño competitivo, pero con una limitación es la falta de métrica AUC.</p>
<p>El balanceo produce una mejora respecto al Ridge Classifier original, con un Recall de 0.63 para la clase Popular, identifcando 63% vs 0% en original. También un Precision de 0.18 para la clase Popular, identificando un 18% de aciertos vs 0% en original. Y un F1-Score de 0.594, una mejor del 22% vs 0.488 en original</p>
<p>SMOTE rescata completamente a Ridge Classifier,  transformándolo de un modelo que ignoraba por completo la clase minoritaria a uno con capacidad razonable de detección.</p>
<p>En el análisis de coeficientes se muestran los siguientes géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con un 1.17, dominio</p></li>
<li><p>Metal con un 0.99, ocn alta relevancia</p></li>
<li><p>Electro con un 0.99</p></li>
<li><p>Dance con un 0.98</p></li>
<li><p>K-Pop con un 0.96, fenómeno global</p></li>
</ul>
<p>Ridge Classifier con SMOTE representa una alternativa sólida y eficiente para aplicaciones de la industria musical, se valora la estabilidad predictiva y la eficiencia computacional.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span><span class="p">,</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de parámetros</span>
<span class="n">LASSO_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>  
<span class="n">LASSO_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>  
<span class="n">LASSO_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CONFIGURACIÓN LASSO OPTIMIZADA&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Valores de C: </span><span class="si">{</span><span class="n">LASSO_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vecinos: </span><span class="si">{</span><span class="n">LASSO_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">lasso_smote_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> 
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>  
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda - CORREGIDO: usar f1_macro</span>
<span class="n">lasso_smote_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="n">LASSO_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">LASSO_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">lasso_smote_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lasso_smote_pipeline</span><span class="p">,</span>
    <span class="n">lasso_smote_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_smote</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_C_VALUES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones SMOTE: </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_lasso_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                   <span class="s2">&quot;Lasso SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 1D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 2D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_pred_proba es None&quot;</span><span class="p">)</span>

<span class="c1"># Métricas</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># CORRECCIÓN: Curva ROC con manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes Lasso </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados LASSO SMOTE&quot;</span><span class="p">)</span>
<span class="c1"># Análisis de selección de características Lasso</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_nonzero_coef</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_zero_coef</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Selección de características Lasso:</span>
<span class="s2">   - Características retenidas: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)</span>
<span class="s2">   - Sparsity ratio: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso SMOTE vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - C óptimo: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
CONFIGURACIÓN LASSO OPTIMIZADA
   Valores de C: [0.001, 0.01, 0.1, 1.0]
   Estrategias: [0.5, &#39;auto&#39;]
   Vecinos: [3, 5]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones SMOTE: 16 × 5 folds = 80 modelos
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo de entrenamiento: 393.74s
Mejores parámetros: {&#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-score (CV): 0.6094
EVALUACIÓN COMPLETA CON evaluate_model

Lasso SMOTE: acc=0.861, f1=0.603, time=1.81s
AUC (predict_proba): 0.8432
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
Análisis LASSO SMOTE
Forma de y_pred_proba: 1D - (22710,)
Evaluación detallada:
Accuracy:            0.8610
Balanced Accuracy:   0.7231
AUC:                 0.8432
F1-score (Weighted): 0.6032
F1-score (Macro):    0.6032

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9758
Recall - No Popular:    0.8757
F1 - No Popular:        0.9231
Precision - Popular:    0.1885
Recall - Popular:       0.5704
F1 - Popular:           0.2834

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18930     2686]
     Popular   [   470      624]

Desglose:
   Verdaderos Negativos: 18930
   Falsos Positivos:     2686
   Falsos Negativos:     470
   Verdaderos Positivos: 624

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.88      0.92     21616
     Popular       0.19      0.57      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.72      0.60     22710
weighted avg       0.94      0.86      0.89     22710
</pre></div>
</div>
<img alt="_images/536dd018e88c0dc2387aa313f2e9bfab1ea8a0392dde7332be26a88b915eff59.png" src="_images/536dd018e88c0dc2387aa313f2e9bfab1ea8a0392dde7332be26a88b915eff59.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados LASSO SMOTE

Rendimiento general:
   - Accuracy: 0.861
   - AUC: 0.843 
   - F1-Score (Macro): 0.603 
   - Balanced Accuracy: 0.723 
   - Tiempo entrenamiento: 1.81s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.876 | F1: 0.923
   - CLASE 1 (Popular): 
        Precision: 0.189 | Recall: 0.570 | F1: 0.283

Hiperparámetros óptimos SMOTE:
   - C: 0.01
   - Sampling strategy: 0.5
   - k_neighbors: 5

Selección de características Lasso:
   - Características retenidas: 70 de 129
   - Características eliminadas: 59 (45.7%)
   - Sparsity ratio: 0.543


Top 10 características importantes:
                       feature    coef
95        cat__track_genre_pop  3.1531
86      cat__track_genre_metal  2.6879
46    cat__track_genre_electro  2.5570
80      cat__track_genre_k-pop  2.4859
35      cat__track_genre_dance  2.4806
68      cat__track_genre_house  2.4368
105      cat__track_genre_rock  2.3726
71      cat__track_genre_indie  2.3581
17   cat__track_genre_alt-rock  2.1737
45        cat__track_genre_edm  2.1646
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Logistic Regression SMOTE
   F1-Score: 0.6032
   Accuracy: 0.8610
   AUC:      0.8432

Lasso SMOTE se encuentra en la posición #13 de 14 modelos

Información:
   - Regularización L1 (Lasso) para selección de características
   - SMOTE para balancear clases
   - Características eliminadas: 59 de 129 (45.7%)
   - C óptimo: 0.01
   - Sampling strategy: 0.5
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Lasso Regression con SMOTE presenta un F1-Score macro de 0.604 y un AUC-ROC de 0.845. La combinación de SMOTE con regularización L1 produce un modelo optimizado con un Recall de 0.58 para la clase Popular, identificando un 58% de detección (634 de 1094 canciones). También, un Precision de 0.19 para la clase Popular, identificando un 19% de aciertos en predicciones positivas.</p>
<p>Lasso con SMOTE mantiene el balance predictivo de Logistic Regression mientras optimiza la complejidad del modelo mediante selección de características.</p>
<p>En a efectividad de la regularización L1 hay aracterísticas retenidas con 72 de 129 (55.8%) y un Sparsity ratio de 0.558, siendo un modelo más simple</p>
<p>En los patrones de género confirmados está:</p>
<ul class="simple">
<li><p>Pop con un 3.13, dominio</p></li>
<li><p>Metal con un 2.69, teniendo la segunda posición reforzada</p></li>
<li><p>Electro con un 2.52</p></li>
<li><p>House con un 2.47</p></li>
<li><p>Dance con un 2.44, mainstream confirmado</p></li>
</ul>
<p>Estas ventajas que tiene el modelo ayuda a identificar características verdaderamente importantes, más fácil de implementar y mantener y menos susceptible a overfitting por características irrelevantes, efectivo que identifica claramente los patrones de género asociados al éxito en Spotify.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomizedSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de parámetros para RandomizedSearch</span>
<span class="n">param_dist</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s1">&#39;model__criterion&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
    <span class="s1">&#39;model__max_features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con RandomizedSearchCV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Combinaciones a probar: 50 (de </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">param_dist</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="si">}</span><span class="s2"> posibles)&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">dt_smote_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Búsqueda aleatoria</span>
<span class="n">random_search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span>
    <span class="n">dt_smote_pipeline</span><span class="p">,</span>
    <span class="n">param_dist</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">random_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">random_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_dt_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                <span class="s2">&quot;Decision Tree SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dt_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis DECISION TREE SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 1D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 2D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_pred_proba es None&quot;</span><span class="p">)</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># CORRECCIÓN: Curva ROC con manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Decision Tree SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Decision Tree SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características (Decision Tree)</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancia de características</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Decision Tree SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Decision Tree SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados DECISION TREE SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Criterion: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__criterion&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Max depth: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Min samples split: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Min samples leaf: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Max features: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_features&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de importancia de características</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Decision Tree SMOTE vs otros modelos</span>
    <span class="n">dt_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Decision Tree SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decision Tree SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">dt_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Decision Tree SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Criterion: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__criterion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Max depth: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Min samples split: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Min samples leaf: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Max features: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con RandomizedSearchCV
   Combinaciones a probar: 50 (de 1440 posibles)
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Tiempo de entrenamiento: 223.89s
Mejores parámetros: {&#39;smote__sampling_strategy&#39;: 0.5, &#39;model__min_samples_split&#39;: 5, &#39;model__min_samples_leaf&#39;: 10, &#39;model__max_features&#39;: None, &#39;model__max_depth&#39;: 20, &#39;model__criterion&#39;: &#39;entropy&#39;}
Mejor F1-score (CV): 0.6101
EVALUACIÓN COMPLETA CON evaluate_model

Decision Tree SMOTE: acc=0.923, f1=0.614, time=5.46s
AUC (predict_proba): 0.7156
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
Análisis DECISION TREE SMOTE
Forma de y_pred_proba: 1D - (22710,)
Evaluación detallada:
Accuracy:            0.9233
Balanced Accuracy:   0.6243
AUC:                 0.7156
F1-score (Weighted): 0.6144
F1-score (Macro):    0.6144

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9639
Recall - No Popular:    0.9552
F1 - No Popular:        0.9595
Precision - Popular:    0.2488
Recall - Popular:       0.2934
F1 - Popular:           0.2693

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20647      969]
     Popular   [   773      321]

Desglose:
   Verdaderos Negativos: 20647
   Falsos Positivos:     969
   Falsos Negativos:     773
   Verdaderos Positivos: 321

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.96      0.96      0.96     21616
     Popular       0.25      0.29      0.27      1094

    accuracy                           0.92     22710
   macro avg       0.61      0.62      0.61     22710
weighted avg       0.93      0.92      0.93     22710
</pre></div>
</div>
<img alt="_images/7c9bc4682cf1c88de4d9e0778c6c881770ab96e647ff0f379166129944df33f9.png" src="_images/7c9bc4682cf1c88de4d9e0778c6c881770ab96e647ff0f379166129944df33f9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados DECISION TREE SMOTE

Rendimiento general:
   - Accuracy: 0.923
   - AUC: 0.716 
   - F1-Score (Macro): 0.614 
   - Balanced Accuracy: 0.624 
   - Tiempo entrenamiento: 5.46s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.964 | Recall: 0.955 | F1: 0.960
   - CLASE 1 (Popular): 
        Precision: 0.249 | Recall: 0.293 | F1: 0.269

Hiperparámetros óptimos SMOTE:
   - Sampling strategy: 0.5
   - Criterion: entropy
   - Max depth: 20
   - Min samples split: 5
   - Min samples leaf: 10
   - Max features: None


Top 10 características importantes:
                       feature  importance
8        num__instrumentalness      0.1167
95        cat__track_genre_pop      0.0606
7            num__acousticness      0.0602
2                  num__energy      0.0504
71      cat__track_genre_indie      0.0442
86      cat__track_genre_metal      0.0430
46    cat__track_genre_electro      0.0414
35      cat__track_genre_dance      0.0341
105      cat__track_genre_rock      0.0335
17   cat__track_genre_alt-rock      0.0297
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Decision Tree SMOTE
   F1-Score: 0.6222
   Accuracy: 0.9122
   AUC:      0.7405

Decision Tree SMOTE se encuentra en la posición #15 de 16 modelos

Información:
   - SMOTE para balancear clases
   - Sampling strategy: 0.5
   - Criterion: entropy
   - Max depth: 20
   - Min samples split: 5
   - Min samples leaf: 10
   - Max features: None
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Árbol de decisión con SMOTE presenta un F1-Score macro de 0.620 y un AUC-ROC de 0.735, logrando el mejor desempeño predictivo general entre todos los modelos evaluados.</p>
<p>La combinación de SMOTE con la arquitectura de árbol de decisión produce un modelo equilibrado con un Recall de 0.364 para la clase Popular, identificando un 36.4% de detección (398 de 1094 canciones populares). También, un Precision de 0.235 para la clase Popular, identificando un 23.5% de aciertos en predicciones positivas, representando el punto óptimo entre complejidad y desempeño pues mantiene la capacidad predictiva de modelos más sofisticados mientras ofrece transparencia total en la toma de decisiones.</p>
<p>En el Top 5 características técnicas determinantes están</p>
<ul class="simple">
<li><p>Instrumentalness con un 12.2%, siendo el factor más influyente con canciones de alto contenido instrumental tienden a ser menos populares</p></li>
<li><p>Acousticness con un 6.1%, es decr, el carácter acústico como moderador clave de popularidad</p></li>
<li><p>Género Pop con un 5.7%, mainstream predominante</p></li>
<li><p>Energy con un 5.5%</p></li>
<li><p>Género Metal con un 4.8%</p></li>
</ul>
<p>Con esto, para los productores reducir instrumentalness prioriza las voces sobre los instrumentales, también aplicar melodias ni demasiado acústico ni completamente electrónico, y la energia como base necesaria.</p>
<p>Este modelo combina el mejor desempeño predictivo general con un F1-Score 0.620 con transparencia completa en la toma de decisiones, ofreciendo no solo predicciones precisas sino también reglas claras y accionables para optimizar estrategias de producción musical, y lo convierte en la herramienta ideal para disqueras y artistas que buscan data-driven insights para el éxito en Spotify.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">pipeline_rf_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros</span>
<span class="n">rf_smote_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span>           <span class="c1"># 2 valores (50, 100, 200 → 100, 150)</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>              <span class="c1"># 2 valores (5, 10, 15, None → 10, None)</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>         <span class="c1"># 2 valores</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">],</span>        <span class="c1"># 1 valor (0.5, 0.7, &#39;auto&#39; to &#39;auto&#39;)</span>
    <span class="c1"># Eliminado smote__k_neighbors</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con SMOTE&quot;</span><span class="p">)</span>
<span class="n">rf_smote_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_rf_smote</span><span class="p">,</span>
    <span class="n">rf_smote_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Cálculo de combinaciones OPTIMIZADAS</span>
<span class="n">n_combos_smote</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">])</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">])</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">])</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones SMOTE: </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reducción del 83% respecto a la configuración original (216 → 40 modelos)&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización con SMOTE completada en </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final con SMOTE</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_rf_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                <span class="s2">&quot;Random Forest SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf_smote</span><span class="p">)</span>

<span class="c1"># Actualizar DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RANDOM FOREST SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># CORRECCIÓN: Manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Si es un array 1D, son las probabilidades de la clase positiva</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 1D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Si es 2D, tomar la segunda columna (clase positiva)</span>
        <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forma de y_pred_proba: 2D - </span><span class="si">{</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_pred_proba es None&quot;</span><span class="p">)</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># CORRECCIÓN: Curva ROC con manejo seguro de probabilidades</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Random Forest SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Random Forest&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RANDOM FOREST SMOTE&quot;</span><span class="p">)</span>
<span class="c1"># Información del Random Forest</span>
<span class="n">rf_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_features_in_</span>

<span class="c1"># Contar características importantes (importancia &gt; 0.01)</span>
<span class="n">n_important_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del Random Forest:</span>
<span class="s2">   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span>
<span class="s2">   - Características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span>
<span class="s2">   - SMOTE aplicado: Sí</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest SMOTE vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ensemble de </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2"> árboles&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE sampling: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Búsqueda de hiperparámetros con SMOTE
Combinaciones SMOTE: 8 × 5 folds = 40 modelos
Reducción del 83% respecto a la configuración original (216 → 40 modelos)
Fitting 5 folds for each of 8 candidates, totalling 40 fits
Optimización con SMOTE completada en 654.99s
Mejores parámetros: {&#39;model__max_depth&#39;: None, &#39;model__min_samples_split&#39;: 5, &#39;model__n_estimators&#39;: 100, &#39;smote__sampling_strategy&#39;: &#39;auto&#39;}
Mejor F1-score (CV): 0.6633
EVALUACIÓN COMPLETA CON evaluate_model

Random Forest SMOTE: acc=0.945, f1=0.677, time=22.60s
AUC (predict_proba): 0.8992
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
Análisis RANDOM FOREST SMOTE
Forma de y_pred_proba: 1D - (22710,)
Evaluación detallada:
Accuracy:            0.9454
Balanced Accuracy:   0.6637
AUC:                 0.8992
F1-score (Weighted): 0.6773
F1-score (Macro):    0.6773

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9675
Recall - No Popular:    0.9754
F1 - No Popular:        0.9714
Precision - Popular:    0.4203
Recall - Popular:       0.3519
F1 - Popular:           0.3831

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21085      531]
     Popular   [   709      385]

Desglose:
   Verdaderos Negativos: 21085
   Falsos Positivos:     531
   Falsos Negativos:     709
   Verdaderos Positivos: 385

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.98      0.97     21616
     Popular       0.42      0.35      0.38      1094

    accuracy                           0.95     22710
   macro avg       0.69      0.66      0.68     22710
weighted avg       0.94      0.95      0.94     22710
</pre></div>
</div>
<img alt="_images/2947a02e482a3b9a36e295015d098afbd37a092dec88597a0e28cfe420788b6d.png" src="_images/2947a02e482a3b9a36e295015d098afbd37a092dec88597a0e28cfe420788b6d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RANDOM FOREST SMOTE

Rendimiento general:
   - Accuracy: 0.945
   - AUC: 0.899 
   - F1-Score (Macro): 0.677 
   - Balanced Accuracy: 0.664 
   - Tiempo entrenamiento: 22.60s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.967 | Recall: 0.975 | F1: 0.971
   - CLASE 1 (Popular): 
        Precision: 0.420 | Recall: 0.352 | F1: 0.383

Información del Random Forest:
   - Número de árboles: 100
   - Características: 129
   - Características importantes: 26
   - SMOTE aplicado: Sí

Hiperparámetros óptimos SMOTE:
   - n_estimators: 100
   - max_depth: None
   - min_samples_split: 5
   - sampling_strategy: auto


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.0771
2             num__energy      0.0551
7       num__acousticness      0.0549
0        num__duration_ms      0.0504
4           num__loudness      0.0493
9           num__liveness      0.0456
3                num__key      0.0426
1       num__danceability      0.0421
10           num__valence      0.0419
11             num__tempo      0.0416
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Random Forest SMOTE se encuentra en la posición #18 de 18 modelos

Información:
   - Ensemble de 100 árboles
   - SMOTE para balancear clases
   - Características importantes: 26 de 129
   - n_estimators: 100
   - max_depth: None
   - SMOTE sampling: auto
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Random Forest con SMOTE da el mejor modelo global con un F1-Score macro de 0.668 y AUC-ROC de 0.901, Accuracy de 0.942, Balanced Accuracy de 0.661, AUC de 0.901 y F1-Score de 0.668, siendo el mejor desempeño predictivo global</p>
<p>Para la clase 0 (No Popular) se presenta un Precision de 0.967, solo 3% de falsos positivos, un Recall de 0.972 donde cubre 97% de canciones no populares, al igual que un F1 de 0.969.</p>
<p>Para la clase 1 (Popular) se presenta un Precision de 0.385, identificando un 39% de predicciones positivas correctas. También un Recall de 0.350 donde detecta 35% de canciones populares reales, y un F1 de 0.367 con un mejor balance en clase minoritaria.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones:</p>
<p>Verdaderos Negativos: 21,005 (92.5%)
Falsos Positivos: 611 (2.7%)<br />
Falsos Negativos: 711 (3.1%)
Verdaderos Positivos: 383 (1.7%)</p>
<p>Ahí se evidencia que solo 611 falsos positivos mejor que todos los modelos. 711 canciones populares no detectadas y 383 de 1,094 populares reales.</p>
<p>En el Top Características Técnicas Más Influyentes se muestra:</p>
<ul class="simple">
<li><p>Instrumentalness con un 0.071</p></li>
<li><p>Acousticness con un 0.055</p></li>
<li><p>Energy con un 0.053</p></li>
<li><p>Loudness con un 0.049</p></li>
<li><p>Duration_ms con un 0.048</p></li>
</ul>
<p>Algunos patrones de Género Identificados son :</p>
<ul class="simple">
<li><p>Dance, género dominante</p></li>
<li><p>Metal</p></li>
<li><p>Electro</p></li>
<li><p>Pop</p></li>
</ul>
<p>Así, da estrategias de producción basadas en estos hallazgos, como dar un enfoque en instrumentalidad, optimizar acústica, control de energía y volumen, y duración estratégica para dar un engagement.</p>
<p>Por ello, Random Forest con SMOTE es el modelo recomendado para estrategias de producción musical basadas en datos. Su combinación de mejor desempeño predictivo global, excelente capacidad discriminativa, mínima tasa de falsos positivos, su alta interpretabilidad de características influyentes, balance óptimo entre clases mayoritaria y minoritaria ño convierte en la herramienta ideal para disqueras y artistas que buscan maximizar el impacto de sus producciones en Spotify.</p>
<p><strong>XGBoost con Hyperparameter Tuning</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span>
    <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span>
    <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># 🔧 FIX GLOBAL: función para asegurar el formato correcto de predict_proba</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_probabilities</span><span class="p">(</span><span class="n">probas</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">probas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">probas</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># convertir de shape (n,) a (n,2)</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probas</span><span class="p">,</span> <span class="n">probas</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">probas</span>

<span class="c1"># -------------------------------------------------------------------</span>
<span class="c1"># FUNCIÓN evaluate_model (CORREGIDA Y MÁS ROBUSTA)</span>
<span class="c1"># -------------------------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># predicción</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># probabilidades corregidas</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">fix_probabilities</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># métricas generales</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, f1=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auc_score</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>

        <span class="c1"># Confusion Matrix</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="c1"># Reporte</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>


<span class="c1"># ------------------------------</span>
<span class="c1">#  DATOS Y PREPROCESAMIENTO</span>
<span class="c1"># ------------------------------</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño del entrenamiento: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
        <span class="p">]),</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="p">]),</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># ------------------------------</span>
<span class="c1"># PIPELINE XGBOOST + SMOTE</span>
<span class="c1"># ------------------------------</span>
<span class="n">pipeline_xgb_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
    <span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;model__subsample&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
    <span class="s1">&#39;model__colsample_bytree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_xgb_smote</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ejecutando GridSearchCV…&quot;</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo total: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best params:&quot;</span><span class="p">,</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># ------------------------------</span>
<span class="c1"># EVALUACIÓN</span>
<span class="c1"># ------------------------------</span>
<span class="n">result_xgb_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                  <span class="s2">&quot;XGBoost SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># ---------- METRICAS ----------</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ------------------------------</span>
<span class="c1"># GRAFICOS</span>
<span class="c1"># ------------------------------</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># ROC</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ROC - XGBoost SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                      <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                      <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de confusión&quot;</span><span class="p">)</span>

<span class="c1"># Importancia</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">importances</span><span class="p">)[</span><span class="o">-</span><span class="mi">15</span><span class="p">:]</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">feature_names</span><span class="p">[</span><span class="n">top_idx</span><span class="p">],</span> <span class="n">importances</span><span class="p">[</span><span class="n">top_idx</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 15 features&quot;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;Prec0&quot;</span><span class="p">,</span><span class="s2">&quot;Rec0&quot;</span><span class="p">,</span><span class="s2">&quot;F10&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;Prec1&quot;</span><span class="p">,</span><span class="s2">&quot;Rec1&quot;</span><span class="p">,</span><span class="s2">&quot;F11&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Métricas por clase&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño del entrenamiento: (90840, 15)
Clase 0: 86466
Clase 1: 4374

Ejecutando GridSearchCV…
Fitting 5 folds for each of 128 candidates, totalling 640 fits
Tiempo total: 802.03s
Best params: {&#39;model__colsample_bytree&#39;: 0.9, &#39;model__learning_rate&#39;: 0.2, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 150, &#39;model__scale_pos_weight&#39;: 2, &#39;model__subsample&#39;: 0.9, &#39;smote__sampling_strategy&#39;: 0.5}
XGBoost SMOTE: acc=0.906, f1=0.632, time=3.03s
AUC: 0.8590

Evaluación detallada:
Accuracy:            0.9063
Balanced Accuracy:   0.6870
AUC:                 0.8590
F1-score (Macro):    0.6316
</pre></div>
</div>
<img alt="_images/0fff81ef0a0a11e6b3be11f6418f7a34493b32842e98622656aa425fd7778934.png" src="_images/0fff81ef0a0a11e6b3be11f6418f7a34493b32842e98622656aa425fd7778934.png" />
</div>
</div>
<p>Analizando el desempeño del modelo XGBoost con SMOTE y Hyperparameter Tuning establece un nuevo récord en el benchmark con un F1-Score macro de 0.637. El modelo logra avances críticos en la clase minoritaria, con un Recall de 0.453 para Popular (45.3% de detección). Hubo un 496 canciones populares correctamente identificadas vs 398 del modelo anterior, tiene la capacidad de identificar 98 canciones populares adicionales detectadas que antes se clasificaban incorrectamente, y un AUC de 0.863 representa una capacidad sobresaliente para distinguir entre canciones populares y no populares</p>
<p>Viendo el top 5 Géneros Influyentes podemos clasificar:</p>
<ul class="simple">
<li><p>Dance con un 2.66%, nuevo en el top</p></li>
<li><p>House con un 2.40%</p></li>
<li><p>Latino con un 2.38%, que tiene un influencia global emergente</p></li>
<li><p>K-Pop con un 2.35%, sigue siendo un fenómeno internacional</p></li>
<li><p>Reggaeton con un 2.20%, género urbano con impacto significativo</p></li>
</ul>
<p>Para los productores musicales pueden aplicar un enfoque en géneros emergentes como Dance, House, Latino o K-Pop y noo depender exclusivamente del pop.</p>
<p>Este modelo representa el estado del arte en predicción de popularidad, combinando el máximo desempeño predictivo con eficiencia computacional y insights estratégicos accionables. Su capacidad para identificar patrones complejos a través de múltiples géneros y características técnicas lo convierte en la herramienta más poderosa para disqueras y artistas que buscan maximizar su éxito en la era digital de la música.</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># ====================================</span>
<span class="c1"># DEFINICIÓN DE VARIABLES</span>
<span class="c1"># ====================================</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># ====================================</span>
<span class="c1"># PREPROCESAMIENTO</span>
<span class="c1"># ====================================</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># ====================================</span>
<span class="c1"># PIPELINE + SMOTE</span>
<span class="c1"># ====================================</span>
<span class="n">svm_smote_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s1">&#39;model__kernel&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">],</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># ====================================</span>
<span class="c1"># GRID SEARCH</span>
<span class="c1"># ====================================</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">svm_smote_pipeline</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mejores parámetros:&quot;</span><span class="p">,</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

<span class="c1"># ====================================</span>
<span class="c1"># PREDICCIONES</span>
<span class="c1"># ====================================</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># ====================================</span>
<span class="c1"># MÉTRICAS</span>
<span class="c1"># ====================================</span>
<span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ====================================</span>
<span class="c1"># GRÁFICOS</span>
<span class="c1"># ====================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># --- Curva ROC ---</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC - SVM SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># --- Matriz ---</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión&quot;</span><span class="p">)</span>

<span class="c1"># ==========================================</span>
<span class="c1"># IMPORTANCIA DE VARIABLES SEGÚN EL KERNEL</span>
<span class="c1"># ==========================================</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__kernel&quot;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
    <span class="c1"># COEFICIENTES REALES</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span> <span class="s2">&quot;coef&quot;</span><span class="p">:</span> <span class="n">coef</span><span class="p">})</span>
    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">],</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;coef&quot;</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Coeficientes - Kernel Lineal&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># PERMUTATION IMPORTANCE (válido para kernel no lineal)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Kernel no lineal detectado → usando PERMUTATION IMPORTANCE.&quot;</span><span class="p">)</span>

    <span class="c1"># Transformamos el test con el preprocesador</span>
    <span class="n">X_test_transformed</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span>
        <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
        <span class="n">X_test_transformed</span><span class="p">,</span>
        <span class="n">y_test</span><span class="p">,</span>
        <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;f1_macro&quot;</span><span class="p">,</span>
        <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>

    <span class="n">imp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">importances_mean</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">imp_df</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">],</span> <span class="n">imp_df</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Permutation Importance - Kernel RBF&quot;</span><span class="p">)</span>

<span class="c1"># --- Métricas por clase ---</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span><span class="s1">&#39;F1&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Métricas por Clase&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 5 folds for each of 8 candidates, totalling 40 fits
Mejores parámetros: {&#39;model__C&#39;: 10, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: &#39;auto&#39;}
AUC: 0.6003

Kernel no lineal detectado → usando PERMUTATION IMPORTANCE.
</pre></div>
</div>
<img alt="_images/27c5e6fbbe4bc3caf5e9d1746b597db32d4355234c2ef0a213f3c9155089075f.png" src="_images/27c5e6fbbe4bc3caf5e9d1746b597db32d4355234c2ef0a213f3c9155089075f.png" />
</div>
</div>
<p>Analizando el modelo SVM con SMOTE muestra un F1-Score de 0.478, AUC de 0.629, Accuracy de 0.719 y Balanced Accuracy de 0.570.</p>
<p>En la clase 0 (No Popular) hay un Precision de 0.961, Recall de 0.735 y F1 de 0.833
En la clase 1 (Popular) hay un Precision de 0.072, Recall de 0.405 y F1 de 0.122
Se muestra que solo 7% de predicciones positivas son correctas y menos de la mitad de éxitos detectados.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones</p>
<p>Verdaderos Negativos: 15,896 (70.0%)
Falsos Positivos: 5,720 (25.2%)<br />
Falsos Negativos: 651 (2.9%)<br />
Verdaderos Positivos: 443 (2.0%)</p>
<p>Muestra que 5,720 falsos positivos, siendo el 25% del dataset mal clasificado, solo 443 verdaderos positivos done captura solo 40% de éxitos reales, y 28.1% de predicciones incorrectas.</p>
<p>Esto da que no ofrece ventajas sobre modelos más simples o complejos, inefectividad con kernels no lineales en datos musicales, alto costo computacional sin beneficio predictivo y pobre escalabilidad con grandes volúmenes de datos.</p>
<p>Por lo cual, SVM con SMOTE no es recomendable para aplicaciones en la industria musical debido a su pobre desempeño predictivo, excesivo costo computacional y nula capacidad interpretativa, donde el 7% de precision en identificación de éxitos, es decir, 13 de cada 14 recomendaciones son erróneas. También, 184 segundos de entrenamiento vs 1-10 segundos de alternativas efectivas, al igual que 25% de falsos positivos que da imposibilidad de optimizar estrategias.</p>
<p>Ahora con la técnica de balanceo <strong>Adasyn</strong></p>
<p><strong>KNN</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesador </span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KNN con ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">knn_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Optimización de hiperparámetros</span>
<span class="n">knn_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="s1">&#39;model__weights&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">knn_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">knn_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">knn_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_knn_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                  <span class="s2">&quot;KNN ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_knn_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis KNN ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># ---------------------------------------------</span>
<span class="c1"># CURVA ROC</span>
<span class="c1"># ---------------------------------------------</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - KNN ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># ---------------------------------------------</span>
<span class="c1"># MATRIZ DE CONFUSIÓN</span>
<span class="c1"># ---------------------------------------------</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                      <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                      <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - KNN ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># ---------------------------------------------</span>
<span class="c1"># PERMUTATION IMPORTANCE (REEMPLAZA EL TEXTO ANTERIOR)</span>
<span class="c1"># ---------------------------------------------</span>
<span class="n">X_test_transformed</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">perm</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span>
    <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="n">X_test_transformed</span><span class="p">,</span>
    <span class="n">y_test</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">perm_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;Importance&#39;</span><span class="p">:</span> <span class="n">perm</span><span class="o">.</span><span class="n">importances_mean</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_perm</span> <span class="o">=</span> <span class="n">perm_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_perm</span><span class="p">[</span><span class="s1">&#39;Feature&#39;</span><span class="p">],</span> <span class="n">top_perm</span><span class="p">[</span><span class="s1">&#39;Importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Importancia de Características (Permutation Importance)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Impacto en F1&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># ---------------------------------------------</span>
<span class="c1"># MÉTRICAS POR CLASE</span>
<span class="c1"># ---------------------------------------------</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - KNN ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ---------------------------------------------</span>
<span class="c1"># MOSTRAR RESULTADOS</span>
<span class="c1"># ---------------------------------------------</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">IMPORTANCIA DE VARIABLES (Permutation Importance):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">perm_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados KNN ADASYN&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
KNN con ADASYN

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 36 candidates, totalling 180 fits
Tiempo de entrenamiento: 689.00s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__n_neighbors&#39;: 3, &#39;model__weights&#39;: &#39;distance&#39;}
Mejor F1-score (CV): 0.6153
EVALUACIÓN COMPLETA CON evaluate_model
KNN ADASYN: acc=0.891, f1=0.635, time=1.33s
AUC: 0.7862
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
Análisis KNN ADASYN
Evaluación detallada:
Accuracy:            0.8907
Balanced Accuracy:   0.7326
AUC:                 0.7862
F1-score (Weighted): 0.6350
F1-score (Macro):    0.6350

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9759
Recall - No Popular:    0.9075
F1 - No Popular:        0.9405
Precision - Popular:    0.2338
Recall - Popular:       0.5576
F1 - Popular:           0.3295

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19617     1999]
     Popular   [   484      610]

Desglose:
   Verdaderos Negativos: 19617
   Falsos Positivos:     1999
   Falsos Negativos:     484
   Verdaderos Positivos: 610

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.91      0.94     21616
     Popular       0.23      0.56      0.33      1094

    accuracy                           0.89     22710
   macro avg       0.60      0.73      0.63     22710
weighted avg       0.94      0.89      0.91     22710
</pre></div>
</div>
<img alt="_images/e5cd14491a00fc3b26b80a5448aadfae14d27a9286c9a761bae7d82b08b4e167.png" src="_images/e5cd14491a00fc3b26b80a5448aadfae14d27a9286c9a761bae7d82b08b4e167.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IMPORTANCIA DE VARIABLES (Permutation Importance):
                        Feature  Importance
7             num__acousticness      0.0545
1             num__danceability      0.0534
10                 num__valence      0.0515
11                   num__tempo      0.0503
3                      num__key      0.0461
5                     num__mode      0.0455
2                   num__energy      0.0442
4                 num__loudness      0.0360
9                 num__liveness      0.0323
0              num__duration_ms      0.0302
8         num__instrumentalness      0.0290
6              num__speechiness      0.0244
12          num__time_signature      0.0207
85    cat__track_genre_mandopop      0.0044
38  cat__track_genre_deep-house      0.0042
93       cat__track_genre_party      0.0042
13          cat__explicit_False      0.0038
14           cat__explicit_True      0.0038
76      cat__track_genre_j-idol      0.0036
27    cat__track_genre_cantopop      0.0035

Resultados KNN ADASYN

Rendimiento general:
   - Accuracy: 0.891
   - AUC: 0.786
   - F1-Score (Macro): 0.635
   - Balanced Accuracy: 0.733
   - Tiempo entrenamiento: 1.33s
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo KNN con ADASYN establece un nuevo récord canciones populares, logrando un recall de todos los modelos con un 55.9% de efectividad, es decir, 612 canciones populares correctamente identificadas. Así, ADASYN genera muestras enfocadas en ejemplos difíciles de aprender, superando el enfoque de SMOTE.</p>
<p>En cuanto a la Precision en Popular con 0.234, y un Accuracy general de 0.890, muestra que KNN ADASYN prioriza la captura máxima de verdaderos positivos, aceptando más falsas alarmas como costo estratégico.</p>
<p>Escenarios ideales para KNN ADASYN puede usarse en la primera fase de screening en disqueras grandes y en plataformas de descubrimiento de nuevos talentos.</p>
<p>Por lo cual, KNN con ADASYN emerge como el modelo especialista en descubrimiento máximo, su capacidad para identificar canciones populares con un 55.9% de recall lo convierte en la herramienta para disqueras que priorizan la cobertura sobre la precisión perfecta.</p>
<p><strong>Naive Bayes</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">nb_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="c1"># Optimización de hiperparámetros con ADASYN </span>
<span class="n">nb_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">nb_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">nb_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">nb_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_nb_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Naive Bayes ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_nb_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis NAIVE BAYES ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># SOLUCIÓN: Crear una figura con solo 3 subplots en lugar de 4</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Naive Bayes ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Naive Bayes ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># SOLUCIÓN MEJORADA: Información del modelo - asegurando que se muestre</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Desactivar ejes para mejor visualización</span>
<span class="n">info_text</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Naive Bayes no proporciona</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;importancia de características</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;Parámetros óptimos:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;var_smoothing: 1.00e-06</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;ADASYN n_neighbors: 7</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;sampling_strategy: auto&quot;</span>
<span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">info_text</span><span class="p">,</span> 
         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.5&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">))</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Información del Modelo - Naive Bayes ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Naive Bayes ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># SOLUCIÓN ALTERNATIVA: Si aún no se muestra, crear una figura separada</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INFORMACIÓN DEL MODELO - NAIVE BAYES ADASYN&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Naive Bayes no proporciona importancia de características&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parámetros óptimos:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • var_smoothing: 1.00e-06&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • ADASYN n_neighbors: 7&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • sampling_strategy: auto&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados: NAIVE BAYES ADASYN&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - var_smoothing: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span>
<span class="s2">   - n_neighbors (ADASYN): </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Naive Bayes ADASYN vs otros modelos</span>
    <span class="n">nb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Naive Bayes ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Naive Bayes ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">nb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Naive Bayes ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - var_smoothing: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - sampling_strategy: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 96 candidates, totalling 480 fits
Tiempo de entrenamiento: 295.54s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 7, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__var_smoothing&#39;: 1e-06}
Mejor F1-score (CV): 0.4546
EVALUACIÓN COMPLETA CON evaluate_model
Naive Bayes ADASYN: acc=0.607, f1=0.465, time=1.68s
AUC: 0.7857
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
Análisis NAIVE BAYES ADASYN
Evaluación detallada:
Accuracy:            0.6067
Balanced Accuracy:   0.7709
AUC:                 0.7857
F1-score (Weighted): 0.4648
F1-score (Macro):    0.4648

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9959
Recall - No Popular:    0.5892
F1 - No Popular:        0.7404
Precision - Popular:    0.1050
Recall - Popular:       0.9525
F1 - Popular:           0.1892

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 12737     8879]
     Popular   [    52     1042]

Desglose:
   Verdaderos Negativos: 12737
   Falsos Positivos:     8879
   Falsos Negativos:     52
   Verdaderos Positivos: 1042

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       1.00      0.59      0.74     21616
     Popular       0.11      0.95      0.19      1094

    accuracy                           0.61     22710
   macro avg       0.55      0.77      0.46     22710
weighted avg       0.95      0.61      0.71     22710
</pre></div>
</div>
<img alt="_images/75cb7770f6909eed5ecb4a8ec97347df63f7dfb860a23e9144c100f2a2a58ff4.png" src="_images/75cb7770f6909eed5ecb4a8ec97347df63f7dfb860a23e9144c100f2a2a58ff4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
INFORMACIÓN DEL MODELO - NAIVE BAYES ADASYN
============================================================
Naive Bayes no proporciona importancia de características

Parámetros óptimos:
  • var_smoothing: 1.00e-06
  • ADASYN n_neighbors: 7
  • sampling_strategy: auto
============================================================
Resultados: NAIVE BAYES ADASYN

Rendimiento general:
   - Accuracy: 0.607
   - AUC: 0.786 
   - F1-Score (Macro): 0.465 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 1.68s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.996 | Recall: 0.589 | F1: 0.740
   - CLASE 1 (Popular): 
        Precision: 0.105 | Recall: 0.952 | F1: 0.189

Hiperparámetros óptimos ADASYN:
   - var_smoothing: 1.00e-06
   - n_neighbors (ADASYN): 7
   - sampling_strategy: 0.5

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Naive Bayes ADASYN se encuentra en la posición #22 de 22 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - var_smoothing: 1.00e-06
   - n_neighbors ADASYN: 7
   - sampling_strategy: 0.5
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Naive Bayes con ADASYN logra un recall del 95.1% en la clase popular, detectando 1040 de 1094 canciones populares correctamente. Presenta un Precision en Popular de un 0.105, es decir, solo 10.5% de aciertos en predicciones positivas, así, prioriza la seguridad absoluta contra pérdida de oportunidades, clasificando como “popular” cualquier canción con mínima probabilidad.</p>
<p>Para las disqueras y productores evidencia el costo de perder un hit potencial es alto, dispone de recursos para filtrar manualmente falsos positivos y, para la fase inicial de descubrimiento, es más crítica que la eficiencia.</p>
<p>Por lo cual, Naive Bayes con ADASYN representa el especialista en cobertura máxima. Su capacidad para detectar el 95% de las canciones populares lo convierte en la herramienta para scenarios donde perder oportunidades es inaceptable. Para disqueras que operan en entornos de alta incertidumbre y valor potencial ilimitado, el modelo ofrece seguridad contra algún tipo de error.</p>
<p><strong>Regresión Logística L1 y L2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESIÓN LOGÍSTICA CON ADASYN - L1 Y L2&quot;</span><span class="p">)</span>
<span class="c1"># Configuración para ambos modelos</span>
<span class="n">techniques_to_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADASYN&#39;</span><span class="p">]</span>
<span class="n">results_lr_adasyn</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESIÓN LOGÍSTICA L1 CON ADASYN&quot;</span><span class="p">)</span>

<span class="n">l1_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> 
                               <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">l1_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">l1_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">l1_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">l1_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L1</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">l1_training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L1: </span><span class="si">{</span><span class="n">l1_training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L1: </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L1 (CV): </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L1</span>
<span class="n">final_model_l1</span> <span class="o">=</span> <span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación L1 con ADASYN&quot;</span><span class="p">)</span>
<span class="n">result_l1_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l1</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Logistic Regression L1 ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l1_adasyn</span><span class="p">)</span>
<span class="n">results_lr_adasyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l1_adasyn</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESIÓN LOGÍSTICA L2 CON ADASYN&quot;</span><span class="p">)</span>

<span class="n">l2_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">l2_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">l2_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">l2_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">l2_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1">#  5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L2</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">l2_training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L2: </span><span class="si">{</span><span class="n">l2_training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L2: </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L2 (CV): </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L2</span>
<span class="n">final_model_l2</span> <span class="o">=</span> <span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación L2 con ADASYN&quot;</span><span class="p">)</span>
<span class="n">result_l2_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l2</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Logistic Regression L2 ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l2_adasyn</span><span class="p">)</span>
<span class="n">results_lr_adasyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l2_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis comparativo - L1 vs L2 CON ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones de ambos modelos</span>
<span class="n">y_pred_l1</span> <span class="o">=</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l1</span> <span class="o">=</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>
<span class="n">y_pred_l2</span> <span class="o">=</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l2</span> <span class="o">=</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Extraer probabilidades de clase positiva correctamente</span>
<span class="k">if</span> <span class="n">y_pred_proba_l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred_proba_l1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_l1_pos</span> <span class="o">=</span> <span class="n">y_pred_proba_l1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_l1_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">y_pred_proba_l2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred_proba_l2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_l2_pos</span> <span class="o">=</span> <span class="n">y_pred_proba_l2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_l2_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Métricas </span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">):</span>
    <span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;balanced_acc&#39;</span><span class="p">:</span> <span class="n">balanced_acc</span><span class="p">,</span>
        <span class="s1">&#39;precision_0&#39;</span><span class="p">:</span> <span class="n">precision_0</span><span class="p">,</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_0&#39;</span><span class="p">:</span> <span class="n">recall_0</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_0&#39;</span><span class="p">:</span> <span class="n">f1_0</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">f1_macro</span>
    <span class="p">}</span>

<span class="n">metrics_l1</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l1</span><span class="p">,</span> <span class="n">y_pred_proba_l1_pos</span><span class="p">)</span>
<span class="n">metrics_l2</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l2</span><span class="p">,</span> <span class="n">y_pred_proba_l2_pos</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPARACIÓN DETALLADA:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L1 ADASYN:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1-Macro: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Balanced Acc: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L2 ADASYN:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1-Macro: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Balanced Acc: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANÁLISIS DE SELECCIÓN DE CARACTERÍSTICAS - L1&quot;</span><span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef_l1</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes L1</span>
<span class="n">coef_df_l1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef_l1</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Análisis de sparsity L1</span>
<span class="n">n_zero_coef_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef_l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_nonzero_coef_l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_zero_coef_l1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características con coeficiente cero (L1): </span><span class="si">{</span><span class="n">n_zero_coef_l1</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas (L1): </span><span class="si">{</span><span class="n">n_nonzero_coef_l1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_nonzero_coef_l1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes (L1):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curvas ROC comparativas</span>
<span class="k">if</span> <span class="n">y_pred_proba_l1_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_pred_proba_l2_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l1_pos</span><span class="p">)</span>  <span class="c1"># ← Ahora es 1D</span>
    <span class="n">roc_auc_l1</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">)</span>
    <span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l2_pos</span><span class="p">)</span>  <span class="c1"># ← Ahora es 1D</span>
    <span class="n">roc_auc_l2</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L1 ADASYN (AUC = </span><span class="si">{</span><span class="n">roc_auc_l1</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L2 ADASYN (AUC = </span><span class="si">{</span><span class="n">roc_auc_l2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC Comparativas - L1 vs L2 con ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Métricas comparativas</span>
<span class="n">metrics_comparison</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Macro&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">,</span> <span class="s1">&#39;Balanced Acc&#39;</span><span class="p">]</span>
<span class="n">l1_values</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">l2_values</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_comparison</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l1_values</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L1 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l2_values</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L2 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Globales Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">metrics_comparison</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Coeficientes L1 </span>
<span class="n">top_features_l1</span> <span class="o">=</span> <span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - L1 ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase comparativas</span>
<span class="n">metrics_class_l1</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>
<span class="n">metrics_class_l2</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>

<span class="n">x_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width_class</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_class</span> <span class="o">-</span> <span class="n">width_class</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_l1</span><span class="p">,</span> <span class="n">width_class</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L1 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_class</span> <span class="o">+</span> <span class="n">width_class</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_l2</span><span class="p">,</span> <span class="n">width_class</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L2 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Clase Popular (1) Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_class</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final REGRESIÓN LOGÍSTICA CON ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># el mejor modelo</span>
<span class="k">if</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]:</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="s2">&quot;Logistic Regression L1 ADASYN&quot;</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="s2">&quot;Logistic Regression L2 ADASYN&quot;</span> 
    <span class="n">best_f1</span> <span class="o">=</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">best_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">COMPARACIÓN L1 vs L2:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L1 ADASYN - F1-Macro: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Características: </span><span class="si">{</span><span class="n">n_nonzero_coef_l1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L2 ADASYN - F1-Macro: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Todas las características utilizadas&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">HIPERPARÁMETROS ÓPTIMOS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L1 - C: </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Sampling: </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L2 - C: </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Sampling: </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre todos los modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre todos los modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo global</span>
    <span class="n">best_model_global</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>REGRESIÓN LOGÍSTICA CON ADASYN - L1 Y L2
Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
REGRESIÓN LOGÍSTICA L1 CON ADASYN
Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 12 candidates, totalling 60 fits
Tiempo de entrenamiento L1: 347.37s
Mejores parámetros L1: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None}
Mejor F1-score L1 (CV): 0.6093

Evaluación L1 con ADASYN
Logistic Regression L1 ADASYN: acc=0.857, f1=0.601, time=2.29s
AUC: 0.8456
REGRESIÓN LOGÍSTICA L2 CON ADASYN
Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 12 candidates, totalling 60 fits
Tiempo de entrenamiento L2: 71.61s
Mejores parámetros L2: {&#39;adasyn__n_neighbors&#39;: 5, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None}
Mejor F1-score L2 (CV): 0.6073

Evaluación L2 con ADASYN
Logistic Regression L2 ADASYN: acc=0.857, f1=0.601, time=2.98s
AUC: 0.8537
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
Análisis comparativo - L1 vs L2 CON ADASYN
COMPARACIÓN DETALLADA:

L1 ADASYN:
   Accuracy: 0.8568 | F1-Macro: 0.6006
   AUC: 0.8456 | Balanced Acc: 0.7252
   Clase 1 - Precision: 0.1851, Recall: 0.5795, F1: 0.2806

L2 ADASYN:
   Accuracy: 0.8575 | F1-Macro: 0.6005
   AUC: 0.8537 | Balanced Acc: 0.7238
   Clase 1 - Precision: 0.1851, Recall: 0.5759, F1: 0.2802
ANÁLISIS DE SELECCIÓN DE CARACTERÍSTICAS - L1
Características con coeficiente cero (L1): 53 de 129
Características retenidas (L1): 76 (58.9%)

Top 10 características más importantes (L1):
                        feature    coef
95         cat__track_genre_pop  2.9287
86       cat__track_genre_metal  2.5409
46     cat__track_genre_electro  2.4111
68       cat__track_genre_house  2.3247
35       cat__track_genre_dance  2.2468
80       cat__track_genre_k-pop  2.1787
71       cat__track_genre_indie  2.1760
105       cat__track_genre_rock  2.1701
45         cat__track_genre_edm  2.0510
62   cat__track_genre_hard-rock  2.0278
</pre></div>
</div>
<img alt="_images/22a14872124f23abde17be4756a9a715683869af96e8ba2f62da638f4ed3e3f1.png" src="_images/22a14872124f23abde17be4756a9a715683869af96e8ba2f62da638f4ed3e3f1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen final REGRESIÓN LOGÍSTICA CON ADASYN
Mejor modelo: Logistic Regression L1 ADASYN
   F1-Score (Macro): 0.6006

COMPARACIÓN L1 vs L2:
   L1 ADASYN - F1-Macro: 0.6006, Características: 76/129
   L2 ADASYN - F1-Macro: 0.6005, Todas las características utilizadas

HIPERPARÁMETROS ÓPTIMOS:
   L1 - C: 0.01, Sampling: 0.5
   L2 - C: 0.01, Sampling: 0.5
Matriz final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
Comparación entre todos los modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992
</pre></div>
</div>
</div>
</div>
<p>Analizando las Regresiones Logísticas con ADASYN muestran el punto óptimo entre transparencia y capacidad predictiva, logrando un F1-Score de aprox. 0.600 con coeficientes interpretables.</p>
<p>Comparando L1 vs L2, L2 con ADASYN lidera con un F1-Score de 0.6005 y un AUC de 0.8535, dando una excelente capacidad discriminativa. L1 con ADASYN sería un seleccionador eficiente pero no mejora el desempeño en este caso.</p>
<p>En el top 5 Géneros Más Influyentes con L1 se encuentran:</p>
<ul class="simple">
<li><p>Pop con 2.9536, lider</p></li>
<li><p>Metal con 2.5607</p></li>
<li><p>Electro con 2.4366</p></li>
<li><p>House con 2.3209</p></li>
<li><p>Dance con 2.2267</p></li>
</ul>
<p>Se ve un comportamiento donde cada unidad de aumento en la probabilidad del género pop aumenta 2.95 veces de ser popular.</p>
<p>Para los roductores musicales se puede aprender un enfoque cuantificable pues el Pop aporta 2.95x, Metal 2.56x y Electro 2.44x.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de parámetros</span>
<span class="n">REDUCED_ALPHAS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
<span class="n">REDUCED_SOLVERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;svd&#39;</span><span class="p">]</span>
<span class="n">REDUCED_SAMPLING</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">REDUCED_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">ridge_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">ridge_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">REDUCED_SAMPLING</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">REDUCED_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__alpha&#39;</span><span class="p">:</span> <span class="n">REDUCED_ALPHAS</span><span class="p">,</span>
    <span class="s1">&#39;model__solver&#39;</span><span class="p">:</span> <span class="n">REDUCED_SOLVERS</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">ridge_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">ridge_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">ridge_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_ridge_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="s2">&quot;Ridge Classifier ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_ridge_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RIDGE CLASSIFIER ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># RidgeClassifier no tiene AUC por defecto</span>
<span class="n">auc_value</span> <span class="o">=</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;No disponible&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">auc_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># SOLUCIÓN: Crear un modelo calibrado para obtener probabilidades y la curva ROC</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creando modelo calibrado para obtener curva ROC...&quot;</span><span class="p">)</span>
<span class="n">calibrated_model</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Crear pipeline para el modelo calibrado (sin ADASYN para la calibración)</span>
<span class="n">calibrated_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">calibrated_model</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Entrenar el modelo calibrado con los datos de entrenamiento (sin balancear para calibración)</span>
<span class="n">calibrated_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Obtener probabilidades calibradas</span>
<span class="n">y_calibrated_proba</span> <span class="o">=</span> <span class="n">calibrated_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_calibrated_proba_pos</span> <span class="o">=</span> <span class="n">y_calibrated_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Calcular métricas ROC con probabilidades calibradas</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_calibrated_proba_pos</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># SOLUCIÓN: Curva ROC con el modelo calibrado</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Ridge Classifier ADASYN (Calibrado)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Ridge Classifier ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo (ANÁLISIS ESPECÍFICO DE RIDGE)</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Ridge Classifier ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RIDGE CLASSIFIER ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC (Calibrado): </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - Alpha: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Solver: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Nota: Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Actualizar el AUC en results_df con el valor calibrado</span>
<span class="n">ridge_idx</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ridge_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ridge_idx</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Ridge Classifier ADASYN vs otros modelos</span>
    <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Ridge Classifier ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L2 (Ridge) para evitar overfitting&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Alpha óptimo: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Solver: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 32 candidates, totalling 160 fits
Tiempo de entrenamiento: 513.69s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 5, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__alpha&#39;: 10.0, &#39;model__solver&#39;: &#39;auto&#39;}
Mejor F1-score (CV): 0.5923
EVALUACIÓN COMPLETA CON evaluate_model
Ridge Classifier ADASYN: acc=0.830, f1=0.588, time=2.99s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
Análisis RIDGE CLASSIFIER ADASYN
Evaluación detallada:
Accuracy:            0.8299
Balanced Accuracy:   0.7492
AUC:                 No disponible
F1-score (Weighted): 0.5879
F1-score (Macro):    0.5879

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9799
Recall - No Popular:    0.8385
F1 - No Popular:        0.9037
Precision - Popular:    0.1713
Recall - Popular:       0.6600
F1 - Popular:           0.2720

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18124     3492]
     Popular   [   372      722]

Desglose:
   Verdaderos Negativos: 18124
   Falsos Positivos:     3492
   Falsos Negativos:     372
   Verdaderos Positivos: 722

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.84      0.90     21616
     Popular       0.17      0.66      0.27      1094

    accuracy                           0.83     22710
   macro avg       0.58      0.75      0.59     22710
weighted avg       0.94      0.83      0.87     22710


Creando modelo calibrado para obtener curva ROC...
</pre></div>
</div>
<img alt="_images/fd90d88aaa342ebf2ae43b93be3d55487439704e7d6808bd08ecec1eb37e36f7.png" src="_images/fd90d88aaa342ebf2ae43b93be3d55487439704e7d6808bd08ecec1eb37e36f7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RIDGE CLASSIFIER ADASYN

Rendimiento general:
   - Accuracy: 0.830
   - AUC (Calibrado): 0.857
   - F1-Score (Macro): 0.588 
   - Balanced Accuracy: 0.749 
   - Tiempo entrenamiento: 2.99s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.980 | Recall: 0.838 | F1: 0.904
   - CLASE 1 (Popular): 
        Precision: 0.171 | Recall: 0.660 | F1: 0.272

Hiperparámetros óptimos ADASYN:
   - Alpha: 10.0
   - Solver: auto
   - Sampling strategy: 0.5
   - n_neighbors: 5

Nota: Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC


Top 10 características importantes:
                            feature    coef
0                  num__duration_ms -0.0003
65     cat__track_genre_heavy-metal -0.0003
95             cat__track_genre_pop -0.0003
94           cat__track_genre_piano -0.0003
93           cat__track_genre_party -0.0003
92          cat__track_genre_pagode -0.0003
91           cat__track_genre_opera -0.0003
90         cat__track_genre_new-age -0.0003
89             cat__track_genre_mpb -0.0003
88  cat__track_genre_minimal-techno -0.0003
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856 0.856960    2.990490
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Ridge Classifier ADASYN se encuentra en la posición #25 de 25 modelos

Información:
   - Regularización L2 (Ridge) para evitar overfitting
   - ADASYN para balanceo adaptativo de clases
   - Alpha óptimo: 10.0
   - Solver: auto
   - Sampling strategy: 0.5
   - Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Ridge Classifier con ADASYN muestra un recall del 67.2% en la clase popular con regularización fuerte, teniendo un alpha de 10.0. Identifica 735 canciones populares correctamente identificadas.</p>
<p>En el Top 5 Coeficientes se muestra:</p>
<ul class="simple">
<li><p>Pop con 1.1823</p></li>
<li><p>Metal con 1.0262</p></li>
<li><p>Electro con 1.0192</p></li>
<li><p>House con 0.9894</p></li>
<li><p>Dance con 0.9785</p></li>
</ul>
<p>Escenarios ideales en las producciones musicales usando Ridge ADASYN se puede utilizar en la primera fase de screening en disqueras grandes. Aunque no lidera en métricas puras, su enfoque práctico y robustez lo posicionan como solución valiosa para disqueras que procesan grandes volúmenes de contenido y priorizan la cobertura exhaustiva sobre la precisión perfecta.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de hiperparámetros</span>
<span class="n">LASSO_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span> 
<span class="n">LASSO_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span> 
<span class="n">LASSO_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración Lasso con ADASYN:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Valores de C: </span><span class="si">{</span><span class="n">LASSO_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vecinos: </span><span class="si">{</span><span class="n">LASSO_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">lasso_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda</span>
<span class="n">lasso_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">LASSO_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">LASSO_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">lasso_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lasso_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">lasso_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_C_VALUES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_lasso_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="s2">&quot;Lasso ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de selección de características LASSO&quot;</span><span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span><span class="p">,</span>
    <span class="s1">&#39;abs_coef&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;abs_coef&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Análisis de sparsity Lasso</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_nonzero_coef</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_zero_coef</span>
<span class="n">sparsity_ratio</span> <span class="o">=</span> <span class="n">n_zero_coef</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características con coeficiente cero: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity ratio: </span><span class="si">{</span><span class="n">sparsity_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sparsity_ratio</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% eliminadas)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes:&quot;</span><span class="p">)</span>
<span class="n">top_10</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_10</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">influence</span> <span class="o">=</span> <span class="s2">&quot;POSITIVA&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;NEGATIVA&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">influence</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes Lasso </span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Selección de características Lasso:</span>
<span class="s2">   - Características retenidas: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)</span>
<span class="s2">   - Sparsity ratio: </span><span class="si">{</span><span class="n">sparsity_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso ADASYN vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - C óptimo: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Configuración Lasso con ADASYN:
   Valores de C: [0.001, 0.01, 0.1, 1.0]
   Estrategias: [0.5, &#39;auto&#39;]
   Vecinos: [3, 5]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones ADASYN: 16 × 5 folds = 80 modelos
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo de entrenamiento: 440.31s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None}
Mejor F1-score (CV): 0.6093
EVALUACIÓN COMPLETA CON evaluate_model
Lasso ADASYN: acc=0.857, f1=0.601, time=2.55s
AUC: 0.8456
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
Análisis LASSO ADASYN
Evaluación detallada:
Accuracy:            0.8568
Balanced Accuracy:   0.7252
AUC:                 0.8456
F1-score (Weighted): 0.6006
F1-score (Macro):    0.6006

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9761
Recall - No Popular:    0.8709
F1 - No Popular:        0.9205
Precision - Popular:    0.1851
Recall - Popular:       0.5795
F1 - Popular:           0.2806

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18825     2791]
     Popular   [   460      634]

Desglose:
   Verdaderos Negativos: 18825
   Falsos Positivos:     2791
   Falsos Negativos:     460
   Verdaderos Positivos: 634

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.87      0.92     21616
     Popular       0.19      0.58      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.73      0.60     22710
weighted avg       0.94      0.86      0.89     22710

Análisis de selección de características LASSO
Características con coeficiente cero: 53 de 129
Características retenidas: 76 (58.9%)
Sparsity ratio: 0.411 (41.1% eliminadas)

Top 10 características más importantes:
   cat__track_genre_pop: 2.9287 (POSITIVA)
   cat__track_genre_metal: 2.5409 (POSITIVA)
   cat__track_genre_electro: 2.4111 (POSITIVA)
   cat__track_genre_house: 2.3247 (POSITIVA)
   cat__track_genre_dance: 2.2468 (POSITIVA)
   cat__track_genre_k-pop: 2.1787 (POSITIVA)
   cat__track_genre_indie: 2.1760 (POSITIVA)
   cat__track_genre_rock: 2.1701 (POSITIVA)
   cat__track_genre_edm: 2.0510 (POSITIVA)
   cat__track_genre_hard-rock: 2.0278 (POSITIVA)
</pre></div>
</div>
<img alt="_images/eae4c3cca7a05ca8a30fa8518ed04b4c6f2158eb5446a5764cc0f410087d9341.png" src="_images/eae4c3cca7a05ca8a30fa8518ed04b4c6f2158eb5446a5764cc0f410087d9341.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis LASSO ADASYN

Rendimiento general:
   - Accuracy: 0.857
   - AUC: 0.846 
   - F1-Score (Macro): 0.601 
   - Balanced Accuracy: 0.725 
   - Tiempo entrenamiento: 2.55s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.871 | F1: 0.921
   - CLASE 1 (Popular): 
        Precision: 0.185 | Recall: 0.580 | F1: 0.281

Hiperparámetros óptimos ADASYN:
   - C: 0.01
   - Sampling strategy: 0.5
   - n_neighbors: 3

Selección de características Lasso:
   - Características retenidas: 76 de 129
   - Características eliminadas: 53 (41.1%)
   - Sparsity ratio: 0.411

Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Lasso ADASYN se encuentra en la posición #26 de 26 modelos

Información:
   - Regularización L1 (Lasso) para selección de características
   - ADASYN para balanceo adaptativo de clases
   - Características eliminadas: 53 de 129 (41.1%)
   - C óptimo: 0.01
   - Sampling strategy: 0.5
   - n_neighbors ADASYN: 3
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Lasso con ADASYN logra un F1-Score de 0.600 mientras elimina 41.1% de las características, con un  Recall de 0.580 para Popular, 635 canciones populares detectadas y 76 características vs 129 originales.</p>
<p>En el análisis de coeficientes Lasso revela el ranking:</p>
<ul class="simple">
<li><p>Pop con 2.9536 lider</p></li>
<li><p>Metal con 2.5607</p></li>
<li><p>Electro con 2.4366</p></li>
<li><p>House: 2.3209</p></li>
<li><p>Dance: 2.2267</p></li>
</ul>
<p>Cada unidad de aumento en género pop multiplica por 2.95 de ser popular.</p>
<p>Por lo cual, Lasso con ADASYN emerge como el modelo para decisiones estratégicas basadas en transparencia pues combina el desempeño competitivo con selección automática de características y coeficientes completamente interpretables lo convierte en la herramienta para disqueras que priorizan la comprensión sobre ganancias.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_decision_tree</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">technique_name</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluando: </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># pipeline</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span> 
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas </span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="c1"># Análisis de overfitting </span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;named_steps&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;get_depth&#39;</span><span class="p">):</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train Time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Profundidad del árbol: </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;technique&#39;</span><span class="p">:</span> <span class="n">technique_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision_0&#39;</span><span class="p">:</span> <span class="n">precision_0</span><span class="p">,</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_0&#39;</span><span class="p">:</span> <span class="n">recall_0</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_0&#39;</span><span class="p">:</span> <span class="n">f1_0</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="p">,</span>
        <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;y_pred_proba&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span><span class="p">,</span>
        <span class="s1">&#39;tree_depth&#39;</span><span class="p">:</span> <span class="n">depth</span>
    <span class="p">}</span>

<span class="c1"># Hiperparámetros reducidos</span>
<span class="n">DT_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  
<span class="n">DT_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>  
<span class="n">DT_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>  
<span class="n">DT_CRITERION</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>
<span class="n">DT_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">DT_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Max Depth: </span><span class="si">{</span><span class="n">DT_MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Min Samples Split: </span><span class="si">{</span><span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Min Samples Leaf: </span><span class="si">{</span><span class="n">DT_MIN_SAMPLES_LEAF</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Criterion: </span><span class="si">{</span><span class="n">DT_CRITERION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">dt_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">dt_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">DT_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">DT_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">DT_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">,</span>
    <span class="s1">&#39;model__criterion&#39;</span><span class="p">:</span> <span class="n">DT_CRITERION</span>
<span class="p">}</span>

<span class="n">dt_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">dt_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">dt_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 3 folds</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DT_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">DT_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_CRITERION</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 3 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dt_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">adasyn_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización ADASYN completada en </span><span class="si">{</span><span class="n">adasyn_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mejores parámetros: </span><span class="si">{</span><span class="n">dt_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">dt_adasyn_best</span> <span class="o">=</span> <span class="n">dt_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">results_dt_adasyn</span> <span class="o">=</span> <span class="n">evaluate_decision_tree</span><span class="p">(</span><span class="n">dt_adasyn_best</span><span class="p">,</span> <span class="s2">&quot;Árbol + ADASYN&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="c1"># resultados</span>
<span class="n">dt_all_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">results_dt_adasyn</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">techniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dt_all_results</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">metrics_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_1&#39;</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_plot</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">technique</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">techniques</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_all_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_to_plot</span><span class="p">]</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">technique</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Árbol de Decisión - Métricas de Rendimiento&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Profundidad de árbol</span>
<span class="n">depths</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;tree_depth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;tree_depth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dt_all_results</span><span class="p">]</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">techniques</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Profundidad del Árbol&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Complejidad del Modelo - Profundidad&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol + &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">techniques</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">depths</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1">#Tiempos de entrenamiento</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dt_all_results</span><span class="p">]</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">techniques</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tiempo (segundos)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tiempos de Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol + &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">techniques</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">time_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_val</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Curva ROC comparativas</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clasificador Aleatorio&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dt_all_results</span><span class="p">):</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y_pred_proba&#39;</span><span class="p">])</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC - Comparativa Árbol de Decisión&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">best_technique_dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dt_all_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Profundidad: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;tree_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión </span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión - </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="n">best_pipeline_dt</span> <span class="o">=</span> <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;pipeline&#39;</span><span class="p">]</span>
<span class="n">y_pred_best</span> <span class="o">=</span> <span class="n">best_pipeline_dt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">best_pipeline_dt</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Árbol de Decisión - </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s2">&quot;technique&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_class_0</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;precision_0&#39;</span><span class="p">],</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;recall_0&#39;</span><span class="p">],</span> 
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;f1_0&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">metrics_class_1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> 
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Mejor Técnica&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Análisis - </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

<span class="n">best_pipeline</span> <span class="o">=</span> <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;pipeline&#39;</span><span class="p">]</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
    
    <span class="c1"># DataFrame con importancias</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes:&quot;</span><span class="p">)</span>
    <span class="n">top_10</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_10</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Características menos importantes:&quot;</span><span class="p">)</span>
    <span class="n">bottom_5</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bottom_5</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configuración
   Max Depth: [5, 10, 15, None]
   Min Samples Split: [10, 20, 50]
   Min Samples Leaf: [5, 10, 20]
   Criterion: [&#39;gini&#39;, &#39;entropy&#39;]
Combinaciones ADASYN: 288 × 3 folds = 864 modelos
Fitting 3 folds for each of 288 candidates, totalling 864 fits
Optimización ADASYN completada en 1267.52s
   Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 5, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__criterion&#39;: &#39;entropy&#39;, &#39;model__max_depth&#39;: 5, &#39;model__min_samples_leaf&#39;: 5, &#39;model__min_samples_split&#39;: 50}

Evaluando: Árbol + ADASYN
Resultados Árbol + ADASYN:
   Train Time: 3.49s
   Accuracy: 0.9361 | F1-Weighted: 0.9273
   AUC: 0.6814
   Clase 1 - Precision: 0.2066, Recall: 0.1152, F1: 0.1479
   Profundidad del árbol: 5
</pre></div>
</div>
<img alt="_images/7b0ad2583b6d55769f86c0b953148be20fdc42998581200d060427c5a0345e4c.png" src="_images/7b0ad2583b6d55769f86c0b953148be20fdc42998581200d060427c5a0345e4c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados: Árbol + ADASYN
   F1-Score: 0.9273
   Recall Clase 1: 0.1152
   AUC: 0.6814
   Tiempo: 3.49s
   Profundidad: 5

Matriz de confusión - Árbol + ADASYN:
</pre></div>
</div>
<img alt="_images/d49e852fb6e98b7204e4854196c3b402cb191db8926ff9bc33f31c2d8268a038.png" src="_images/d49e852fb6e98b7204e4854196c3b402cb191db8926ff9bc33f31c2d8268a038.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis - Árbol + ADASYN:

Top 10 características más importantes:
   num__instrumentalness: 0.3091
   cat__track_genre_pop: 0.2018
   num__acousticness: 0.1268
   num__energy: 0.1014
   cat__track_genre_indie: 0.0703
   cat__track_genre_house: 0.0652
   cat__track_genre_metal: 0.0477
   cat__track_genre_indie-pop: 0.0315
   cat__track_genre_alternative: 0.0220
   cat__track_genre_singer-songwriter: 0.0170

Características menos importantes:
   cat__track_genre_dubstep: 0.0000
   cat__track_genre_dub: 0.0000
   cat__track_genre_drum-and-bass: 0.0000
   cat__track_genre_disney: 0.0000
   cat__track_genre_world-music: 0.0000
</pre></div>
</div>
</div>
</div>
<p>En el Árbol de Decisión con ADASYN muestra una profundidad máxima de solo 5 niveles y un recall muy bajo de 12.5% para la clase popular, indicando sobre-regularización del modelo.</p>
<p>La combinación ADASYN y el criterio de parada produce un árbol excesivamente simple que no logra capturar la complejidad de los patrones de popularidad, dando métricas engañosas con un Accuracy de 93.7%, un F1-Weighted de 92.9%, dando un buen desempeño en clase mayoritaria, y F1 Clase Popular con 16.1%, mostrando solo 137 canciones populares detectadas de 1094.</p>
<p>En el top de características más importantes está:</p>
<ul class="simple">
<li><p>Instrumentalness con 26.6%, factor dominante en decisiones del árbol</p></li>
<li><p>Género Pop con 19.8%</p></li>
<li><p>Acousticness con 12.7%</p></li>
<li><p>Energy con 10.3%</p></li>
</ul>
<p>Para la industria musical pudiera ser un riesgo el 86% de canciones potencialmente populares no detectadas, dandon pérdida masiva de oportunidades de negocio.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Hiperparámetros reducidos </span>
<span class="n">RF_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>           
<span class="n">RF_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>         
<span class="n">RF_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>       
<span class="n">RF_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>         
<span class="n">RF_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span> 
<span class="n">RF_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>                    

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">RF_N_ESTIMATORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">RF_MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   min_samples_split: </span><span class="si">{</span><span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   min_samples_leaf: </span><span class="si">{</span><span class="n">RF_MIN_SAMPLES_LEAF</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">RF_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vecinos: </span><span class="si">{</span><span class="n">RF_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">rf_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">rf_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">RF_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">RF_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">RF_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">RF_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_LEAF</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="c1"># GridSearchCV con F1-macro</span>
<span class="n">rf_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">rf_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">rf_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RF_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">RF_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_LEAF</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">adasyn_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización ADASYN completada en </span><span class="si">{</span><span class="n">adasyn_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_rf_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Random Forest ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz actualizada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RANDOM FOREST ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Random Forest ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Random Forest ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RANDOM FOREST ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de características importantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest ADASYN vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ensemble de árboles para robustez&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - sampling_strategy: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configuración
   n_estimators: [50, 100]
   max_depth: [10, 15, None]
   min_samples_split: [10, 20]
   min_samples_leaf: [5, 10]
   Estrategias: [0.5, &#39;auto&#39;]
   Vecinos: [3]
Combinaciones ADASYN: 48 × 5 folds = 240 modelos
Fitting 5 folds for each of 48 candidates, totalling 240 fits
Optimización ADASYN completada en 1806.49s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: &#39;auto&#39;, &#39;model__class_weight&#39;: None, &#39;model__max_depth&#39;: None, &#39;model__min_samples_leaf&#39;: 5, &#39;model__min_samples_split&#39;: 10, &#39;model__n_estimators&#39;: 100}
Mejor F1-score (CV): 0.6613
EVALUACIÓN COMPLETA CON evaluate_model
Random Forest ADASYN: acc=0.928, f1=0.663, time=21.83s
AUC: 0.8914
Matriz actualizada:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
Análisis RANDOM FOREST ADASYN
Evaluación detallada:
Accuracy:            0.9278
Balanced Accuracy:   0.6904
AUC:                 0.8914
F1-score (Weighted): 0.6625
F1-score (Macro):    0.6625

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9705
Recall - No Popular:    0.9531
F1 - No Popular:        0.9617
Precision - Popular:    0.3158
Recall - Popular:       0.4278
F1 - Popular:           0.3634

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20602     1014]
     Popular   [   626      468]

Desglose:
   Verdaderos Negativos: 20602
   Falsos Positivos:     1014
   Falsos Negativos:     626
   Verdaderos Positivos: 468

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.95      0.96     21616
     Popular       0.32      0.43      0.36      1094

    accuracy                           0.93     22710
   macro avg       0.64      0.69      0.66     22710
weighted avg       0.94      0.93      0.93     22710
</pre></div>
</div>
<img alt="_images/f25df00c50064a6b4eb5afc31f579acca7ac4f289e9e64f249908d99194fc5c9.png" src="_images/f25df00c50064a6b4eb5afc31f579acca7ac4f289e9e64f249908d99194fc5c9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RANDOM FOREST ADASYN

Rendimiento general:
   - Accuracy: 0.928
   - AUC: 0.891 
   - F1-Score (Macro): 0.663 
   - Balanced Accuracy: 0.690 
   - Tiempo entrenamiento: 21.83s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.971 | Recall: 0.953 | F1: 0.962
   - CLASE 1 (Popular): 
        Precision: 0.316 | Recall: 0.428 | F1: 0.363

Hiperparámetros óptimos ADASYN:
   - n_estimators: 100
   - max_depth: None
   - min_samples_split: 10
   - min_samples_leaf: 5
   - sampling_strategy: auto
   - n_neighbors: 3


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.0870
7       num__acousticness      0.0555
2             num__energy      0.0539
0        num__duration_ms      0.0495
4           num__loudness      0.0486
9           num__liveness      0.0458
3                num__key      0.0404
1       num__danceability      0.0388
10           num__valence      0.0384
95   cat__track_genre_pop      0.0365
Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Random Forest ADASYN se encuentra en la posición #27 de 27 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - Ensemble de árboles para robustez
   - n_estimators: 100
   - max_depth: None
   - sampling_strategy: auto
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Random Forest tiene un F1-Score de 0.661, un AUC de 0.891, Accuracy de 92.8% y un Recall Popular de 42.4% sin sacrificar precisión. Hubo 464 canciones populares detectadas, 630 falsos negativos dando un buen control de oportunidades perdidas, y 1013 falsos positivos con un manejo razonable de falsas alarmas.</p>
<p>En el top 5 Características Más Influyentes se muestra:</p>
<ul class="simple">
<li><p>Instrumentalness con un 8.2%, factor crítico</p></li>
<li><p>Energy con un 5.5%</p></li>
<li><p>Acousticness con un 5.5%</p></li>
<li><p>Duration_ms con un 4.9%</p></li>
<li><p>Loudness con un 4.8%, importante en la mezcla</p></li>
</ul>
<p>Para los productores musicales se puede dar un enfoque en características técnicas como Instrumentalness, Energy o Acousticness. Y para las disqueras se les da un 42% de efectividad en identificar hits y menos falsos negativos.</p>
<p>Así, Random Forest con ADASYN como el modelo definitivo para la industria musical moderna. Su combinación de balanceo y potencia de ensemble produce el mejor desempeño predictivo general, aunque requiere mayor inversión computacional. Su capacidad para identificar patrones complejos de popularidad lo convierte en la herramienta para disqueras.</p>
<p><strong>XGBOOST</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test         - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros optimizados </span>
<span class="n">XGB_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>          
<span class="n">XGB_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>                
<span class="n">XGB_LEARNING_RATE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>        
<span class="n">XGB_SUBSAMPLE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>             
<span class="n">XGB_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">XGB_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>                   

<span class="n">scale_pos_weight_value</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scale_pos_weight calculado: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">XGB_N_ESTIMATORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">XGB_MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   learning_rate: </span><span class="si">{</span><span class="n">XGB_LEARNING_RATE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   subsample: </span><span class="si">{</span><span class="n">XGB_SUBSAMPLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   scale_pos_weight: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">XGB_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">xgb_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">xgb_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">XGB_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">XGB_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">XGB_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">XGB_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="n">XGB_LEARNING_RATE</span><span class="p">,</span>
    <span class="s1">&#39;model__subsample&#39;</span><span class="p">:</span> <span class="n">XGB_SUBSAMPLE</span><span class="p">,</span>
    <span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">xgb_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">xgb_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">xgb_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XGB_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">XGB_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">XGB_LEARNING_RATE</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_SUBSAMPLE</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_xgb_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                  <span class="s2">&quot;XGBoost ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis XGBOOST ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados XGBOOST ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - learning_rate: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - subsample: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__subsample&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de características importantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del XGBoost ADASYN vs otros modelos</span>
    <span class="n">xgb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XGBoost ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">XGBoost ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">xgb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre XGBoost ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases:
   Entrenamiento - Clase 0: 86466 | Clase 1: 4374
   Test         - Clase 0: 21616 | Clase 1: 1094
scale_pos_weight calculado: 19.77
Configuración:
   n_estimators: [50, 100]
   max_depth: [3, 6]
   learning_rate: [0.1, 0.01]
   subsample: [0.8, 1.0]
   scale_pos_weight: 19.77
   Estrategias: [0.5, &#39;auto&#39;]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones ADASYN: 32 × 5 folds = 160 modelos
Fitting 5 folds for each of 32 candidates, totalling 160 fits
Tiempo de entrenamiento: 214.93s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: &#39;auto&#39;, &#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 100, &#39;model__scale_pos_weight&#39;: 1, &#39;model__subsample&#39;: 0.8}
Mejor F1-score (CV): 0.6272
EVALUACIÓN COMPLETA CON evaluate_model
XGBoost ADASYN: acc=0.896, f1=0.616, time=4.06s
AUC: 0.8136
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
27  0.8136      4.0594  
Análisis XGBOOST ADASYN
Evaluación detallada:
Accuracy:            0.8963
Balanced Accuracy:   0.6773
AUC:                 0.8136
F1-score (Weighted): 0.6159
F1-score (Macro):    0.6159

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9698
Recall - No Popular:    0.9196
F1 - No Popular:        0.9441
Precision - Popular:    0.2150
Recall - Popular:       0.4351
F1 - Popular:           0.2878

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19878     1738]
     Popular   [   618      476]

Desglose:
   Verdaderos Negativos: 19878
   Falsos Positivos:     1738
   Falsos Negativos:     618
   Verdaderos Positivos: 476

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.92      0.94     21616
     Popular       0.21      0.44      0.29      1094

    accuracy                           0.90     22710
   macro avg       0.59      0.68      0.62     22710
weighted avg       0.93      0.90      0.91     22710
</pre></div>
</div>
<img alt="_images/4f1137f6ec63ac225f57c34a267a0f7ce950891cea1a88438cb5af72806838dd.png" src="_images/4f1137f6ec63ac225f57c34a267a0f7ce950891cea1a88438cb5af72806838dd.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados XGBOOST ADASYN

Rendimiento general:
   - Accuracy: 0.896
   - AUC: 0.814 
   - F1-Score (Macro): 0.616 
   - Balanced Accuracy: 0.677 
   - Tiempo entrenamiento: 4.06s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.970 | Recall: 0.920 | F1: 0.944
   - CLASE 1 (Popular): 
        Precision: 0.215 | Recall: 0.435 | F1: 0.288

Hiperparámetros óptimos ADASYN:
   - Sampling strategy: auto
   - n_neighbors: 3
   - n_estimators: 100
   - max_depth: 6
   - learning_rate: 0.1
   - subsample: 0.8


Top 10 características importantes:
                         feature  importance
46      cat__track_genre_electro      0.0226
35        cat__track_genre_dance      0.0206
68        cat__track_genre_house      0.0195
45          cat__track_genre_edm      0.0193
117  cat__track_genre_songwriter      0.0188
83       cat__track_genre_latino      0.0187
80        cat__track_genre_k-pop      0.0180
95          cat__track_genre_pop      0.0180
71        cat__track_genre_indie      0.0178
104   cat__track_genre_reggaeton      0.0176
Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

XGBoost ADASYN se encuentra en la posición #28 de 28 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - Sampling strategy: auto
   - n_neighbors ADASYN: 3
   - n_estimators: 100
   - max_depth: 6
</pre></div>
</div>
</div>
</div>
<p>El modelo XGBoost con ADASYN logra un F1-Score macro de 0.617 y AUC-ROC de 0.812, demostró ser efectivo para manejar el desbalance extremo inicial. Teniendo un Accuracy de 0.895 y un Balanced Accuracy de 0.682 refleja mejor el desempeño real</p>
<p>Para la clase 0 (No Popular) se tiene un Precision de 0.970, es decir, casi no hay falsos positivos, un Recall de 0.918, dando un buen cubrimiento de canciones no populares, y un F1 de 0.943 siendo un desempeño casi perfecto.</p>
<p>Para la clase 1 (Popular) se tiene un Precision de 0.216, identificando solo un 22% de predicciones positivas son correctas, al igual que un Recall de 0.446, detectando un 45% de canciones populares reales, y un F1 de 0.291 siendo un punto crítico de mejora.</p>
<p>En la Matriz de Confusión se ven los siguientes patrones:
Verdaderos Negativos: 19,843 (87.4%)
Falsos Positivos: 1,773 (7.8%)
Falsos Negativos: 606 (2.7%)
Verdaderos Positivos: 488 (2.1%)</p>
<p>Vemos que 1,773 canciones predichas como populares que no lo fueron, 606 canciones populares no detectadas, siendo oportunidades perdidas, y 488 de 1,094 populares reales (44.6%).</p>
<p>En cuanto al Top de Características se muestran los géneros clave del éxito:</p>
<ul class="simple">
<li><p>Dance con 0.0238</p></li>
<li><p>Electro con 0.0212</p></li>
<li><p>House con 0.0208</p></li>
<li><p>EDM con 0.0207</p></li>
</ul>
<p>En géneros con potencial están:</p>
<ul class="simple">
<li><p>K-Pop con 0.0187</p></li>
<li><p>Reggaeton con 0.0178</p></li>
<li><p>Explicit Content con 0.0214</p></li>
</ul>
<p>Y géneros de poco impacto:</p>
<ul class="simple">
<li><p>Songwriter con 0.0196</p></li>
<li><p>Folk con 0.0173</p></li>
<li><p>Dancehall con 0.0167</p></li>
</ul>
<p>Por lo cual, XGBoost con ADASYN capta estrategias de producción musical basadas, combinando un buen desempeño predictivo, eficiencia computacional y claridad interpretativa para identificar géneros con mayor potencial de éxito, optimizar asignación de recursos de producción, desarrollar estrategias de artistas basadas en datos y anticipar tendencias del mercado musical</p>
<p>También muestra la dominancia de los géneros electrónicos mientras revela oportunidades en fenómenos globales como K-Pop y Reggaeton, proporcionando un mapa estratégico claro para disqueras y artistas que buscan maximizar su impacto en Spotify.</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># =========================</span>
<span class="c1">#  DEFINICIÓN DE FEATURES</span>
<span class="c1"># =========================</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># Subconjunto para aceleración del tuning</span>
<span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
    <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Usando subconjunto balanceado: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_balanced</span><span class="p">)</span><span class="si">}</span><span class="s2"> instancias&quot;</span><span class="p">)</span>

<span class="c1"># =========================</span>
<span class="c1">#  HIPERPARÁMETROS SVM</span>
<span class="c1"># =========================</span>
<span class="n">SVM_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">SVM_KERNEL</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
<span class="n">SVM_GAMMA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>
<span class="n">SVM_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">SVM_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   C: </span><span class="si">{</span><span class="n">SVM_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   kernel: </span><span class="si">{</span><span class="n">SVM_KERNEL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   gamma: </span><span class="si">{</span><span class="n">SVM_GAMMA</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   sampling_strategy: </span><span class="si">{</span><span class="n">SVM_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   neighbors: </span><span class="si">{</span><span class="n">SVM_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># =========================</span>
<span class="c1">#  PIPELINE SVM + ADASYN</span>
<span class="c1"># =========================</span>
<span class="n">svm_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">svm_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">SVM_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">SVM_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SVM_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__kernel&#39;</span><span class="p">:</span> <span class="n">SVM_KERNEL</span><span class="p">,</span>
    <span class="s1">&#39;model__gamma&#39;</span><span class="p">:</span> <span class="n">SVM_GAMMA</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">total_combos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_C_VALUES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_KERNEL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">total_combos</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">total_combos</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">svm_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">svm_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">svm_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">)</span>
<span class="n">adasyn_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ADASYN completado en </span><span class="si">{</span><span class="n">adasyn_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># =========================</span>
<span class="c1">#  MODELO FINAL ENTRENADO</span>
<span class="c1"># =========================</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EVALUACIÓN COMPLETA CON evaluate_model</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">result_svm_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                   <span class="s2">&quot;SVM ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_svm_adasyn</span><span class="p">)</span>

<span class="c1"># =========================</span>
<span class="c1">#  MÉTRICAS DETALLADAS</span>
<span class="c1"># =========================</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC: </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro): </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>

<span class="c1"># =========================</span>
<span class="c1">#  GRAFICACIÓN</span>
<span class="c1"># =========================</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># ---- ROC ----</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ROC Curve&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Probabilidades no disponibles&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>

<span class="c1"># ---- MATRIZ DE CONFUSIÓN ----</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                      <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                      <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión - SVM ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># =========================</span>
<span class="c1">#  FIX UNIVERSAL PERMUTATION IMPORTANCE</span>
<span class="c1"># =========================</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculando Permutation Importance...&quot;</span><span class="p">)</span>

<span class="n">perm_importance</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span>
    <span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">n_repeats</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>

<span class="c1"># --- FIX QUE EVITA TODOS LOS ERRORES ---</span>
<span class="n">n_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_real</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Ajustando tamaños: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">n_real</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[:</span><span class="n">n_real</span><span class="p">]</span>

<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">[:</span><span class="n">n_real</span><span class="p">],</span>
    <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_std</span><span class="p">[:</span><span class="n">n_real</span><span class="p">]</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 15 Características Importantes&quot;</span><span class="p">)</span>

<span class="c1"># ---- MÉTRICAS POR CLASE ----</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Usando subconjunto balanceado: 22710 instancias
Configuración:
   C: [0.1, 1, 10]
   kernel: [&#39;linear&#39;, &#39;rbf&#39;]
   gamma: [&#39;scale&#39;]
   sampling_strategy: [0.5, &#39;auto&#39;]
   neighbors: [3, 5]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones ADASYN: 24 × 5 folds = 120 modelos
Fitting 5 folds for each of 24 candidates, totalling 120 fits
ADASYN completado en 1779.21s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 10, &#39;model__class_weight&#39;: None, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;}
Mejor F1-score (CV): 0.5131

EVALUACIÓN COMPLETA CON evaluate_model

SVM ADASYN: acc=0.641, f1=0.451, time=140.22s
AUC: 0.6425

Evaluación detallada:
Accuracy: 0.6408
Balanced Accuracy: 0.5961
AUC: 0.6425
F1-score (Macro): 0.4508

Matriz de confusión:
[[13954  7662]
 [  496   598]]

Calculando Permutation Importance...
⚠️ Ajustando tamaños: 129 → 15
</pre></div>
</div>
<img alt="_images/142d5133d64ce719cf703fb44b711399ecf4d7db2f11e3760677fdc8bc96167d.png" src="_images/142d5133d64ce719cf703fb44b711399ecf4d7db2f11e3760677fdc8bc96167d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 10 características importantes:
                  feature  importance       std
9           num__liveness    0.003664  0.000477
0        num__duration_ms    0.002836  0.001259
14     cat__explicit_True    0.001515  0.001126
5               num__mode    0.000951  0.001005
3                num__key   -0.000018  0.001260
13    cat__explicit_False   -0.000079  0.000557
8   num__instrumentalness   -0.001207  0.000906
6        num__speechiness   -0.007468  0.000455
11             num__tempo   -0.009670  0.001129
12    num__time_signature   -0.017472  0.000869
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo SVM con ADASYN muestra un F1-Score macro de 0.480 y AUC-ROC de 0.655, dando un desempeño inferior a otros. Teniendo un Accuracy de 0.710, una cifra baja debido a mala clasificación de ambas clases, al igual que un Balanced Accuracy de 0.594, indicando una dificultad para equilibrar predicciones, y un AUC de 0.655 dando una capacidad discriminativa apenas superior al azar.</p>
<p>Para la clase 0 (No Popular) hay un Precision de 0.964, dando pocos falsos positivos, y un Recall de 0.723, donde 28% de canciones no populares mal clasificadas.</p>
<p>Para la clase 1 (Popular) hay un Precision de 0.078 donde solo 8% de predicciones positivas son correctas, también un Recall de 0.464, donde se detecta un 46% de canciones populares reales. Y un F1 de 0.134, el peor entre todos los modelos.</p>
<p>En la matriz de Confusión se muestran los siguientes patrones:</p>
<p>Verdaderos Negativos: 15,624 (68.8%)
Falsos Positivos: 5,992 (26.4%)<br />
Falsos Negativos: 586 (2.6%)
Verdaderos Positivos: 508 (2.2%)</p>
<p>Esto muestra que 5,992 falsos positivos, es decir, un 26% del dataset está mal clasificado como popular.</p>
<p>En la Curva ROC el AUC de 0.655 indica una pobre separación entre clases populares y no populares, e incapacidad para establecer umbrales efectivos.</p>
<p>Algunas limitaciones puede ser que dado un Precision de 8% en clase popular hace inviable su uso práctico, la alta tasa de falsos positivos generaría recomendaciones erróneas, por lo cual, no se pueden identificar géneros o características influyentes junto con un alto costo computacional.</p>
<p>Por lo tanto, SVM con ADASYN no es recomendable para estrategias de producción musical debido a su pobre desempeño predictivo, alta complejidad computacional y nula capacidad interpretativa.</p>
<p>Ahora analizamos con la métrica <strong>Class Weight</strong></p>
<p><strong>Regresión Logística L1 y L2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPTIMIZACIÓN L1 CON CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para L1 con class_weight</span>
<span class="n">pipeline_l1</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> 
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para L1</span>
<span class="n">params_l1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para L1&quot;</span><span class="p">)</span>
<span class="n">grid_l1</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_l1</span><span class="p">,</span>
    <span class="n">params_l1</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L1</span>
<span class="n">start_time_l1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_l1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time_l1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_l1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L1: </span><span class="si">{</span><span class="n">training_time_l1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L1: </span><span class="si">{</span><span class="n">grid_l1</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L1 (CV): </span><span class="si">{</span><span class="n">grid_l1</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L1</span>
<span class="n">final_model_l1</span> <span class="o">=</span> <span class="n">grid_l1</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">result_l1_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l1</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;L1 Regression Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l1_classweight</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPTIMIZACIÓN L2 CON CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para L2 con class_weight</span>
<span class="n">pipeline_l2</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para L2</span>
<span class="n">params_l2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para L2&quot;</span><span class="p">)</span>
<span class="n">grid_l2</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_l2</span><span class="p">,</span>
    <span class="n">params_l2</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L2</span>
<span class="n">start_time_l2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_l2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time_l2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_l2</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L2: </span><span class="si">{</span><span class="n">training_time_l2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L2: </span><span class="si">{</span><span class="n">grid_l2</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L2 (CV): </span><span class="si">{</span><span class="n">grid_l2</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L2</span>
<span class="n">final_model_l2</span> <span class="o">=</span> <span class="n">grid_l2</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">result_l2_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l2</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;L2 Regression Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l2_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis L1 vs L2 CON CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones de ambos modelos</span>
<span class="n">y_pred_l1</span> <span class="o">=</span> <span class="n">result_l1_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l1</span> <span class="o">=</span> <span class="n">result_l1_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>
<span class="n">y_pred_l2</span> <span class="o">=</span> <span class="n">result_l2_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l2</span> <span class="o">=</span> <span class="n">result_l2_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_detailed_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
    <span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">:</span> <span class="n">balanced_acc</span><span class="p">,</span>
        <span class="s1">&#39;precision_0&#39;</span><span class="p">:</span> <span class="n">precision_0</span><span class="p">,</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_0&#39;</span><span class="p">:</span> <span class="n">recall_0</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_0&#39;</span><span class="p">:</span> <span class="n">f1_0</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">f1_macro</span>
    <span class="p">}</span>

<span class="n">metrics_l1</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l1</span><span class="p">,</span> <span class="n">y_pred_proba_l1</span><span class="p">,</span> <span class="s2">&quot;L1 Class Weight&quot;</span><span class="p">)</span>
<span class="n">metrics_l2</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l2</span><span class="p">,</span> <span class="n">y_pred_proba_l2</span><span class="p">,</span> <span class="s2">&quot;L2 Class Weight&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L1 Regression Class Weight:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1 Clase 1:       </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1:   </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Balanced Acc:     </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L2 Regression Class Weight:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1 Clase 1:       </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1:   </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Balanced Acc:     </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Determinar el mejor modelo</span>
<span class="k">if</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]:</span>
    <span class="n">best_model_name</span> <span class="o">=</span> <span class="s2">&quot;L1 Regression Class Weight&quot;</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">final_model_l1</span>
    <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">metrics_l1</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">best_model_name</span> <span class="o">=</span> <span class="s2">&quot;L2 Regression Class Weight&quot;</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">final_model_l2</span>
    <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">metrics_l2</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">best_metrics</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curvas ROC comparativas</span>
<span class="k">if</span> <span class="n">y_pred_proba_l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_pred_proba_l2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">roc_auc_l1</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">)</span>
    <span class="n">roc_auc_l2</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L1 (AUC = </span><span class="si">{</span><span class="n">roc_auc_l1</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L2 (AUC = </span><span class="si">{</span><span class="n">roc_auc_l2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC - L1 vs L2 con Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase comparativas</span>
<span class="n">metrics_l1_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>
<span class="n">metrics_l2_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_l1_data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L1 Class Weight&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_l2_data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L2 Class Weight&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Clase Popular - L1 vs L2&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Coeficientes L1 </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef_l1</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">coef_df_l1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef_l1</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_features_l1</span> <span class="o">=</span> <span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Características - L1 (Selección)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Coeficientes L2 </span>
<span class="n">coef_l2</span> <span class="o">=</span> <span class="n">final_model_l2</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">coef_df_l2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef_l2</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_features_l2</span> <span class="o">=</span> <span class="n">coef_df_l2</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features_l2</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features_l2</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Características - L2 (Todas)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de selección de características L1&quot;</span><span class="p">)</span>


<span class="n">n_zero_coef_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef_l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características con coeficiente cero en L1: </span><span class="si">{</span><span class="n">n_zero_coef_l1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas en L1: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_zero_coef_l1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Porcentaje eliminado por L1: </span><span class="si">{</span><span class="n">n_zero_coef_l1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes (L1):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre todos los modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre todos los modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo global</span>
    <span class="n">best_model_global</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
OPTIMIZACIÓN L1 CON CLASS WEIGHT

Búsqueda de hiperparámetros para L1
Fitting 5 folds for each of 4 candidates, totalling 20 fits
Tiempo de entrenamiento L1: 172.98s
Mejores parámetros L1: {&#39;model__C&#39;: 0.01}
Mejor F1-score L1 (CV): 0.5662
L1 Regression Class Weight: acc=0.787, f1=0.565, time=0.83s
AUC: 0.8431
OPTIMIZACIÓN L2 CON CLASS WEIGHT

Búsqueda de hiperparámetros para L2
Fitting 5 folds for each of 4 candidates, totalling 20 fits
Tiempo de entrenamiento L2: 15.93s
Mejores parámetros L2: {&#39;model__C&#39;: 0.01}
Mejor F1-score L2 (CV): 0.5478
L2 Regression Class Weight: acc=0.760, f1=0.551, time=1.22s
AUC: 0.8535
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   
28                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
29                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
30       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
31       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
27  0.8136      4.0594  
28  0.6425    134.8376  
29  0.6425    140.2210  
30  0.8431      0.8286  
31  0.8535      1.2164  
Análisis L1 vs L2 CON CLASS WEIGHT
Comparación:

L1 Regression Class Weight:
   F1-Score (Macro): 0.5647
   F1 Clase 1:       0.2539
   Recall Clase 1:   0.7532
   Balanced Acc:     0.7708

L2 Regression Class Weight:
   F1-Score (Macro): 0.5511
   F1 Clase 1:       0.2452
   Recall Clase 1:   0.8108
   Balanced Acc:     0.7839

Mejor modelo: L1 Regression Class Weight
   F1-Score (Macro): 0.5647
</pre></div>
</div>
<img alt="_images/7298a7782851afe2a1ef91fa43671556a5aa9418f7f7b1657fd918a2af41373b.png" src="_images/7298a7782851afe2a1ef91fa43671556a5aa9418f7f7b1657fd918a2af41373b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis de selección de características L1
Características con coeficiente cero en L1: 57
Características retenidas en L1: 72
Porcentaje eliminado por L1: 44.2%

Top 10 características más importantes (L1):
                          feature    coef
95           cat__track_genre_pop  2.5602
86         cat__track_genre_metal  2.1763
46       cat__track_genre_electro  2.1023
71         cat__track_genre_indie  2.0621
80         cat__track_genre_k-pop  2.0544
35         cat__track_genre_dance  2.0190
105         cat__track_genre_rock  1.9871
68         cat__track_genre_house  1.9686
17      cat__track_genre_alt-rock  1.8159
18   cat__track_genre_alternative  1.8141
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
Comparación entre todos los modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992
</pre></div>
</div>
</div>
</div>
<p>Analizando los modelos L1 y L2 con Class Weight combinan una regularización para selección de características con balanceo de clases logrando un F1-Score de 0.565, AUC de 0.843 y Accuracy de 0.787 en L1, y F1-Score de 0.551, AUC de 0.854 y Accuracy de 0.760 en L2, dando que el mejor modelo es L1 por superioridad en F1-Score.</p>
<p>En las métricas por clase para L1 se ve en la clase 0 (No Popular) un Precision de 0.944, un Recall de 0.787 y un F1 de 0.859. Y en la clase 1 (Popular) un Precision de 0.191, Recall de 0.753 y un F1 de 0.254, dando un buen equilibrio entre clases.</p>
<p>En el Top Características Identificadas por L1 se muestran los siguientes géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con 2.569</p></li>
<li><p>Metal con 2.176, influencia del rock pesado</p></li>
<li><p>Electro con 2.102</p></li>
<li><p>Indie con 2.062</p></li>
<li><p>K-Pop con 2.054</p></li>
<li><p>Dance con 2.019</p></li>
<li><p>Rock con 1.987</p></li>
<li><p>House con 1.969</p></li>
<li><p>Alt-Rock con 1.816</p></li>
<li><p>Alternative con 1.814</p></li>
</ul>
<p>En la Matriz de Confusión se muestra un alto recall en clase popular donde detecta la mayoría de canciones exitosas, al igual que una baja precision con muchas falsas alarmas, por lo que el modelo da una alerta temprana donde es mejor tener falsos positivos que perder oportunidades reales.</p>
<p>Por lo cual, Regresión Logística L1 con Class Weight da la solución óptima para aplicaciones que priorizan la detección temprana sobre la precision exacta, también un recall del 75% en detección de canciones populares y simplicidad operativa para implementación en producción.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Calcular class weights</span>
<span class="n">class_weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span>
    <span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
    <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>

<span class="c1"># Usar con sample_weight</span>
<span class="n">class_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">weight</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_weights</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class weights calculados: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Proporción de clases: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Custom Ridge Classifier con class weights</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RidgeClassifierWithWeights</span><span class="p">(</span><span class="n">RidgeClassifier</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># usar los pesos calculados</span>
        <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">class_idx</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">class_weight_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sample_weight</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="n">class_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

<span class="c1"># Pipeline principal</span>
<span class="n">pipe_ridge</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifierWithWeights</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Optimización de hiperparámetros </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
    <span class="s1">&#39;model__solver&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;svd&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesky&#39;</span><span class="p">,</span> <span class="s1">&#39;lsqr&#39;</span><span class="p">,</span> <span class="s1">&#39;sparse_cg&#39;</span><span class="p">,</span> <span class="s1">&#39;sag&#39;</span><span class="p">,</span> <span class="s1">&#39;saga&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_ridge</span><span class="p">,</span> 
    <span class="n">param_grid</span><span class="p">,</span> 
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>
<span class="n">result_ridge_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                         <span class="s2">&quot;Ridge Classifier Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_ridge_classweight</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RIDGE CLASSIFIER CLASS WEIGHT&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="n">auc_value</span> <span class="o">=</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">auc_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;AUC:                 No disponible&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># SOLUCIÓN: Crear modelo calibrado para obtener probabilidades</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creando modelo calibrado para obtener curva ROC...&quot;</span><span class="p">)</span>
<span class="n">calibrated_model</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Crear pipeline para el modelo calibrado</span>
<span class="n">calibrated_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">calibrated_model</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Entrenar el modelo calibrado</span>
<span class="n">calibrated_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Obtener probabilidades calibradas</span>
<span class="n">y_calibrated_proba</span> <span class="o">=</span> <span class="n">calibrated_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_calibrated_proba_pos</span> <span class="o">=</span> <span class="n">y_calibrated_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Calcular métricas ROC con probabilidades calibradas</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_calibrated_proba_pos</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># SOLUCIÓN: Curva ROC con el modelo calibrado</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Ridge Classifier Class Weight (Calibrado)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Ridge Classifier Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Ridge Classifier&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RIDGE CLASSIFIER CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC (Calibrado): </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - Alpha: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Solver: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Class weights: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span>

<span class="s2">Nota: Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Actualizar el AUC en results_df con el valor calibrado</span>
<span class="n">ridge_idx</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ridge_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ridge_idx</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Ridge Classifier Class Weight vs otros modelos</span>
    <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Ridge Classifier Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Custom implementation con class weights&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Alpha óptimo: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Solver: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weights aplicados: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Class weights calculados: {0: 0.5252931788217334, 1: 10.3840877914952}
   Proporción de clases: [0.95184941 0.04815059]

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 42 candidates, totalling 210 fits
Tiempo de entrenamiento: 204.84s
Mejores parámetros: {&#39;model__alpha&#39;: 100.0, &#39;model__solver&#39;: &#39;lsqr&#39;}
Mejor F1-score (CV): 0.5425
EVALUACIÓN COMPLETA CON evaluate_model
Ridge Classifier Class Weight: acc=0.744, f1=0.543, time=0.90s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   
28                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
29                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
30       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
31       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
32    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
27  0.8136      4.0594  
28  0.6425    134.8376  
29  0.6425    140.2210  
30  0.8431      0.8286  
31  0.8535      1.2164  
32     NaN      0.8974  
Análisis RIDGE CLASSIFIER CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.7440
Balanced Accuracy:   0.7891
AUC:                 No disponible
F1-score (Weighted): 0.5430
F1-score (Macro):    0.5430

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9891
Recall - No Popular:    0.7392
F1 - No Popular:        0.8461
Precision - Popular:    0.1400
Recall - Popular:       0.8391
F1 - Popular:           0.2400

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 15978     5638]
     Popular   [   176      918]

Desglose:
   Verdaderos Negativos: 15978
   Falsos Positivos:     5638
   Falsos Negativos:     176
   Verdaderos Positivos: 918

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.99      0.74      0.85     21616
     Popular       0.14      0.84      0.24      1094

    accuracy                           0.74     22710
   macro avg       0.56      0.79      0.54     22710
weighted avg       0.95      0.74      0.82     22710


Creando modelo calibrado para obtener curva ROC...
</pre></div>
</div>
<img alt="_images/d01c19677e278a352a1c87724a208109b26d8baf07a6cb6a694cca70b10794c4.png" src="_images/d01c19677e278a352a1c87724a208109b26d8baf07a6cb6a694cca70b10794c4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RIDGE CLASSIFIER CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.744
   - AUC (Calibrado): 0.862
   - F1-Score (Macro): 0.543 
   - Balanced Accuracy: 0.789 
   - Tiempo entrenamiento: 0.90s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.989 | Recall: 0.739 | F1: 0.846
   - CLASE 1 (Popular): 
        Precision: 0.140 | Recall: 0.839 | F1: 0.240

Hiperparámetros óptimos:
   - Alpha: 100.0
   - Solver: lsqr
   - Class weights: {0: 0.5252931788217334, 1: 10.3840877914952}

Nota: Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC


Top 10 características importantes:
                            feature    coef
0                  num__duration_ms  0.0008
65     cat__track_genre_heavy-metal  0.0008
95             cat__track_genre_pop  0.0008
94           cat__track_genre_piano  0.0008
93           cat__track_genre_party  0.0008
92          cat__track_genre_pagode  0.0008
91           cat__track_genre_opera  0.0008
90         cat__track_genre_new-age  0.0008
89             cat__track_genre_mpb  0.0008
88  cat__track_genre_minimal-techno  0.0008
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034 0.861619    0.897364
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Ridge Classifier Class Weight se encuentra en la posición #33 de 33 modelos

Información:
   - Custom implementation con class weights
   - Alpha óptimo: 100.0
   - Solver: lsqr
   - Class weights aplicados: {0: 0.5252931788217334, 1: 10.3840877914952}
   - Se utilizó CalibratedClassifierCV para obtener probabilidades y calcular AUC
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Ridge Classifier con Class Weight implementa una estrategia de regularización L2 combinada con balanceo agresivo de clases, logrando un F1-Score de 0.543 y un alpha de 100.0 con alta regularización</p>
<p>En la clase 0 (No Popular) da un Precision de 0.989, Recall de 0.739 y F1 de 0.846.
En la clase 1 (Popular) da un Precision de 0.140, Recall de 0.839 y F1 de 0.240.</p>
<p>En recall del 84% en clase popular es el más alto de todos los modelos, un Precision bajo del 14%, dando así un alto costo en falsos positivos</p>
<p>En la Matriz de Confusión se muestra el siguiente comportamiento</p>
<p>Verdaderos Negativos: 15,978 (70.4%)
Falsos Positivos: 5,638 (24.8%)<br />
Falsos Negativos: 176 (0.8%)<br />
Verdaderos Positivos: 918 (4.0%)</p>
<p>Esto muestra que solo 176 falsos negativos, es decir, prácticamente no se pierden canciones populares, 5,638 falsos positivos y 918 de 1,094 populares reales.</p>
<p>En el Top de Características se muestran los siguientes patrones de géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con 1.011</p></li>
<li><p>Metal con 0.909</p></li>
<li><p>Electro con 0.891</p></li>
<li><p>K-Pop con 0.884</p></li>
<li><p>Indie con 0.881</p></li>
<li><p>Dance con 0.877</p></li>
<li><p>Rock con 0.876</p></li>
<li><p>House con 0.862</p></li>
<li><p>Alternative con 0.809</p></li>
<li><p>Alt-Rock con 0.808</p></li>
</ul>
<p>Esto muestra que enfocarse en géneros como Pop, Metal, Electro, K-Pop confirmados puede desarrollar estrategias cross-género.</p>
<p>Así, Ridge Classifier con Class Weight es la solución óptima para aplicaciones que priorizan la cobertura máxima sobre la precision exacta con el recall del 84% para no perder oportunidades.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir valores de C para Lasso</span>
<span class="n">LASSO_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

<span class="c1"># Pipeline para Lasso con class_weight</span>
<span class="n">lasso_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span> 
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">lasso_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">LASSO_C_VALUES</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para Lasso con Class Weight&quot;</span><span class="p">)</span>
<span class="n">lasso_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lasso_classweight_pipeline</span><span class="p">,</span>
    <span class="n">lasso_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_C_VALUES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final Lasso con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">result_lasso_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                         <span class="s2">&quot;Lasso Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados LASSO CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Contar características con coeficiente cero</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_total_coef</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Penalty: L1 (Lasso)</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Selección de características:</span>
<span class="s2">   - Características con coeficiente cero: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span>
<span class="s2">   - Características retenidas: </span><span class="si">{</span><span class="n">n_total_coef</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_zero_coef</span><span class="si">}</span>
<span class="s2">   - Porcentaje de características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="n">n_total_coef</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso Class Weight vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_total_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="n">n_total_coef</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hiperparámetro C óptimo: </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros para Lasso con Class Weight
Combinaciones Class Weight: 6 × 5 folds = 30 modelos
Fitting 5 folds for each of 6 candidates, totalling 30 fits
Optimización Class Weight completada en 477.23s
Mejores parámetros: {&#39;model__C&#39;: 0.01}
Mejor F1-score (CV): 0.5662
Lasso Class Weight: acc=0.787, f1=0.565, time=0.88s
AUC: 0.8431
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   
28                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
29                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
30       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
31       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
32    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
33               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
27  0.8136      4.0594  
28  0.6425    134.8376  
29  0.6425    140.2210  
30  0.8431      0.8286  
31  0.8535      1.2164  
32     NaN      0.8974  
33  0.8431      0.8832  
Análisis LASSO CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.7867
Balanced Accuracy:   0.7708
AUC:                 0.8431
F1-score (Weighted): 0.5647
F1-score (Macro):    0.5647

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9844
Recall - No Popular:    0.7884
F1 - No Popular:        0.8756
Precision - Popular:    0.1527
Recall - Popular:       0.7532
F1 - Popular:           0.2539

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 17043     4573]
     Popular   [   270      824]

Desglose:
   Verdaderos Negativos: 17043
   Falsos Positivos:     4573
   Falsos Negativos:     270
   Verdaderos Positivos: 824

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.79      0.88     21616
     Popular       0.15      0.75      0.25      1094

    accuracy                           0.79     22710
   macro avg       0.57      0.77      0.56     22710
weighted avg       0.94      0.79      0.85     22710
</pre></div>
</div>
<img alt="_images/ff0652ee511954a2cd045d7d914d35c2fcd3764ba25b13160a66c78edc2ec080.png" src="_images/ff0652ee511954a2cd045d7d914d35c2fcd3764ba25b13160a66c78edc2ec080.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados LASSO CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.787
   - AUC: 0.843 
   - F1-Score (Macro): 0.565 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 0.88s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.984 | Recall: 0.788 | F1: 0.876
   - CLASE 1 (Popular): 
        Precision: 0.153 | Recall: 0.753 | F1: 0.254

Hiperparámetros óptimos:
   - C: 0.01
   - Penalty: L1 (Lasso)
   - Class weight: balanced

Selección de características:
   - Características con coeficiente cero: 57
   - Características retenidas: 72
   - Porcentaje de características eliminadas: 44.2%


Top 10 características importantes:
                          feature    coef
95           cat__track_genre_pop  2.5602
86         cat__track_genre_metal  2.1763
46       cat__track_genre_electro  2.1023
71         cat__track_genre_indie  2.0621
80         cat__track_genre_k-pop  2.0544
35         cat__track_genre_dance  2.0190
105         cat__track_genre_rock  1.9871
68         cat__track_genre_house  1.9686
17      cat__track_genre_alt-rock  1.8159
18   cat__track_genre_alternative  1.8141
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Lasso Class Weight se encuentra en la posición #34 de 34 modelos

Información:
   - Regularización L1 (Lasso) para selección de características
   - Class weight: balanced para manejar desbalance
   - Características eliminadas: 57 de 129 (44.2%)
   - Hiperparámetro C óptimo: 0.01
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Lasso con Class Weight combina la regularización L1 para selección de características con balanceo de clases logrando un F1-Score de 0.565, un AUC de 0.843 dando buena capacidad discriminativa y un Accuracy de 0.787.</p>
<p>En la clase 0 (No Popular) se da un Precision de 0.984, un Recall de 0.788 y un F1 de 0.876.
En la clase 1 (Popular) se da un Precision de 0.153, un Recall de 0.753 y un F1 de 0.254.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones:</p>
<p>Verdaderos Negativos: 17,043 (75.0%)
Falsos Positivos: 4,573 (20.1%)<br />
Falsos Negativos: 270 (1.2%)<br />
Verdaderos Positivos: 824 (3.6%)</p>
<p>Mostrando solo 270 falsos negativos, donde prácticamente no se pierden oportunidades, 4,573 falsos positivos, y 824 de 1,094 populares reales.</p>
<p>En el Top Características Identificadas se muestran los siguientes géneros Más Influyentes:</p>
<ul class="simple">
<li><p>Pop con 2.560</p></li>
<li><p>Metal con 2.176</p></li>
<li><p>Electro con 2.102</p></li>
<li><p>Indie con 2.062</p></li>
<li><p>K-Pop con 2.054</p></li>
<li><p>Dance con 2.019</p></li>
<li><p>Rock con 1.987</p></li>
<li><p>House con 1.969</p></li>
<li><p>Alt-Rock con 1.816</p></li>
<li><p>Alternative con 1.814</p></li>
</ul>
<p>Esto muestra una segmentación de mercado por géneros de alto impacto, una planificación de producción basada en datos y evaluación de tendencias con métricas cuantificables.</p>
<p>Por lo cual, Lasso con Class Weight emerge como la solución óptima para implementaciones prácticas en la industria musical que priorizan eficiencia, interpretabilidad y velocidad sobre máxima precision. Permite a las disqueras y artistas optimizar inversiones en producción al enfocarse en géneros probados como Pop, Metal y Electro, mientras reduce riesgos mediante decisiones basadas en datos comprobables en lugar de la intuición, todo con una implementación rápida y costo-eficiente que maximiza el retorno comercial.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para Decision Tree</span>
<span class="n">DT_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">DT_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">DT_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">DT_CRITERION</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización Decision Tree con Class Weight&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para Decision Tree con class_weight</span>
<span class="n">dt_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>  
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">dt_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">DT_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">,</span>
    <span class="s1">&#39;model__criterion&#39;</span><span class="p">:</span> <span class="n">DT_CRITERION</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para Decision Tree con Class Weight&quot;</span><span class="p">)</span>
<span class="n">dt_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">dt_classweight_pipeline</span><span class="p">,</span>
    <span class="n">dt_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DT_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> 
                        <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_CRITERION</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final Decision Tree con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model</span>
<span class="n">result_dt_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;Decision Tree Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dt_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis DECISION TREE CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Decision Tree Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Decision Tree Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Decision Tree&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Decision Tree Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados DECISION TREE CLASS WEIGHT&quot;</span><span class="p">)</span>
<span class="c1"># Información del árbol</span>
<span class="n">tree_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">tree_depth</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span>
<span class="n">n_leaves</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del árbol:</span>
<span class="s2">   - Profundidad: </span><span class="si">{</span><span class="n">tree_depth</span><span class="si">}</span>
<span class="s2">   - Número de hojas: </span><span class="si">{</span><span class="n">n_leaves</span><span class="si">}</span>
<span class="s2">   - Criterio: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">criterion</span><span class="si">}</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - criterion: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__criterion&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Decision Tree Class Weight vs otros modelos</span>
    <span class="n">dt_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Decision Tree Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decision Tree Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">dt_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Decision Tree Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad óptima: </span><span class="si">{</span><span class="n">tree_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hojas: </span><span class="si">{</span><span class="n">n_leaves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Criterio: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">criterion</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - min_samples_split: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Optimización Decision Tree con Class Weight

Búsqueda de hiperparámetros para Decision Tree con Class Weight
Combinaciones Class Weight: 224 × 5 folds = 1120 modelos
Fitting 5 folds for each of 224 candidates, totalling 1120 fits
Optimización Class Weight completada en 815.52s
Mejores parámetros: {&#39;model__criterion&#39;: &#39;gini&#39;, &#39;model__max_depth&#39;: None, &#39;model__min_samples_leaf&#39;: 2, &#39;model__min_samples_split&#39;: 2}
Mejor F1-score (CV): 0.6392
Decision Tree Class Weight: acc=0.918, f1=0.617, time=4.59s
AUC: 0.6399
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   
28                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
29                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
30       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
31       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
32    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
33               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
34       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
27  0.8136      4.0594  
28  0.6425    134.8376  
29  0.6425    140.2210  
30  0.8431      0.8286  
31  0.8535      1.2164  
32     NaN      0.8974  
33  0.8431      0.8832  
34  0.6399      4.5864  
Análisis DECISION TREE CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.9181
Balanced Accuracy:   0.6376
AUC:                 0.6399
F1-score (Weighted): 0.6172
F1-score (Macro):    0.6172

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9653
Recall - No Popular:    0.9480
F1 - No Popular:        0.9566
Precision - Popular:    0.2414
Recall - Popular:       0.3272
F1 - Popular:           0.2778

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20491     1125]
     Popular   [   736      358]

Desglose:
   Verdaderos Negativos: 20491
   Falsos Positivos:     1125
   Falsos Negativos:     736
   Verdaderos Positivos: 358

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.95      0.96     21616
     Popular       0.24      0.33      0.28      1094

    accuracy                           0.92     22710
   macro avg       0.60      0.64      0.62     22710
weighted avg       0.93      0.92      0.92     22710
</pre></div>
</div>
<img alt="_images/37a4c941a62c9c52251e54e3e2c1a2e9a7b4423989304b0e8ed2c55d2fd03311.png" src="_images/37a4c941a62c9c52251e54e3e2c1a2e9a7b4423989304b0e8ed2c55d2fd03311.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados DECISION TREE CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.918
   - AUC: 0.640 
   - F1-Score (Macro): 0.617 
   - Balanced Accuracy: 0.638 
   - Tiempo entrenamiento: 4.59s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.965 | Recall: 0.948 | F1: 0.957
   - CLASE 1 (Popular): 
        Precision: 0.241 | Recall: 0.327 | F1: 0.278

Información del árbol:
   - Profundidad: 70
   - Número de hojas: 5070
   - Criterio: gini
   - Class weight: balanced

Hiperparámetros óptimos:
   - max_depth: None
   - min_samples_split: 2
   - min_samples_leaf: 2
   - criterion: gini


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.1026
7       num__acousticness      0.0856
2             num__energy      0.0720
11             num__tempo      0.0673
9           num__liveness      0.0640
6        num__speechiness      0.0625
0        num__duration_ms      0.0624
4           num__loudness      0.0590
1       num__danceability      0.0550
10           num__valence      0.0537
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    4.586393
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    4.586393
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6773
   Accuracy: 0.9454
   AUC:      0.8992

Decision Tree Class Weight se encuentra en la posición #35 de 35 modelos

Información:
   - Class weight: balanced para manejar desbalance
   - Profundidad óptima: 70
   - Hojas: 5070
   - Criterio: gini
   - max_depth: None
   - min_samples_split: 2
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Árbol de Decisión con Class Weight logra un F1-Score de 0.616 y un Accuracy de 0.917</p>
<p>En la clase 0 (No Popular) da un Precision de 0.965, Recall de 0.947 y F1 0.956.
En la clase 1 (Popular) da un Precision de 0.238, Recall de 0.327 y F1 de 0.276.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones:
Verdaderos Negativos: 20,471 (90.1%)
Falsos Positivos: 1,145 (5.0%)<br />
Falsos Negativos: 736 (3.2%)<br />
Verdaderos Positivos: 358 (1.6%)</p>
<p>Muestra solo 1,145 falsos positivos, falsos negativos moderados y 358 de 1,094 populares reales</p>
<p>En el Top de Características Técnicas Más Importantes se muestra:</p>
<ul class="simple">
<li><p>Instrumentalness con 0.102</p></li>
<li><p>Acousticness con 0.085</p></li>
<li><p>Energy con 0.073</p></li>
<li><p>Tempo con 0.068</p></li>
<li><p>Liveness con 0.065</p></li>
</ul>
<p>Se ven géneros como Electro, Indie, Metal y Pop.</p>
<p>Por lo cual, el modelo Árbol de Decisión con Class Weight es la solución óptima para aplicaciones que priorizan la transparencia, eficiencia operativa y minimización de falsos positivos sobre la cobertura máxima. Para la industria musical, representa la herramienta ideal para sistemas de preselección automatizada donde cada falso positivo tiene un costo operativo tangible, permitiendo a equipos de A&amp;R enfocarse en material genuinamente prometedor mientras mantiene total transparencia en el proceso de decision-making.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para Random Forest</span>
<span class="n">RF_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">RF_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">RF_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">RF_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización Random Forest con Class Weight&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para Random Forest con class_weight</span>
<span class="n">rf_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
        <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">rf_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">RF_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">RF_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_LEAF</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para Random Forest con Class Weight&quot;</span><span class="p">)</span>
<span class="n">rf_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">rf_classweight_pipeline</span><span class="p">,</span>
    <span class="n">rf_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RF_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                        <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_LEAF</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final Random Forest con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model</span>
<span class="n">result_rf_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;Random Forest Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RANDOM FOREST CLASS WEIGHT&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Random Forest Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Random Forest&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reultados RANDOM FOREST CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Información del Random Forest</span>
<span class="n">rf_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_features_in_</span>

<span class="c1"># características importantes </span>
<span class="n">n_important_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del Random Forest:</span>
<span class="s2">   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span>
<span class="s2">   - Características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest Class Weight vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ensemble de </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2"> árboles&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Bootstrap: True&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Optimización Random Forest con Class Weight

Búsqueda de hiperparámetros para Random Forest con Class Weight
Combinaciones Class Weight: 135 × 5 folds = 675 modelos
Fitting 5 folds for each of 135 candidates, totalling 675 fits
Optimización Class Weight completada en 3785.14s
Mejores parámetros: {&#39;model__max_depth&#39;: None, &#39;model__min_samples_leaf&#39;: 4, &#39;model__min_samples_split&#39;: 10, &#39;model__n_estimators&#39;: 200}
Mejor F1-score (CV): 0.6942
Random Forest Class Weight: acc=0.939, f1=0.697, time=17.97s
AUC: 0.9127
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   
28                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
29                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
30       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
31       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
32    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
33               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
34       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   
35       Random Forest Class Weight    0.9395     0.9447  0.9395    0.6966   

       AUC  Train_Time  
0   0.8431      0.9011  
1   0.7255      0.5779  
2   0.8431      0.9191  
3   0.6043      9.3873  
4   0.9015     11.6153  
5   0.8791      2.7068  
6   0.7936     34.6723  
7   0.7842      1.5429  
8   0.7842      2.1784  
9   0.8432      2.8730  
10  0.8432      2.8242  
11  0.8554   2788.0202  
12  0.8432      1.9366  
13  0.8432      1.8110  
14  0.7405      7.5556  
15  0.7156      5.4582  
16  0.8992     24.5057  
17  0.8992     22.5961  
18  0.8590      3.2425  
19  0.8590      3.1980  
20  0.7862      1.3265  
21  0.7857      1.6794  
22  0.8456      2.2850  
23  0.8537      2.9832  
24     NaN      2.9905  
25  0.8456      2.5540  
26  0.8914     21.8316  
27  0.8136      4.0594  
28  0.6425    134.8376  
29  0.6425    140.2210  
30  0.8431      0.8286  
31  0.8535      1.2164  
32     NaN      0.8974  
33  0.8431      0.8832  
34  0.6399      4.5864  
35  0.9127     17.9692  
Análisis RANDOM FOREST CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.9395
Balanced Accuracy:   0.7139
AUC:                 0.9127
F1-score (Weighted): 0.6966
F1-score (Macro):    0.6966

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9726
Recall - No Popular:    0.9635
F1 - No Popular:        0.9681
Precision - Popular:    0.3920
Recall - Popular:       0.4644
F1 - Popular:           0.4251

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20828      788]
     Popular   [   586      508]

Desglose:
   Verdaderos Negativos: 20828
   Falsos Positivos:     788
   Falsos Negativos:     586
   Verdaderos Positivos: 508

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.96      0.97     21616
     Popular       0.39      0.46      0.43      1094

    accuracy                           0.94     22710
   macro avg       0.68      0.71      0.70     22710
weighted avg       0.94      0.94      0.94     22710
</pre></div>
</div>
<img alt="_images/9f4b75f89804b7bb609483c5d67f4d8d3030b4954146bcef3f062963125cff63.png" src="_images/9f4b75f89804b7bb609483c5d67f4d8d3030b4954146bcef3f062963125cff63.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reultados RANDOM FOREST CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.939
   - AUC: 0.913 
   - F1-Score (Macro): 0.697 
   - Balanced Accuracy: 0.714 
   - Tiempo entrenamiento: 17.97s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.973 | Recall: 0.964 | F1: 0.968
   - CLASE 1 (Popular): 
        Precision: 0.392 | Recall: 0.464 | F1: 0.425

Información del Random Forest:
   - Número de árboles: 200
   - Características: 129
   - Características importantes: 16
   - Class weight: balanced

Hiperparámetros óptimos:
   - n_estimators: 200
   - max_depth: None
   - min_samples_split: 10
   - min_samples_leaf: 4


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.0862
2             num__energy      0.0761
7       num__acousticness      0.0727
4           num__loudness      0.0715
0        num__duration_ms      0.0689
9           num__liveness      0.0661
10           num__valence      0.0594
1       num__danceability      0.0588
6        num__speechiness      0.0578
11             num__tempo      0.0570
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    4.586393
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   17.969170
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   17.969170
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    4.586393
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

Mejor modelo: Random Forest Class Weight
   F1-Score: 0.6966
   Accuracy: 0.9395
   AUC:      0.9127

Random Forest Class Weight se encuentra en la posición #36 de 36 modelos

Información:
   - Ensemble de 200 árboles
   - Class weight: balanced para manejar desbalance
   - Características importantes: 16 de 129
   - n_estimators: 200
   - max_depth: None
   - Bootstrap: True
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Random Forest Class Weight muestra un F1-Score de 0.6966, AUC de 0.9127 con capacidad discriminativa, Accuracy de 93.95%, y un Balanced Accuracy de 0.714</p>
<p>En la clase 0 (No Popular) hay un Precision de 97.3%, Recall de 96.4% y F1 de 96.8%
En la clase 1 (Popular) hay un Precision de 39.2%, Recall de 46.4%, y F1 de 42.5%</p>
<p>En la Matriz de Confusión se muestra que 20,828 no populares correctos, 508 populares correctos, 586 falsos negativos (populares no detectados), y 788 falsos positivos, por lo cual detecta una cantidad de canciones populares sin generar demasiados falsos positivos.</p>
<p>En el Top 10 Características se identifica que:</p>
<ul class="simple">
<li><p>instrumentalness con 0.0862</p></li>
<li><p>energy con 0.0761</p></li>
<li><p>acousticness con 0.0727</p></li>
<li><p>loudness con 0.0715</p></li>
<li><p>duration_ms con 0.0689</p></li>
<li><p>liveness con 0.0661</p></li>
<li><p>valence con 0.0594</p></li>
<li><p>danceability con 0.0588</p></li>
<li><p>speechiness con 0.0578</p></li>
<li><p>tempo con 0.0570</p></li>
</ul>
<p>Para los artistas y productoras ayud a detectar un 46% de canciones populares con buena confianza, donde solo 39% de falsos positivos. Puede identificar patrones musicales que funcionan, dando un balance ideal entre detección y precisión</p>
<p>Así, el modelo Random Forest con Class Weight pueden invertir en canciones con alto instrumentalness y energy, optimizar mezcla basado en características importantes, asignar presupuestos de marketing a canciones predichas como populares y guiar decisiones de producción musical</p>
<p>En <strong>XGBOOST</strong> usamos <strong>Scale_Pos_Weight</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;División de datos:&quot;</span><span class="p">)</span>

<span class="c1"># Primero dividir train+val vs test</span>
<span class="n">X_temp</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># Luego dividir train vs validation</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_temp</span>  <span class="c1"># 0.25 * 0.8 = 0.2 para val</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaños finales:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train:      </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Validation: </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test:       </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para XGBoost</span>
<span class="n">XGB_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">]</span>
<span class="n">XGB_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="n">XGB_LEARNING_RATE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">XGB_SUBSAMPLE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

<span class="c1"># Calcular scale_pos_weight solo con training data</span>
<span class="n">scale_pos_weight_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scale pos weight calculado (solo train): </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización XGBOOST&quot;</span><span class="p">)</span>
<span class="c1"># Pipeline para XGBoost con scale_pos_weight</span>
<span class="n">xgb_weight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">scale_pos_weight</span><span class="o">=</span><span class="n">scale_pos_weight_value</span> 
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">xgb_weight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">XGB_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">XGB_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="n">XGB_LEARNING_RATE</span><span class="p">,</span>
    <span class="s1">&#39;model__subsample&#39;</span><span class="p">:</span> <span class="n">XGB_SUBSAMPLE</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros (sin Data Leakage)&quot;</span><span class="p">)</span>
<span class="n">xgb_weight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">xgb_weight_pipeline</span><span class="p">,</span>
    <span class="n">xgb_weight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">n_combos_weight</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XGB_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">XGB_LEARNING_RATE</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_SUBSAMPLE</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones: </span><span class="si">{</span><span class="n">n_combos_weight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Entrenamiento con GridSearchCV correctamente&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cada fold de CV tendrá su propio preprocesamiento sin leakage&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">weight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización completada en </span><span class="si">{</span><span class="n">weight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verificar que no hay superposición</span>
<span class="n">train_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">test_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">val_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_val</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Verificación de particiones:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train ∩ Test:    </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">test_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train ∩ Val:     </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">val_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test ∩ Val:      </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_indices</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">val_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total únicos:    </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">test_indices</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">val_indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación final:&quot;</span><span class="p">)</span>
<span class="c1"># Modelo final </span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model CON TEST SET AISLADO</span>
<span class="n">result_xgb_weight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                  <span class="s2">&quot;XGBoost Scale Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb_weight</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis XGBOOST SCALE WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost Scale Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost Scale Weight&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost Scale Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados XGBOOST SCALE WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Información del XGBoost</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">n_estimators</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">n_features_in_</span>

<span class="c1"># características importantes</span>
<span class="n">n_important_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del XGBoost:</span>
<span class="s2">   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span>
<span class="s2">   - Características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span>
<span class="s2">   - Scale pos weight: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - learning_rate: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - subsample: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__subsample&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Data_Leakage&#39;</span><span class="p">:</span> <span class="s1">&#39;0%&#39;</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del XGBoost Scale Weight vs otros modelos</span>
    <span class="n">xgb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XGBoost Scale Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">XGBoost Scale Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">xgb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre XGBoost Scale Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Gradient Boosting optimizado&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Scale pos weight: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Learning rate: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Max depth: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - DATA LEAKAGE: 0% - Evaluación limpia&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>División de datos:
Tamaños finales:
   Train:      68130 muestras
   Validation: 22710 muestras
   Test:       22710 muestras

Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 64849 muestras (95.2%)
   Clase 1 (Popular):    3281 muestras (4.8%)

Scale pos weight calculado (solo train): 19.77
Optimización XGBOOST

Búsqueda de hiperparámetros (sin Data Leakage)
Combinaciones: 81 × 5 folds = 405 modelos

Entrenamiento con GridSearchCV correctamente
Cada fold de CV tendrá su propio preprocesamiento sin leakage
Fitting 5 folds for each of 81 candidates, totalling 405 fits
Optimización completada en 292.92s
Mejores parámetros: {&#39;model__learning_rate&#39;: 0.2, &#39;model__max_depth&#39;: 9, &#39;model__n_estimators&#39;: 300, &#39;model__subsample&#39;: 0.8}
Mejor F1-score (CV): 0.7415

Verificación de particiones:
   Train ∩ Test:    0
   Train ∩ Val:     0
   Test ∩ Val:      0
   Total únicos:    113550 / 113550
Evaluación final:
XGBoost Scale Weight: acc=0.953, f1=0.755, time=4.71s
AUC: 0.9062
Análisis XGBOOST SCALE WEIGHT
Evaluación detallada:
Accuracy:            0.9530
Balanced Accuracy:   0.7662
AUC:                 0.9062
F1-score (Weighted): 0.7548
F1-score (Macro):    0.7548

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9776
Recall - No Popular:    0.9729
F1 - No Popular:        0.9753
Precision - Popular:    0.5113
Recall - Popular:       0.5594
F1 - Popular:           0.5343

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21031      585]
     Popular   [   482      612]

Desglose:
   Verdaderos Negativos: 21031
   Falsos Positivos:     585
   Falsos Negativos:     482
   Verdaderos Positivos: 612

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.97      0.98     21616
     Popular       0.51      0.56      0.53      1094

    accuracy                           0.95     22710
   macro avg       0.74      0.77      0.75     22710
weighted avg       0.96      0.95      0.95     22710
</pre></div>
</div>
<img alt="_images/5ee6c934b6742d3ae31cb91a6988f3c416f627f931ac878118240b47488b4e24.png" src="_images/5ee6c934b6742d3ae31cb91a6988f3c416f627f931ac878118240b47488b4e24.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados XGBOOST SCALE WEIGHT

Rendimiento general:
   - Accuracy: 0.953
   - AUC: 0.906 
   - F1-Score (Macro): 0.755 
   - Balanced Accuracy: 0.766 
   - Tiempo entrenamiento: 4.71s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.978 | Recall: 0.973 | F1: 0.975
   - CLASE 1 (Popular): 
        Precision: 0.511 | Recall: 0.559 | F1: 0.534

Información del XGBoost:
   - Número de árboles: 300
   - Características: 129
   - Características importantes: 37
   - Scale pos weight: 19.77

Hiperparámetros óptimos:
   - n_estimators: 300
   - max_depth: 9
   - learning_rate: 0.2
   - subsample: 0.8


Top 10 características importantes:
                          feature  importance
81          cat__track_genre_kids      0.0219
76        cat__track_genre_j-idol      0.0197
24        cat__track_genre_brazil      0.0191
50         cat__track_genre_forro      0.0189
86         cat__track_genre_metal      0.0188
29      cat__track_genre_children      0.0188
56          cat__track_genre_goth      0.0178
65   cat__track_genre_heavy-metal      0.0169
89           cat__track_genre_mpb      0.0168
112    cat__track_genre_sertanejo      0.0166
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
3                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
4                     Random Forest    0.9517     0.9330  0.9517    0.5547   
5                           XGBoost    0.9525     0.9376  0.9525    0.5224   
6                               SVM    0.8835     0.9316  0.8835    0.5996   
7             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
8             Naive Bayes con SMOTE    0.6140     0.9525  0.6140    0.4687   
9         Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
10        Logistic Regression SMOTE    0.8610     0.9378  0.8610    0.6032   
11           Ridge Classifier SMOTE    0.9493     0.9237  0.9493    0.5299   
12                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
13                      Lasso SMOTE    0.8610     0.9378  0.8610    0.6032   
14              Decision Tree SMOTE    0.9122     0.9323  0.9122    0.6222   
15              Decision Tree SMOTE    0.9233     0.9295  0.9233    0.6144   
16              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
17              Random Forest SMOTE    0.9454     0.9411  0.9454    0.6773   
18                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
19                    XGBoost SMOTE    0.9063     0.9355  0.9063    0.6316   
20                       KNN ADASYN    0.8907     0.9402  0.8907    0.6350   
21               Naive Bayes ADASYN    0.6067     0.9530  0.6067    0.4648   
22    Logistic Regression L1 ADASYN    0.8568     0.9380  0.8568    0.6006   
23    Logistic Regression L2 ADASYN    0.8575     0.9379  0.8575    0.6005   
24          Ridge Classifier ADASYN    0.8299     0.9409  0.8299    0.5879   
25                     Lasso ADASYN    0.8568     0.9380  0.8568    0.6006   
26             Random Forest ADASYN    0.9278     0.9390  0.9278    0.6625   
27                   XGBoost ADASYN    0.8963     0.9335  0.8963    0.6159   
28                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
29                       SVM ADASYN    0.6408     0.9226  0.6408    0.4508   
30       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
31       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
32    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
33               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
34       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   
35       Random Forest Class Weight    0.9395     0.9447  0.9395    0.6966   
36             XGBoost Scale Weight    0.9530     0.9551  0.9530    0.7548   

       AUC  Train_Time Data_Leakage  
0   0.8431      0.9011           0%  
1   0.7255      0.5779           0%  
2   0.8431      0.9191           0%  
3   0.6043      9.3873           0%  
4   0.9015     11.6153           0%  
5   0.8791      2.7068           0%  
6   0.7936     34.6723           0%  
7   0.7842      1.5429           0%  
8   0.7842      2.1784           0%  
9   0.8432      2.8730           0%  
10  0.8432      2.8242           0%  
11  0.8554   2788.0202           0%  
12  0.8432      1.9366           0%  
13  0.8432      1.8110           0%  
14  0.7405      7.5556           0%  
15  0.7156      5.4582           0%  
16  0.8992     24.5057           0%  
17  0.8992     22.5961           0%  
18  0.8590      3.2425           0%  
19  0.8590      3.1980           0%  
20  0.7862      1.3265           0%  
21  0.7857      1.6794           0%  
22  0.8456      2.2850           0%  
23  0.8537      2.9832           0%  
24     NaN      2.9905           0%  
25  0.8456      2.5540           0%  
26  0.8914     21.8316           0%  
27  0.8136      4.0594           0%  
28  0.6425    134.8376           0%  
29  0.6425    140.2210           0%  
30  0.8431      0.8286           0%  
31  0.8535      1.2164           0%  
32     NaN      0.8974           0%  
33  0.8431      0.8832           0%  
34  0.6399      4.5864           0%  
35  0.9127     17.9692           0%  
36  0.9062      4.7078           0%  
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time Data_Leakage
           XGBoost Scale Weight  0.953016   0.955131 0.953016  0.754762 0.906217    4.707805           0%
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   17.969170           0%
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694           0%
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   22.596140           0%
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621           0%
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482           0%
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.197955           0%
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541           0%
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623           0%
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    4.586393           0%
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417           0%
            Decision Tree SMOTE  0.923294   0.929465 0.923294  0.614409 0.715611    5.458198           0%
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.824188           0%
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050           0%
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607           0%
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.810996           0%
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309           0%
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016           0%
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991           0%
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184           0%
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270           0%
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490           0%
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151           0%
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560           0%
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100           0%
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091           0%
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292           0%
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419           0%
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364           0%
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244           0%
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795           0%
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904           0%
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    2.178358           0%
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352           0%
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575           0%
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  140.220986           0%
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922           0%

Mejor modelo: XGBoost Scale Weight
   F1-Score: 0.7548
   Accuracy: 0.9530
   AUC:      0.9062

XGBoost Scale Weight se encuentra en la posición #37 de 37 modelos

Información:
   - Gradient Boosting optimizado
   - Scale pos weight: 19.77 para manejar desbalance
   - Número de árboles: 300
   - Características importantes: 37 de 129
   - Learning rate: 0.2
   - Max depth: 9
   - DATA LEAKAGE: 0% - Evaluación limpia
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo XGBoost Scale Weight con un F1-Score de 0.7683, AUC de  0.9226, Accuracy de 95.15%, y un Balanced Accuracy: 0.766 - Muy buen balance entre clases</p>
<p>En la clase 0 (No Popular) hay un Precision de 97.7%, Recall de 97.3%, y F1 de 97.5%.
En clase 1 (Popular) hay un Precision 51.1%, Recall de 55.9%, y F1 de 53.4%.</p>
<p>En la Matriz de Confusión se muestra 21,031 no populares correctos (97.3% de recall), 612 populares correctos, 482 falsos negativos y 585 falsos positivos, lo cual máxima detección de canciones populares con mínimos falsos positivos.</p>
<p>En el Top 10 Características del XGBoost se muestra:</p>
<ul class="simple">
<li><p>track_genre_kids (0.0219)</p></li>
<li><p>track_genre_j-idol (0.0197)</p></li>
<li><p>track_genre_brazil (0.0191)</p></li>
<li><p>track_genre_forro (0.0189)</p></li>
<li><p>track_genre_metal (0.0188)</p></li>
<li><p>track_genre_children (0.0188)</p></li>
<li><p>track_genre_goth (0.0178)</p></li>
<li><p>track_genre_heavy-metal (0.0169)</p></li>
<li><p>track_genre_mpb (0.0168)</p></li>
<li><p>track_genre_sertanejo (0.0166)</p></li>
</ul>
<p>Así, géneros regionales como brazil, forro, sertanejo o mpb son muy importantes, y géneros temáticos como kids, children y goth son clave, donde la popularidad depende más de audiencias específicas y leales que de características musicales universales.</p>
<p>Para los artistas y productoras se puede implementar este modelo pues etecta 56% de canciones populares, olo 51% de falsos positivos e identifica nichos de mercado específicos</p>
<p>También, la popularidad en Spotify está más determinada por géneros de nicho con audiencias leales que por características musicales universales o géneros mainstream.”</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 0. DEFINICIÓN DE VARIABLES</span>
<span class="c1"># ============================================================</span>

<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 1. TRAIN/TEST SPLIT</span>
<span class="c1"># ============================================================</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 2. PREPROCESAMIENTO</span>
<span class="c1"># ============================================================</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 3. DEFINICIÓN SVM CLASS WEIGHT</span>
<span class="c1"># ============================================================</span>

<span class="n">SVM_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">SVM_KERNEL</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
<span class="n">SVM_GAMMA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>

<span class="n">svm_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">svm_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SVM_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__kernel&#39;</span><span class="p">:</span> <span class="n">SVM_KERNEL</span><span class="p">,</span>
    <span class="s1">&#39;model__gamma&#39;</span><span class="p">:</span> <span class="n">SVM_GAMMA</span>
<span class="p">}</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 4. GRID SEARCH</span>
<span class="c1"># ============================================================</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda hiperparámetros SVM Class Weight&quot;</span><span class="p">)</span>

<span class="n">svm_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">svm_classweight_pipeline</span><span class="p">,</span>
    <span class="n">svm_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo búsqueda: </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-macro CV: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 5. MODELO FINAL</span>
<span class="c1"># ============================================================</span>

<span class="n">final_model</span> <span class="o">=</span> <span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                        <span class="s2">&quot;SVM Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;probabilities&quot;</span><span class="p">]</span>

<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS DETALLADAS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 6. MATRIZ DE CONFUSIÓN</span>
<span class="c1"># ============================================================</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPop  → Pred NoPop: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">, Pred Pop: </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real Pop    → Pred NoPop: </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">, Pred Pop: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 7. GRAFICAS</span>
<span class="c1"># ============================================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC=</span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span><span class="n">tpr</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC - SVM Class Weight&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Matriz de confusión gráfica</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión&quot;</span><span class="p">)</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 8. PERMUTATION IMPORTANCE (CON FIX UNIVERSAL)</span>
<span class="c1"># ============================================================</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Calculando permutation importance...&quot;</span><span class="p">)</span>
<span class="n">start_perm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">perm_importance</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span>
    <span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">n_repeats</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo PI: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_perm</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Nombres reales de columnas del preprocessor</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>

<span class="c1"># ---- 🔥 FIX UNIVERSAL ----</span>
<span class="n">n_real</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">)</span>
<span class="n">n_feat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>

<span class="k">if</span> <span class="n">n_feat</span> <span class="o">!=</span> <span class="n">n_real</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠ Ajustando dimensiones: features=</span><span class="si">{</span><span class="n">n_feat</span><span class="si">}</span><span class="s2"> → importances=</span><span class="si">{</span><span class="n">n_real</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[:</span><span class="n">n_real</span><span class="p">]</span>
<span class="c1"># --------------------------</span>

<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">,</span>
    <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">perm_importance</span><span class="o">.</span><span class="n">importances_std</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

<span class="c1"># Gráfica de PI</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top 15 Features – Permutation Importance&quot;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="c1"># Métricas por clase</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span>    <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span>        <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">recall_1</span>    <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f1_1</span>        <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s1">&#39;Prec 0&#39;</span><span class="p">,</span><span class="s1">&#39;Rec 0&#39;</span><span class="p">,</span><span class="s1">&#39;F1 0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s1">&#39;Prec 1&#39;</span><span class="p">,</span><span class="s1">&#39;Rec 1&#39;</span><span class="p">,</span><span class="s1">&#39;F1 1&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Métricas por clase&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># ============================================================</span>
<span class="c1"># 9. TOP 10 FEATURES</span>
<span class="c1"># ============================================================</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 features más importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución entrenamiento:
   Clase 0: 86466 (95.2%)
   Clase 1: 4374 (4.8%)

Búsqueda hiperparámetros SVM Class Weight
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo búsqueda: 2569.64s
Mejores parámetros: {&#39;model__C&#39;: 100, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;}
Mejor F1-macro CV: 0.4730
SVM Class Weight: acc=0.688, f1=0.477, time=78.10s
AUC: 0.6782

MÉTRICAS DETALLADAS:
Accuracy:            0.6885
Balanced Accuracy:   0.6207
AUC:                 0.6782
F1-score (Macro):    0.4770

Matriz de confusión:
Real NoPop  → Pred NoPop: 15038, Pred Pop: 6578
Real Pop    → Pred NoPop: 497, Pred Pop: 597

Calculando permutation importance...
Tiempo PI: 46.36s
⚠ Ajustando dimensiones: features=129 → importances=15
</pre></div>
</div>
<img alt="_images/f253882f1c4ee3218b071e6ce12021806073c6a904196b15d448d5085461ea95.png" src="_images/f253882f1c4ee3218b071e6ce12021806073c6a904196b15d448d5085461ea95.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 10 features más importantes:
                  feature  importance       std
14     cat__explicit_True    0.010985  0.001180
9           num__liveness    0.002970  0.000558
8   num__instrumentalness    0.002370  0.000755
13    cat__explicit_False   -0.000096  0.000284
5               num__mode   -0.001726  0.001673
12    num__time_signature   -0.001989  0.000657
6        num__speechiness   -0.002824  0.000582
3                num__key   -0.004317  0.000838
11             num__tempo   -0.004429  0.001024
10           num__valence   -0.004562  0.000891
</pre></div>
</div>
</div>
</div>
<p>En el análisis de métricas del modelo SVM con Class Weightn F1-Score de 0.4770, AUC de 0.6782, Accuracy de 68.85%, y uun Balanced Accuracy de 0.621, siendo muy bajas métricas</p>
<p>En la clase 0 (No Popular) hay un Precision de 96.8%, Recall de 69.6%, y F1 de 81.0%
En la clase 1 (Popular) hay un Precision de 8.3%, Recall de 54.6%, y F1 de 14.4%</p>
<p>En la Matriz de Confusión se muestra que 15,938 no populares correctos, 597 populares correctos, 6,578 falsos positivos y 497 falsos negativos. Por lo cual modelo genera demasiados falsos positivos, clasificando incorrectamente 6,578 canciones no populares como populares.</p>
<p>Así, para las disqueras, solo 8.3% de precisión para canciones populares, hay 6,578 falsos positivos, siendo mucho “ruido” en las predicciones, y un costo muy alto de implementación por baja calidad</p>
<p>Tampoco es confiable para decisiones de inversión, generaría muchas pérdidas por falsos positivos y no identifica patrones útiles para producción musical</p>
<p>Por lo tanto, SVM con Class Weight es el peor modelo evaluado para aplicaciones prácticas en la industria musical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># CELDA: Selección del mejor modelo y panel de métricas (copia/pega completa)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span>

<span class="c1"># ---- 1) Localizar &quot;best_technique&quot; o construirlo desde `results` / `results_df` ----</span>
<span class="k">if</span> <span class="s1">&#39;best_technique&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">bt</span> <span class="o">=</span> <span class="n">best_technique</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usando variable existente: best_technique&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">bt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">best_entry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">best_entry</span> <span class="o">=</span> <span class="n">r</span>

        <span class="k">if</span> <span class="n">best_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bt</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;technique&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">),</span>
                <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auc&#39;</span><span class="p">),</span>
                <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;cv_time&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cv_time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pipeline&#39;</span><span class="p">),</span>
                <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predictions&#39;</span><span class="p">),</span>
                <span class="s1">&#39;y_proba&#39;</span><span class="p">:</span> <span class="n">best_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;probabilities&#39;</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="k">elif</span> <span class="s1">&#39;results_df&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;f1&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">results_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;technique&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">),</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">),</span>
            <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AUC&#39;</span><span class="p">),</span>
            <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">),</span>
            <span class="s1">&#39;cv_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;y_proba&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

<span class="k">if</span> <span class="n">bt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No se pudo construir `best_technique`.&quot;</span><span class="p">)</span>

<span class="c1"># ---- 2) Obtener y_pred y y_proba ----</span>
<span class="n">best_pipeline</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pipeline&#39;</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y_pred&#39;</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y_proba&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">y_pred</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">best_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="k">if</span> <span class="n">y_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No se pudo obtener y_pred.&quot;</span><span class="p">)</span>

<span class="c1"># === FIX DEFINITIVO: Asegurar probas 1D ===</span>
<span class="k">if</span> <span class="n">y_proba</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">best_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">y_proba_raw</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba_raw</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Si siguen viniendo como (n,2), usar la columna positiva</span>
<span class="k">if</span> <span class="n">y_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_proba</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">y_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">y_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># ---- 3) Calcular métricas ----</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
<span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">y_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error calculando ROC/AUC:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># ---- 4) Graficar ----</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Métricas principales</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;F1 Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">auc_score</span> <span class="k">if</span> <span class="n">auc_score</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Métricas - </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span><span class="o">+</span><span class="n">b</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">v</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión&quot;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clase 0&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mf">0.15</span><span class="p">,</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clase 1&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;Precision&quot;</span><span class="p">,</span> <span class="s2">&quot;Recall&quot;</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">auc_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;Sin probabilidades - No hay ROC&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC - AUC=</span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ---- 5) Resumen ----</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resumen del mejor modelo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Técnica: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-macro: </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">auc_score</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No disponible&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/57d8d0f4cf08b1ec57d2d896dc46bf70119d0c71c645ed3814be1b30ac67cf67.png" src="_images/57d8d0f4cf08b1ec57d2d896dc46bf70119d0c71c645ed3814be1b30ac67cf67.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen del mejor modelo:
------------------------------------------------------------
Técnica: XGBoost Scale Weight
Accuracy: 0.9530
F1-macro: 0.7548
AUC: 0.9062174178311955
------------------------------------------------------------
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="optimizacion-computacional">
<h1>Optimización Computacional<a class="headerlink" href="#optimizacion-computacional" title="Permalink to this heading">#</a></h1>
<p>La siguiente sección del trabajo es ejercer otras formas de ejecutar y visualizar los modelos con mejores funciones optimizadas para comparar resultados</p>
<p><strong>KNN con KD-TREES</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># CELDA: KNN con KD-Tree (versión robusta — copia/pega)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 1) Verificaciones y fallback</span>
<span class="c1"># ---------------------------</span>
<span class="c1"># Comprueba que X_train, X_test, y_train, y_test existen; si no, intenta crearlos desde df</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span><span class="s1">&#39;y_test&#39;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="s1">&#39;df&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No encuentro X_train/X_test ni el dataframe `df` para crearlos. Ejecuta la celda de preparación de datos primero.&quot;</span><span class="p">)</span>
    <span class="c1"># Intentar usar numeric_features/categorical_features si existen</span>
    <span class="k">if</span> <span class="s1">&#39;numeric_features&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;categorical_features&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># heurística: tomar todas las columnas numéricas + &#39;explicit&#39; + &#39;track_genre&#39; si existen</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">num_cols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># target</span>
    <span class="k">if</span> <span class="s1">&#39;HighPopularity&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;popularity&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No encuentro la columna &#39;popularity&#39; en df para construir la variable objetivo.&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nota: He creado X_train/X_test/y_train/y_test automáticamente desde df.&quot;</span><span class="p">)</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 2) Construir o reusar preprocessor</span>
<span class="c1"># ---------------------------</span>
<span class="k">if</span> <span class="s1">&#39;preprocessor&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">preprocessor_used</span> <span class="o">=</span> <span class="n">preprocessor</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usando preprocessor ya definido en memoria.&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="s1">&#39;full_pipeline&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">preprocessor_used</span> <span class="o">=</span> <span class="n">full_pipeline</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Usando full_pipeline ya definido en memoria.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Crear preprocessor igual que en otras celdas (fallback seguro)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No encontré &#39;preprocessor&#39; ni &#39;full_pipeline&#39; — construyendo uno nuevo (fallback).&quot;</span><span class="p">)</span>
    <span class="c1"># intentar usar las variables numeric_features y categorical_features</span>
    <span class="k">if</span> <span class="s1">&#39;numeric_features&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;categorical_features&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="n">num_feats</span> <span class="o">=</span> <span class="n">numeric_features</span>
        <span class="n">cat_feats</span> <span class="o">=</span> <span class="n">categorical_features</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># heurística</span>
        <span class="n">num_feats</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">cat_feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">X_train</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># pequeño fallback</span>
    <span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
    <span class="p">])</span>
    <span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="p">])</span>
    <span class="n">preprocessor_used</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">cat_feats</span><span class="p">)</span>
    <span class="p">])</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 3) Definir pipeline KNN (KD-Tree) y entrenar</span>
<span class="c1"># ---------------------------</span>
<span class="n">knn_kd</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span>
    <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;kd_tree&quot;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span>
    <span class="n">leaf_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">knn_kd_pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">&quot;preprocessor&quot;</span><span class="p">,</span> <span class="n">preprocessor_used</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">knn_kd</span><span class="p">)</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entrenando KNN (KD-Tree) con pipeline...&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">knn_kd_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entrenamiento completado en </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 4) Predicción y probabilidades (robusto)</span>
<span class="c1"># ---------------------------</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">knn_kd_pipe</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">y_proba</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">y_proba_raw</span> <span class="o">=</span> <span class="n">knn_kd_pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_proba_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_proba_raw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_proba_raw</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">y_proba_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba_raw</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba_raw</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># algunos estimadores no devuelven predict_proba — lo informamos</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: predict_proba no disponible o falló:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">y_proba</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 5) Métricas</span>
<span class="c1"># ---------------------------</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_pos</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_pos</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_pos</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">fpr</span> <span class="o">=</span> <span class="n">tpr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">y_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: error calculando ROC/AUC:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 6) Guardar resultado en `results` si existe o crear</span>
<span class="c1"># ---------------------------</span>
<span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;KNN KD-Tree&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="n">knn_kd_pipe</span><span class="p">,</span>
    <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
    <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">precision_pos</span><span class="p">,</span>
    <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="n">recall_pos</span><span class="p">,</span>
    <span class="s2">&quot;f1_weighted&quot;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
    <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
    <span class="s2">&quot;probabilities&quot;</span><span class="p">:</span> <span class="n">y_proba</span><span class="p">,</span>
    <span class="s2">&quot;auc&quot;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
    <span class="s2">&quot;train_time&quot;</span><span class="p">:</span> <span class="n">train_time</span>
<span class="p">}</span>
<span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 7) Plots (matriz + ROC + métricas)</span>
<span class="c1"># ---------------------------</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Métricas</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;F1-weighted&quot;</span><span class="p">,</span> <span class="s2">&quot;Recall (pos)&quot;</span><span class="p">,</span> <span class="s2">&quot;AUC&quot;</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">recall_pos</span><span class="p">,</span> <span class="n">auc_score</span> <span class="k">if</span> <span class="n">auc_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span> <span class="s2">&quot;salmon&quot;</span><span class="p">,</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Métricas - KNN KD-Tree&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;No Popular&quot;</span><span class="p">,</span><span class="s2">&quot;Popular&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Matriz de Confusión&quot;</span><span class="p">)</span>

<span class="c1"># ROC</span>
<span class="k">if</span> <span class="n">fpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC = </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">);</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;No hay probabilidades para ROC&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Curva ROC - No disponible&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen KNN KD-Tree:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  F1-weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recall (pos): </span><span class="si">{</span><span class="n">recall_pos</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">auc_score</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No disponible&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Usando preprocessor ya definido en memoria.
Entrenando KNN (KD-Tree) con pipeline...
Entrenamiento completado en 3.34s
</pre></div>
</div>
<img alt="_images/52861208eb04ec04da9487522bff060120e68e614feb2633ce19f6704e8a0140.png" src="_images/52861208eb04ec04da9487522bff060120e68e614feb2633ce19f6704e8a0140.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen KNN KD-Tree:
  Accuracy: 0.9506
  F1-weighted: 0.9405
  Recall (pos): 0.1901
  AUC: 0.7825763966227197
</pre></div>
</div>
</div>
</div>
<p>El modelo KNN con KD-Tree optimizado muestra un alto accuracy pero problemas graves para detectar canciones populares.
Teniendo un Accuracy de 94.90% puede predecir correctamente en general, un F1-Weighted de 94.28%, es decir, un buen balance entre precision y recall considerando todas las clases, y un AUC de 0.755, dando la capacidad para distinguir entre clases
En la Matriz de Confusión se muestra que 21,457 canciones no populares correctamente identificadas, 295 canciones populares correctamente detectadas, 799 canciones populares no detectadas (siendo falsos negativos), y 359 falsos positivos, dando que el modelo está clasificando casi todo como “no popular”.</p>
<p>Para las disqueras, este modelo no es confiable para identificar canciones potencialmente populares pues solo captura 1 de cada 4 hits potenciales, dando una pérdida del 73% de oportunidades y prefiere no arriesgarse a predecir popularidad.</p>
<p><strong>Ridge/Lasso</strong> con <strong>Solver SAGA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>

<span class="c1"># subconjunto para velocidad con 25% de los datos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X_train_fast</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_train_fast</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> 
    <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Usando subconjunto optimizado: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_fast</span><span class="p">)</span><span class="si">}</span><span class="s2"> instancias&quot;</span><span class="p">)</span>

<span class="c1"># Configuración</span>
<span class="n">SAGA_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>           <span class="c1"># Solo 3 valores clave</span>
<span class="n">SAGA_PENALTY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">]</span>            <span class="c1"># Ridge y Lasso</span>
<span class="n">SAGA_SOLVER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;saga&#39;</span><span class="p">]</span>                 <span class="c1"># Solver optimizado</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   C: </span><span class="si">{</span><span class="n">SAGA_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   penalty: </span><span class="si">{</span><span class="n">SAGA_PENALTY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   solver: </span><span class="si">{</span><span class="n">SAGA_SOLVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_saga_optimization</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">technique_name</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluando: </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">start_train</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_train</span>
    
    <span class="n">start_predict</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_predict</span>
    
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas </span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train Time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predict Time: </span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="s1">&#39;LogisticRegression&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="n">technique_name</span><span class="p">,</span>
        <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;C=</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">C</span><span class="si">}</span><span class="s2">, penalty=</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">penalty</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">predict_time</span><span class="p">,</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">pipeline</span>
    <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización con Solver SAGA&quot;</span><span class="p">)</span>

<span class="n">saga_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">saga_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SAGA_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__penalty&#39;</span><span class="p">:</span> <span class="n">SAGA_PENALTY</span>
<span class="p">}</span>

<span class="c1"># 2 folds para máxima velocidad</span>
<span class="n">saga_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">saga_pipeline</span><span class="p">,</span>
    <span class="n">saga_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizamos con solver SAGA&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">saga_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_fast</span><span class="p">,</span> <span class="n">y_train_fast</span><span class="p">)</span>
<span class="n">saga_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización SAGA completada en </span><span class="si">{</span><span class="n">saga_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mejores parámetros: </span><span class="si">{</span><span class="n">saga_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluar con todos los datos</span>
<span class="n">saga_best</span> <span class="o">=</span> <span class="n">saga_grid</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">results_saga</span> <span class="o">=</span> <span class="n">evaluate_saga_optimization</span><span class="p">(</span><span class="n">saga_best</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;SAGA (</span><span class="si">{</span><span class="n">saga_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> 
                                        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">saga_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">results_saga</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tabla resumne:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">saga_summary</span><span class="p">[[</span><span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">,</span> <span class="s1">&#39;Configuración&#39;</span><span class="p">,</span> <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">,</span> <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Comparación:</span>

<span class="s2">KNN con KD-Trees:</span>
<span class="s2">   • Tiempo optimización: 1111.49s</span>
<span class="s2">   • Tiempo entrenamiento: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Ridge/Lasso con SAGA:</span>
<span class="s2">   • Tiempo optimización: </span><span class="si">{</span><span class="n">saga_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Tiempo entrenamiento: </span><span class="si">{</span><span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Tiempo predicción: </span><span class="si">{</span><span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • F1-Weighted: </span><span class="si">{</span><span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;F1_Weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Métricas comparativas</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KNN + KD-Trees&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;LR + SAGA</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">saga_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span>
<span class="n">f1_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">f1_weighted</span><span class="p">,</span> <span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;F1_Weighted&#39;</span><span class="p">]]</span>
<span class="n">train_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_time</span><span class="p">,</span> <span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">]]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">train_times</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tiempo Entrenamiento (s)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Modelos&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score / Tiempo (s)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación: KNN vs LogisticRegression Optimizados&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Curva ROC</span>
<span class="n">fpr_saga</span><span class="p">,</span> <span class="n">tpr_saga</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">saga_best</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">roc_auc_saga</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_saga</span><span class="p">,</span> <span class="n">tpr_saga</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;KNN + KD-Trees (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_saga</span><span class="p">,</span> <span class="n">tpr_saga</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;LR + SAGA (AUC = </span><span class="si">{</span><span class="n">roc_auc_saga</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># tabla final</span>
<span class="n">ridge_lasso_results</span> <span class="o">=</span> <span class="n">results_saga</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Usando subconjunto optimizado: 22710 instancias
Configuración:
   C: [0.1, 1, 10]
   penalty: [&#39;l1&#39;, &#39;l2&#39;]
   solver: [&#39;saga&#39;]
Optimización con Solver SAGA
Optimizamos con solver SAGA
Fitting 3 folds for each of 6 candidates, totalling 18 fits
Optimización SAGA completada en 106.97s
   Mejores parámetros: {&#39;model__C&#39;: 1, &#39;model__penalty&#39;: &#39;l1&#39;}

Evaluando: SAGA (L1)
Resultados SAGA (L1):
   Train Time: 152.29s
   Predict Time: 0.0311s
   F1-Weighted: 0.9285
   AUC: 0.8628
   Recall Clase 1: 0.0018

Tabla resumne:
Técnica_Optimización   Configuración  Tiempo_Entrenamiento_s  Tiempo_Predicción_s  F1_Weighted  Recall_Clase_1      AUC
           SAGA (L1) C=1, penalty=l1              152.289871             0.031082     0.928531        0.001828 0.862787

Comparación:

KNN con KD-Trees:
   • Tiempo optimización: 1111.49s
   • Tiempo entrenamiento: 3.34s
   • F1-Weighted: 0.9405

Ridge/Lasso con SAGA:
   • Tiempo optimización: 106.97s
   • Tiempo entrenamiento: 152.29s
   • Tiempo predicción: 0.0311s
   • F1-Weighted: 0.9285
</pre></div>
</div>
<img alt="_images/554099b04e2fa6c41293bafcea08727d520c518efa94e3c609eec6c3559b51b4.png" src="_images/554099b04e2fa6c41293bafcea08727d520c518efa94e3c609eec6c3559b51b4.png" />
</div>
</div>
<p>Analizando los resultados de las métricas se muestra un AUC de 0.8628 y un F1-Weighted de 0.9285.</p>
<p>Este realiza selección de características automática, pone coeficientes de características irrelevantes a cero e ideal para identificar qué variables realmente importan, pero el modelo básicamente aprende a ignorar la clase “popular”.</p>
<p>Sugiere que las características disponibles no son suficientemente predictivas para identificar hits y no es bueno en detectar canciones populares efectivamente.</p>
<p>Por lo que se puede identificar que la popularidad en Spotify depende de factores beyond características técnicas.</p>
<p><strong>Naive Bayes</strong> con <strong>Partial Fit</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Tamaños de lote optimizados</span>
<span class="n">BATCH_SIZES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">]</span>  

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración optimizada con Partial Fit&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Batch Sizes: </span><span class="si">{</span><span class="n">BATCH_SIZES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Modelo: GaussianNB con partial_fit&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_naive_bayes_incremental</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entrena Naive Bayes de forma incremental usando partial_fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entrenando con batch_size = </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ajustar el preprocesador una vez con todos los datos</span>
    <span class="n">X_train_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    
    <span class="c1"># Inicializar el modelo</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">GaussianNB</span><span class="p">()</span>
    
    <span class="c1"># Obtener clases únicas para partial_fit</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    
    <span class="c1"># Entrenamiento por lotes</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X_train_processed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
    
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        
        <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X_train_processed</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="s1">&#39;iloc&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">y_train</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
        
        <span class="c1"># Primera llamada necesita classes, las siguientes no</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        
        <span class="c1"># Progress tracking</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_batches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Procesado lote </span><span class="si">{</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_batches</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="p">(</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_samples</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">n_samples</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> muestras)&quot;</span><span class="p">)</span>
    
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_time</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación con los diferentes lotes&quot;</span><span class="p">)</span>
<span class="n">batch_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">batch_size</span> <span class="ow">in</span> <span class="n">BATCH_SIZES</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Probando batch_size = </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Entrenar modelo incremental</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">fitted_preprocessor</span><span class="p">,</span> <span class="n">train_time</span> <span class="o">=</span> <span class="n">train_naive_bayes_incremental</span><span class="p">(</span>
        <span class="n">preprocessor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span>
    <span class="p">)</span>
    
    <span class="c1"># Transformar test set</span>
    <span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">fitted_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="c1"># tiempo de predicción</span>
    <span class="n">predict_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)</span>
    <span class="n">predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">predict_start</span>
    
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados batch_size </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train Time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predict Time: </span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s1">&#39;preprocessor&#39;</span><span class="p">:</span> <span class="n">fitted_preprocessor</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predict_time&#39;</span><span class="p">:</span> <span class="n">predict_time</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;y_pred_proba&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">})</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selección de mejor tamaño de lote&quot;</span><span class="p">)</span>

<span class="c1"># mejor balance entre velocidad y rendimiento</span>
<span class="n">best_batch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">])</span>
<span class="n">fastest_batch</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor batch_size (rendimiento): </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo entrenamiento: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch_size más rápido: </span><span class="si">{</span><span class="n">fastest_batch</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">fastest_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo entrenamiento: </span><span class="si">{</span><span class="n">fastest_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Usar el mejor batch_size </span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">best_preprocessor</span> <span class="o">=</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparamos con el método tradicional&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entrenando sin partial_fit&quot;</span><span class="p">)</span>
<span class="n">traditional_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">traditional_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">traditional_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">traditional_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">traditional_start</span>

<span class="n">traditional_predict_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">y_pred_traditional</span> <span class="o">=</span> <span class="n">traditional_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">traditional_predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">traditional_predict_start</span>

<span class="n">y_pred_proba_traditional</span> <span class="o">=</span> <span class="n">traditional_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">f1_traditional</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Traditional - Train: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, F1: </span><span class="si">{</span><span class="n">f1_traditional</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Incremental  - Train: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, F1: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Speedup: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tabla resumen&quot;</span><span class="p">)</span>
<span class="n">summary_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">:</span>
    <span class="n">summary_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;partial_fit (batch=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;GaussianNB, batch_size=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;predict_time&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
        <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">],</span>
        <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span>
    <span class="p">})</span>

<span class="c1"># método tradicional</span>
<span class="n">summary_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="s1">&#39;Traditional fit&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="s1">&#39;GaussianNB (batch completo)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">traditional_train_time</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">traditional_predict_time</span><span class="p">,</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">),</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">f1_traditional</span><span class="p">,</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_traditional</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tabla resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Visualizaciones&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Comparación de tiempos</span>
<span class="n">batch_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;batch_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;traditional&#39;</span><span class="p">]</span>
<span class="n">train_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">traditional_train_time</span><span class="p">]</span>
<span class="n">predict_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;predict_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">traditional_predict_time</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">train_times</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tiempo Entrenamiento&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">predict_times</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tiempo Predicción&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Método de Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tiempo (segundos)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación de Tiempos - Naive Bayes&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="c1"># Métricas de rendimiento</span>
<span class="n">f1_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f1_traditional</span><span class="p">]</span>
<span class="n">auc_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_traditional</span><span class="p">)]</span>

<span class="n">x_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">))</span>
<span class="n">width_metrics</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars3</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_metrics</span> <span class="o">-</span> <span class="n">width_metrics</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">,</span> <span class="n">width_metrics</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>
<span class="n">bars4</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_metrics</span> <span class="o">+</span> <span class="n">width_metrics</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">auc_scores</span><span class="p">,</span> <span class="n">width_metrics</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Método de Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación de Métricas - Naive Bayes&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_metrics</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars3</span><span class="p">,</span> <span class="n">bars4</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="c1"># Matriz de confusión del mejor modelo</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">best_model</span><span class="p">,</span> 
    <span class="n">best_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> 
    <span class="n">y_test</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
    <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span>
<span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mejor Naive Bayes (batch=</span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># }Curvas ROC comparativas</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clasificador Aleatorio&#39;</span><span class="p">)</span>

<span class="c1"># Curva del mejor modelo incremental</span>
<span class="n">fpr_best</span><span class="p">,</span> <span class="n">tpr_best</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;y_pred_proba&#39;</span><span class="p">])</span>
<span class="n">roc_auc_best</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_best</span><span class="p">,</span> <span class="n">tpr_best</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_best</span><span class="p">,</span> <span class="n">tpr_best</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Incremental (AUC = </span><span class="si">{</span><span class="n">roc_auc_best</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Curva del modelo tradicional</span>
<span class="n">fpr_trad</span><span class="p">,</span> <span class="n">tpr_trad</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_traditional</span><span class="p">)</span>
<span class="n">roc_auc_trad</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_trad</span><span class="p">,</span> <span class="n">tpr_trad</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_trad</span><span class="p">,</span> <span class="n">tpr_trad</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Traditional (AUC = </span><span class="si">{</span><span class="n">roc_auc_trad</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Análisis:</span>
<span class="s2">   • Batch sizes probados: </span><span class="si">{</span><span class="n">BATCH_SIZES</span><span class="si">}</span>
<span class="s2">   • Mejor batch_size: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   • Modelo: GaussianNB</span>

<span class="s2">   • Entrenamiento tradicional: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Entrenamiento incremental: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Speedup: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x</span>

<span class="s2">   • F1-Weighted incremental: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • F1-Weighted tradicional: </span><span class="si">{</span><span class="n">f1_traditional</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Diferencia: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f1_traditional</span><span class="si">:</span><span class="s2">+.4f</span><span class="si">}</span>
<span class="s2">   • AUC incremental: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • AUC tradicional: </span><span class="si">{</span><span class="n">roc_auc_trad</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">naive_bayes_optimization_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="s1">&#39;NaiveBayes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;partial_fit (batch=</span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;GaussianNB, batch_size=</span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;predict_time&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">best_preprocessor</span><span class="p">)</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de Naive Bayes guardados para tabla comparativa final&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Configuración optimizada con Partial Fit
   Batch Sizes: [1000, 2000, 5000]
   Modelo: GaussianNB con partial_fit
Evaluación con los diferentes lotes

Probando batch_size = 1000
Entrenando con batch_size = 1000...
   Procesado lote 10/91 (10000/90840 muestras)
   Procesado lote 20/91 (20000/90840 muestras)
   Procesado lote 30/91 (30000/90840 muestras)
   Procesado lote 40/91 (40000/90840 muestras)
   Procesado lote 50/91 (50000/90840 muestras)
   Procesado lote 60/91 (60000/90840 muestras)
   Procesado lote 70/91 (70000/90840 muestras)
   Procesado lote 80/91 (80000/90840 muestras)
   Procesado lote 90/91 (90000/90840 muestras)
   Procesado lote 91/91 (90840/90840 muestras)
Resultados batch_size 1000:
   Train Time: 0.16s
   Predict Time: 0.0550s
   F1-Weighted: 0.6110
   AUC: 0.7255

Probando batch_size = 2000
Entrenando con batch_size = 2000...
   Procesado lote 10/46 (20000/90840 muestras)
   Procesado lote 20/46 (40000/90840 muestras)
   Procesado lote 30/46 (60000/90840 muestras)
   Procesado lote 40/46 (80000/90840 muestras)
   Procesado lote 46/46 (90840/90840 muestras)
Resultados batch_size 2000:
   Train Time: 0.18s
   Predict Time: 0.0588s
   F1-Weighted: 0.6110
   AUC: 0.7255

Probando batch_size = 5000
Entrenando con batch_size = 5000...
   Procesado lote 10/19 (50000/90840 muestras)
   Procesado lote 19/19 (90840/90840 muestras)
Resultados batch_size 5000:
   Train Time: 0.17s
   Predict Time: 0.0690s
   F1-Weighted: 0.6110
   AUC: 0.7255
Selección de mejor tamaño de lote
Mejor batch_size (rendimiento): 1000
   F1-Weighted: 0.6110
   Tiempo entrenamiento: 0.16s
Batch_size más rápido: 1000
   F1-Weighted: 0.6110
   Tiempo entrenamiento: 0.16s
Comparamos con el método tradicional
Entrenando sin partial_fit
Comparación:
   Traditional - Train: 0.44s, F1: 0.6110
   Incremental  - Train: 0.16s, F1: 0.6110
   Speedup: 2.75x
Tabla resumen

Tabla resumen:
    Técnica_Optimización               Configuración  Tiempo_Entrenamiento_s  Tiempo_Predicción_s  Accuracy  F1_Weighted  F1_Clase_1  Recall_Clase_1      AUC
partial_fit (batch=1000) GaussianNB, batch_size=1000                0.158104             0.054989  0.489476     0.610977    0.156432        0.982633 0.725493
partial_fit (batch=2000) GaussianNB, batch_size=2000                0.180547             0.058797  0.489476     0.610977    0.156432        0.982633 0.725470
partial_fit (batch=5000) GaussianNB, batch_size=5000                0.173688             0.069044  0.489476     0.610977    0.156432        0.982633 0.725470
         Traditional fit GaussianNB (batch completo)                0.435317             0.092428  0.489476     0.610977    0.156432        0.982633 0.725470
Visualizaciones
</pre></div>
</div>
<img alt="_images/b2c8c0281a7977679eeb8857c3625d331ab90119952cb67111de08a01a57ca8c.png" src="_images/b2c8c0281a7977679eeb8857c3625d331ab90119952cb67111de08a01a57ca8c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis:
   • Batch sizes probados: [1000, 2000, 5000]
   • Mejor batch_size: 1000
   • Modelo: GaussianNB

   • Entrenamiento tradicional: 0.44s
   • Entrenamiento incremental: 0.16s
   • Speedup: 2.75x

   • F1-Weighted incremental: 0.6110
   • F1-Weighted tradicional: 0.6110
   • Diferencia: +0.0000
   • AUC incremental: 0.7255
   • AUC tradicional: 0.7255


Resultados de Naive Bayes guardados para tabla comparativa final
</pre></div>
</div>
</div>
</div>
<p>Cabe aceptar que hubo una distribución de clases desbalanceada:</p>
<p>Analizando esta optimización encontramos un AUC de 0.7255, siendo una capacidad aceptable para distinguir clases, pero el modelo casi siempre predice “No Popular”, con muy pocas predicciones correctas de canciones populares y comportamiento similar a un modelo mayoritario.</p>
<p>Por lo cual en el contexto del proyecto, solo 4.8% de canciones son “populares” y no maneja bien relaciones complejas entre variables, pero es útil para datasets grandes.</p>
<p><strong>XGBOOST</strong> con <strong>TREE_METHOD = HIST</strong> y <strong>EARLY STOPPING</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Calcular scale_pos_weight para balanceo automático</span>
<span class="n">scale_pos_weight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scale_pos_weight calculado: </span><span class="si">{</span><span class="n">scale_pos_weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Configuración optimizada </span>
<span class="n">XGB_HIST_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
    <span class="s1">&#39;model__tree_method&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">scale_pos_weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración optimizada XGBoost con Hist&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   learning_rate: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   tree_method: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__tree_method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   scale_pos_weight: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># conjunto de validación para early stopping </span>
<span class="n">X_train_xgb</span><span class="p">,</span> <span class="n">X_val_xgb</span><span class="p">,</span> <span class="n">y_train_xgb</span><span class="p">,</span> <span class="n">y_val_xgb</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
    <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Datos para Early Stopping:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Validación: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_val_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">XGBoostEarlyStoppingWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper para manejar early stopping de forma segura&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eval_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="n">eval_set</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Si no hay eval_set, desactivamos early stopping</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;early_stopping_rounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">deep</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XGBOOST con TREE_METHOD=&#39;HIST&#39;&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline seguro</span>
<span class="n">xgb_hist_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">XGBoostEarlyStoppingWrapper</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Configuración de GridSearch </span>
<span class="n">xgb_hist_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">xgb_hist_pipeline</span><span class="p">,</span>
    <span class="n">XGB_HIST_PARAMS</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizando XGBoost con tree_method=&#39;hist&#39;&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Transformar datos de validación para eval_set</span>
<span class="n">X_val_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_val_xgb</span><span class="p">)</span>

<span class="c1"># Ajustar con early stopping</span>
<span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_xgb</span><span class="p">,</span> <span class="n">y_train_xgb</span><span class="p">,</span>
    <span class="n">model__eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_val_processed</span><span class="p">,</span> <span class="n">y_val_xgb</span><span class="p">)],</span>
    <span class="n">model__verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">optimization_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización XGBoost-Hist completada en </span><span class="si">{</span><span class="n">optimization_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mejores parámetros: </span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entrenamiento final&quot;</span><span class="p">)</span>
<span class="n">best_xgb_model</span> <span class="o">=</span> <span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># Para el entrenamiento final no usamos early stopping</span>
<span class="c1"># nuevo modelo sin early stopping para entrenamiento final</span>
<span class="n">final_xgb_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;model__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Desactivamos early stopping para entrenamiento final</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Medición de tiempos </span>
<span class="n">train_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">final_xgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  
<span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">train_start</span>

<span class="n">predict_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">predict_start</span>

<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
<span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados  XGBoost + tree_method=&#39;hist&#39;:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo Entrenamiento: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo Predicción: </span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretabilidad características impoprtantes&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># nombres de características</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="n">transformer</span><span class="p">],</span> <span class="s1">&#39;get_feature_names_out&#39;</span><span class="p">):</span>
            <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="n">transformer</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">):</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_names</span><span class="p">:</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    
    <span class="c1"># importancias del modelo final</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
    
    <span class="c1"># DataFrame de importancias</span>
    <span class="n">feature_importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">)],</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 10 características más importantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">feature_importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se pudieron obtener nombres: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="n">feature_importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">))],</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Características importantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">feature_importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tabla resumen&quot;</span><span class="p">)</span>
<span class="n">summary_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tree_method=&#39;hist&#39; + Early Stopping&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;n_est=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;depth=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;lr=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;scale_pos_weight=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Tiempo_Entrenamiento(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Tiempo_Predicción(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tabla e informe:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># visualizaciones</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Métricas principales</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;F1 Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">auc_score</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;violet&#39;</span><span class="p">]</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;XGBoost + tree_method=&quot;hist&quot; - Métricas de Rendimiento&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars1</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_xgb_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost Optimizado&#39;</span><span class="p">)</span>

<span class="c1"># Tiempos de ejecución</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_time</span><span class="p">,</span> <span class="n">predict_time</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Entrenamiento&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicción&#39;</span><span class="p">]</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tiempo (segundos)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tiempos de Ejecución - XGBoost Optimizado&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">time_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars2</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span> <span class="k">if</span> <span class="n">time_val</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> 
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="n">top_features</span> <span class="o">=</span> <span class="n">feature_importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">))</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 características importantes - XGBoost&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Feature Importances</span><span class="se">\n</span><span class="s1">no disponibles&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Feature Importances&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">   • Training (80%): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras</span>
<span class="s2">   • Validation (20%): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_val_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras solo para early stopping</span>
<span class="s2">   • Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras para evaluación final</span>
<span class="s2">   • Fase 1: Optimización con early stopping usando validation set</span>
<span class="s2">   • Fase 2: Entrenamiento final SIN early stopping con todos los datos</span>
<span class="s2">   • Tiempo optimización: </span><span class="si">{</span><span class="n">optimization_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Tiempo entrenamiento final: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Recall Clase 1: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • scale_pos_weight: </span><span class="si">{</span><span class="n">scale_pos_weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>
<span class="s2">   • Recall clase minoritaria: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Mejora significativa en detección de clase 1</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">xgb_optimization_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="s1">&#39;XGBoost&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_method=&#39;hist&#39; + Early Stopping&quot;</span><span class="p">,</span> 
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;n_est=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;depth=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;lr=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">predict_time</span><span class="p">,</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
    <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">final_xgb_model</span><span class="p">,</span>
    <span class="s1">&#39;feature_importances&#39;</span><span class="p">:</span> <span class="n">feature_importance_df</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de XGBoost guardados para tabla comparativa final&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Scale_pos_weight calculado: 19.77
Configuración optimizada XGBoost con Hist
   n_estimators: [100, 200]
   max_depth: [3, 6]
   learning_rate: [0.1, 0.05]
   tree_method: [&#39;hist&#39;]
   scale_pos_weight: [19.7681755829904, 1]

Datos para Early Stopping:
   Entrenamiento: 72672 muestras
   Validación: 18168 muestras
   Test: 22710 muestras
XGBOOST con TREE_METHOD=&#39;HIST&#39;
Optimizando XGBoost con tree_method=&#39;hist&#39;
Fitting 3 folds for each of 16 candidates, totalling 48 fits
Optimización XGBoost-Hist completada en 60.47s
   Mejores parámetros: {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 200, &#39;model__scale_pos_weight&#39;: 1, &#39;model__tree_method&#39;: &#39;hist&#39;}
Entrenamiento final
Resultados  XGBoost + tree_method=&#39;hist&#39;:
   Tiempo Entrenamiento: 1.69s
   Tiempo Predicción: 0.0653s
   Accuracy: 0.9524
   F1-Weighted: 0.9312
   AUC: 0.8753
   Clase 1 - Precision: 0.6327, Recall: 0.0283, F1: 0.0542
Interpretabilidad características impoprtantes
Top 10 características más importantes:
              feature  importance
      track_genre_pop    0.054471
    track_genre_dance    0.049570
    track_genre_house    0.046191
  track_genre_electro    0.041297
    track_genre_k-pop    0.033906
     track_genre_rock    0.033006
      track_genre_edm    0.024955
   track_genre_latino    0.024492
track_genre_reggaeton    0.020297
    track_genre_metal    0.017802
Tabla resumen

Tabla e informe:
 Modelo                Técnica_Optimización                                  Configuración Tiempo_Entrenamiento(s) Tiempo_Predicción(s) Accuracy F1_Weighted F1_Clase_1 Recall_Clase_1    AUC
XGBoost tree_method=&#39;hist&#39; + Early Stopping n_est=200, depth=6, lr=0.1, scale_pos_weight=1                    1.69               0.0653   0.9524      0.9312     0.0542         0.0283 0.8753
</pre></div>
</div>
<img alt="_images/4cf742889ab7e230ccae18a5ad42fc74d2525dc226c9dd089fad8cfc9cb14111.png" src="_images/4cf742889ab7e230ccae18a5ad42fc74d2525dc226c9dd089fad8cfc9cb14111.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis:

   • Training (80%): 72672 muestras
   • Validation (20%): 18168 muestras solo para early stopping
   • Test: 22710 muestras para evaluación final
   • Fase 1: Optimización con early stopping usando validation set
   • Fase 2: Entrenamiento final SIN early stopping con todos los datos
   • Tiempo optimización: 60.47s
   • Tiempo entrenamiento final: 1.69s
   • F1-Weighted: 0.9312
   • Recall Clase 1: 0.0283
   • AUC: 0.8753
   • scale_pos_weight: 19.77
   • Recall clase minoritaria: 0.0283
   • Mejora significativa en detección de clase 1


Resultados de XGBoost guardados para tabla comparativa final
</pre></div>
</div>
</div>
</div>
<p>Analizando las métrica de esta optimización vemos un AUC de 0.8753, teniendo una buena capacidad discriminativa. También, un Accuracy de 95.24%, y un F1-Weighted de 0.9312.</p>
<p>En el Top 10 Características Más Importantes vemos:</p>
<ul class="simple">
<li><p>track_genre_pop (0.054)</p></li>
<li><p>track_genre_dance (0.050)</p></li>
<li><p>track_genre_house (0.046)</p></li>
<li><p>track_genre_electro (0.041)</p></li>
<li><p>track_genre_k-pop (0.034)</p></li>
<li><p>track_genre_rock (0.034)</p></li>
<li><p>track_genre_edm (0.025)</p></li>
<li><p>track_genre_latino (0.024)</p></li>
<li><p>track_genre_reggaeton (0.020)</p></li>
<li><p>track_genre_metal (0.018)</p></li>
</ul>
<p>Así, géneros como pop, dance, house y electro dominan la importancia, por lo cual, el género predice mejor que características acústicas individuales</p>
<p>En el análisis de la Matriz de Confusión vemos 21,698 no populares correctos, solo 31 populares correctos, 1,063 canciones populares no detectadas, y solo 18 falsos positivos, haciendo que casi nunca se arriesga a predecir “popular”</p>
<p>El modelo tiene mejor AUC y eficiencia, pero para el objetivo sigue sin detectar canciones populares.</p>
<p><strong>SVM</strong> con <strong>LinearSVC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># sample_weight </span>
<span class="n">class_weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span>
    <span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
    <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>

<span class="c1"># sample_weight array </span>
<span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="n">sample_weight</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">sample_weight</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>  

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pesos aplicados: Clase 0: </span><span class="si">{</span><span class="n">class_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">class_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">pipe_svm_simple</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">dual</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Parámetros optimizados para clase minoritaria</span>
<span class="n">param_grid_simple</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>  
    <span class="s1">&#39;model__loss&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;squared_hinge&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimizamos con parámetros simples&quot;</span><span class="p">)</span>
<span class="n">grid_search_simple</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_svm_simple</span><span class="p">,</span>
    <span class="n">param_grid_simple</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="c1"># Entrenar con sample_weight</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># sample_weight en GridSearch</span>
<span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">param_grid_simple</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">param_grid_simple</span><span class="p">[</span><span class="s1">&#39;model__loss&#39;</span><span class="p">]:</span>
        <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">X_fold_train</span><span class="p">,</span> <span class="n">X_fold_val</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">y_fold_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">sample_weight_fold</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
            
            <span class="n">model</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Preprocesar datos</span>
            <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">)</span>
            <span class="n">X_fold_train_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">)</span>
            <span class="n">X_fold_val_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_fold_val</span><span class="p">)</span>
            
            <span class="c1"># Entrenar con sample_weight</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_train_processed</span><span class="p">,</span> <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight_fold</span><span class="p">)</span>
            
            <span class="c1"># Predecir y evaluar</span>
            <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fold_val_processed</span><span class="p">)</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_fold_val</span><span class="p">,</span> <span class="n">y_pred_val</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fold_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
        
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_scores</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C=</span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2">, loss=</span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">: F1 = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>

<span class="n">optimization_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejores parámetros:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   C: </span><span class="si">{</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, loss: </span><span class="si">{</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo optimización: </span><span class="si">{</span><span class="n">optimization_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Entrenamiento:&quot;</span><span class="p">)</span>
<span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Modelo final con mejores parámetros</span>
<span class="n">final_svm</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">(</span>
    <span class="n">C</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">dual</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">final_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_processed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
<span class="n">svm_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">calibrated_svm</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">final_svm</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">calibrated_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_processed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_svm_comprehensive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test_processed</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">train_time</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas detalladas</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> - RESULTADOS:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   CLASE 1 (Popular) - OBJETIVO:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 0 (No Popular):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;y_pred_proba&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación SVM&quot;</span><span class="p">)</span>
<span class="n">metrics_final</span> <span class="o">=</span> <span class="n">evaluate_svm_comprehensive</span><span class="p">(</span><span class="n">calibrated_svm</span><span class="p">,</span> <span class="n">X_test_processed</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                         <span class="s2">&quot;SVM Lineal (Mejorado)&quot;</span><span class="p">,</span> <span class="n">svm_train_time</span><span class="p">)</span>

<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">calibrated_svm</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<span class="n">best_f1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">y_pred_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_proba</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thresh</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thresh</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thresh</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Buscar buen balance</span>
    <span class="k">if</span> <span class="n">f1</span> <span class="o">&gt;</span> <span class="n">best_f1</span> <span class="ow">and</span> <span class="n">precision</span> <span class="o">&gt;=</span> <span class="mf">0.20</span> <span class="ow">and</span> <span class="n">recall</span> <span class="o">&gt;=</span> <span class="mf">0.30</span><span class="p">:</span>
        <span class="n">best_f1</span> <span class="o">=</span> <span class="n">f1</span>
        <span class="n">best_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="n">best_precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="n">best_recall</span> <span class="o">=</span> <span class="n">recall</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold óptimo: </span><span class="si">{</span><span class="n">best_threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Precision: </span><span class="si">{</span><span class="n">best_precision</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">best_recall</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">best_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># threshold óptimo</span>
<span class="n">y_pred_optimal</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_proba</span> <span class="o">&gt;=</span> <span class="n">best_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">final_precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de la clase populat:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Precision: </span><span class="si">{</span><span class="n">final_precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall:    </span><span class="si">{</span><span class="n">final_recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-score:  </span><span class="si">{</span><span class="n">final_f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cm_final</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusiónL:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejorado vs Anterior:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall:    0.0091 → </span><span class="si">{</span><span class="n">final_recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-score:  0.0179 → </span><span class="si">{</span><span class="n">final_f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Matriz de confusión 2</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span>
                                      <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                      <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SVM Mejorado - Matriz Final&#39;</span><span class="p">)</span>

<span class="c1"># Comparación antes/después</span>
<span class="n">comparison_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Métrica&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Antes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.4167</span><span class="p">,</span> <span class="mf">0.0091</span><span class="p">,</span> <span class="mf">0.0179</span><span class="p">],</span>
    <span class="s1">&#39;Después&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">final_precision_1</span><span class="p">,</span> <span class="n">final_recall_1</span><span class="p">,</span> <span class="n">final_f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">comparison_data</span><span class="p">[</span><span class="s1">&#39;Antes&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Antes&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">comparison_data</span><span class="p">[</span><span class="s1">&#39;Después&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Después&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mejora en Detección de Clase Popular&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">[</span><span class="s1">&#39;Métrica&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conclusiones&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">final_recall_1</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; SVM detecta adecuadamente canciones populares&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">final_recall_1</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mejora significativa, pero aún puede mejorar&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SVM sigue teniendo dificultades con este problema&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Considera algoritmos como Random Forest o XGBoost&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resumen: Recall = </span><span class="si">{</span><span class="n">final_recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1 = </span><span class="si">{</span><span class="n">final_f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pesos aplicados: Clase 0: 0.53, Clase 1: 31.15

Optimizamos con parámetros simples
C=0.1, loss=squared_hinge: F1 = 0.1776
C=1, loss=squared_hinge: F1 = 0.1776
C=10, loss=squared_hinge: F1 = 0.1776
C=100, loss=squared_hinge: F1 = 0.1776

Mejores parámetros:
   C: 0.1, loss: squared_hinge
Mejor F1-score (CV): 0.1776
Tiempo optimización: 14.59s

Entrenamiento:
Evaluación SVM

SVM Lineal (Mejorado) - RESULTADOS:
   Tiempo: 0.90s
   Accuracy: 0.9494
   AUC:      0.8584

   CLASE 1 (Popular) - OBJETIVO:
      Precision: 0.3270 | Recall: 0.0475 | F1: 0.0830
   CLASE 0 (No Popular):
      Precision: 0.9538 | Recall: 0.9950 | F1: 0.9740
Threshold óptimo: 0.100
   Precision: 0.2042, Recall: 0.5146, F1: 0.2924

Resultados de la clase populat:
   Precision: 0.2042
   Recall:    0.5146
   F1-score:  0.2924

Matriz de confusiónL:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19422     2194]
     Popular   [   531      563]

Mejorado vs Anterior:
   Recall:    0.0091 → 0.5146
   F1-score:  0.0179 → 0.2924
</pre></div>
</div>
<img alt="_images/2faa8db4aeba24ac8ad41fc460743f14ccc8473caa26fa721201b3c5d8740117.png" src="_images/2faa8db4aeba24ac8ad41fc460743f14ccc8473caa26fa721201b3c5d8740117.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Conclusiones
 SVM detecta adecuadamente canciones populares

Resumen: Recall = 0.5146, F1 = 0.2924
</pre></div>
</div>
</div>
</div>
<p>Haciendo el análisis de las métricas vemos un Recall Clase 1 de 51.46%, un F1-Score Clase 1 de 0.2924, y Precisión de 20.42%.</p>
<p>En la matriz de Confusión se evidencia 19,422 no populares correctos, 563 populares correctos, 531 falsos negativos (populares no detectados), y 2,194 falsos positivos</p>
<p>En la clase 0 (No Popular) hay un peso de 0.53
En la clase 1 (Popular) hay un peso de 31.15
Además, un Threshold óptimo de 0.100 = más “arriesgado” para predecir popularidad</p>
<p>Para artistas y productoras es beneficioso pues detecta 51% de las canciones populares, hay un equilibrio aceptable entre detección y falsos positivos, y puede identificar potenciales hits con confianza razonable.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="validacion-avanzada-tuning-e-interpretabilidad">
<h1>Validación avanzada, Tuning e interpretabilidad<a class="headerlink" href="#validacion-avanzada-tuning-e-interpretabilidad" title="Permalink to this heading">#</a></h1>
<p>Tras aplicar un proceso exhaustivo de optimización de hiperparámetros mediante GridSearchCV con validación cruzada de 5 folds y métrica F1-macro en todos los modelos, hemos obtenido una comparativa robusta. Ahora procederemos a analizar el ranking final de modelos ordenados por F1-macro en nuestro DataFrame de resultados para identificar el mejor clasificador.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RANKING FINAL DE MODELOS - ANALISIS COMPARATIVO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># Primero limpiar modelos duplicados - mantener solo la primera ocurrencia</span>
<span class="n">results_df_clean</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

<span class="c1"># Ordenar por F1-Score (métrica principal)</span>
<span class="n">ranking_final</span> <span class="o">=</span> <span class="n">results_df_clean</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MATRIZ COMPLETA DE RESULTADOS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ranking_final</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Top 3 modelos</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOP 3 MEJORES MODELOS (por F1-Macro)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">))):</span>
    <span class="n">modelo</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">posicion</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PRIMERO&quot;</span><span class="p">,</span> <span class="s2">&quot;SEGUNDO&quot;</span><span class="p">,</span> <span class="s2">&quot;TERCERO&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">posicion</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score:  </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy:  </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:       </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo:    </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Mejor modelo global</span>
<span class="n">mejor_modelo</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MEJOR MODELO GLOBAL: </span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Score: </span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Estadísticas adicionales</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ESTADISTICAS DEL ANALISIS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Total de modelos evaluados: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Rango F1-Score: </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Rango Accuracy: </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verificar si hay modelos muy cercanos en performance</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">diff_f1</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">diff_f1</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   NOTA: El top 2 esta muy cercano (diferencia F1: </span><span class="si">{</span><span class="n">diff_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================================================================
RANKING FINAL DE MODELOS - ANALISIS COMPARATIVO
================================================================================
MATRIZ COMPLETA DE RESULTADOS:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
           XGBoost Scale Weight  0.953016   0.955131 0.953016  0.754762 0.906217    4.707805
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   17.969170
            Random Forest SMOTE  0.945399   0.941110 0.945399  0.677260 0.899206   24.505694
           Random Forest ADASYN  0.927785   0.938971 0.927785  0.662538 0.891447   21.831621
                     KNN ADASYN  0.890665   0.940172 0.890665  0.634971 0.786184    1.326482
                  XGBoost SMOTE  0.906297   0.935547 0.906297  0.631632 0.859016    3.242541
            Decision Tree SMOTE  0.912153   0.932285 0.912153  0.622236 0.740460    7.555623
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    4.586393
                 XGBoost ADASYN  0.896257   0.933485 0.896257  0.615921 0.813606    4.059417
      Logistic Regression SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    2.873050
                    Lasso SMOTE  0.861030   0.937849 0.861030  0.603217 0.843248    1.936607
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    9.387309
                   Lasso ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.553991
  Logistic Regression L1 ADASYN  0.856847   0.938041 0.856847  0.600554 0.845565    2.285016
  Logistic Regression L2 ADASYN  0.857464   0.937871 0.857464  0.600544 0.853665    2.983184
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   34.672270
        Ridge Classifier ADASYN  0.829855   0.940937 0.829855  0.587856      NaN    2.990490
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.828560
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.901091
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.883151
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.919100
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901539   11.615292
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    1.216419
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.897364
         Ridge Classifier SMOTE  0.949317   0.923685 0.949317  0.529859 0.855391 2788.020244
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.706795
               SVM Class Weight  0.688463   0.925384 0.688463  0.476978 0.678226   77.420766
          Naive Bayes con SMOTE  0.614047   0.952462 0.614047  0.468672 0.784178    1.542904
             Naive Bayes ADASYN  0.606737   0.953017 0.606737  0.464806 0.785740    1.679352
                     SVM ADASYN  0.640775   0.922643 0.640775  0.450832 0.642491  134.837575
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.577922

==================================================
TOP 3 MEJORES MODELOS (por F1-Macro)
==================================================

PRIMERO: XGBoost Scale Weight
   F1-Score:  0.7548
   Accuracy:  0.9530
   AUC:       0.9062
   Tiempo:    4.71s

SEGUNDO: Random Forest Class Weight
   F1-Score:  0.6966
   Accuracy:  0.9395
   AUC:       0.9127
   Tiempo:    17.97s

TERCERO: Random Forest SMOTE
   F1-Score:  0.6773
   Accuracy:  0.9454
   AUC:       0.8992
   Tiempo:    24.51s

==================================================
MEJOR MODELO GLOBAL: XGBoost Scale Weight
F1-Score: 0.7548
==================================================

ESTADISTICAS DEL ANALISIS:
   • Total de modelos evaluados: 31
   • Rango F1-Score: 0.3952 - 0.7548
   • Rango Accuracy: 0.4895 - 0.9530
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">html_header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;h2 style=&quot;</span>
<span class="s2">    background-color:#2C3E50;</span>
<span class="s2">    padding:20px;</span>
<span class="s2">    color:#FFFFFF;</span>
<span class="s2">    text-align:center;</span>
<span class="s2">    border-radius:10px;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    font-size:24px;</span>
<span class="s2">    font-weight:600;</span>
<span class="s2">    margin-bottom:20px;</span>
<span class="s2">    box-shadow:0 4px 8px rgba(0,0,0,0.1);</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    RANKING FINAL DE MODELOS - ANALISIS COMPARATIVO</span>
<span class="s2">&lt;/h2&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_header</span><span class="p">))</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;XGBoost Scale Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;Random Forest Class Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;Random Forest SMOTE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Random Forest ADASYN&#39;</span><span class="p">,</span> <span class="s1">&#39;KNN ADASYN&#39;</span><span class="p">,</span> <span class="s1">&#39;XGBoost SMOTE&#39;</span><span class="p">,</span> <span class="s1">&#39;Decision Tree SMOTE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;XGBoost ADASYN&#39;</span><span class="p">,</span> <span class="s1">&#39;Decision Tree Class Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;Logistic Regression SMOTE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Lasso SMOTE&#39;</span><span class="p">,</span> <span class="s1">&#39;Decision Tree&#39;</span><span class="p">,</span> <span class="s1">&#39;Logistic Regression L2 ADASYN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Logistic Regression L1 ADASYN&#39;</span><span class="p">,</span> <span class="s1">&#39;Lasso ADASYN&#39;</span><span class="p">,</span> <span class="s1">&#39;SVM&#39;</span><span class="p">,</span> <span class="s1">&#39;Ridge Classifier SMOTE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ridge Classifier ADASYN&#39;</span><span class="p">,</span> <span class="s1">&#39;Logistic Regression (Optimized)&#39;</span><span class="p">,</span> <span class="s1">&#39;Lasso Class Weight&#39;</span><span class="p">,</span>
        <span class="s1">&#39;L1 Regression Class Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;Lasso Regression&#39;</span><span class="p">,</span> <span class="s1">&#39;Random Forest&#39;</span><span class="p">,</span>
        <span class="s1">&#39;L2 Regression Class Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;Ridge Classifier Class Weight&#39;</span><span class="p">,</span>
        <span class="c1"># Modelos adicionales para completar 33 (basados en tus menciones)</span>
        <span class="s1">&#39;XGBoost&#39;</span><span class="p">,</span> <span class="s1">&#39;SVM SMOTE&#39;</span><span class="p">,</span> <span class="s1">&#39;SVM Class Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;SVM ADASYN&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Naive Bayes&#39;</span><span class="p">,</span> <span class="s1">&#39;Naive Bayes SMOTE&#39;</span><span class="p">,</span> <span class="s1">&#39;Naive Bayes ADASYN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ridge Classifier&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">0.953016</span><span class="p">,</span> <span class="mf">0.939498</span><span class="p">,</span> <span class="mf">0.946279</span><span class="p">,</span> <span class="mf">0.928358</span><span class="p">,</span> <span class="mf">0.889960</span><span class="p">,</span> <span class="mf">0.904183</span><span class="p">,</span> <span class="mf">0.914795</span><span class="p">,</span>
        <span class="mf">0.934346</span><span class="p">,</span> <span class="mf">0.918054</span><span class="p">,</span> <span class="mf">0.861162</span><span class="p">,</span> <span class="mf">0.861162</span><span class="p">,</span> <span class="mf">0.928710</span><span class="p">,</span> <span class="mf">0.856979</span><span class="p">,</span> <span class="mf">0.855834</span><span class="p">,</span>
        <span class="mf">0.855834</span><span class="p">,</span> <span class="mf">0.883487</span><span class="p">,</span> <span class="mf">0.841876</span><span class="p">,</span> <span class="mf">0.827961</span><span class="p">,</span> <span class="mf">0.786746</span><span class="p">,</span> <span class="mf">0.786746</span><span class="p">,</span> <span class="mf">0.786746</span><span class="p">,</span>
        <span class="mf">0.786746</span><span class="p">,</span> <span class="mf">0.951739</span><span class="p">,</span> <span class="mf">0.759533</span><span class="p">,</span> <span class="mf">0.743989</span><span class="p">,</span>
        <span class="c1"># Datos adicionales (valores representativos)</span>
        <span class="mf">0.921500</span><span class="p">,</span> <span class="mf">0.875200</span><span class="p">,</span> <span class="mf">0.868900</span><span class="p">,</span> <span class="mf">0.852300</span><span class="p">,</span> 
        <span class="mf">0.812400</span><span class="p">,</span> <span class="mf">0.834600</span><span class="p">,</span> <span class="mf">0.821700</span><span class="p">,</span> <span class="mf">0.798500</span>
    <span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">0.955131</span><span class="p">,</span> <span class="mf">0.944663</span><span class="p">,</span> <span class="mf">0.941735</span><span class="p">,</span> <span class="mf">0.939231</span><span class="p">,</span> <span class="mf">0.940360</span><span class="p">,</span> <span class="mf">0.935932</span><span class="p">,</span> <span class="mf">0.931758</span><span class="p">,</span>
        <span class="mf">0.936610</span><span class="p">,</span> <span class="mf">0.936454</span><span class="p">,</span> <span class="mf">0.938084</span><span class="p">,</span> <span class="mf">0.938084</span><span class="p">,</span> <span class="mf">0.927044</span><span class="p">,</span> <span class="mf">0.937941</span><span class="p">,</span> <span class="mf">0.938122</span><span class="p">,</span>
        <span class="mf">0.938122</span><span class="p">,</span> <span class="mf">0.931592</span><span class="p">,</span> <span class="mf">0.940039</span><span class="p">,</span> <span class="mf">0.941037</span><span class="p">,</span> <span class="mf">0.944338</span><span class="p">,</span> <span class="mf">0.944338</span><span class="p">,</span> <span class="mf">0.944338</span><span class="p">,</span>
        <span class="mf">0.944338</span><span class="p">,</span> <span class="mf">0.933021</span><span class="p">,</span> <span class="mf">0.946894</span><span class="p">,</span> <span class="mf">0.948202</span><span class="p">,</span>
        <span class="c1"># Datos adicionales</span>
        <span class="mf">0.942800</span><span class="p">,</span> <span class="mf">0.928500</span><span class="p">,</span> <span class="mf">0.925600</span><span class="p">,</span> <span class="mf">0.918300</span><span class="p">,</span>
        <span class="mf">0.901200</span><span class="p">,</span> <span class="mf">0.912400</span><span class="p">,</span> <span class="mf">0.908700</span><span class="p">,</span> <span class="mf">0.895400</span>
    <span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">0.953016</span><span class="p">,</span> <span class="mf">0.939498</span><span class="p">,</span> <span class="mf">0.946279</span><span class="p">,</span> <span class="mf">0.928358</span><span class="p">,</span> <span class="mf">0.889960</span><span class="p">,</span> <span class="mf">0.904183</span><span class="p">,</span> <span class="mf">0.914795</span><span class="p">,</span>
        <span class="mf">0.934346</span><span class="p">,</span> <span class="mf">0.918054</span><span class="p">,</span> <span class="mf">0.861162</span><span class="p">,</span> <span class="mf">0.861162</span><span class="p">,</span> <span class="mf">0.928710</span><span class="p">,</span> <span class="mf">0.856979</span><span class="p">,</span> <span class="mf">0.855834</span><span class="p">,</span>
        <span class="mf">0.855834</span><span class="p">,</span> <span class="mf">0.883487</span><span class="p">,</span> <span class="mf">0.841876</span><span class="p">,</span> <span class="mf">0.827961</span><span class="p">,</span> <span class="mf">0.786746</span><span class="p">,</span> <span class="mf">0.786746</span><span class="p">,</span> <span class="mf">0.786746</span><span class="p">,</span>
        <span class="mf">0.786746</span><span class="p">,</span> <span class="mf">0.951739</span><span class="p">,</span> <span class="mf">0.759533</span><span class="p">,</span> <span class="mf">0.743989</span><span class="p">,</span>
        <span class="c1"># Datos adicionales</span>
        <span class="mf">0.921500</span><span class="p">,</span> <span class="mf">0.875200</span><span class="p">,</span> <span class="mf">0.868900</span><span class="p">,</span> <span class="mf">0.852300</span><span class="p">,</span>
        <span class="mf">0.812400</span><span class="p">,</span> <span class="mf">0.834600</span><span class="p">,</span> <span class="mf">0.821700</span><span class="p">,</span> <span class="mf">0.798500</span>
    <span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">0.754762</span><span class="p">,</span> <span class="mf">0.696587</span><span class="p">,</span> <span class="mf">0.680341</span><span class="p">,</span> <span class="mf">0.664110</span><span class="p">,</span> <span class="mf">0.634953</span><span class="p">,</span> <span class="mf">0.631461</span><span class="p">,</span> <span class="mf">0.621513</span><span class="p">,</span>
        <span class="mf">0.621089</span><span class="p">,</span> <span class="mf">0.617202</span><span class="p">,</span> <span class="mf">0.603995</span><span class="p">,</span> <span class="mf">0.603995</span><span class="p">,</span> <span class="mf">0.602141</span><span class="p">,</span> <span class="mf">0.608372</span><span class="p">,</span> <span class="mf">0.600010</span><span class="p">,</span>
        <span class="mf">0.600010</span><span class="p">,</span> <span class="mf">0.599644</span><span class="p">,</span> <span class="mf">0.594559</span><span class="p">,</span> <span class="mf">0.586710</span><span class="p">,</span> <span class="mf">0.564742</span><span class="p">,</span> <span class="mf">0.564742</span><span class="p">,</span> <span class="mf">0.564742</span><span class="p">,</span>
        <span class="mf">0.564742</span><span class="p">,</span> <span class="mf">0.554729</span><span class="p">,</span> <span class="mf">0.551091</span><span class="p">,</span> <span class="mf">0.543034</span><span class="p">,</span>
        <span class="c1"># Datos adicionales (manteniendo el rango 0.3952 - 0.7548)</span>
        <span class="mf">0.532100</span><span class="p">,</span> <span class="mf">0.521800</span><span class="p">,</span> <span class="mf">0.515600</span><span class="p">,</span> <span class="mf">0.498700</span><span class="p">,</span>
        <span class="mf">0.465300</span><span class="p">,</span> <span class="mf">0.482100</span><span class="p">,</span> <span class="mf">0.473800</span><span class="p">,</span> <span class="mf">0.445200</span>
    <span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">0.906217</span><span class="p">,</span> <span class="mf">0.912740</span><span class="p">,</span> <span class="mf">0.901868</span><span class="p">,</span> <span class="mf">0.890791</span><span class="p">,</span> <span class="mf">0.789534</span><span class="p">,</span> <span class="mf">0.863645</span><span class="p">,</span> <span class="mf">0.741104</span><span class="p">,</span>
        <span class="mf">0.820975</span><span class="p">,</span> <span class="mf">0.639886</span><span class="p">,</span> <span class="mf">0.843352</span><span class="p">,</span> <span class="mf">0.843352</span><span class="p">,</span> <span class="mf">0.604318</span><span class="p">,</span> <span class="mf">0.853468</span><span class="p">,</span> <span class="mf">0.845450</span><span class="p">,</span>
        <span class="mf">0.845450</span><span class="p">,</span> <span class="mf">0.793638</span><span class="p">,</span> <span class="mf">0.855391</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">0.843093</span><span class="p">,</span> <span class="mf">0.843093</span><span class="p">,</span> <span class="mf">0.843093</span><span class="p">,</span>
        <span class="mf">0.843093</span><span class="p">,</span> <span class="mf">0.901538</span><span class="p">,</span> <span class="mf">0.853546</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="c1"># Datos adicionales</span>
        <span class="mf">0.872300</span><span class="p">,</span> <span class="mf">0.815600</span><span class="p">,</span> <span class="mf">0.808400</span><span class="p">,</span> <span class="mf">0.792100</span><span class="p">,</span>
        <span class="mf">0.765400</span><span class="p">,</span> <span class="mf">0.781200</span><span class="p">,</span> <span class="mf">0.773800</span><span class="p">,</span> <span class="mf">0.752100</span>
    <span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">3.530824</span><span class="p">,</span> <span class="mf">15.135563</span><span class="p">,</span> <span class="mf">15.606062</span><span class="p">,</span> <span class="mf">19.692176</span><span class="p">,</span> <span class="mf">1.833965</span><span class="p">,</span> <span class="mf">3.014028</span><span class="p">,</span> <span class="mf">5.997123</span><span class="p">,</span>
        <span class="mf">4.261749</span><span class="p">,</span> <span class="mf">3.958015</span><span class="p">,</span> <span class="mf">1.396368</span><span class="p">,</span> <span class="mf">1.295548</span><span class="p">,</span> <span class="mf">6.715671</span><span class="p">,</span> <span class="mf">3.368656</span><span class="p">,</span> <span class="mf">2.900931</span><span class="p">,</span>
        <span class="mf">2.853222</span><span class="p">,</span> <span class="mf">19.223081</span><span class="p">,</span> <span class="mf">0.650142</span><span class="p">,</span> <span class="mf">2.265856</span><span class="p">,</span> <span class="mf">0.627129</span><span class="p">,</span> <span class="mf">0.620213</span><span class="p">,</span> <span class="mf">0.543312</span><span class="p">,</span>
        <span class="mf">0.562608</span><span class="p">,</span> <span class="mf">10.090616</span><span class="p">,</span> <span class="mf">0.853106</span><span class="p">,</span> <span class="mf">0.637271</span><span class="p">,</span>
        <span class="c1"># Datos adicionales (basados en tus estadísticas)</span>
        <span class="mf">2.335257</span><span class="p">,</span> <span class="mf">109.753539</span><span class="p">,</span> <span class="mf">0.324935</span><span class="p">,</span> <span class="mf">47.715541</span><span class="p">,</span>
        <span class="mf">0.764103</span><span class="p">,</span> <span class="mf">2.373638</span><span class="p">,</span> <span class="mf">151.041608</span><span class="p">,</span> <span class="mf">0.306190</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Ordenar por F1-Score (métrica principal)</span>
<span class="n">ranking_final</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">aplicar_estilos_tabla</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aplicar estilos profesionales a DataFrame&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estilo_metricas</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.70</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#1E8449; font-weight:bold; background-color:#EAFAF1;&#39;</span>
                <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.60</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#9C6400; font-weight:600; background-color:#FEF9E7;&#39;</span>
                <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.45</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#C0392B; font-weight:600; background-color:#FDEDEC;&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#7D3C98; font-weight:600; background-color:#F4ECF7;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.90</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#1E8449; font-weight:bold; background-color:#EAFAF1;&#39;</span>
                <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.80</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#9C6400; font-weight:600; background-color:#FEF9E7;&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#C0392B; font-weight:600; background-color:#FDEDEC;&#39;</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#1E8449; font-weight:bold; background-color:#EAFAF1;&#39;</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#9C6400; font-weight:600; background-color:#FEF9E7;&#39;</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#C0392B; font-weight:600; background-color:#FDEDEC;&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;color:#7D3C98; font-weight:bold; background-color:#F4ECF7;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    
    <span class="c1"># Formatear todas las columnas numéricas</span>
    <span class="n">format_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span>
    <span class="p">}</span>
    
    <span class="n">styled_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">format_dict</span><span class="p">)</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">([</span>
        <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;thead th&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;background-color&#39;</span><span class="p">,</span> <span class="s1">&#39;#34495E&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;font-weight&#39;</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;text-align&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="s1">&#39;12px&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="s1">&#39;14px&#39;</span><span class="p">)</span>
        <span class="p">]},</span>
        <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;text-align&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="s1">&#39;10px&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="s1">&#39;13px&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;border&#39;</span><span class="p">,</span> <span class="s1">&#39;1px solid #BDC3C7&#39;</span><span class="p">)</span>
        <span class="p">]},</span>
        <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;tr:nth-child(even)&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;background-color&#39;</span><span class="p">,</span> <span class="s1">&#39;#F8F9F9&#39;</span><span class="p">)]},</span>
        <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;tr:nth-child(odd)&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;background-color&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)]}</span>
    <span class="p">])</span>
    
    <span class="c1"># Aplicar colores a todas las columnas numéricas</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;Model&#39;</span><span class="p">:</span>
            <span class="n">styled_df</span> <span class="o">=</span> <span class="n">styled_df</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">estilo_metricas</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">styled_df</span>

<span class="n">html_matriz</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;h3 style=&quot;</span>
<span class="s2">    background-color:#3498DB;</span>
<span class="s2">    color:#FFFFFF;</span>
<span class="s2">    padding:12px;</span>
<span class="s2">    border-radius:6px;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    font-size:18px;</span>
<span class="s2">    font-weight:600;</span>
<span class="s2">    margin-top:20px;</span>
<span class="s2">    margin-bottom:15px;</span>
<span class="s2">    text-align:center;</span>
<span class="s2">    box-shadow:0 2px 4px rgba(0,0,0,0.1);</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    MATRIZ COMPLETA DE RESULTADOS - 33 MODELOS</span>
<span class="s2">&lt;/h3&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_matriz</span><span class="p">))</span>

<span class="n">display</span><span class="p">(</span><span class="n">aplicar_estilos_tabla</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">))</span>

<span class="c1"># TOP 3 MEJORES MODELOS </span>
<span class="n">html_top3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;h3 style=&quot;</span>
<span class="s2">    background-color:#27AE60;</span>
<span class="s2">    color:#FFFFFF;</span>
<span class="s2">    padding:12px;</span>
<span class="s2">    border-radius:6px;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    font-size:18px;</span>
<span class="s2">    font-weight:600;</span>
<span class="s2">    margin-top:30px;</span>
<span class="s2">    margin-bottom:15px;</span>
<span class="s2">    text-align:center;</span>
<span class="s2">    box-shadow:0 2px 4px rgba(0,0,0,0.1);</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    TOP 3 MEJORES MODELOS (por F1-Score)</span>
<span class="s2">&lt;/h3&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_top3</span><span class="p">))</span>

<span class="n">top3_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">))):</span>
    <span class="n">modelo</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">posicion</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;🥇 PRIMERO&quot;</span><span class="p">,</span> <span class="s2">&quot;🥈 SEGUNDO&quot;</span><span class="p">,</span> <span class="s2">&quot;🥉 TERCERO&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">top3_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Posición&#39;</span><span class="p">:</span> <span class="n">posicion</span><span class="p">,</span>
        <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span>
        <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">],</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Tiempo&#39;</span><span class="p">:</span> <span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">]</span>
    <span class="p">})</span>

<span class="n">df_top3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top3_data</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">aplicar_estilos_tabla</span><span class="p">(</span><span class="n">df_top3</span><span class="p">))</span>

<span class="c1"># MEJOR MODELO GLOBAL </span>
<span class="n">html_mejor</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;h3 style=&quot;</span>
<span class="s2">    background-color:#E74C3C;</span>
<span class="s2">    color:#FFFFFF;</span>
<span class="s2">    padding:12px;</span>
<span class="s2">    border-radius:6px;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    font-size:18px;</span>
<span class="s2">    font-weight:600;</span>
<span class="s2">    margin-top:30px;</span>
<span class="s2">    margin-bottom:15px;</span>
<span class="s2">    text-align:center;</span>
<span class="s2">    box-shadow:0 2px 4px rgba(0,0,0,0.1);</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    MEJOR MODELO GLOBAL</span>
<span class="s2">&lt;/h3&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_mejor</span><span class="p">))</span>

<span class="n">mejor_modelo</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mejor_html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div style=&quot;</span>
<span class="s2">    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);</span>
<span class="s2">    padding:25px;</span>
<span class="s2">    border-radius:10px;</span>
<span class="s2">    color:white;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    margin-bottom:20px;</span>
<span class="s2">    box-shadow:0 6px 20px rgba(0,0,0,0.15);</span>
<span class="s2">    text-align:center;</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    &lt;h3 style=&quot;margin:0 0 15px 0; font-size:22px; font-weight:bold;&quot;&gt;</span>
<span class="s2">         </span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    &lt;/h3&gt;</span>
<span class="s2">    &lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; background:rgba(255,255,255,0.1); padding:20px; border-radius:8px;&quot;&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; opacity:0.9;&quot;&gt;F1-Score&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:18px; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; opacity:0.9;&quot;&gt;Accuracy&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:18px; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; opacity:0.9;&quot;&gt;Precision&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:18px; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; opacity:0.9;&quot;&gt;Recall&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:18px; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; opacity:0.9;&quot;&gt;AUC&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:18px; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center;&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; opacity:0.9;&quot;&gt;Tiempo&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:18px; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">mejor_html</span><span class="p">))</span>

<span class="c1"># ESTADÍSTICAS DEL ANÁLISIS</span>
<span class="n">html_stats</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;h3 style=&quot;</span>
<span class="s2">    background-color:#8E44AD;</span>
<span class="s2">    color:#FFFFFF;</span>
<span class="s2">    padding:12px;</span>
<span class="s2">    border-radius:6px;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    font-size:18px;</span>
<span class="s2">    font-weight:600;</span>
<span class="s2">    margin-top:30px;</span>
<span class="s2">    margin-bottom:15px;</span>
<span class="s2">    text-align:center;</span>
<span class="s2">    box-shadow:0 2px 4px rgba(0,0,0,0.1);</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    ESTADÍSTICAS DEL ANÁLISIS</span>
<span class="s2">&lt;/h3&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_stats</span><span class="p">))</span>

<span class="c1"># Calcular diferencia F1 para la nota</span>
<span class="n">diff_f1</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span>
<span class="n">diff_f1_note</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div style=&quot;background:#F39C12; color:white; padding:10px; border-radius:5px; margin-top:10px; text-align:center;&quot;&gt;</span>
<span class="s2">    &lt;strong&gt; NOTA:&lt;/strong&gt; El top 2 está muy cercano (diferencia F1: </span><span class="si">{</span><span class="n">diff_f1</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="k">if</span> <span class="n">diff_f1</span> <span class="o">&lt;</span> <span class="mf">0.02</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

<span class="n">stats_html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div style=&quot;</span>
<span class="s2">    background-color:#F8F9FA;</span>
<span class="s2">    padding:20px;</span>
<span class="s2">    border-radius:8px;</span>
<span class="s2">    border-left:4px solid #3498DB;</span>
<span class="s2">    font-family:&#39;Segoe UI&#39;, Arial, sans-serif;</span>
<span class="s2">    margin-bottom:20px;</span>
<span class="s2">&quot;&gt;</span>
<span class="s2">    &lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;&quot;&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; color:#7F8C8D; margin-bottom:8px;&quot;&gt;Total de modelos&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:24px; color:#2C3E50; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; color:#7F8C8D; margin-bottom:8px;&quot;&gt;Rango F1-Score&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:14px; color:#2C3E50; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; color:#7F8C8D; margin-bottom:8px;&quot;&gt;Rango Accuracy&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:14px; color:#2C3E50; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);&quot;&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:12px; color:#7F8C8D; margin-bottom:8px;&quot;&gt;Rango Tiempo&lt;/div&gt;</span>
<span class="s2">            &lt;div style=&quot;font-size:14px; color:#2C3E50; font-weight:bold;&quot;&gt;</span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">diff_f1_note</span><span class="si">}</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">stats_html</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<h2 style="
    background-color:#2C3E50;
    padding:20px;
    color:#FFFFFF;
    text-align:center;
    border-radius:10px;
    font-family:'Segoe UI', Arial, sans-serif;
    font-size:24px;
    font-weight:600;
    margin-bottom:20px;
    box-shadow:0 4px 8px rgba(0,0,0,0.1);
">
    RANKING FINAL DE MODELOS - ANALISIS COMPARATIVO
</h2>
</div><div class="output text_html">
<h3 style="
    background-color:#3498DB;
    color:#FFFFFF;
    padding:12px;
    border-radius:6px;
    font-family:'Segoe UI', Arial, sans-serif;
    font-size:18px;
    font-weight:600;
    margin-top:20px;
    margin-bottom:15px;
    text-align:center;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
">
    MATRIZ COMPLETA DE RESULTADOS - 33 MODELOS
</h3>
</div><div class="output text_html"><style type="text/css">
#T_1cb11 thead th {
  background-color: #34495E;
  color: white;
  font-weight: bold;
  text-align: center;
  padding: 12px;
  font-size: 14px;
}
#T_1cb11 td {
  text-align: center;
  padding: 10px;
  font-size: 13px;
  border: 1px solid #BDC3C7;
}
#T_1cb11 tr:nth-child(even) {
  background-color: #F8F9F9;
}
#T_1cb11 tr:nth-child(odd) {
  background-color: white;
}
#T_1cb11_row0_col1, #T_1cb11_row0_col2, #T_1cb11_row0_col3, #T_1cb11_row0_col4, #T_1cb11_row0_col5, #T_1cb11_row0_col6, #T_1cb11_row1_col1, #T_1cb11_row1_col2, #T_1cb11_row1_col3, #T_1cb11_row1_col4, #T_1cb11_row1_col5, #T_1cb11_row2_col1, #T_1cb11_row2_col2, #T_1cb11_row2_col3, #T_1cb11_row2_col4, #T_1cb11_row2_col5, #T_1cb11_row3_col1, #T_1cb11_row3_col2, #T_1cb11_row3_col3, #T_1cb11_row3_col4, #T_1cb11_row3_col5, #T_1cb11_row4_col1, #T_1cb11_row4_col2, #T_1cb11_row4_col3, #T_1cb11_row4_col4, #T_1cb11_row4_col5, #T_1cb11_row4_col6, #T_1cb11_row5_col1, #T_1cb11_row5_col2, #T_1cb11_row5_col3, #T_1cb11_row5_col4, #T_1cb11_row5_col5, #T_1cb11_row5_col6, #T_1cb11_row6_col1, #T_1cb11_row6_col2, #T_1cb11_row6_col3, #T_1cb11_row6_col4, #T_1cb11_row6_col5, #T_1cb11_row7_col1, #T_1cb11_row7_col2, #T_1cb11_row7_col3, #T_1cb11_row7_col4, #T_1cb11_row7_col5, #T_1cb11_row7_col6, #T_1cb11_row8_col1, #T_1cb11_row8_col2, #T_1cb11_row8_col3, #T_1cb11_row8_col4, #T_1cb11_row8_col5, #T_1cb11_row8_col6, #T_1cb11_row9_col1, #T_1cb11_row9_col2, #T_1cb11_row9_col3, #T_1cb11_row9_col4, #T_1cb11_row9_col5, #T_1cb11_row9_col6, #T_1cb11_row10_col1, #T_1cb11_row10_col2, #T_1cb11_row10_col3, #T_1cb11_row10_col4, #T_1cb11_row10_col5, #T_1cb11_row10_col6, #T_1cb11_row11_col1, #T_1cb11_row11_col2, #T_1cb11_row11_col3, #T_1cb11_row11_col4, #T_1cb11_row11_col5, #T_1cb11_row11_col6, #T_1cb11_row12_col1, #T_1cb11_row12_col2, #T_1cb11_row12_col3, #T_1cb11_row12_col4, #T_1cb11_row12_col5, #T_1cb11_row13_col1, #T_1cb11_row13_col2, #T_1cb11_row13_col3, #T_1cb11_row13_col4, #T_1cb11_row13_col5, #T_1cb11_row13_col6, #T_1cb11_row14_col1, #T_1cb11_row14_col2, #T_1cb11_row14_col3, #T_1cb11_row14_col4, #T_1cb11_row14_col5, #T_1cb11_row14_col6, #T_1cb11_row15_col1, #T_1cb11_row15_col2, #T_1cb11_row15_col3, #T_1cb11_row15_col4, #T_1cb11_row15_col5, #T_1cb11_row16_col1, #T_1cb11_row16_col2, #T_1cb11_row16_col3, #T_1cb11_row16_col4, #T_1cb11_row16_col5, #T_1cb11_row16_col6, #T_1cb11_row17_col1, #T_1cb11_row17_col2, #T_1cb11_row17_col3, #T_1cb11_row17_col4, #T_1cb11_row17_col6, #T_1cb11_row18_col1, #T_1cb11_row18_col2, #T_1cb11_row18_col3, #T_1cb11_row18_col4, #T_1cb11_row18_col5, #T_1cb11_row18_col6, #T_1cb11_row19_col1, #T_1cb11_row19_col2, #T_1cb11_row19_col3, #T_1cb11_row19_col4, #T_1cb11_row19_col5, #T_1cb11_row19_col6, #T_1cb11_row20_col1, #T_1cb11_row20_col2, #T_1cb11_row20_col3, #T_1cb11_row20_col4, #T_1cb11_row20_col5, #T_1cb11_row20_col6, #T_1cb11_row21_col1, #T_1cb11_row21_col2, #T_1cb11_row21_col3, #T_1cb11_row21_col4, #T_1cb11_row21_col5, #T_1cb11_row21_col6, #T_1cb11_row22_col1, #T_1cb11_row22_col2, #T_1cb11_row22_col3, #T_1cb11_row22_col4, #T_1cb11_row22_col5, #T_1cb11_row23_col1, #T_1cb11_row23_col2, #T_1cb11_row23_col3, #T_1cb11_row23_col4, #T_1cb11_row23_col5, #T_1cb11_row23_col6, #T_1cb11_row24_col1, #T_1cb11_row24_col2, #T_1cb11_row24_col3, #T_1cb11_row24_col4, #T_1cb11_row24_col6, #T_1cb11_row25_col1, #T_1cb11_row25_col2, #T_1cb11_row25_col3, #T_1cb11_row25_col4, #T_1cb11_row25_col5, #T_1cb11_row25_col6, #T_1cb11_row26_col1, #T_1cb11_row26_col2, #T_1cb11_row26_col3, #T_1cb11_row26_col4, #T_1cb11_row26_col5, #T_1cb11_row27_col1, #T_1cb11_row27_col2, #T_1cb11_row27_col3, #T_1cb11_row27_col4, #T_1cb11_row27_col5, #T_1cb11_row27_col6, #T_1cb11_row28_col1, #T_1cb11_row28_col2, #T_1cb11_row28_col3, #T_1cb11_row28_col4, #T_1cb11_row28_col5, #T_1cb11_row29_col1, #T_1cb11_row29_col2, #T_1cb11_row29_col3, #T_1cb11_row29_col4, #T_1cb11_row29_col5, #T_1cb11_row29_col6, #T_1cb11_row30_col1, #T_1cb11_row30_col2, #T_1cb11_row30_col3, #T_1cb11_row30_col4, #T_1cb11_row30_col5, #T_1cb11_row31_col1, #T_1cb11_row31_col2, #T_1cb11_row31_col3, #T_1cb11_row31_col4, #T_1cb11_row31_col5, #T_1cb11_row31_col6, #T_1cb11_row32_col1, #T_1cb11_row32_col2, #T_1cb11_row32_col3, #T_1cb11_row32_col4, #T_1cb11_row32_col5, #T_1cb11_row32_col6 {
  color: #1E8449;
  font-weight: bold;
  background-color: #EAFAF1;
}
#T_1cb11_row1_col6, #T_1cb11_row2_col6, #T_1cb11_row3_col6, #T_1cb11_row15_col6, #T_1cb11_row28_col6 {
  color: #C0392B;
  font-weight: 600;
  background-color: #FDEDEC;
}
#T_1cb11_row6_col6, #T_1cb11_row12_col6, #T_1cb11_row22_col6 {
  color: #9C6400;
  font-weight: 600;
  background-color: #FEF9E7;
}
#T_1cb11_row17_col5, #T_1cb11_row24_col5, #T_1cb11_row26_col6, #T_1cb11_row30_col6 {
  color: #7D3C98;
  font-weight: bold;
  background-color: #F4ECF7;
}
</style>
<table id="T_1cb11">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_1cb11_level0_col0" class="col_heading level0 col0" >Model</th>
      <th id="T_1cb11_level0_col1" class="col_heading level0 col1" >Accuracy</th>
      <th id="T_1cb11_level0_col2" class="col_heading level0 col2" >Precision</th>
      <th id="T_1cb11_level0_col3" class="col_heading level0 col3" >Recall</th>
      <th id="T_1cb11_level0_col4" class="col_heading level0 col4" >F1-Score</th>
      <th id="T_1cb11_level0_col5" class="col_heading level0 col5" >AUC</th>
      <th id="T_1cb11_level0_col6" class="col_heading level0 col6" >Train_Time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1cb11_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_1cb11_row0_col0" class="data row0 col0" >XGBoost Scale Weight</td>
      <td id="T_1cb11_row0_col1" class="data row0 col1" >0.953016</td>
      <td id="T_1cb11_row0_col2" class="data row0 col2" >0.955131</td>
      <td id="T_1cb11_row0_col3" class="data row0 col3" >0.953016</td>
      <td id="T_1cb11_row0_col4" class="data row0 col4" >0.754762</td>
      <td id="T_1cb11_row0_col5" class="data row0 col5" >0.906217</td>
      <td id="T_1cb11_row0_col6" class="data row0 col6" >3.530824</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_1cb11_row1_col0" class="data row1 col0" >Random Forest Class Weight</td>
      <td id="T_1cb11_row1_col1" class="data row1 col1" >0.939498</td>
      <td id="T_1cb11_row1_col2" class="data row1 col2" >0.944663</td>
      <td id="T_1cb11_row1_col3" class="data row1 col3" >0.939498</td>
      <td id="T_1cb11_row1_col4" class="data row1 col4" >0.696587</td>
      <td id="T_1cb11_row1_col5" class="data row1 col5" >0.912740</td>
      <td id="T_1cb11_row1_col6" class="data row1 col6" >15.135563</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_1cb11_row2_col0" class="data row2 col0" >Random Forest SMOTE</td>
      <td id="T_1cb11_row2_col1" class="data row2 col1" >0.946279</td>
      <td id="T_1cb11_row2_col2" class="data row2 col2" >0.941735</td>
      <td id="T_1cb11_row2_col3" class="data row2 col3" >0.946279</td>
      <td id="T_1cb11_row2_col4" class="data row2 col4" >0.680341</td>
      <td id="T_1cb11_row2_col5" class="data row2 col5" >0.901868</td>
      <td id="T_1cb11_row2_col6" class="data row2 col6" >15.606062</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_1cb11_row3_col0" class="data row3 col0" >Random Forest ADASYN</td>
      <td id="T_1cb11_row3_col1" class="data row3 col1" >0.928358</td>
      <td id="T_1cb11_row3_col2" class="data row3 col2" >0.939231</td>
      <td id="T_1cb11_row3_col3" class="data row3 col3" >0.928358</td>
      <td id="T_1cb11_row3_col4" class="data row3 col4" >0.664110</td>
      <td id="T_1cb11_row3_col5" class="data row3 col5" >0.890791</td>
      <td id="T_1cb11_row3_col6" class="data row3 col6" >19.692176</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_1cb11_row4_col0" class="data row4 col0" >KNN ADASYN</td>
      <td id="T_1cb11_row4_col1" class="data row4 col1" >0.889960</td>
      <td id="T_1cb11_row4_col2" class="data row4 col2" >0.940360</td>
      <td id="T_1cb11_row4_col3" class="data row4 col3" >0.889960</td>
      <td id="T_1cb11_row4_col4" class="data row4 col4" >0.634953</td>
      <td id="T_1cb11_row4_col5" class="data row4 col5" >0.789534</td>
      <td id="T_1cb11_row4_col6" class="data row4 col6" >1.833965</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_1cb11_row5_col0" class="data row5 col0" >XGBoost SMOTE</td>
      <td id="T_1cb11_row5_col1" class="data row5 col1" >0.904183</td>
      <td id="T_1cb11_row5_col2" class="data row5 col2" >0.935932</td>
      <td id="T_1cb11_row5_col3" class="data row5 col3" >0.904183</td>
      <td id="T_1cb11_row5_col4" class="data row5 col4" >0.631461</td>
      <td id="T_1cb11_row5_col5" class="data row5 col5" >0.863645</td>
      <td id="T_1cb11_row5_col6" class="data row5 col6" >3.014028</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_1cb11_row6_col0" class="data row6 col0" >Decision Tree SMOTE</td>
      <td id="T_1cb11_row6_col1" class="data row6 col1" >0.914795</td>
      <td id="T_1cb11_row6_col2" class="data row6 col2" >0.931758</td>
      <td id="T_1cb11_row6_col3" class="data row6 col3" >0.914795</td>
      <td id="T_1cb11_row6_col4" class="data row6 col4" >0.621513</td>
      <td id="T_1cb11_row6_col5" class="data row6 col5" >0.741104</td>
      <td id="T_1cb11_row6_col6" class="data row6 col6" >5.997123</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_1cb11_row7_col0" class="data row7 col0" >XGBoost ADASYN</td>
      <td id="T_1cb11_row7_col1" class="data row7 col1" >0.934346</td>
      <td id="T_1cb11_row7_col2" class="data row7 col2" >0.936610</td>
      <td id="T_1cb11_row7_col3" class="data row7 col3" >0.934346</td>
      <td id="T_1cb11_row7_col4" class="data row7 col4" >0.621089</td>
      <td id="T_1cb11_row7_col5" class="data row7 col5" >0.820975</td>
      <td id="T_1cb11_row7_col6" class="data row7 col6" >4.261749</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_1cb11_row8_col0" class="data row8 col0" >Decision Tree Class Weight</td>
      <td id="T_1cb11_row8_col1" class="data row8 col1" >0.918054</td>
      <td id="T_1cb11_row8_col2" class="data row8 col2" >0.936454</td>
      <td id="T_1cb11_row8_col3" class="data row8 col3" >0.918054</td>
      <td id="T_1cb11_row8_col4" class="data row8 col4" >0.617202</td>
      <td id="T_1cb11_row8_col5" class="data row8 col5" >0.639886</td>
      <td id="T_1cb11_row8_col6" class="data row8 col6" >3.958015</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row9" class="row_heading level0 row9" >12</th>
      <td id="T_1cb11_row9_col0" class="data row9 col0" >Logistic Regression L2 ADASYN</td>
      <td id="T_1cb11_row9_col1" class="data row9 col1" >0.856979</td>
      <td id="T_1cb11_row9_col2" class="data row9 col2" >0.937941</td>
      <td id="T_1cb11_row9_col3" class="data row9 col3" >0.856979</td>
      <td id="T_1cb11_row9_col4" class="data row9 col4" >0.608372</td>
      <td id="T_1cb11_row9_col5" class="data row9 col5" >0.853468</td>
      <td id="T_1cb11_row9_col6" class="data row9 col6" >3.368656</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row10" class="row_heading level0 row10" >9</th>
      <td id="T_1cb11_row10_col0" class="data row10 col0" >Logistic Regression SMOTE</td>
      <td id="T_1cb11_row10_col1" class="data row10 col1" >0.861162</td>
      <td id="T_1cb11_row10_col2" class="data row10 col2" >0.938084</td>
      <td id="T_1cb11_row10_col3" class="data row10 col3" >0.861162</td>
      <td id="T_1cb11_row10_col4" class="data row10 col4" >0.603995</td>
      <td id="T_1cb11_row10_col5" class="data row10 col5" >0.843352</td>
      <td id="T_1cb11_row10_col6" class="data row10 col6" >1.396368</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row11" class="row_heading level0 row11" >10</th>
      <td id="T_1cb11_row11_col0" class="data row11 col0" >Lasso SMOTE</td>
      <td id="T_1cb11_row11_col1" class="data row11 col1" >0.861162</td>
      <td id="T_1cb11_row11_col2" class="data row11 col2" >0.938084</td>
      <td id="T_1cb11_row11_col3" class="data row11 col3" >0.861162</td>
      <td id="T_1cb11_row11_col4" class="data row11 col4" >0.603995</td>
      <td id="T_1cb11_row11_col5" class="data row11 col5" >0.843352</td>
      <td id="T_1cb11_row11_col6" class="data row11 col6" >1.295548</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row12" class="row_heading level0 row12" >11</th>
      <td id="T_1cb11_row12_col0" class="data row12 col0" >Decision Tree</td>
      <td id="T_1cb11_row12_col1" class="data row12 col1" >0.928710</td>
      <td id="T_1cb11_row12_col2" class="data row12 col2" >0.927044</td>
      <td id="T_1cb11_row12_col3" class="data row12 col3" >0.928710</td>
      <td id="T_1cb11_row12_col4" class="data row12 col4" >0.602141</td>
      <td id="T_1cb11_row12_col5" class="data row12 col5" >0.604318</td>
      <td id="T_1cb11_row12_col6" class="data row12 col6" >6.715671</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row13" class="row_heading level0 row13" >13</th>
      <td id="T_1cb11_row13_col0" class="data row13 col0" >Logistic Regression L1 ADASYN</td>
      <td id="T_1cb11_row13_col1" class="data row13 col1" >0.855834</td>
      <td id="T_1cb11_row13_col2" class="data row13 col2" >0.938122</td>
      <td id="T_1cb11_row13_col3" class="data row13 col3" >0.855834</td>
      <td id="T_1cb11_row13_col4" class="data row13 col4" >0.600010</td>
      <td id="T_1cb11_row13_col5" class="data row13 col5" >0.845450</td>
      <td id="T_1cb11_row13_col6" class="data row13 col6" >2.900931</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row14" class="row_heading level0 row14" >14</th>
      <td id="T_1cb11_row14_col0" class="data row14 col0" >Lasso ADASYN</td>
      <td id="T_1cb11_row14_col1" class="data row14 col1" >0.855834</td>
      <td id="T_1cb11_row14_col2" class="data row14 col2" >0.938122</td>
      <td id="T_1cb11_row14_col3" class="data row14 col3" >0.855834</td>
      <td id="T_1cb11_row14_col4" class="data row14 col4" >0.600010</td>
      <td id="T_1cb11_row14_col5" class="data row14 col5" >0.845450</td>
      <td id="T_1cb11_row14_col6" class="data row14 col6" >2.853222</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row15" class="row_heading level0 row15" >15</th>
      <td id="T_1cb11_row15_col0" class="data row15 col0" >SVM</td>
      <td id="T_1cb11_row15_col1" class="data row15 col1" >0.883487</td>
      <td id="T_1cb11_row15_col2" class="data row15 col2" >0.931592</td>
      <td id="T_1cb11_row15_col3" class="data row15 col3" >0.883487</td>
      <td id="T_1cb11_row15_col4" class="data row15 col4" >0.599644</td>
      <td id="T_1cb11_row15_col5" class="data row15 col5" >0.793638</td>
      <td id="T_1cb11_row15_col6" class="data row15 col6" >19.223081</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row16" class="row_heading level0 row16" >16</th>
      <td id="T_1cb11_row16_col0" class="data row16 col0" >Ridge Classifier SMOTE</td>
      <td id="T_1cb11_row16_col1" class="data row16 col1" >0.841876</td>
      <td id="T_1cb11_row16_col2" class="data row16 col2" >0.940039</td>
      <td id="T_1cb11_row16_col3" class="data row16 col3" >0.841876</td>
      <td id="T_1cb11_row16_col4" class="data row16 col4" >0.594559</td>
      <td id="T_1cb11_row16_col5" class="data row16 col5" >0.855391</td>
      <td id="T_1cb11_row16_col6" class="data row16 col6" >0.650142</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row17" class="row_heading level0 row17" >17</th>
      <td id="T_1cb11_row17_col0" class="data row17 col0" >Ridge Classifier ADASYN</td>
      <td id="T_1cb11_row17_col1" class="data row17 col1" >0.827961</td>
      <td id="T_1cb11_row17_col2" class="data row17 col2" >0.941037</td>
      <td id="T_1cb11_row17_col3" class="data row17 col3" >0.827961</td>
      <td id="T_1cb11_row17_col4" class="data row17 col4" >0.586710</td>
      <td id="T_1cb11_row17_col5" class="data row17 col5" >nan</td>
      <td id="T_1cb11_row17_col6" class="data row17 col6" >2.265856</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row18" class="row_heading level0 row18" >18</th>
      <td id="T_1cb11_row18_col0" class="data row18 col0" >Logistic Regression (Optimized)</td>
      <td id="T_1cb11_row18_col1" class="data row18 col1" >0.786746</td>
      <td id="T_1cb11_row18_col2" class="data row18 col2" >0.944338</td>
      <td id="T_1cb11_row18_col3" class="data row18 col3" >0.786746</td>
      <td id="T_1cb11_row18_col4" class="data row18 col4" >0.564742</td>
      <td id="T_1cb11_row18_col5" class="data row18 col5" >0.843093</td>
      <td id="T_1cb11_row18_col6" class="data row18 col6" >0.627129</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row19" class="row_heading level0 row19" >19</th>
      <td id="T_1cb11_row19_col0" class="data row19 col0" >Lasso Class Weight</td>
      <td id="T_1cb11_row19_col1" class="data row19 col1" >0.786746</td>
      <td id="T_1cb11_row19_col2" class="data row19 col2" >0.944338</td>
      <td id="T_1cb11_row19_col3" class="data row19 col3" >0.786746</td>
      <td id="T_1cb11_row19_col4" class="data row19 col4" >0.564742</td>
      <td id="T_1cb11_row19_col5" class="data row19 col5" >0.843093</td>
      <td id="T_1cb11_row19_col6" class="data row19 col6" >0.620213</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row20" class="row_heading level0 row20" >20</th>
      <td id="T_1cb11_row20_col0" class="data row20 col0" >L1 Regression Class Weight</td>
      <td id="T_1cb11_row20_col1" class="data row20 col1" >0.786746</td>
      <td id="T_1cb11_row20_col2" class="data row20 col2" >0.944338</td>
      <td id="T_1cb11_row20_col3" class="data row20 col3" >0.786746</td>
      <td id="T_1cb11_row20_col4" class="data row20 col4" >0.564742</td>
      <td id="T_1cb11_row20_col5" class="data row20 col5" >0.843093</td>
      <td id="T_1cb11_row20_col6" class="data row20 col6" >0.543312</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row21" class="row_heading level0 row21" >21</th>
      <td id="T_1cb11_row21_col0" class="data row21 col0" >Lasso Regression</td>
      <td id="T_1cb11_row21_col1" class="data row21 col1" >0.786746</td>
      <td id="T_1cb11_row21_col2" class="data row21 col2" >0.944338</td>
      <td id="T_1cb11_row21_col3" class="data row21 col3" >0.786746</td>
      <td id="T_1cb11_row21_col4" class="data row21 col4" >0.564742</td>
      <td id="T_1cb11_row21_col5" class="data row21 col5" >0.843093</td>
      <td id="T_1cb11_row21_col6" class="data row21 col6" >0.562608</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row22" class="row_heading level0 row22" >22</th>
      <td id="T_1cb11_row22_col0" class="data row22 col0" >Random Forest</td>
      <td id="T_1cb11_row22_col1" class="data row22 col1" >0.951739</td>
      <td id="T_1cb11_row22_col2" class="data row22 col2" >0.933021</td>
      <td id="T_1cb11_row22_col3" class="data row22 col3" >0.951739</td>
      <td id="T_1cb11_row22_col4" class="data row22 col4" >0.554729</td>
      <td id="T_1cb11_row22_col5" class="data row22 col5" >0.901538</td>
      <td id="T_1cb11_row22_col6" class="data row22 col6" >10.090616</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row23" class="row_heading level0 row23" >23</th>
      <td id="T_1cb11_row23_col0" class="data row23 col0" >L2 Regression Class Weight</td>
      <td id="T_1cb11_row23_col1" class="data row23 col1" >0.759533</td>
      <td id="T_1cb11_row23_col2" class="data row23 col2" >0.946894</td>
      <td id="T_1cb11_row23_col3" class="data row23 col3" >0.759533</td>
      <td id="T_1cb11_row23_col4" class="data row23 col4" >0.551091</td>
      <td id="T_1cb11_row23_col5" class="data row23 col5" >0.853546</td>
      <td id="T_1cb11_row23_col6" class="data row23 col6" >0.853106</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row24" class="row_heading level0 row24" >24</th>
      <td id="T_1cb11_row24_col0" class="data row24 col0" >Ridge Classifier Class Weight</td>
      <td id="T_1cb11_row24_col1" class="data row24 col1" >0.743989</td>
      <td id="T_1cb11_row24_col2" class="data row24 col2" >0.948202</td>
      <td id="T_1cb11_row24_col3" class="data row24 col3" >0.743989</td>
      <td id="T_1cb11_row24_col4" class="data row24 col4" >0.543034</td>
      <td id="T_1cb11_row24_col5" class="data row24 col5" >nan</td>
      <td id="T_1cb11_row24_col6" class="data row24 col6" >0.637271</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row25" class="row_heading level0 row25" >25</th>
      <td id="T_1cb11_row25_col0" class="data row25 col0" >XGBoost</td>
      <td id="T_1cb11_row25_col1" class="data row25 col1" >0.921500</td>
      <td id="T_1cb11_row25_col2" class="data row25 col2" >0.942800</td>
      <td id="T_1cb11_row25_col3" class="data row25 col3" >0.921500</td>
      <td id="T_1cb11_row25_col4" class="data row25 col4" >0.532100</td>
      <td id="T_1cb11_row25_col5" class="data row25 col5" >0.872300</td>
      <td id="T_1cb11_row25_col6" class="data row25 col6" >2.335257</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row26" class="row_heading level0 row26" >26</th>
      <td id="T_1cb11_row26_col0" class="data row26 col0" >SVM SMOTE</td>
      <td id="T_1cb11_row26_col1" class="data row26 col1" >0.875200</td>
      <td id="T_1cb11_row26_col2" class="data row26 col2" >0.928500</td>
      <td id="T_1cb11_row26_col3" class="data row26 col3" >0.875200</td>
      <td id="T_1cb11_row26_col4" class="data row26 col4" >0.521800</td>
      <td id="T_1cb11_row26_col5" class="data row26 col5" >0.815600</td>
      <td id="T_1cb11_row26_col6" class="data row26 col6" >109.753539</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row27" class="row_heading level0 row27" >27</th>
      <td id="T_1cb11_row27_col0" class="data row27 col0" >SVM Class Weight</td>
      <td id="T_1cb11_row27_col1" class="data row27 col1" >0.868900</td>
      <td id="T_1cb11_row27_col2" class="data row27 col2" >0.925600</td>
      <td id="T_1cb11_row27_col3" class="data row27 col3" >0.868900</td>
      <td id="T_1cb11_row27_col4" class="data row27 col4" >0.515600</td>
      <td id="T_1cb11_row27_col5" class="data row27 col5" >0.808400</td>
      <td id="T_1cb11_row27_col6" class="data row27 col6" >0.324935</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row28" class="row_heading level0 row28" >28</th>
      <td id="T_1cb11_row28_col0" class="data row28 col0" >SVM ADASYN</td>
      <td id="T_1cb11_row28_col1" class="data row28 col1" >0.852300</td>
      <td id="T_1cb11_row28_col2" class="data row28 col2" >0.918300</td>
      <td id="T_1cb11_row28_col3" class="data row28 col3" >0.852300</td>
      <td id="T_1cb11_row28_col4" class="data row28 col4" >0.498700</td>
      <td id="T_1cb11_row28_col5" class="data row28 col5" >0.792100</td>
      <td id="T_1cb11_row28_col6" class="data row28 col6" >47.715541</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row29" class="row_heading level0 row29" >30</th>
      <td id="T_1cb11_row29_col0" class="data row29 col0" >Naive Bayes SMOTE</td>
      <td id="T_1cb11_row29_col1" class="data row29 col1" >0.834600</td>
      <td id="T_1cb11_row29_col2" class="data row29 col2" >0.912400</td>
      <td id="T_1cb11_row29_col3" class="data row29 col3" >0.834600</td>
      <td id="T_1cb11_row29_col4" class="data row29 col4" >0.482100</td>
      <td id="T_1cb11_row29_col5" class="data row29 col5" >0.781200</td>
      <td id="T_1cb11_row29_col6" class="data row29 col6" >2.373638</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row30" class="row_heading level0 row30" >31</th>
      <td id="T_1cb11_row30_col0" class="data row30 col0" >Naive Bayes ADASYN</td>
      <td id="T_1cb11_row30_col1" class="data row30 col1" >0.821700</td>
      <td id="T_1cb11_row30_col2" class="data row30 col2" >0.908700</td>
      <td id="T_1cb11_row30_col3" class="data row30 col3" >0.821700</td>
      <td id="T_1cb11_row30_col4" class="data row30 col4" >0.473800</td>
      <td id="T_1cb11_row30_col5" class="data row30 col5" >0.773800</td>
      <td id="T_1cb11_row30_col6" class="data row30 col6" >151.041608</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row31" class="row_heading level0 row31" >29</th>
      <td id="T_1cb11_row31_col0" class="data row31 col0" >Naive Bayes</td>
      <td id="T_1cb11_row31_col1" class="data row31 col1" >0.812400</td>
      <td id="T_1cb11_row31_col2" class="data row31 col2" >0.901200</td>
      <td id="T_1cb11_row31_col3" class="data row31 col3" >0.812400</td>
      <td id="T_1cb11_row31_col4" class="data row31 col4" >0.465300</td>
      <td id="T_1cb11_row31_col5" class="data row31 col5" >0.765400</td>
      <td id="T_1cb11_row31_col6" class="data row31 col6" >0.764103</td>
    </tr>
    <tr>
      <th id="T_1cb11_level0_row32" class="row_heading level0 row32" >32</th>
      <td id="T_1cb11_row32_col0" class="data row32 col0" >Ridge Classifier</td>
      <td id="T_1cb11_row32_col1" class="data row32 col1" >0.798500</td>
      <td id="T_1cb11_row32_col2" class="data row32 col2" >0.895400</td>
      <td id="T_1cb11_row32_col3" class="data row32 col3" >0.798500</td>
      <td id="T_1cb11_row32_col4" class="data row32 col4" >0.445200</td>
      <td id="T_1cb11_row32_col5" class="data row32 col5" >0.752100</td>
      <td id="T_1cb11_row32_col6" class="data row32 col6" >0.306190</td>
    </tr>
  </tbody>
</table>
</div><div class="output text_html">
<h3 style="
    background-color:#27AE60;
    color:#FFFFFF;
    padding:12px;
    border-radius:6px;
    font-family:'Segoe UI', Arial, sans-serif;
    font-size:18px;
    font-weight:600;
    margin-top:30px;
    margin-bottom:15px;
    text-align:center;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
">
    TOP 3 MEJORES MODELOS (por F1-Score)
</h3>
</div><div class="output text_html"><style type="text/css">
#T_aec23 thead th {
  background-color: #34495E;
  color: white;
  font-weight: bold;
  text-align: center;
  padding: 12px;
  font-size: 14px;
}
#T_aec23 td {
  text-align: center;
  padding: 10px;
  font-size: 13px;
  border: 1px solid #BDC3C7;
}
#T_aec23 tr:nth-child(even) {
  background-color: #F8F9F9;
}
#T_aec23 tr:nth-child(odd) {
  background-color: white;
}
</style>
<table id="T_aec23">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_aec23_level0_col0" class="col_heading level0 col0" >Posición</th>
      <th id="T_aec23_level0_col1" class="col_heading level0 col1" >Modelo</th>
      <th id="T_aec23_level0_col2" class="col_heading level0 col2" >F1-Score</th>
      <th id="T_aec23_level0_col3" class="col_heading level0 col3" >Accuracy</th>
      <th id="T_aec23_level0_col4" class="col_heading level0 col4" >Precision</th>
      <th id="T_aec23_level0_col5" class="col_heading level0 col5" >Recall</th>
      <th id="T_aec23_level0_col6" class="col_heading level0 col6" >AUC</th>
      <th id="T_aec23_level0_col7" class="col_heading level0 col7" >Tiempo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_aec23_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_aec23_row0_col0" class="data row0 col0" >🥇 PRIMERO</td>
      <td id="T_aec23_row0_col1" class="data row0 col1" >XGBoost Scale Weight</td>
      <td id="T_aec23_row0_col2" class="data row0 col2" >0.754762</td>
      <td id="T_aec23_row0_col3" class="data row0 col3" >0.953016</td>
      <td id="T_aec23_row0_col4" class="data row0 col4" >0.955131</td>
      <td id="T_aec23_row0_col5" class="data row0 col5" >0.953016</td>
      <td id="T_aec23_row0_col6" class="data row0 col6" >0.906217</td>
      <td id="T_aec23_row0_col7" class="data row0 col7" >3.530824</td>
    </tr>
    <tr>
      <th id="T_aec23_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_aec23_row1_col0" class="data row1 col0" >🥈 SEGUNDO</td>
      <td id="T_aec23_row1_col1" class="data row1 col1" >Random Forest Class Weight</td>
      <td id="T_aec23_row1_col2" class="data row1 col2" >0.696587</td>
      <td id="T_aec23_row1_col3" class="data row1 col3" >0.939498</td>
      <td id="T_aec23_row1_col4" class="data row1 col4" >0.944663</td>
      <td id="T_aec23_row1_col5" class="data row1 col5" >0.939498</td>
      <td id="T_aec23_row1_col6" class="data row1 col6" >0.912740</td>
      <td id="T_aec23_row1_col7" class="data row1 col7" >15.135563</td>
    </tr>
    <tr>
      <th id="T_aec23_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_aec23_row2_col0" class="data row2 col0" >🥉 TERCERO</td>
      <td id="T_aec23_row2_col1" class="data row2 col1" >Random Forest SMOTE</td>
      <td id="T_aec23_row2_col2" class="data row2 col2" >0.680341</td>
      <td id="T_aec23_row2_col3" class="data row2 col3" >0.946279</td>
      <td id="T_aec23_row2_col4" class="data row2 col4" >0.941735</td>
      <td id="T_aec23_row2_col5" class="data row2 col5" >0.946279</td>
      <td id="T_aec23_row2_col6" class="data row2 col6" >0.901868</td>
      <td id="T_aec23_row2_col7" class="data row2 col7" >15.606062</td>
    </tr>
  </tbody>
</table>
</div><div class="output text_html">
<h3 style="
    background-color:#E74C3C;
    color:#FFFFFF;
    padding:12px;
    border-radius:6px;
    font-family:'Segoe UI', Arial, sans-serif;
    font-size:18px;
    font-weight:600;
    margin-top:30px;
    margin-bottom:15px;
    text-align:center;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
">
    MEJOR MODELO GLOBAL
</h3>
</div><div class="output text_html">
<div style="
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding:25px;
    border-radius:10px;
    color:white;
    font-family:'Segoe UI', Arial, sans-serif;
    margin-bottom:20px;
    box-shadow:0 6px 20px rgba(0,0,0,0.15);
    text-align:center;
">
    <h3 style="margin:0 0 15px 0; font-size:22px; font-weight:bold;">
         XGBoost Scale Weight
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; background:rgba(255,255,255,0.1); padding:20px; border-radius:8px;">
        <div style="text-align: center;">
            <div style="font-size:12px; opacity:0.9;">F1-Score</div>
            <div style="font-size:18px; font-weight:bold;">0.754762</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size:12px; opacity:0.9;">Accuracy</div>
            <div style="font-size:18px; font-weight:bold;">0.953016</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size:12px; opacity:0.9;">Precision</div>
            <div style="font-size:18px; font-weight:bold;">0.955131</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size:12px; opacity:0.9;">Recall</div>
            <div style="font-size:18px; font-weight:bold;">0.953016</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size:12px; opacity:0.9;">AUC</div>
            <div style="font-size:18px; font-weight:bold;">0.906217</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size:12px; opacity:0.9;">Tiempo</div>
            <div style="font-size:18px; font-weight:bold;">3.530824s</div>
        </div>
    </div>
</div>
</div><div class="output text_html">
<h3 style="
    background-color:#8E44AD;
    color:#FFFFFF;
    padding:12px;
    border-radius:6px;
    font-family:'Segoe UI', Arial, sans-serif;
    font-size:18px;
    font-weight:600;
    margin-top:30px;
    margin-bottom:15px;
    text-align:center;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
">
    ESTADÍSTICAS DEL ANÁLISIS
</h3>
</div><div class="output text_html">
<div style="
    background-color:#F8F9FA;
    padding:20px;
    border-radius:8px;
    border-left:4px solid #3498DB;
    font-family:'Segoe UI', Arial, sans-serif;
    margin-bottom:20px;
">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#7F8C8D; margin-bottom:8px;">Total de modelos</div>
            <div style="font-size:24px; color:#2C3E50; font-weight:bold;">33</div>
        </div>
        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#7F8C8D; margin-bottom:8px;">Rango F1-Score</div>
            <div style="font-size:14px; color:#2C3E50; font-weight:bold;">0.445200 - 0.754762</div>
        </div>
        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#7F8C8D; margin-bottom:8px;">Rango Accuracy</div>
            <div style="font-size:14px; color:#2C3E50; font-weight:bold;">0.743989 - 0.953016</div>
        </div>
        <div style="text-align: center; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#7F8C8D; margin-bottom:8px;">Rango Tiempo</div>
            <div style="font-size:14px; color:#2C3E50; font-weight:bold;">0.306190s - 151.041608s</div>
        </div>
    </div>
    
</div>
</div></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="conclusion-comparativa-y-seleccion-del-mejor-modelo">
<h1>Conclusión Comparativa y Selección del Mejor Modelo<a class="headerlink" href="#conclusion-comparativa-y-seleccion-del-mejor-modelo" title="Permalink to this heading">#</a></h1>
<p>Para nuestro proyecto de aprendizaje automático desarrollado se abordó un problema real dentro del campo de la producción musical digital, empleando información proveniente de Spotify para analizar y predecir patrones de popularidad en canciones a partir de sus características acústicas, rítmicas y tonales.</p>
<p>Desde el <strong>Análisis Exploratorio de Datos</strong> se identificaron relaciones clave entre variables como energy, danceability, valence y speechiness con el nivel de popularidad de una canción, revelando tendencias propias de géneros y dinámicas de mercado. La detección de outliers, el tratamiento de valores faltantes y la verificación del balance de clases permitieron limpiar y preparar los datos de forma rigurosa. Asimismo, la reducción exploratoria mediante PCA mostró que gran parte de la variabilidad puede explicarse por unas pocas dimensiones relacionadas con la energía y el ritmo, validando la relevancia musical de estas variables.</p>
<p>En la etapa de <strong>modelado Benchmark</strong>, se implementaron y compararon algoritmos representativos de diferentes familias:</p>
<ul class="simple">
<li><p>Modelos lineales (Regresión Logística, Ridge, Lasso) para establecer una base interpretable.</p></li>
<li><p>Modelos probabilísticos (Naive Bayes) y basados en instancias (KNN) para explorar relaciones locales.</p></li>
<li><p>Modelos no lineales y de ensamble (Árboles de Decisión, Random Forest, XGBoost) para capturar interacciones complejas.</p></li>
</ul>
<p>Finalmente, SVM permitió contrastar el rendimiento de modelos con fronteras de decisión más flexibles.</p>
<p>La comparación inicial evidenció que los modelos de ensamble superaron en desempeño a los lineales, logrando mejores métricas de F1-weighted, Recall y AUC-ROC, lo que indica una mejor capacidad para identificar correctamente canciones populares sin sacrificar la precisión general del sistema.</p>
<p>Posteriormente, la aplicación de técnicas de balanceo de clases (SMOTE, ADASYN y class_weight=’balanced’) fue determinante para mitigar el sesgo hacia la clase mayoritaria. El uso de SMOTE mejoró especialmente el recall de la clase minoritaria, demostrando la importancia de estas estrategias cuando se trabaja con datos desbalanceados, un problema común en el análisis musical donde solo un pequeño porcentaje de canciones alcanza altos niveles de popularidad.</p>
<p>En la sección de <strong>Optimización Computacional</strong>, se implementaron mejoras específicas para cada modelo, tales como el uso de KD-Trees en KNN, solvers optimizados en modelos lineales y métodos de histogramas y early stopping en XGBoost, reduciendo significativamente los tiempos de entrenamiento sin afectar la calidad de las predicciones.</p>
<p>La Validación Avanzada y el Tuning de Hiperparámetros mediante GridSearchCV con StratifiedKFold (5 folds) permitieron refinar cada modelo de manera sistemática, garantizando una evaluación justa y replicable. El modelo XGBoost optimizado destacó por su estabilidad, precisión y robustez frente al desbalance, alcanzando los mejores valores de F1-weighted, Recall Clase 1 y AUC en el conjunto de prueba.</p>
<p>En la etapa de <strong>Interpretabilidad</strong>, se utilizaron importancias de características, Permutation Importance y análisis de coeficientes para comprender la influencia de cada variable. Este análisis reveló que atributos como energy, danceability, valence y acousticness tienen un peso considerable en la predicción de popularidad. Desde una perspectiva musical, estos resultados sugieren que las canciones más bailables, enérgicas y con mayor positividad emocional tienden a ser mejor recibidas por el público, confirmando hipótesis empíricas del ámbito de la producción musical contemporánea.</p>
<p>Finalmente, la evaluación comparativa integral confirmó que la sinergia entre preprocesamiento, balanceo, optimización y tuning puede transformar un conjunto de datos inicialmente limitado en una herramienta predictiva sólida para la toma de decisiones en la industria musical. El pipeline construido es reproducible, interpretable y escalable, lo que lo convierte en una base valiosa para futuros proyectos de predicción de éxito musical, recomendación automatizada o análisis de tendencias de escucha en plataformas digitales.</p>
<section id="interpretacion-de-mejor-modelo">
<h2>Interpretación de Mejor Modelo<a class="headerlink" href="#interpretacion-de-mejor-modelo" title="Permalink to this heading">#</a></h2>
<p>Para nuestro objetivo como entrega de información con la base de datos de Spotify, demuestra que:</p>
<ul class="simple">
<li><p>Hay un pipeline bien diseñado y documentado puede competir con metodologías industriales en rendimiento y transparencia.</p></li>
<li><p>Las variables de energía, positividad y bailabilidad son determinantes en la percepción de popularidad musical.</p></li>
<li><p>El modelo XGBoost optimizado con balanceo SMOTE representa la solución más eficiente, estable y explicable para este problema.</p></li>
</ul>
<p>Además de estas caraterísticas y resultados, evidenciamos que el modelo mejor seleccionado fue <strong>XGBoost Scale Weight</strong>, vemos que combina de manera excepcional un alto rendimiento predictivo con un F1-Score de 0.754762, lo que demuestra una capacidad sobresaliente para manejar el desbalance de clases, manteniendo simultáneamente una Accuracy del 95.30% y un AUC de 90.62%. Además, su tiempo de entrenamiento de apenas 3.53 segundos lo posiciona como uno de los modelos más rápidos dentro del top 10, ofreciendo un equilibrio ideal entre precisión y velocidad que lo hace ideal para implementaciones en producción donde se requieren tanto predicciones confiables como respuestas ágiles.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="propuesta-de-modelo-original">
<h1>Propuesta de Modelo Original<a class="headerlink" href="#propuesta-de-modelo-original" title="Permalink to this heading">#</a></h1>
<section id="imboost-improved-boosting-for-imbalanced-data">
<h2>IMBoost (Improved Boosting for Imbalanced Data)<a class="headerlink" href="#imboost-improved-boosting-for-imbalanced-data" title="Permalink to this heading">#</a></h2>
<p>IMBoost es una variante mejorada de AdaBoost diseñada para conjuntos de datos desbalanceados, siendo mayoritariamente nuestro caso. Aunque AdaBoost tradicional trata por igual a todas las muestras, IMBoost calcula y actualiza los pesos de manera independiente para las clases minoritaria y mayoritaria, basándose en el rendimiento del clasificador en cada una de ellas. Esto permite un aprendizaje más equilibrado y reduce el sesgo hacia la clase mayoritaria.</p>
<p>Al evaluar el contexto del modelo, encontramos ventajas importantes para darle oportunidad de ser implementadas a nuestro proyecto:</p>
<ul class="simple">
<li><p><strong>Tiene un Balanceo adaptativo</strong>: Los pesos iniciales se asignan en función de la distribución de las clases (<span class="math notranslate nohighlight">\(1/N_{\min}\)</span> para minoritaria, <span class="math notranslate nohighlight">\(1/N_{\text{maj}}\)</span> para mayoritaria).</p></li>
<li><p><strong>Actualiza de manera dual los errores</strong>: Se calculan <span class="math notranslate nohighlight">\(\epsilon_{\min}\)</span> y <span class="math notranslate nohighlight">\(\epsilon_{\text{maj}}\)</span> de forma separada, lo que permite ajustar la influencia de cada clase en el proceso de boosting.</p></li>
<li><p>En cada iteración, el dataset se remuestrea según los pesos actualizados, favoreciendo la repetición de muestras difíciles o mal clasificadas.</p></li>
<li><p><strong>Tiene interpretabilidad estadística</strong>: El método se fundamenta en el modelado aditivo por etapas (Forward Stagewise Additive Modeling) con función de pérdida exponencial.</p></li>
</ul>
<section id="aplicacion-en-el-proyecto">
<h3>Aplicación en el proyecto<a class="headerlink" href="#aplicacion-en-el-proyecto" title="Permalink to this heading">#</a></h3>
<p>Se implementó IMBoost utilizando árboles de decisión como clasificadores débiles, optimizando los hiperparámetros mediante <strong>Optuna</strong> con validación cruzada para evitar data leakage. El proceso de optimización evaluó 30 trials, buscando maximizar el F1-Macro.</p>
<p><strong>Parámetros óptimos encontrados:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_estimators</span></code>: 176</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_depth</span></code>: 14</p></li>
</ul>
</section>
<section id="resultado-destacado">
<h3>Resultado destacado<a class="headerlink" href="#resultado-destacado" title="Permalink to this heading">#</a></h3>
<p><strong>IMBoost optimizado superó significativamente al mejor modelo anterior (XGBoost Scale Weight):</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Modelo</p></th>
<th class="head"><p>F1-Macro</p></th>
<th class="head"><p>Accuracy</p></th>
<th class="head"><p>AUC</p></th>
<th class="head"><p>Mejora vs Baseline</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>XGBoost Scale Weight</p></td>
<td><p>0.7548</p></td>
<td><p>0.9530</p></td>
<td><p>0.9062</p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p>IMBoost Optimizado</p></td>
<td><p><strong>0.8030</strong></p></td>
<td><p><strong>0.9633</strong></p></td>
<td><p>0.8927</p></td>
<td><p><strong>+0.3125</strong></p></td>
</tr>
</tbody>
</table>
</div>
<p>El modelo logró un <strong>F1-Macro de 0.8030</strong> en el conjunto de test, representando una mejora de <strong>0.3125 puntos</strong> respecto a la versión sin optimizar (F1-Macro: 0.4905).</p>
</section>
<section id="por-que-destaca">
<h3>Por qué destaca<a class="headerlink" href="#por-que-destaca" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Rendimiento superior</strong>: IMBoost optimizado supera en <strong>0.0482 puntos de F1-Macro</strong> al anterior mejor modelo (XGBoost Scale Weight)</p></li>
<li><p><strong>Balanceo efectivo</strong>: Mejora significativa en la clase minoritaria (F1-Clase 1: 0.6253 vs 0.1516 en baseline)</p></li>
<li><p><strong>Optimización rigurosa</strong>: Proceso de tuning con Optuna que validó 30 combinaciones diferentes</p></li>
<li><p><strong>Generalización robusta</strong>: Alto rendimiento en conjunto de test manteniendo buen performance en clase mayoritaria (F1-Clase 0: 0.9807)</p></li>
</ol>
</section>
<section id="referencia-metodologica-basada-en">
<h3>Referencia metodológica basada en<a class="headerlink" href="#referencia-metodologica-basada-en" title="Permalink to this heading">#</a></h3>
<p>Roshan, S., Tanha, J., Hallaji, F., &amp; Ghanbari, M. (2023). <em>IMBoost: A New Weighting Factor for Boosting to Improve the Classification Performance of Imbalanced Data</em>. Complexity, 2023, Article ID 2176891. <a class="reference external" href="https://doi.org/10.1155/2023/2176891">https://doi.org/10.1155/2023/2176891</a></p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="implementacion-del-modelo-original-y-comparacion">
<h1>Implementación del Modelo Original y Comparación<a class="headerlink" href="#implementacion-del-modelo-original-y-comparacion" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_X_y</span><span class="p">,</span> <span class="n">check_array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">make_scorer</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">optuna.samplers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TPESampler</span>

<span class="c1"># DEFINICIÓN DE IMBoost</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NotFittedError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception class to raise if estimator is used before fitting.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IMBoost</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="n">n_estimators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Validar y convertir datos</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Convertir a numpy arrays para evitar problemas con pandas</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        
        <span class="c1"># Identificar clases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;IMBoost solo funciona para problemas binarios&quot;</span><span class="p">)</span>
        
        <span class="c1"># Asumir que la clase 1 es la minoritaria </span>
        <span class="n">minority_class</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">majority_class</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Convertir etiquetas a -1 y 1 para el algoritmo de boosting</span>
        <span class="n">y_transformed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">minority_class</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">minority_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">minority_class</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">majority_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">majority_class</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">n_minority</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">minority_indices</span><span class="p">)</span>
        <span class="n">n_majority</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">majority_indices</span><span class="p">)</span>
        
        <span class="c1"># Inicializar pesos como en el paper</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">minority_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n_minority</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">majority_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n_majority</span>
        
        <span class="c1"># Inicializar listas para almacenar modelos y pesos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifiers_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphas_min_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphas_maj_</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Remuestreo basado en pesos</span>
                <span class="n">sample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span> 
                    <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> 
                    <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                    <span class="n">p</span><span class="o">=</span><span class="n">weights</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="p">)</span>
                
                <span class="n">X_resampled</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">sample_indices</span><span class="p">]</span>
                <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">y_transformed</span><span class="p">[</span><span class="n">sample_indices</span><span class="p">]</span>
                
                <span class="c1"># Entrenar clasificador débil</span>
                <span class="n">base_clf</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span>
                    <span class="n">max_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span>
                    <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">+</span> <span class="n">t</span>
                <span class="p">)</span>
                <span class="n">base_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">)</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">base_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                
                <span class="c1"># Calcular errores por clase separadamente</span>
                <span class="n">minority_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_transformed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">majority_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_transformed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># Calcular errores ponderados</span>
                <span class="n">error_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y_transformed</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">]))</span>
                <span class="n">error_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y_transformed</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">]))</span>
                
                <span class="n">total_weight_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">])</span>
                <span class="n">total_weight_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">])</span>
                
                <span class="n">epsilon_min</span> <span class="o">=</span> <span class="n">error_min</span> <span class="o">/</span> <span class="n">total_weight_min</span> <span class="k">if</span> <span class="n">total_weight_min</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.5</span>
                <span class="n">epsilon_maj</span> <span class="o">=</span> <span class="n">error_maj</span> <span class="o">/</span> <span class="n">total_weight_maj</span> <span class="k">if</span> <span class="n">total_weight_maj</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.5</span>
                
                <span class="c1"># Evitamos división por cero y valores extremos</span>
                <span class="n">epsilon_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">epsilon_min</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1e-10</span><span class="p">)</span>
                <span class="n">epsilon_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">epsilon_maj</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1e-10</span><span class="p">)</span>
                
                <span class="c1"># Calculamos alpha para cada clase</span>
                <span class="n">alpha_min</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">epsilon_min</span><span class="p">)</span>
                <span class="n">alpha_maj</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon_maj</span><span class="p">)</span> <span class="o">/</span> <span class="n">epsilon_maj</span><span class="p">)</span>
                
                <span class="c1"># Actualizar pesos</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha_min</span> <span class="o">*</span> <span class="n">y_transformed</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">minority_mask</span><span class="p">])</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha_maj</span> <span class="o">*</span> <span class="n">y_transformed</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">majority_mask</span><span class="p">])</span>
                
                <span class="c1"># Normalizar pesos</span>
                <span class="n">weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                
                <span class="c1"># Guardar modelo y pesos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classifiers_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_clf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alphas_min_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_min</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alphas_maj_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha_maj</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en iteración </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="c1"># Marcar como ajustado</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features_in_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># Verificar si está ajustado usando classifiers_</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;classifiers_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifiers_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="s2">&quot;This IMBoost instance is not fitted yet. Call &#39;fit&#39; with appropriate arguments before using this estimator.&quot;</span><span class="p">)</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
            
        <span class="c1"># Calcular predicción ponderada</span>
        <span class="n">pred_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pred_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">alpha_min</span><span class="p">,</span> <span class="n">alpha_maj</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphas_min_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_maj_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifiers_</span><span class="p">):</span>
            <span class="n">clf_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">pred_min</span> <span class="o">+=</span> <span class="n">alpha_min</span> <span class="o">*</span> <span class="n">clf_pred</span>
            <span class="n">pred_maj</span> <span class="o">+=</span> <span class="n">alpha_maj</span> <span class="o">*</span> <span class="n">clf_pred</span>
        
        <span class="c1"># Combinar predicciones </span>
        <span class="n">final_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pred_min</span> <span class="o">+</span> <span class="n">pred_maj</span><span class="p">)</span>
        
        <span class="c1"># Convertir de vuelta a las etiquetas originales (0 y 1)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># Verificar si está ajustado usando classifiers_</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;classifiers_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifiers_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="s2">&quot;This IMBoost instance is not fitted yet. Call &#39;fit&#39; with appropriate arguments before using this estimator.&quot;</span><span class="p">)</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
            
        <span class="n">pred_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pred_maj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">alpha_min</span><span class="p">,</span> <span class="n">alpha_maj</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphas_min_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_maj_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifiers_</span><span class="p">):</span>
            <span class="n">clf_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">pred_min</span> <span class="o">+=</span> <span class="n">alpha_min</span> <span class="o">*</span> <span class="n">clf_pred</span>
            <span class="n">pred_maj</span> <span class="o">+=</span> <span class="n">alpha_maj</span> <span class="o">*</span> <span class="n">clf_pred</span>
        
        <span class="c1"># Convertir a probabilidades usando sigmoid</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">pred_min</span> <span class="o">+</span> <span class="n">pred_maj</span>
        <span class="n">proba_positive</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">scores</span><span class="p">))</span>
        
        <span class="c1"># Asegurar que las probabilidades estén entre 0 y 1</span>
        <span class="n">proba_positive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">proba_positive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">proba_negative</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">proba_positive</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">proba_negative</span><span class="p">,</span> <span class="n">proba_positive</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># CONFIGURACIÓN INICIAL Y PREPROCESAMIENTO</span>
<span class="n">RANDOM_STATE</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_STATE</span><span class="p">)</span>

<span class="c1"># Configuración de características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>

<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span>

<span class="c1"># Preprocesamiento</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Validación cruzada</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DIVISIÓN CORRECTA DE DATOS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Dividir en train + validation, y test</span>
<span class="n">X_temp</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># Dividir temp en train y validation</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_temp</span>  <span class="c1"># 0.25 * 0.8 = 0.2</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation: </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proporción clases en train - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proporción clases en val - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proporción clases en test - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># EVALUACIÓN BASE</span>

<span class="c1"># Crear pipeline base</span>
<span class="n">imboost_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">IMBoost</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">))</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ENTRENANDO IMBoost BASE...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">imboost_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluación base en validation set</span>
<span class="n">y_pred_base</span> <span class="o">=</span> <span class="n">imboost_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="n">y_proba_base</span> <span class="o">=</span> <span class="n">imboost_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_val</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">IMBoost BASE - Resultados en Validation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Macro: </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_base</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 (Clase 0): </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_base</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 (Clase 1): </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_base</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Definir F1-Macro como métrica principal</span>
<span class="n">f1_macro_scorer</span> <span class="o">=</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">f1_score</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Función objetivo para Optuna SIN data leakage&quot;&quot;&quot;</span>
    <span class="c1"># hiperparámetros</span>
    <span class="n">n_estimators</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    
    <span class="c1"># Crear modelo con los hiperparámetros sugeridos</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">IMBoost</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span>
    <span class="p">)</span>
    
    <span class="c1"># Pipeline con preprocesador</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="c1"># Calcular F1-Macro con validación cruzada en TRAIN</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                               <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">f1_macro_scorer</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f1_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">f1_mean</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="k">return</span> <span class="n">f1_mean</span>

<span class="c1"># estudio de Optuna</span>
<span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
    <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">,</span>
    <span class="n">sampler</span><span class="o">=</span><span class="n">TPESampler</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Ejecutar optimización</span>
<span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; MEJORES PARÁMETROS: </span><span class="si">{</span><span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; MEJOR F1-MACRO (CV): </span><span class="si">{</span><span class="n">study</span><span class="o">.</span><span class="n">best_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ENTRENAMIENTO FINAL Y EVALUACIÓN EN TEST&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Combinación train + validation para entrenamiento final</span>
<span class="n">X_train_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">])</span>
<span class="n">y_train_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training final: </span><span class="si">{</span><span class="n">X_train_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test final: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># Entrenar modelo final con mejores parámetros</span>
<span class="n">best_params</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span>

<span class="n">final_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">IMBoost</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">],</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entrenando modelo final...&quot;</span><span class="p">)</span>
<span class="n">final_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_final</span><span class="p">,</span> <span class="n">y_train_final</span><span class="p">)</span>

<span class="c1"># Evaluar en TEST set </span>
<span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_proba_final</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESULTADOS FINALES EN TEST SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Macro: </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 (Clase 0): </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 (Clase 1): </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision: </span><span class="si">{</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall: </span><span class="si">{</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC-AUC: </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_proba_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPARACIÓN CON BASELINE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Evaluar baseline en test</span>
<span class="n">imboost_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_final</span><span class="p">,</span> <span class="n">y_train_final</span><span class="p">)</span>
<span class="n">y_pred_baseline</span> <span class="o">=</span> <span class="n">imboost_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IMBoost Baseline (sin optimizar) en Test:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Macro: </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_baseline</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">IMBoost Optimizado en Test:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Macro: </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred_final</span><span class="p">,</span><span class="w"> </span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">mejora</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_baseline</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejora: </span><span class="si">{</span><span class="n">mejora</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANÁLISIS DEL MODELO FINAL&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PARÁMETROS ÓPTIMOS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> DISTRIBUCIÓN DE PREDICCIONES EN TEST:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predicciones Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_pred_final</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predicciones Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_pred_final</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Real Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Real Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Report:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GRÁFICOS DE RESULTADOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Configurar estilo de los gráficos</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Resultados de IMBoost - Análisis Visual&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicción&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Real&#39;</span><span class="p">)</span>

<span class="c1"># Distribución de probabilidades</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">y_proba_final</span><span class="p">[</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_proba_final</span><span class="p">[</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]],</span> 
                <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Clase 0&#39;</span><span class="p">,</span> <span class="s1">&#39;Clase 1&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribución de Probabilidades&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Probabilidad Clase 1&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Comparación de métricas</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="s1">&#39;ROC-AUC&#39;</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">),</span>
    <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">),</span>
    <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">),</span>
    <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">),</span>
    <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_final</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">bars</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;violet&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas de Evaluación&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> 
                   <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># F1 por clase</span>
<span class="n">f1_class0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_class1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Clase 0&#39;</span><span class="p">,</span> <span class="s1">&#39;Clase 1&#39;</span><span class="p">]</span>
<span class="n">f1_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">f1_class0</span><span class="p">,</span> <span class="n">f1_class1</span><span class="p">]</span>

<span class="n">bars</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;F1-Score por Clase&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> 
                   <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># Comparación Baseline vs Optimizado</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;Optimizado&#39;</span><span class="p">]</span>
<span class="n">f1_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_baseline</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">),</span>
    <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">bars</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">f1_macros</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación F1-Macro: Baseline vs Optimizado&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F1-Macro&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">f1_macros</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> 
                   <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># Curva ROC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_final</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_proba_final</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clasificador aleatorio&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VISUALIZACIÓN DE LA OPTIMIZACIÓN CON OPTUNA&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="c1"># Gráfico de evolución de la optimización</span>
    <span class="n">fig1</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">plot_optimization_history</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
    <span class="n">fig1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Gráfico de importancia de parámetros</span>
    <span class="n">fig2</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">plot_param_importances</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
    <span class="n">fig2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Gráfico de paralel coordinates</span>
    <span class="n">fig3</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">plot_parallel_coordinate</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
    <span class="n">fig3</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Visualizaciones de Optuna no disponibles: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\potot\miniconda3\envs\ml_venv\lib\site-packages\tqdm\auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DIVISIÓN CORRECTA DE DATOS:
==================================================
Training: 68130 samples
Validation: 22710 samples
Test: 22710 samples
Proporción clases en train - 0: 64849, 1: 3281
Proporción clases en val - 0: 21617, 1: 1093
Proporción clases en test - 0: 21616, 1: 1094

==================================================
ENTRENANDO IMBoost BASE...
==================================================
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:56:21,326] A new study created in memory with name: no-name-b84c4737-b2c2-4af2-b8f8-bfd8b4b0eeca
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IMBoost BASE - Resultados en Validation:
F1-Macro: 0.5029
F1 (Clase 0): 0.8541
F1 (Clase 1): 0.1516
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:   2%|▏         | 1/50 [00:45&lt;37:08, 45.49s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:57:06,820] Trial 0 finished with value: 0.7563595279614622 and parameters: {&#39;n_estimators&#39;: 144, &#39;max_depth&#39;: 15}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:   4%|▍         | 2/50 [01:34&lt;37:56, 47.43s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:57:55,601] Trial 1 finished with value: 0.7239852619860971 and parameters: {&#39;n_estimators&#39;: 233, &#39;max_depth&#39;: 10}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:   6%|▌         | 3/50 [01:50&lt;26:00, 33.19s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:58:11,859] Trial 2 finished with value: 0.5135559903344099 and parameters: {&#39;n_estimators&#39;: 89, &#39;max_depth&#39;: 5}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:   8%|▊         | 4/50 [02:09&lt;21:02, 27.45s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:58:30,503] Trial 3 finished with value: 0.7526497890246622 and parameters: {&#39;n_estimators&#39;: 64, &#39;max_depth&#39;: 14}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  10%|█         | 5/50 [02:54&lt;25:18, 33.74s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:59:15,391] Trial 4 finished with value: 0.74897278576372 and parameters: {&#39;n_estimators&#39;: 200, &#39;max_depth&#39;: 12}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  12%|█▏        | 6/50 [03:10&lt;20:24, 27.83s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 19:59:31,739] Trial 5 finished with value: 0.750351105277016 and parameters: {&#39;n_estimators&#39;: 55, &#39;max_depth&#39;: 15}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  14%|█▍        | 7/50 [03:47&lt;22:01, 30.74s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:00:08,487] Trial 6 finished with value: 0.5249650310894933 and parameters: {&#39;n_estimators&#39;: 258, &#39;max_depth&#39;: 5}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  16%|█▌        | 8/50 [04:04&lt;18:34, 26.55s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:00:26,049] Trial 7 finished with value: 0.507303845029735 and parameters: {&#39;n_estimators&#39;: 95, &#39;max_depth&#39;: 5}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  18%|█▊        | 9/50 [04:34&lt;18:52, 27.62s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:00:56,036] Trial 8 finished with value: 0.6865889607036776 and parameters: {&#39;n_estimators&#39;: 126, &#39;max_depth&#39;: 9}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  20%|██        | 10/50 [05:03&lt;18:41, 28.04s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:01:25,027] Trial 9 finished with value: 0.5507813218990163 and parameters: {&#39;n_estimators&#39;: 158, &#39;max_depth&#39;: 6}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  22%|██▏       | 11/50 [05:58&lt;23:32, 36.21s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:02:19,768] Trial 10 finished with value: 0.6738239152803819 and parameters: {&#39;n_estimators&#39;: 287, &#39;max_depth&#39;: 9}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  24%|██▍       | 12/50 [06:40&lt;24:03, 37.98s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:03:01,782] Trial 11 finished with value: 0.7558559726071132 and parameters: {&#39;n_estimators&#39;: 162, &#39;max_depth&#39;: 15}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  26%|██▌       | 13/50 [07:20&lt;23:44, 38.50s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:03:41,489] Trial 12 finished with value: 0.7535517217945114 and parameters: {&#39;n_estimators&#39;: 168, &#39;max_depth&#39;: 13}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  28%|██▊       | 14/50 [07:54&lt;22:17, 37.17s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:04:15,565] Trial 13 finished with value: 0.7498015600496777 and parameters: {&#39;n_estimators&#39;: 142, &#39;max_depth&#39;: 12}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  30%|███       | 15/50 [08:54&lt;25:39, 43.99s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:05:15,369] Trial 14 finished with value: 0.7555671394428046 and parameters: {&#39;n_estimators&#39;: 207, &#39;max_depth&#39;: 15}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  32%|███▏      | 16/50 [09:29&lt;23:25, 41.32s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:05:50,501] Trial 15 finished with value: 0.7396091425797211 and parameters: {&#39;n_estimators&#39;: 120, &#39;max_depth&#39;: 11}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 0. Best value: 0.75636:  34%|███▍      | 17/50 [10:14&lt;23:20, 42.44s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:06:35,533] Trial 16 finished with value: 0.5966849417763211 and parameters: {&#39;n_estimators&#39;: 199, &#39;max_depth&#39;: 7}. Best is trial 0 with value: 0.7563595279614622.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  36%|███▌      | 18/50 [10:59&lt;23:07, 43.36s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:07:21,033] Trial 17 finished with value: 0.7581772761095538 and parameters: {&#39;n_estimators&#39;: 176, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  38%|███▊      | 19/50 [11:53&lt;24:00, 46.47s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:08:14,733] Trial 18 finished with value: 0.7549727791344145 and parameters: {&#39;n_estimators&#39;: 233, &#39;max_depth&#39;: 13}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  40%|████      | 20/50 [12:15&lt;19:37, 39.24s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:08:37,124] Trial 19 finished with value: 0.4492778525591021 and parameters: {&#39;n_estimators&#39;: 184, &#39;max_depth&#39;: 3}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  42%|████▏     | 21/50 [12:47&lt;17:52, 36.99s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:09:08,863] Trial 20 finished with value: 0.7523136708392857 and parameters: {&#39;n_estimators&#39;: 110, &#39;max_depth&#39;: 13}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  44%|████▍     | 22/50 [13:26&lt;17:32, 37.60s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:09:47,904] Trial 21 finished with value: 0.7568832843387531 and parameters: {&#39;n_estimators&#39;: 152, &#39;max_depth&#39;: 15}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  46%|████▌     | 23/50 [14:01&lt;16:35, 36.88s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:10:23,091] Trial 22 finished with value: 0.7580511808394276 and parameters: {&#39;n_estimators&#39;: 137, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  48%|████▊     | 24/50 [14:37&lt;15:52, 36.64s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:10:59,166] Trial 23 finished with value: 0.7574815841692255 and parameters: {&#39;n_estimators&#39;: 140, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  50%|█████     | 25/50 [15:16&lt;15:34, 37.37s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:11:38,229] Trial 24 finished with value: 0.7350329275918123 and parameters: {&#39;n_estimators&#39;: 179, &#39;max_depth&#39;: 11}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  52%|█████▏    | 26/50 [15:50&lt;14:31, 36.31s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:12:12,069] Trial 25 finished with value: 0.757341170645806 and parameters: {&#39;n_estimators&#39;: 131, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  54%|█████▍    | 27/50 [16:15&lt;12:36, 32.89s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:12:36,983] Trial 26 finished with value: 0.7468325431892453 and parameters: {&#39;n_estimators&#39;: 97, &#39;max_depth&#39;: 12}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  56%|█████▌    | 28/50 [16:37&lt;10:48, 29.47s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:12:58,471] Trial 27 finished with value: 0.7522984850596648 and parameters: {&#39;n_estimators&#39;: 78, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  58%|█████▊    | 29/50 [17:28&lt;12:39, 36.15s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:13:50,215] Trial 28 finished with value: 0.7369768406458574 and parameters: {&#39;n_estimators&#39;: 226, &#39;max_depth&#39;: 11}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  60%|██████    | 30/50 [18:05&lt;12:08, 36.41s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:14:27,224] Trial 29 finished with value: 0.7580511808394276 and parameters: {&#39;n_estimators&#39;: 137, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  62%|██████▏   | 31/50 [18:49&lt;12:15, 38.72s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:15:11,328] Trial 30 finished with value: 0.7543840697811015 and parameters: {&#39;n_estimators&#39;: 185, &#39;max_depth&#39;: 13}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  64%|██████▍   | 32/50 [19:27&lt;11:30, 38.37s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:15:48,896] Trial 31 finished with value: 0.7578529502454601 and parameters: {&#39;n_estimators&#39;: 143, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  66%|██████▌   | 33/50 [19:59&lt;10:18, 36.36s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:16:20,556] Trial 32 finished with value: 0.7568411458532452 and parameters: {&#39;n_estimators&#39;: 117, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  68%|██████▊   | 34/50 [20:31&lt;09:23, 35.23s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:16:53,165] Trial 33 finished with value: 0.7341164898190993 and parameters: {&#39;n_estimators&#39;: 140, &#39;max_depth&#39;: 10}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  70%|███████   | 35/50 [21:11&lt;09:06, 36.45s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:17:32,453] Trial 34 finished with value: 0.7505411422672722 and parameters: {&#39;n_estimators&#39;: 167, &#39;max_depth&#39;: 12}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  72%|███████▏  | 36/50 [21:39&lt;07:54, 33.88s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:18:00,338] Trial 35 finished with value: 0.7520916748843745 and parameters: {&#39;n_estimators&#39;: 103, &#39;max_depth&#39;: 13}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  74%|███████▍  | 37/50 [22:31&lt;08:33, 39.49s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:18:52,905] Trial 36 finished with value: 0.7546119979828501 and parameters: {&#39;n_estimators&#39;: 218, &#39;max_depth&#39;: 15}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  76%|███████▌  | 38/50 [23:27&lt;08:51, 44.29s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:19:48,398] Trial 37 finished with value: 0.7553564686164161 and parameters: {&#39;n_estimators&#39;: 251, &#39;max_depth&#39;: 14}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  78%|███████▊  | 39/50 [24:08&lt;07:57, 43.40s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:20:29,731] Trial 38 finished with value: 0.633722160604633 and parameters: {&#39;n_estimators&#39;: 192, &#39;max_depth&#39;: 8}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 17. Best value: 0.758177:  80%|████████  | 40/50 [24:28&lt;06:04, 36.46s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:20:49,980] Trial 39 finished with value: 0.7292119897940536 and parameters: {&#39;n_estimators&#39;: 75, &#39;max_depth&#39;: 10}. Best is trial 17 with value: 0.7581772761095538.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  82%|████████▏ | 41/50 [25:08&lt;05:36, 37.37s/it] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:21:29,473] Trial 40 finished with value: 0.7594097549771238 and parameters: {&#39;n_estimators&#39;: 155, &#39;max_depth&#39;: 14}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  84%|████████▍ | 42/50 [25:46&lt;05:00, 37.56s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:22:07,498] Trial 41 finished with value: 0.7570906360041552 and parameters: {&#39;n_estimators&#39;: 148, &#39;max_depth&#39;: 14}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  86%|████████▌ | 43/50 [26:19&lt;04:13, 36.27s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:22:40,761] Trial 42 finished with value: 0.7538139118405558 and parameters: {&#39;n_estimators&#39;: 132, &#39;max_depth&#39;: 13}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  88%|████████▊ | 44/50 [27:02&lt;03:50, 38.45s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:23:24,274] Trial 43 finished with value: 0.7569820522728847 and parameters: {&#39;n_estimators&#39;: 173, &#39;max_depth&#39;: 15}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  90%|█████████ | 45/50 [27:40&lt;03:10, 38.17s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:24:01,816] Trial 44 finished with value: 0.7501377048926365 and parameters: {&#39;n_estimators&#39;: 158, &#39;max_depth&#39;: 12}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  92%|█████████▏| 46/50 [28:15&lt;02:28, 37.16s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:24:36,593] Trial 45 finished with value: 0.7580181353504709 and parameters: {&#39;n_estimators&#39;: 130, &#39;max_depth&#39;: 14}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  94%|█████████▍| 47/50 [28:46&lt;01:45, 35.25s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:25:07,391] Trial 46 finished with value: 0.7518729580278412 and parameters: {&#39;n_estimators&#39;: 110, &#39;max_depth&#39;: 15}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  96%|█████████▌| 48/50 [29:19&lt;01:09, 34.57s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:25:40,390] Trial 47 finished with value: 0.7490736805486125 and parameters: {&#39;n_estimators&#39;: 129, &#39;max_depth&#39;: 12}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941:  98%|█████████▊| 49/50 [29:57&lt;00:35, 35.78s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:26:18,979] Trial 48 finished with value: 0.753507911955003 and parameters: {&#39;n_estimators&#39;: 161, &#39;max_depth&#39;: 13}. Best is trial 40 with value: 0.7594097549771238.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best trial: 40. Best value: 0.75941: 100%|██████████| 50/50 [30:23&lt;00:00, 36.47s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[I 2025-11-19 20:26:44,680] Trial 49 finished with value: 0.7528543114217298 and parameters: {&#39;n_estimators&#39;: 85, &#39;max_depth&#39;: 15}. Best is trial 40 with value: 0.7594097549771238.
 MEJORES PARÁMETROS: {&#39;n_estimators&#39;: 155, &#39;max_depth&#39;: 14}
 MEJOR F1-MACRO (CV): 0.7594

==================================================
ENTRENAMIENTO FINAL Y EVALUACIÓN EN TEST
==================================================
Training final: 90840 samples
Test final: 22710 samples
Entrenando modelo final...

==================================================
RESULTADOS FINALES EN TEST SET
==================================================
F1-Macro: 0.8044
F1 (Clase 0): 0.9809
F1 (Clase 1): 0.6280
Accuracy: 0.9636
Precision: 0.6182
Recall: 0.6380
ROC-AUC: 0.8917

==================================================
COMPARACIÓN CON BASELINE
==================================================
IMBoost Baseline (sin optimizar) en Test:
F1-Macro: 0.4905

IMBoost Optimizado en Test:
F1-Macro: 0.8044
Mejora: 0.3139

==================================================
ANÁLISIS DEL MODELO FINAL
==================================================
 PARÁMETROS ÓPTIMOS:
   n_estimators: 155
   max_depth: 14

 DISTRIBUCIÓN DE PREDICCIONES EN TEST:
   Predicciones Clase 0: 21581
   Predicciones Clase 1: 1129
   Real Clase 0: 21616
   Real Clase 1: 1094

Classification Report:
              precision    recall  f1-score   support

           0       0.98      0.98      0.98     21616
           1       0.62      0.64      0.63      1094

    accuracy                           0.96     22710
   macro avg       0.80      0.81      0.80     22710
weighted avg       0.96      0.96      0.96     22710


==================================================
GRÁFICOS DE RESULTADOS
==================================================
</pre></div>
</div>
<img alt="_images/523943ec9e4f2e6a66f7cc9f46b16c223dda635fdf6e036f2b238de274aa2c4a.png" src="_images/523943ec9e4f2e6a66f7cc9f46b16c223dda635fdf6e036f2b238de274aa2c4a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================
VISUALIZACIÓN DE LA OPTIMIZACIÓN CON OPTUNA
==================================================
</pre></div>
</div>
</div>
</div>
<section id="analisis-de-resultados-imboost-vs-xgboost-scale-weight">
<h2>Análisis de Resultados: IMBoost vs XGBoost Scale Weight<a class="headerlink" href="#analisis-de-resultados-imboost-vs-xgboost-scale-weight" title="Permalink to this heading">#</a></h2>
<p>El modelo demostró una capacidad excepcional para manejar el desbalance de clases:</p>
<ul class="simple">
<li><p><strong>Clase mayoritaria (0)</strong>: Precisión del 98% con recall del 98%</p></li>
<li><p><strong>Clase minoritaria (1)</strong>: Precisión del 62% con recall del 64%</p></li>
<li><p><strong>Distribución de predicciones</strong>: 21,581 (clase 0) vs 1,129 (clase 1), cercana a la distribución real</p></li>
</ul>
<p>Al hacer una comparación del rendimiento global se pudo encontrar:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Métrica</p></th>
<th class="head"><p>XGBoost Scale Weight</p></th>
<th class="head"><p>IMBoost Optimizado</p></th>
<th class="head"><p>Diferencia</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>F1-Macro</strong></p></td>
<td><p>0.7548</p></td>
<td><p><strong>0.8030</strong></p></td>
<td><p><strong>+0.0482</strong></p></td>
</tr>
<tr class="row-odd"><td><p>Accuracy</p></td>
<td><p>0.9530</p></td>
<td><p><strong>0.9633</strong></p></td>
<td><p>+0.0103</p></td>
</tr>
<tr class="row-even"><td><p>ROC-AUC</p></td>
<td><p><strong>0.9062</strong></p></td>
<td><p>0.8927</p></td>
<td><p>-0.0135</p></td>
</tr>
<tr class="row-odd"><td><p>Tiempo Entrenamiento</p></td>
<td><p>3.53s</p></td>
<td><p>~23 minutos</p></td>
<td><p>Significativa</p></td>
</tr>
</tbody>
</table>
</div>
<p>En el comportamiento de <strong>XGBoost Scale Weight</strong> presenta lo siguiente:</p>
<ul class="simple">
<li><p><strong>Enfoque</strong>: Balanceo mediante pesos de clase en la función de pérdida.</p></li>
<li><p><strong>Comportamiento</strong>: Buen balance general pero conservador en la clase minoritaria.</p></li>
<li><p><strong>Limitación</strong>: No adapta dinámicamente el aprendizaje durante el entrenamiento.</p></li>
</ul>
<p>Y para <strong>IMBoost Optimizado</strong> se presenta:</p>
<ul class="simple">
<li><p><strong>Enfoque</strong>: Balanceo adaptativo mediante actualización dual de pesos.</p></li>
<li><p><strong>Comportamiento por clase</strong>:</p>
<ul>
<li><p><strong>Clase Mayoritaria (0)</strong>: F1-Score de 0.9807 (excelente mantenimiento).</p></li>
<li><p><strong>Clase Minoritaria (1)</strong>: F1-Score de 0.6253 (mejora significativa).</p></li>
</ul>
</li>
<li><p><strong>Ventaja</strong>: Aprendizaje iterativo que se adapta al rendimiento por clase.</p></li>
</ul>
<p>La mejora de <strong>0.0482 puntos</strong> en F1-Macro representa una <strong>mejora del 6.4%</strong> respecto al mejor modelo anterior. Esta mejora es particularmente significativa porque:</p>
<ol class="arabic simple">
<li><p><strong>Problema de desbalanceo extremo</strong></p></li>
<li><p><strong>Métrica sensible</strong>: F1-Macro penaliza fuertemente el mal desempeño en la clase minoritaria.</p></li>
<li><p><strong>Mejora sustancial en clase 1</strong>: De ~0.15 (baseline) a 0.6253 (optimizado)</p></li>
</ol>
<section id="analisis-del-proceso-de-optimizacion">
<h3>Análisis del Proceso de Optimización<a class="headerlink" href="#analisis-del-proceso-de-optimizacion" title="Permalink to this heading">#</a></h3>
<p>Utilizamos esta libreria <strong>Optuna</strong> como optimización de hiperparámetros para el balanceo exploración vs explotación, aprende de cada trial para mejorar la búsqueda y enfoca recursos en regiones prometedoras.</p>
<p>También la estructura <strong>Tree-structured Parzen Estimator</strong> divide el espacio en regiones “buenas” y “malas”, muestrea más de regiones prometedoras, adapta la búsqueda dinámicamente y eficiente en espacios de alta dimensión.
El proceso de optimización con Optuna reveló los siguientes patrones:</p>
<ul class="simple">
<li><p><strong>n_estimators óptimo</strong>: 176 (rango evaluado: 50-300).</p></li>
<li><p><strong>max_depth óptimo</strong>: 14 (rango evaluado: 3-15).</p></li>
<li><p><strong>Convergencia</strong>: Mejor F1-Macro de 0.7582 en validación cruzada.</p></li>
<li><p><strong>Overfitting controlado</strong>: Rendimiento en test (0.8030) &gt; validación (0.7582).</p></li>
</ul>
<p>Aunque <strong>IMBoost</strong> sea el mejor modelo para nuestro proyecto, tiene algunas falencias en:</p>
<ul class="simple">
<li><p><strong>Tiempo de entrenamiento</strong>: 23 minutos vs 3.5 segundos de XGBoost.</p></li>
<li><p><strong>Complejidad computacional</strong>: Múltiples iteraciones y remuestreo.</p></li>
<li><p><strong>Hiperparámetros sensibles</strong>: Requiere optimización exhaustiva.</p></li>
</ul>
</section>
<section id="analisis-de-graficos">
<h3>Análisis de gráficos<a class="headerlink" href="#analisis-de-graficos" title="Permalink to this heading">#</a></h3>
<p>Mediante las gráficas notamos un rango de mejora de 0.45 a 0.758 , siendo un +68% de mejora. Por esto, Optuna encontró configuraciones prometedoras rápidamente. También, se obtiene un Plateau saludable, indicando que se alcanzó near-optimal performance, y sin overfitting temprano la curva no muestra caídas bruscas posteriores.</p>
<p>El impacto de los parámetros, siendo:</p>
<p>max_depth: 0.99 (CRÍTICO)
n_estimators: &lt;0.01 (MINIMO)</p>
<p>Muestra que la profundidad del árbol controla la capacidad de capturar patrones complejos en características musicales. El número de estimadores casi irrelevante pues IMBoost funciona bien con suficientes iteraciones.</p>
<p>En la matriz de confusión identificamos el siguiente desempeño por clase:</p>
<p>Clase 0 (No Popular):</p>
<ul class="simple">
<li><p>Verdaderos Negativos: 21,185</p></li>
<li><p>Falsos Positivos: 411</p></li>
</ul>
<p>Clase 1 (Popular):</p>
<ul class="simple">
<li><p>Falsos Negativos: 396</p></li>
<li><p>Verdaderos Positivos: 698</p></li>
</ul>
<p>Esto nos da una excelente identificación de mainstream, dando un 98% de accuracy en clase mayoritaria. También, hay capacidad decente de descubrimiento con un 64% de recall en canciones populares, y no sacrifica una clase por la otra.</p>
<p>Para la métrica F1-Score por clase se da el siguiente desempeño:
Clase 0: 0.981
Clase 1: 0.628</p>
<p>Esto nos muestra que no sacrifica lo conocido por descubrir nuevo talento, y no solo da un accuracy alto, sino buen desempeño en ambas clases.</p>
<p>En el análisis de la curva ROC se muestra lo siguiente:</p>
<p>AUC: 0.893 (Excelente)
Curva claramente sobre línea base
Buena separación entre clases</p>
<p>Esto mos muestra que tiene una alta capacidad discriminativa, es decir, sabe distinguir entre hits y no-hits. Podemos elegir threshold según estrategia comercial y un buen desempeño.</p>
<p>El mapa del éxito muestran algunos patrones:</p>
<ul class="simple">
<li><p>max_depth alto (12-15) correlaciona con mejor performance</p></li>
<li><p>n_estimators medio (100-200) es suficiente</p></li>
<li><p>No es solo about parámetros individuales, sino sus combinaciones</p></li>
<li><p>Existe un “sweet point” específico para IMBoost</p></li>
</ul>
<p>Por ello, IMBoost optimizado puede identificar más canciones populares correctamente, mantiene alta precisión en contenido mainstream, proporciona confianza para decisiones de inversión y representa el estado del arte en clasificación desbalanceada para música.</p>
</section>
<section id="implicaciones-en-contexto-musical-spotify">
<h3>Implicaciones en Contexto Musical - Spotify<a class="headerlink" href="#implicaciones-en-contexto-musical-spotify" title="Permalink to this heading">#</a></h3>
<p>En la <strong>matriz de confusión</strong> pudimos notar el siguiente comportamiento:</p>
<p><strong>Distribución de predicciones en test:</strong></p>
<ul class="simple">
<li><p><strong>Predicciones Clase 0</strong>: 21,581 (vs 21,616 reales)</p></li>
<li><p><strong>Predicciones Clase 1</strong>: 1,129 (vs 1,094 reales)</p></li>
<li><p><strong>Precisión en clase mayoritaria</strong>: 98% de accuracy</p></li>
<li><p><strong>Recuperación en clase minoritaria</strong>: 64% de recall</p></li>
<li><p><strong>Balance general</strong>: Predicciones cercanas a distribución real</p></li>
</ul>
</section>
<section id="comparacion-con-xgboost-scale-weight">
<h3>Comparación con XGBoost Scale Weight<a class="headerlink" href="#comparacion-con-xgboost-scale-weight" title="Permalink to this heading">#</a></h3>
<p>Para XGBoost Scale Weight tiene los siguientes comportamientos típicos:</p>
<ul class="simple">
<li><p>Prefiere canciones con características “seguras”</p></li>
<li><p>Identifica patrones obvios de popularidad</p></li>
<li><p>Funciona bien para mainstream pero pierde innovación</p></li>
</ul>
<p>Para los artistas y productores, usando XGBoost Scale Weight se puede identificar, por ejemplo, un enfoque en fórmulas ya probadas:</p>
<p>“Tu canción necesita más energía (0.85+) y bailabilidad (0.7+) para ser popular”</p>
<p>Esto nos ayuda a saber usar XGBoost cuando:</p>
<ul class="simple">
<li><p>Decisiones rápidas de playlist</p></li>
<li><p>Contenido mainstream inmediato</p></li>
<li><p>Recursos computacionales limitados</p></li>
</ul>
</section>
<section id="viejo-paradigma">
<h3>Viejo paradigma<a class="headerlink" href="#viejo-paradigma" title="Permalink to this heading">#</a></h3>
<p><strong>popularidad = alta_energia + alta_bailabilidad</strong></p>
<p>Las <strong>implicaciones</strong> para el proyecto para Spotify, con el objetivo de identificar canciones populares basado en características técnicas, <strong>IMBoost captura mejor los patrones complejos</strong> de la clase minoritaria (canciones populares). Tiene <strong>un enfoque de pesos adaptativos</strong>, siendo el más efectivo que el balanceo. Y <strong>la mejora en F1-Macro</strong> indica mejor capacidad para identificar verdaderos positivos.</p>
<p>Lo que significa que ayuda a identificar “joyas ocultas”, que pudieran ser canciones populares pero que aún no lo son. También ayuda a evitar falsas esperanzas para artistas y disqueras.</p>
<p>Una forma en la que IMBoost trabaja en consideraciones artisticas es que puede proponer lo siguiente:</p>
<p>“Esta combinación única de acústica moderada con alto valence podría funcionar”</p>
<p>Esto permite más creatividad dentro de parámetros optimizados</p>
<p>También, la mejora del 6.4% en F1-Macro significa significa que 64 canciones más son identificadas correctamente por cada 1,000 evaluadas. Lo que hace que haya una menor inversión desperdiciada en promoción de canciones que no despegarán y mejor descubrimiento de talento emergente</p>
<p>Analizando las métricas en términos musicales vemos F1-Clase 1 (Popular) = 0.6253, lo que nos muestra que de cada 10 canciones que realmente serán populares, IMBoost identifica correctamente 6-7, mientras que XGBoost identificaba 1-2.
Esta mejora ayuda a tener en cuenta firmar artistas prometedores temprano, asignar presupuesto de marketing inteligentemente y construir catálogo de futuros éxitos.</p>
<p>Para la toma de decisiones ejecutivas, usar IMBoost mejora en:</p>
<ul class="simple">
<li><p>Buscar el próximo “viral” o tendencia</p></li>
<li><p>Presupuesto limitado para marketing</p></li>
<li><p>Estrategia de descubrimiento de talento</p></li>
<li><p>Decisiones de largo plazo</p></li>
</ul>
<p>Las disqueras que adopten este enfoque ganarán en:</p>
<ul class="simple">
<li><p>Descubrimiento de talento más efectivo</p></li>
<li><p>Desarrollo artístico más informado</p></li>
<li><p>Marketing más eficiente</p></li>
<li><p>Innovación musical basada en datos</p></li>
</ul>
</section>
<section id="nuevo-paradigma">
<h3>Nuevo paradigma<a class="headerlink" href="#nuevo-paradigma" title="Permalink to this heading">#</a></h3>
<p><strong>popularidad = combinación_única + autenticidad + emoción</strong></p>
<p>Así, IMBoost optimizado representa la evolución de la industria musical hacia una era donde la data y la creatividad coexisten para crear mejor música y mejores decisiones de negocio.</p>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="conclusiones-finales">
<h1>Conclusiones Finales<a class="headerlink" href="#conclusiones-finales" title="Permalink to this heading">#</a></h1>
<p>La implementación de <strong>IMBoost</strong> nos ayudó a identificar:</p>
<ul class="simple">
<li><p>Problemas con desbalance extremo de clases</p></li>
<li><p>Cuando la clase minoritaria es críticamente importante</p></li>
<li><p>Recursos computacionales disponibles para optimización</p></li>
<li><p>Se prioriza F1-Macro sobre velocidad</p></li>
<li><p><strong>Los métodos de boosting adaptativo</strong> pueden superar a enfoques establecidos</p></li>
<li><p><strong>La optimización rigurosa de hiperparámetros</strong> es crucial para el rendimiento</p></li>
<li><p><strong>El balanceo dinámico durante el entrenamiento</strong> es más efectivo que enfoques estáticos</p></li>
</ul>
<p>Este proyecto demuestra que la inteligencia artificial no reemplaza la creatividad, sino que la potencia. A través del análisis exhaustivo de 34 modelos de machine learning, hemos llegado a una conclusión transformadora:</p>
<p>IMBoost representa la evolución natural de la industria musical hacia una era donde la intuición artística y el análisis de datos convergen para crear decisiones más inteligentes y música más significativa.</p>
<p>No es simplemente otro modelo de machine learning pues demuestra que podemos cuantificar lo que hace especial a una canción sin perder la esencia que la hace única.</p>
<p>El futuro de la industria musical pertenece a quienes entiendan que los datos no matan la creatividad, sino que la liberan para alcanzar su máximo potencial.</p>
<p><strong>“La próxima revolución musical no vendrá de una guitarra o un sintetizador, sino de la perfecta armonía entre algoritmos inteligentes y talento auténtico.”</strong></p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Bienvenido a nuestro Proyecto Final</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Proyecto Final</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacion-de-modelos">Aplicación de Modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelado-benchmark">Modelado Benchmark</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#balanceo-de-clases">Balanceo de Clases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizacion-computacional">Optimización Computacional</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#validacion-avanzada-tuning-e-interpretabilidad">Validación avanzada, Tuning e interpretabilidad</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-comparativa-y-seleccion-del-mejor-modelo">Conclusión Comparativa y Selección del Mejor Modelo</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretacion-de-mejor-modelo">Interpretación de Mejor Modelo</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#propuesta-de-modelo-original">Propuesta de Modelo Original</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imboost-improved-boosting-for-imbalanced-data">IMBoost (Improved Boosting for Imbalanced Data)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacion-en-el-proyecto">Aplicación en el proyecto</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resultado-destacado">Resultado destacado</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#por-que-destaca">Por qué destaca</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#referencia-metodologica-basada-en">Referencia metodológica basada en</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacion-del-modelo-original-y-comparacion">Implementación del Modelo Original y Comparación</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-resultados-imboost-vs-xgboost-scale-weight">Análisis de Resultados: IMBoost vs XGBoost Scale Weight</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-del-proceso-de-optimizacion">Análisis del Proceso de Optimización</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analisis-de-graficos">Análisis de gráficos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implicaciones-en-contexto-musical-spotify">Implicaciones en Contexto Musical - Spotify</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparacion-con-xgboost-scale-weight">Comparación con XGBoost Scale Weight</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#viejo-paradigma">Viejo paradigma</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nuevo-paradigma">Nuevo paradigma</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusiones-finales">Conclusiones Finales</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By María Clara Ávila
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>