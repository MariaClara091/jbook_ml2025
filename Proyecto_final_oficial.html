
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Proyecto Final &#8212; EDA</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Proyecto_final_oficial';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Bienvenido a nuestro Proyecto Final" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/Spotify.png" class="logo__image only-light" alt="EDA - Home"/>
    <script>document.write(`<img src="_static/Spotify.png" class="logo__image only-dark" alt="EDA - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Bienvenido a nuestro Proyecto Final
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Proyecto Final</a></li>






</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FProyecto_final_oficial.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Proyecto_final_oficial.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Proyecto Final</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Proyecto Final</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacion-de-modelos">Aplicación de Modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelado-benchmark">Modelado Benchmark</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#balanceo-de-clases">Balanceo de Clases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizacion-computacional">Optimización Computacional</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#validacion-avanzada-tuning-e-interpretabilidad">Validación avanzada, Tuning e interpretabilidad</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-y-seleccion-del-mejor-modelo">Conclusión y Selección del Mejor Modelo</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="proyecto-final">
<h1>Proyecto Final<a class="headerlink" href="#proyecto-final" title="Link to this heading">#</a></h1>
<p>Al tener como objetivo evaluar cómo las características técnicas de las canciones (ej. energía, bailabilidad, acústica) se correlacionan con la popularidad en Spotify, para identificar patrones que puedan optimizar las estrategias de producción musical para disqueras y artistas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;ggplot&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s2">&quot;pastel&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;dataset.csv&#39;</span><span class="p">)</span> 
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>track_id</th>
      <th>artists</th>
      <th>album_name</th>
      <th>track_name</th>
      <th>popularity</th>
      <th>duration_ms</th>
      <th>explicit</th>
      <th>danceability</th>
      <th>energy</th>
      <th>...</th>
      <th>loudness</th>
      <th>mode</th>
      <th>speechiness</th>
      <th>acousticness</th>
      <th>instrumentalness</th>
      <th>liveness</th>
      <th>valence</th>
      <th>tempo</th>
      <th>time_signature</th>
      <th>track_genre</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>5SuOikwiRyPMVoIQDJUgSV</td>
      <td>Gen Hoshino</td>
      <td>Comedy</td>
      <td>Comedy</td>
      <td>73</td>
      <td>230666</td>
      <td>False</td>
      <td>0.676</td>
      <td>0.4610</td>
      <td>...</td>
      <td>-6.746</td>
      <td>0</td>
      <td>0.1430</td>
      <td>0.0322</td>
      <td>0.000001</td>
      <td>0.3580</td>
      <td>0.715</td>
      <td>87.917</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>4qPNDBW1i3p13qLCt0Ki3A</td>
      <td>Ben Woodward</td>
      <td>Ghost (Acoustic)</td>
      <td>Ghost - Acoustic</td>
      <td>55</td>
      <td>149610</td>
      <td>False</td>
      <td>0.420</td>
      <td>0.1660</td>
      <td>...</td>
      <td>-17.235</td>
      <td>1</td>
      <td>0.0763</td>
      <td>0.9240</td>
      <td>0.000006</td>
      <td>0.1010</td>
      <td>0.267</td>
      <td>77.489</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1iJBSr7s7jYXzM8EGcbK5b</td>
      <td>Ingrid Michaelson;ZAYN</td>
      <td>To Begin Again</td>
      <td>To Begin Again</td>
      <td>57</td>
      <td>210826</td>
      <td>False</td>
      <td>0.438</td>
      <td>0.3590</td>
      <td>...</td>
      <td>-9.734</td>
      <td>1</td>
      <td>0.0557</td>
      <td>0.2100</td>
      <td>0.000000</td>
      <td>0.1170</td>
      <td>0.120</td>
      <td>76.332</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>6lfxq3CG4xtTiEg7opyCyx</td>
      <td>Kina Grannis</td>
      <td>Crazy Rich Asians (Original Motion Picture Sou...</td>
      <td>Can't Help Falling In Love</td>
      <td>71</td>
      <td>201933</td>
      <td>False</td>
      <td>0.266</td>
      <td>0.0596</td>
      <td>...</td>
      <td>-18.515</td>
      <td>1</td>
      <td>0.0363</td>
      <td>0.9050</td>
      <td>0.000071</td>
      <td>0.1320</td>
      <td>0.143</td>
      <td>181.740</td>
      <td>3</td>
      <td>acoustic</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>5vjLSffimiIP26QG5WcN2K</td>
      <td>Chord Overstreet</td>
      <td>Hold On</td>
      <td>Hold On</td>
      <td>82</td>
      <td>198853</td>
      <td>False</td>
      <td>0.618</td>
      <td>0.4430</td>
      <td>...</td>
      <td>-9.681</td>
      <td>1</td>
      <td>0.0526</td>
      <td>0.4690</td>
      <td>0.000000</td>
      <td>0.0829</td>
      <td>0.167</td>
      <td>119.949</td>
      <td>4</td>
      <td>acoustic</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 114000 entries, 0 to 113999
Data columns (total 21 columns):
 #   Column            Non-Null Count   Dtype  
---  ------            --------------   -----  
 0   Unnamed: 0        114000 non-null  int64  
 1   track_id          114000 non-null  object 
 2   artists           113999 non-null  object 
 3   album_name        113999 non-null  object 
 4   track_name        113999 non-null  object 
 5   popularity        114000 non-null  int64  
 6   duration_ms       114000 non-null  int64  
 7   explicit          114000 non-null  bool   
 8   danceability      114000 non-null  float64
 9   energy            114000 non-null  float64
 10  key               114000 non-null  int64  
 11  loudness          114000 non-null  float64
 12  mode              114000 non-null  int64  
 13  speechiness       114000 non-null  float64
 14  acousticness      114000 non-null  float64
 15  instrumentalness  114000 non-null  float64
 16  liveness          114000 non-null  float64
 17  valence           114000 non-null  float64
 18  tempo             114000 non-null  float64
 19  time_signature    114000 non-null  int64  
 20  track_genre       114000 non-null  object 
dtypes: bool(1), float64(9), int64(6), object(5)
memory usage: 17.5+ MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>popularity</th>
      <th>duration_ms</th>
      <th>danceability</th>
      <th>energy</th>
      <th>key</th>
      <th>loudness</th>
      <th>mode</th>
      <th>speechiness</th>
      <th>acousticness</th>
      <th>instrumentalness</th>
      <th>liveness</th>
      <th>valence</th>
      <th>tempo</th>
      <th>time_signature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>1.140000e+05</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
      <td>114000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>56999.500000</td>
      <td>33.238535</td>
      <td>2.280292e+05</td>
      <td>0.566800</td>
      <td>0.641383</td>
      <td>5.309140</td>
      <td>-8.258960</td>
      <td>0.637553</td>
      <td>0.084652</td>
      <td>0.314910</td>
      <td>0.156050</td>
      <td>0.213553</td>
      <td>0.474068</td>
      <td>122.147837</td>
      <td>3.904035</td>
    </tr>
    <tr>
      <th>std</th>
      <td>32909.109681</td>
      <td>22.305078</td>
      <td>1.072977e+05</td>
      <td>0.173542</td>
      <td>0.251529</td>
      <td>3.559987</td>
      <td>5.029337</td>
      <td>0.480709</td>
      <td>0.105732</td>
      <td>0.332523</td>
      <td>0.309555</td>
      <td>0.190378</td>
      <td>0.259261</td>
      <td>29.978197</td>
      <td>0.432621</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-49.531000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>28499.750000</td>
      <td>17.000000</td>
      <td>1.740660e+05</td>
      <td>0.456000</td>
      <td>0.472000</td>
      <td>2.000000</td>
      <td>-10.013000</td>
      <td>0.000000</td>
      <td>0.035900</td>
      <td>0.016900</td>
      <td>0.000000</td>
      <td>0.098000</td>
      <td>0.260000</td>
      <td>99.218750</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>56999.500000</td>
      <td>35.000000</td>
      <td>2.129060e+05</td>
      <td>0.580000</td>
      <td>0.685000</td>
      <td>5.000000</td>
      <td>-7.004000</td>
      <td>1.000000</td>
      <td>0.048900</td>
      <td>0.169000</td>
      <td>0.000042</td>
      <td>0.132000</td>
      <td>0.464000</td>
      <td>122.017000</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>85499.250000</td>
      <td>50.000000</td>
      <td>2.615060e+05</td>
      <td>0.695000</td>
      <td>0.854000</td>
      <td>8.000000</td>
      <td>-5.003000</td>
      <td>1.000000</td>
      <td>0.084500</td>
      <td>0.598000</td>
      <td>0.049000</td>
      <td>0.273000</td>
      <td>0.683000</td>
      <td>140.071000</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>113999.000000</td>
      <td>100.000000</td>
      <td>5.237295e+06</td>
      <td>0.985000</td>
      <td>1.000000</td>
      <td>11.000000</td>
      <td>4.532000</td>
      <td>1.000000</td>
      <td>0.965000</td>
      <td>0.996000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.995000</td>
      <td>243.372000</td>
      <td>5.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>El dataset tiene 114,000 canciones con 21 variables y métricas de popularidad. Como pequeños hallazgos notables en este descriptivo es que la popularidad tiene un sesgo hacia valores bajos, con una media de 33.24/100 (±22.31) y mediana de 35.
Con este descriptivo vamos a llevar a cabo los pasos para identificar la características de las canciones exitosas dependiendo de la variable Popularidad y con estos resultados dar las recomendaciones específicas.</p>
<p>Al encontrar una alerta de posibles nulos y duplicados, hacemos un tratamiento más detallado de ellos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valores nulos por columna:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c1"># Eliminamos columna innecesaria si existe</span>
<span class="k">if</span> <span class="s1">&#39;Unnamed: 0&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Verificamos duplicados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Número de duplicados:&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c1"># Eliminar duplicados si los hay</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="c1"># Verificar valores únicos en las columnas categóricas</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Valores únicos en track_genre:&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Valores nulos por columna:
Unnamed: 0          0
track_id            0
artists             1
album_name          1
track_name          1
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64

Número de duplicados: 450

Valores únicos en track_genre: 114
track_genre
acoustic       1000
british        1000
electronic     1000
emo            1000
funk           1000
garage         1000
disco          1000
country        1000
rock           1000
rock-n-roll    1000
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Encontramos en la base 3 nulos que debemos tratar para así observar mejor los datos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;artists&#39;</span><span class="p">,</span> <span class="s1">&#39;album_name&#39;</span><span class="p">,</span> <span class="s1">&#39;track_name&#39;</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>track_id            0
artists             0
album_name          1
track_name          1
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64
track_id            0
artists             0
album_name          0
track_name          1
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64
track_id            0
artists             0
album_name          0
track_name          0
popularity          0
duration_ms         0
explicit            0
danceability        0
energy              0
key                 0
loudness            0
mode                0
speechiness         0
acousticness        0
instrumentalness    0
liveness            0
valence             0
tempo               0
time_signature      0
track_genre         0
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Analizamos Datos Atípicos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Librerias necesarias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Boxplot de </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
<span class="n">plot_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">numeric_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ec96bfa4b06186273e62048b5f0b5e18b7b182a70ffd4f58aca7a70c547481ab.png" src="_images/ec96bfa4b06186273e62048b5f0b5e18b7b182a70ffd4f58aca7a70c547481ab.png" />
</div>
</div>
<p>Haciendo un analisis de cada una de las variables con base a los boxplots de Outliers es, primero, duración (en milisegundos) es que hay canciones que duran más que 5,000,000 ms, siendo aproximadamente unos 83 minutos, algo excepcional.</p>
<p>Segundo, la instrumentalidad las canciones con más popularidad no son 100% instrumentales porque la mayoría, siendo el 75%, está por debajo de aproximadamente 0.049.</p>
<p>Y tercero, el compás (time_signature), casi el 100% está en 4/4, lo que significa que todas las canciones de la mayoría de géneros comparten un mismo compás pues influye en que todas empiencen igual. Se haría un estudio de la historia de esta variable desde tiempos antiguos pues no tiene un cambio en las canciones sin importar su género.</p>
<p>Por lo visto en las gráficas podemos visualizar que para la popularidad solo un pequeña subida, es decir, pocas canciones alcanzan alta popularidad.</p>
<p>En cuanto a la duración de las canciones la mayoría dura entre 2-4 minutos.</p>
<p>Para la variable Key no se ve una preferencia por alguna tonalidad en general.</p>
<p>En volumen podemos inferir que las canciones más escuchadas y que alcanzan un pico alto están entre -6 a -4 dB.</p>
<p>Las canciones más bailables tienen un ritmo por encima de (aprox.) 0.45 y y son más comunes la que tienen una alta energía, un tanto mayor a 0.7, como las playlist de ejercicio para los centros educativos o GYMs.</p>
<p>En cuanto a la acústica se ve un pico en 0 y entre 0.8 a 1, lo cual significa que el sonido debe ser puro. Y en las instrumentales no hay un pico significativo desde los 0.5, por lo cual son pocas canciones que lo tienen.</p>
<p>En la variable Tempo la mayoría de las canciones tienen un número de pulsaciones o latidos entre los 100 BPM A 140 BPM.</p>
<p>Como nuestra variable predictora es la popularidad de las canciones, atribuimos a fondo su investigación y repercusión en el estudio de nuestro Analisis Exploratorio. Por ello vemos de cerca su distribución:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Análisis de la distribución de Popularidad</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de Popularidad de las Canciones&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frecuencia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Estadísticas descriptivas de popularity</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Estadísticas de popularidad:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

<span class="c1"># Boxplot de popularity</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Boxplot de Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3170884e9dd8b1fce947b035bed401009a2a30fb6ce041dda2de52c79e3b7816.png" src="_images/3170884e9dd8b1fce947b035bed401009a2a30fb6ce041dda2de52c79e3b7816.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estadísticas de popularidad:
count    113550.000000
mean         33.324139
std          22.283976
min           0.000000
25%          17.000000
50%          35.000000
75%          50.000000
max         100.000000
Name: popularity, dtype: float64
</pre></div>
</div>
<img alt="_images/4553ea7083bb7247f6536a07d8373f65edbf366c45384fbb9287992ce1aa3db1.png" src="_images/4553ea7083bb7247f6536a07d8373f65edbf366c45384fbb9287992ce1aa3db1.png" />
</div>
</div>
<p>De acuerdo con el gráfico de distribución podemos notar que la mayoría de las canciones tienen popularidad menos que 60, después decae, por lo cual son muy pocas las canciones que llegan a tener una alta popularidad, y por su descriptivo se confirma una asimetría con cola a la derecha, es decir, muchos atípicos mayores a 50 y son los que más rapido llegan a tener una gran popularidad.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">popularity_by_genre</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;track_genre&#39;</span><span class="p">)[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 10 Géneros con Mayor Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularity (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 10 Géneros con Menor Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularidad (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Boxplot para los principales géneros</span>
<span class="n">top_genres</span> <span class="o">=</span> <span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_top_genres</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_genres</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_top_genres</span><span class="p">,</span> 
            <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Esto muestra la media como un marcador</span>
            <span class="n">meanprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;marker&quot;</span><span class="p">:</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>  <span class="c1"># Forma del marcador</span>
                       <span class="s2">&quot;markerfacecolor&quot;</span><span class="p">:</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># Color interno</span>
                       <span class="s2">&quot;markeredgecolor&quot;</span><span class="p">:</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>  <span class="c1"># Color del borde</span>
                       <span class="s2">&quot;markersize&quot;</span><span class="p">:</span><span class="s2">&quot;10&quot;</span><span class="p">})</span>  <span class="c1"># Tamaño</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de Popularidad por Género (Top 10)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b4991d8434a69f2a7b923ac5617b11f086929699797b0b9210cfb8893ce3685e.png" src="_images/b4991d8434a69f2a7b923ac5617b11f086929699797b0b9210cfb8893ce3685e.png" />
<img alt="_images/195df5542d680d265100a8c7d2b18ef60cd37262085eecbe32988cb3e2b54f17.png" src="_images/195df5542d680d265100a8c7d2b18ef60cd37262085eecbe32988cb3e2b54f17.png" />
<img alt="_images/c718d8f116b30eeafd71f2b49195186d6b432fd371f6ac2ccfa74c096dfc9585.png" src="_images/c718d8f116b30eeafd71f2b49195186d6b432fd371f6ac2ccfa74c096dfc9585.png" />
</div>
</div>
<p>Analizando el Top de los 10 géneros con mayor popularidad vemos preferencias en estos géneros:</p>
<ul class="simple">
<li><p>Pop</p></li>
<li><p>K-pop</p></li>
<li><p>Pop-film</p></li>
<li><p>Dance-pop</p></li>
</ul>
<p>Por lo cual para las disqueras se les recomienda invertir más en estos géneros.</p>
<p>Mientras que en el top de los 10 géneros con menor popularidad como el Grimbton, Kids, Classical e Iranian tiene un bajo rendimiento en Spotify, por lo cual se les recomienda usar otras app o páginas que los impulsen.</p>
<p>Y en la distribución de popularidad por género el K-pop mtiene alta popularidad y algunos temas de géneros menos populares como señanajo logran alta popularidad.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calcular la matriz de correlación</span>
<span class="n">spotify_num</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

<span class="n">corr</span> <span class="o">=</span> <span class="n">spotify_num</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de correlación:&quot;</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Crear la máscara para ocultar la mitad superior</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Configurar el estilo y mostrar el mapa de calor</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Matriz de Correlación - Dataset de Spotify&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de correlación: (14, 14)
</pre></div>
</div>
<img alt="_images/078622d710cf1248d1932ee91c85b5752d68b13d8c393348dced810938b0a54a.png" src="_images/078622d710cf1248d1932ee91c85b5752d68b13d8c393348dced810938b0a54a.png" />
</div>
</div>
<p>Aquí podemos ver las correlaciones más significativas entre variables como la energía y volumen pues muchas canciones energéticas tienden a tener un alto volumen.</p>
<p>Tambien entre la acástica y la energía con Volumen pues al ser más “movidas” contienen una acústica más alta.</p>
<p>Mientras la popularidad, siendo nuestra variable predictora, tiene correlaciones medias con las anteriormente mencionadas pues las canciones populares tienden a ser más altas en volumen pero algunas con acústicas son menos populares.</p>
<p>Y las correlaciones más bajas, siendo entre variables como Key, time_signature y tempo no influye en la popularidad de las canciones.</p>
<p>Al evaluar estos comportamientos, hicimos un análisis PCA para ver más detalladamente la variabilidad de estas variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Análisis PCA</span>
<span class="n">numeric_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">numeric_df</span> <span class="o">=</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">numeric_df</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="c1"># Estandarización</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">numeric_df</span><span class="p">)</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">pca_result</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> 
         <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Varianza explicada acumulada por componentes PCA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Número de componentes&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Varianza explicada acumulada&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/acc929291f4c45ab5aadad23021a92867bb2da0012c937bb59755de4b5024ce8.png" src="_images/acc929291f4c45ab5aadad23021a92867bb2da0012c937bb59755de4b5024ce8.png" />
</div>
</div>
<p>Viendo este patrón junto con los datos musicales volvimos a ver la correlación entre la energía y el volumen, correlacionado y relación entre bailabilidad y positividad (valence).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Analisis VIF </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.outliers_influence</span><span class="w"> </span><span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Seleccionar solo las columnas numéricas</span>
<span class="n">spotify_num</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

<span class="c1"># Eliminar columnas que no tienen suficiente varianza (opcional)</span>
<span class="n">spotify_num</span> <span class="o">=</span> <span class="n">spotify_num</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Por si hay columnas con NaN</span>

<span class="c1"># Escalar los datos antes de calcular VIF</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">spotify_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">spotify_num</span><span class="p">)</span>

<span class="c1"># Calcular el VIF para cada variable</span>
<span class="n">vif_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spotify_num</span><span class="o">.</span><span class="n">columns</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">spotify_scaled</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spotify_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

<span class="c1"># Mostrar el resultado</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vif_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;VIF&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>            Variable       VIF
3             energy  4.249848
5           loudness  3.269293
8       acousticness  2.407126
11           valence  1.586171
2       danceability  1.540188
9   instrumentalness  1.474825
10          liveness  1.142463
7        speechiness  1.132767
12             tempo  1.091453
13    time_signature  1.080963
1        duration_ms  1.055228
6               mode  1.042076
0         popularity  1.023728
4                key  1.021432
</pre></div>
</div>
</div>
</div>
<p>Podemos notar que todas las variables tienen un valor VIF entre 1 a 5, lo que indica que no hay problemas graves de multicolinealidad.</p>
<p>Luego, hicimos una analisis de correlación más a fondo de nuestra variable predictora:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correlaciones con popularidad</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">numeric_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlación con Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/57da6abc30281bf68bec665c28e9a51a5e6c9f1ae5c847519fd1a366aa1b1a2b.png" src="_images/57da6abc30281bf68bec665c28e9a51a5e6c9f1ae5c847519fd1a366aa1b1a2b.png" />
</div>
</div>
<p>Visto en el gráfico, volvemos a ver más de cerca una mayor correlación con nuestra variable predictora con:</p>
<ul class="simple">
<li><p>Volumen</p></li>
<li><p>Bailabilidad</p></li>
<li><p>Energía</p></li>
</ul>
<p>Es decir, canciones que contengas un mayor volumen y que contengan ritmos bailables producen una mayor energía y, asimismo, una mayor popularidad para el público en general.</p>
<p>Para las variables tempo, vivacidad y duración influyen poco en que las canciones tengan una popularidad alta, pero son vitales para que se mantengan en los tops.</p>
<p>Y por último, en variables como la acústica y la instrumentalidad no influyen significativamente en la popularidad de una canción, por lo cual no es recomendable que se hagan mayormente canciones puramente instrumentales pues son poco atractivas.</p>
<p>Dejando de lado la popularidad, indagamos más en la influencia de los artistas:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Análisis de artistas</span>
<span class="n">top_artists</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;artists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">top_artists</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">top_artists</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 20 artistas con más canciones&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Número de canciones&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Artista&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">artist_popularity</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;artists&#39;</span><span class="p">)[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">artist_popularity</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">artist_popularity</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Top 20 artistas por popularidad (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Popularidad (mediana)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Artista&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ff60c5b2011774e0155f9fa72a7946a68071a99d8973363000d4b231067ef346.png" src="_images/ff60c5b2011774e0155f9fa72a7946a68071a99d8973363000d4b231067ef346.png" />
<img alt="_images/d27b2624bf9df29d627867cc6707cd336a3a20e162dbcc9d82f8038e911bbffd.png" src="_images/d27b2624bf9df29d627867cc6707cd336a3a20e162dbcc9d82f8038e911bbffd.png" />
</div>
</div>
<p>Algunas características del top de artistas con más canciones son:</p>
<ul class="simple">
<li><p>The Beatles: lideran con aprox. 250 canciones</p></li>
<li><p>George Jones</p></li>
<li><p>Stevie Wonder</p></li>
</ul>
<p>Y artistas nuevos como BTS llegan al top dando una revolución e impacto global en la música.</p>
<p>Pero algo interesante es que la cantidad de canciones no influye en su popularidad pues hay artistas como Bad Bunny que tiene menos canciones que The Beatles, pero tiene una mayor popularidad.</p>
<p>En el top de artistas por popularidad tenemos a Bad Bunny, The Weeknd, Beyoncé, Harry Styles, por lo cual música actual tiene una mezcla de estos géneros: reggaetón, pop y electrónica.</p>
<p>También las colaboraciones entre artistas aumentan la posibilidad de llegar a tener mayor popularidad, como los dúos.</p>
<p>Y como características de estos artistas es que tienen más sencillos que albumen largos, por lo que las disqueras pueden aumentar su popularidad cambiando esta estrategia comercial a una disco más corto. Por lo que las disqueras podrían priorizar lanzamientos de sencillos en lugar de álbumes largos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boxplot por género</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">top_genres</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_genres</span><span class="p">)],</span> 
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de popularidad por género&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a6788dfd2966a20c1de41fb840e0d0a6f3ec03fed211776857bbd257db3799a2.png" src="_images/a6788dfd2966a20c1de41fb840e0d0a6f3ec03fed211776857bbd257db3799a2.png" />
</div>
</div>
<p>Podemos observar que géneros como acoustic, disco, emo, electronic, funk y metalcore tienen una mediana alta casi llegando a 50. También géneros como mandopop, metalcore, garage tienen una distribución muy amplia, lo que indica que hay canciones muy populares y otras poco populares.</p>
<p>Mientras que el reggaeton tieen alta variabilidad y outliers hacia arriba, por lo cual hay excepciones, es decir, canciones que alcanzan más popularidad que el promedio.</p>
<p>Y por géneros como mpb, pagode, punk-rock, r&amp;b, electronic y funk tienen cajas muy estrechas, es decir, una popularidad sin muchos cambios a lo largo de estas canciones.</p>
<p>Por lo tanto, un género único o primordial no existe porque hay una variabilidad alta y extensa que una competencia en cómo llegar a tener canciones populares..</p>
<p>Luego abarcamos los contenidos explícitos de algunos albumes de estos artistas y en cómo afecta su la popularidad en las listas. Además, evaluamos la bailabilidad y la energía de estas canciones y que pueden influir en alcanzar una mayor popularidad:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Popularidad por género y explicit content</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> 
            <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_genres</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Popularidad por Género y Contenido Explícito&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Género Musical&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Explícito&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Relación entre popularity, danceability y energy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> 
                <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Relación entre Danceability, Energy y Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/de3d1feebd0420b9fac76d727549350315a2407d602881b4e9886081e22cafc4.png" src="_images/de3d1feebd0420b9fac76d727549350315a2407d602881b4e9886081e22cafc4.png" />
<img alt="_images/187d530f171311645528835ec280df8210fa8f257c439e00ac804f2524a01d29.png" src="_images/187d530f171311645528835ec280df8210fa8f257c439e00ac804f2524a01d29.png" />
</div>
</div>
<p>Algunas repercuciones en el cotenido explicito de algunas canciones y su popularidad sí están relacionadas pues las canciones explícitas tienden a ser más populares, como podemos ver en géneros como emo, metalcore, reggaeton r-n-b pues tienen una mediana más alta que las no explícitas, contrario al caso de los géneros mpb y pagode, que no muestran ningún hallazgo de temas explícitos y los no explícitos.</p>
<p>Mientras que para géneros como acoustic, disco, garage y rock-n-roll no son muy populares por sus temas explícitos.</p>
<p>Y géneros como funk, mandopop, punk-rock y country no tienen diferencias marcadas entre sus canciones explícitas y las no explícitas.</p>
<p>Por tanto, la presencia de contenido explícito puede generar un aumento en la popularidad de la canción pero se sigue viendo una variabilidad en los géneros afecta mucho que resurgan este tipo de vocabulario.</p>
<p>En cuanto a la relación entre la bailabilidad y la energía muchas canciones tienden a ser tanto bailables como energéticas pues, como dijimos antes, hay una correlación entre alta energía y bailabilidad con alta popularidad.</p>
<p>Pero existen canciones con baja energía o bailabilidad que también logran buena popularidad en el centro de la gráfica, por lo que no son factores exclusivos pero si influyen significativamente en que tengan una mayor popularidad.</p>
<p>Como último esquema del EDA, vamos a hacer un análisis de Regresión logística</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">precision_recall_curve</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">]</span>  
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;popular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;popular&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span>  <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;logistic_model_class_weight_balanced.joblib&quot;</span><span class="p">)</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="s2">&quot;scaler.joblib&quot;</span><span class="p">)</span>

<span class="n">y_pred</span>  <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">acc</span>  <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">prec</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rec</span>  <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1</span>   <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">roc</span>  <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Logistic Regression (class_weight=&#39;balanced&#39;) ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:  </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision: </span><span class="si">{</span><span class="n">prec</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall:    </span><span class="si">{</span><span class="n">rec</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score:  </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC-ROC:   </span><span class="si">{</span><span class="n">roc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Confusion Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Report:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">roc_thresh</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>
<span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">pr_thresh</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC = </span><span class="si">{</span><span class="n">roc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;FPR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;TPR (Recall)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recalls</span><span class="p">,</span> <span class="n">precisions</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">thr</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">y_pred_thr</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_proba</span> <span class="o">&gt;=</span> <span class="n">thr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">thr</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">),</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thr</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 5 thresholds según F1:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">metrics_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision / Recall / F1 vs Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">coef</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">odds_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span><span class="p">,</span>
    <span class="s1">&#39;odds_ratio&#39;</span><span class="p">:</span> <span class="n">odds_ratio</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;odds_ratio&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coeficientes y Odds Ratios (ordenados por efecto):&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">coef_df</span><span class="p">)</span>

<span class="n">best_f1_row</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor umbral por F1: </span><span class="si">{</span><span class="n">best_f1_row</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> con F1=</span><span class="si">{</span><span class="n">best_f1_row</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rec80</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">rec80</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">rec80</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ejemplo de umbral con recall ≥ 0.8:&quot;</span><span class="p">,</span> <span class="n">chosen</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay umbral que logre recall ≥ 0.8 sin sacrificar demasiada precisión.&quot;</span><span class="p">)</span>

<span class="n">metrics_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;threshold_metrics.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">coef_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;logistic_coef_odds.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Logistic Regression (class_weight=&#39;balanced&#39;) ===
Accuracy:  0.5526
Precision: 0.0664
Recall:    0.6344
F1 Score:  0.1202
AUC-ROC:   0.6165

Confusion Matrix:
 [[11856  9760]
 [  400   694]]

Classification Report:
               precision    recall  f1-score   support

           0       0.97      0.55      0.70     21616
           1       0.07      0.63      0.12      1094

    accuracy                           0.55     22710
   macro avg       0.52      0.59      0.41     22710
weighted avg       0.92      0.55      0.67     22710
</pre></div>
</div>
<img alt="_images/443dacb5f85a631d8c6e780fd2a3870d624937fcd3b6b5ff678c78b1f1041e5e.png" src="_images/443dacb5f85a631d8c6e780fd2a3870d624937fcd3b6b5ff678c78b1f1041e5e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Top 5 thresholds según F1:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>threshold</th>
      <th>accuracy</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>54</th>
      <td>0.55</td>
      <td>0.695509</td>
      <td>0.072425</td>
      <td>0.450640</td>
      <td>0.124794</td>
    </tr>
    <tr>
      <th>51</th>
      <td>0.52</td>
      <td>0.609203</td>
      <td>0.069492</td>
      <td>0.574040</td>
      <td>0.123976</td>
    </tr>
    <tr>
      <th>50</th>
      <td>0.51</td>
      <td>0.581066</td>
      <td>0.068736</td>
      <td>0.613346</td>
      <td>0.123618</td>
    </tr>
    <tr>
      <th>55</th>
      <td>0.56</td>
      <td>0.723822</td>
      <td>0.072772</td>
      <td>0.403108</td>
      <td>0.123288</td>
    </tr>
    <tr>
      <th>53</th>
      <td>0.54</td>
      <td>0.668604</td>
      <td>0.070628</td>
      <td>0.483547</td>
      <td>0.123253</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/194710deaa903aaa630152023cf7dcd377a920cfd2210554a846aaa4d4d42fa7.png" src="_images/194710deaa903aaa630152023cf7dcd377a920cfd2210554a846aaa4d4d42fa7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coeficientes y Odds Ratios (ordenados por efecto):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>coef</th>
      <th>odds_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>acousticness</td>
      <td>-0.477646</td>
      <td>0.620242</td>
    </tr>
    <tr>
      <th>0</th>
      <td>danceability</td>
      <td>0.286651</td>
      <td>1.331960</td>
    </tr>
    <tr>
      <th>1</th>
      <td>energy</td>
      <td>-0.180912</td>
      <td>0.834509</td>
    </tr>
    <tr>
      <th>3</th>
      <td>tempo</td>
      <td>-0.091542</td>
      <td>0.912523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>valence</td>
      <td>0.005926</td>
      <td>1.005944</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mejor umbral por F1: 0.550 con F1=0.125
Ejemplo de umbral con recall ≥ 0.8: {&#39;threshold&#39;: 0.43, &#39;accuracy&#39;: 0.3718626155878468, &#39;precision&#39;: 0.05899685260831715, &#39;recall&#39;: 0.8053016453382084, &#39;f1&#39;: 0.10993947713233918}
</pre></div>
</div>
</div>
</div>
<p>Características de TN, FP, FN, TP.</p>
<p>Una caraterística que muestran estos resultados es que, por ejemplo, un alto FN significa que el modelo no detecta muchos hits o éxitos.</p>
<p>Por tanto, si Spotify quiere maximizar descubrimiento de posibles hits se debe priorizar Recall, es decir, capturar la mayor cantidad de canciones con potencial. Pero si no quisiera gastar presupuesto en música que no pegue o sea la más popular en listas, priorizar Precision cuando quiera promocionar, es decir, que tenga alta probabilidad de éxito.</p>
<p>Por otro lado, los coeficientes positivos aumentan la popularidad mientras que los coeficientes negativos la reducen.</p>
<p>Una característica fundamental que va directamente ligada a los usuarios, y que puede incremetar no solo la popularidad del artista, sino también de la app, es la segmentación de usuarios porque combina predisposición de track con perfiles de usuarios para darles recomendaciones más efectivas y que les guste. Ahora, si la predicción de popularidad ayuda a reducir el gasto en promoción en tracks sin potencial, mejora RO, por lo que usar el modelo para proponer experimentos (como colocar X canciones en una playlist) y medir lift de streams, así ayuda a entender y corregir sesgos algorítmicos.</p>
<p>Pero para cumplir con esta idea faltarían comportamientos externos por analizar, como fecha de lanzamiento, de marketing como las campañas publicitarias y propagandas, metadatos geográficos o demográficos de audiencia.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resumen de hallazgos</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resumen de hallazgos:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Cantidad total de géneros únicos: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;track_genre&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Género más popular en promedio: </span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Género menos popular en promedio: </span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">popularity_by_genre</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Variables más correlacionadas con popularidad:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen de hallazgos:
- Cantidad total de géneros únicos: 114
- Género más popular en promedio: pop-film (59.28)
- Género menos popular en promedio: iranian (2.22)
- Variables más correlacionadas con popularidad:
loudness        0.047371
danceability    0.034412
tempo           0.012180
energy         -0.002444
liveness       -0.005658
Name: popularity, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Concluimos que hay mucha diversidad musical hoy en día pues hay 114 géneros bien representados.
Contiene una distribución balanceada de géneros y una distribución asimétrica de popularidad, lo que sugiere que todos los géneros tienen oportunidad pero pocos alcanzan esa máxima popularidad.</p>
<p>Este EDA representa la diversidad musical actual. Captura la dinámica competitiva de la industria que ofrece oportunidades para ver patrones en ciertos géneros, poder predecir un éxito musical y optimizar recomendaciones.</p>
<p>Los hallazgos no solo muestras las preferencias de las personas del mundo, sino que también las herramientas para los artistas, productores y plataformas digitales o streaming necesitas pues la música va a seguir creciendo y con ello tenemos muchos aspectos con los cuales poder seguir investigando las futuras tendencias.</p>
<p>##Aplicación de Modelos</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="aplicacion-de-modelos">
<h1>Aplicación de Modelos<a class="headerlink" href="#aplicacion-de-modelos" title="Link to this heading">#</a></h1>
<p>Ahora presentamos la ejecución de los modelos aplicado en clase en nuestro proyecto:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">hstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># númericas</span>
<span class="n">num_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
<span class="n">X_train_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>
<span class="n">X_test_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_num</span><span class="p">)</span>
<span class="n">X_test_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_num</span><span class="p">)</span>

<span class="c1"># categóricas</span>
<span class="n">cat_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)</span>
<span class="n">X_train_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>
<span class="n">X_test_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">X_train_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_cat</span><span class="p">)</span>
<span class="n">X_test_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_cat</span><span class="p">)</span>

<span class="c1"># numéricas + categóricas</span>
<span class="n">X_train_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_train_num_scaled</span><span class="p">,</span> <span class="n">X_train_cat_encoded</span><span class="p">])</span>
<span class="n">X_test_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_test_num_scaled</span><span class="p">,</span> <span class="n">X_test_cat_encoded</span><span class="p">])</span>

<span class="n">X_train_dense</span> <span class="o">=</span> <span class="n">X_train_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_test_dense</span> <span class="o">=</span> <span class="n">X_test_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño original: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proporción de clases: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># GridSearchCV personalizado con SMOTE en cada fold para regresión logística</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> 
    <span class="s2">&quot;penalty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="c1"># CV estratificado</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid search de regresión logística:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">penalty</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;penalty&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">penalty</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">and</span> <span class="n">C</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">X_fold_train</span><span class="p">,</span> <span class="n">X_fold_val</span> <span class="o">=</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">y_fold_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            
            <span class="c1"># Aplicamos Smote solo en el entrenamiendo en e fold</span>
            <span class="n">smote</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
            <span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span> <span class="o">=</span> <span class="n">smote</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">,</span> <span class="n">y_fold_train</span><span class="p">)</span>
            
            <span class="n">logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
                <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> 
                <span class="n">penalty</span><span class="o">=</span><span class="n">penalty</span><span class="p">,</span> 
                <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span> <span class="k">if</span> <span class="n">penalty</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span> <span class="k">else</span> <span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
                <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            <span class="n">logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span><span class="p">)</span>
            <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fold_val</span><span class="p">)</span>
            
            <span class="n">score</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_fold_val</span><span class="p">,</span> <span class="n">y_pred_val</span><span class="p">)</span>
            <span class="n">fold_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_scores</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C=</span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2">, penalty=</span><span class="si">{</span><span class="n">penalty</span><span class="si">}</span><span class="s2">: Recall CV = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;penalty&#39;</span><span class="p">:</span> <span class="n">penalty</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejores parámetros: </span><span class="si">{</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor recall (CV): </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Aplicamos Smote en el entrenamiendo completo para el modelo final</span>
<span class="n">smote_final</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span> <span class="o">=</span> <span class="n">smote_final</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño con SMOTE: </span><span class="si">{</span><span class="n">X_train_res</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">best_logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
    <span class="o">**</span><span class="n">best_params</span><span class="p">,</span> 
    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span> <span class="k">if</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;penalty&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span> <span class="k">else</span> <span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
<span class="n">best_logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_logreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">best_logreg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación de regresión logística&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Accuracy en test:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ROC AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">))</span>

<span class="c1"># curva ROC</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Curva ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base (AUC = 0.5)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos (FPR)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos (TPR)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Regresión Logística con SMOTE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># punto óptimo </span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fpr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">tpr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">optimal_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
<span class="n">optimal_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Punto óptimo (threshold=</span><span class="si">{</span><span class="n">optimal_threshold</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Umbral óptimo: </span><span class="si">{</span><span class="n">optimal_threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">y_pred_optimal</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_proba</span> <span class="o">&gt;=</span> <span class="n">optimal_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Informe de Clasificación con umbral óptimo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de confusión con umbral óptimo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño original: (90840, 15)
Proporción de clases: [0.95184941 0.04815059]
Grid search de regresión logística:
C=0.01, penalty=l2: Recall CV = 0.5770
C=0.01, penalty=None: Recall CV = 0.6731
C=0.1, penalty=l2: Recall CV = 0.6571
C=0.1, penalty=None: Recall CV = 0.6731
C=1, penalty=l2: Recall CV = 0.6710
C=1, penalty=None: Recall CV = 0.6731
C=10, penalty=l2: Recall CV = 0.6717
C=10, penalty=None: Recall CV = 0.6731
C=100, penalty=l2: Recall CV = 0.6733
C=100, penalty=None: Recall CV = 0.6731

Mejores parámetros: {&#39;C&#39;: 100, &#39;penalty&#39;: &#39;l2&#39;}
Mejor recall (CV): 0.6733
Tamaño con SMOTE: (129699, 129)
Evaluación de regresión logística

Accuracy en test: 0.8322324966974901

Matriz de confusión:
 [[18183  3433]
 [  377   717]]

Reporte de clasificación:
               precision    recall  f1-score   support

           0       0.98      0.84      0.91     21616
           1       0.17      0.66      0.27      1094

    accuracy                           0.83     22710
   macro avg       0.58      0.75      0.59     22710
weighted avg       0.94      0.83      0.87     22710

ROC AUC: 0.8620851344795716
</pre></div>
</div>
<img alt="_images/d087a431c2bede01ff2663f6b4098bd20a8ec8d6f33d7686a1396f968d01cf20.png" src="_images/d087a431c2bede01ff2663f6b4098bd20a8ec8d6f33d7686a1396f968d01cf20.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Umbral óptimo: 0.353

Informe de Clasificación con umbral óptimo:
              precision    recall  f1-score   support

           0       0.99      0.76      0.86     21616
           1       0.15      0.81      0.25      1094

    accuracy                           0.77     22710
   macro avg       0.57      0.79      0.56     22710
weighted avg       0.95      0.77      0.83     22710

Matriz de confusión con umbral óptimo:
[[16508  5108]
 [  206   888]]
</pre></div>
</div>
</div>
</div>
<p>Para el modelo de regresión logística, ajustado con la técnica de sobremuestreo SMOTE para balancear las clases, alcanzó un desempeño adecuado. Se evidenció un fuerte desbalanceo con aproximadamente un 95% de observaciones a la clase negativa y solo un 5% a la clase positiva.</p>
<p>Por ello, se aplicó SMOTE y  se realizó una búsqueda de hiperparámetros, para encontrar el mejor modelo correspondido a una regresión logística con C = 0.01  logrando un recall promedio en validación cruzada de 0.6733.</p>
<p>En el conjunto de prueba, el modelo obtuvo una accuracy de 0.83 y un área bajo la curva ROC AUC de 0.862, lo cual refleja una buena capacidad de discriminación entre las clases.</p>
<p>El análisis del reporte de clasificación mostró que con el umbral estándar de 0.5, la clase minoritaria alcanzaba un recall de 0.66 pero con una baja precisión con un 0.17.</p>
<p>Al ajustar el umbral de decisión a 0.346 el recall de la clase positiva aumentó significativamente hasta 0.82, así el modelo logra detectar la gran mayoría de los casos. Pero el ajuste lo que hace es una disminución en la precisión y en la exactitud.</p>
<p>Por ello, estas modificaciones prioriza la identificación de las canciones exitosas y así apoyar decisiones en las que resulta más dificil no dejar escapar canciones que tengan un tipo de potencial y no eliminarlas.</p>
<p>Ahora veamos el modelo KNN</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">recall_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">hstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>

<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>
<span class="c1"># numéricas</span>
<span class="n">num_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
<span class="n">X_train_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>
<span class="n">X_test_num</span> <span class="o">=</span> <span class="n">num_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">])</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_num</span><span class="p">)</span>
<span class="n">X_test_num_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_num</span><span class="p">)</span>

<span class="c1"># categóricas</span>
<span class="n">cat_imputer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)</span>
<span class="n">X_train_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>
<span class="n">X_test_cat</span> <span class="o">=</span> <span class="n">cat_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">categorical_features</span><span class="p">])</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">X_train_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_cat</span><span class="p">)</span>
<span class="n">X_test_cat_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_cat</span><span class="p">)</span>

<span class="c1"># numéricas + categóricas </span>
<span class="n">X_train_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_train_num_scaled</span><span class="p">,</span> <span class="n">X_train_cat_encoded</span><span class="p">])</span>
<span class="n">X_test_final</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_test_num_scaled</span><span class="p">,</span> <span class="n">X_test_cat_encoded</span><span class="p">])</span>

<span class="n">X_train_dense</span> <span class="o">=</span> <span class="n">X_train_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_test_dense</span> <span class="o">=</span> <span class="n">X_test_final</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño original: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_neighbors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">21</span><span class="p">]}</span>

<span class="c1"># CV estratificado</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">cv_scores</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">n_neighbors</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">]:</span>
    <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="n">X_fold_train</span><span class="p">,</span> <span class="n">X_fold_val</span> <span class="o">=</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_train_dense</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
        <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">y_fold_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
        
        <span class="n">smote</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span> <span class="o">=</span> <span class="n">smote</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">,</span> <span class="n">y_fold_train</span><span class="p">)</span>
        
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_res</span><span class="p">,</span> <span class="n">y_fold_res</span><span class="p">)</span>
        <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fold_val</span><span class="p">)</span>
        
        <span class="n">score</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_fold_val</span><span class="p">,</span> <span class="n">y_pred_val</span><span class="p">)</span>
        <span class="n">fold_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    
    <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_scores</span><span class="p">)</span>
    <span class="n">cv_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_score</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_neighbors=</span><span class="si">{</span><span class="n">n_neighbors</span><span class="si">}</span><span class="s2">: Recall CV = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">best_n_neighbors</span> <span class="o">=</span> <span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor parámetro: n_neighbors=</span><span class="si">{</span><span class="n">best_n_neighbors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor recall (CV): </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cv_scores</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">smote_final</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span> <span class="o">=</span> <span class="n">smote_final</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño con SMOTE: </span><span class="si">{</span><span class="n">X_train_res</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">best_knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_n_neighbors</span><span class="p">)</span>
<span class="n">best_knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_res</span><span class="p">,</span> <span class="n">y_train_res</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">best_knn</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_dense</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Accuracy en test:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ROC AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño original: (90840, 15)
n_neighbors=1: Recall CV = 0.4225
n_neighbors=3: Recall CV = 0.5597
n_neighbors=5: Recall CV = 0.6360
n_neighbors=7: Recall CV = 0.6829
n_neighbors=9: Recall CV = 0.7140
n_neighbors=11: Recall CV = 0.7355
n_neighbors=13: Recall CV = 0.7478
n_neighbors=15: Recall CV = 0.7583
n_neighbors=17: Recall CV = 0.7627
n_neighbors=19: Recall CV = 0.7659
n_neighbors=21: Recall CV = 0.7643

Mejor parámetro: n_neighbors=19
Mejor recall (CV): 0.7659
Tamaño con SMOTE: (129699, 129)

Accuracy en test: 0.7647291941875826

Matriz de confusión:
 [[16516  5100]
 [  243   851]]

Reporte de clasificación:
               precision    recall  f1-score   support

           0       0.99      0.76      0.86     21616
           1       0.14      0.78      0.24      1094

    accuracy                           0.76     22710
   macro avg       0.56      0.77      0.55     22710
weighted avg       0.94      0.76      0.83     22710

ROC AUC: 0.853761331236798
</pre></div>
</div>
</div>
</div>
<p>El modelo KNN ajustado con  SMOTE mostró que el mejor desempeño se alcanzó con k = 19 con un recall promedio en validación cruzada de 0.7661.</p>
<p>En el conjunto de prueba el modelo alcanzó un accuracy de 0.7647 y un área bajo la curva ROC (AUC) de 0.854, es decir, buena capacidad de discriminación entre clases.</p>
<p>La matriz de confusión muestra que el modelo detectó  850 de los 1,094 casos positivos, lo que significa que identifica la mayoría de las canciones potencialmente exitosas. Pero la precisión de la clase positiva fue baja dando un número elevado de falsos positivos.</p>
<p>Por ello,  el modelo KNN logra identificar la clase minoritaria y la detección de canciones exitosas. Y al haber una baja precisión  muchas de las canciones clasificadas como exitosas no lo son en realidad. Comparándolo con la regresión logística ambos modelos obtienen resultados similares, pero la regresión logística da un desempeño más balanceado, mientras que KNN tiende a elevar precisión del recall.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
            <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">],</span> 
            <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matriz de Confusión (k=</span><span class="si">{</span><span class="n">best_n_neighbors</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predicho&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Real&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7f5f94b579159474957596711a05afd0bd4babbbeff77e5a37977d28fe4679d2.png" src="_images/7f5f94b579159474957596711a05afd0bd4babbbeff77e5a37977d28fe4679d2.png" />
</div>
</div>
<p>La matriz de confusión obtenida para el modelo KNN con k = 19 muestra un buen desempeño en la identificación de canciones populares. De un total de 22,710 observaciones, el modelo clasificó correctamente 16,517 canciones no populares y 850 canciones populares. Pero hay  5,099 canciones fueron clasificadas incorrectamente como populares  mientras que 244 canciones populares no fueron detectadas.</p>
<p>Estos resultados dieron un recall de 0.78 para la clase positiva, lo que indica que el modelo identifica la mayoría de las canciones populares, aunque la precisión de esa clase es baja con 0.14, reflejando que las canciones predichas como populares no lo son realmente.</p>
<p>Por ello, la matriz confirma que el modelo KNN da la detección de la clase minoritaria y la mayor parte de las canciones populares, aunque con un poquito de falsos positivos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>

<span class="c1"># Aplicar PCA a los datos de entrenamiento procesados</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_dense</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Subplot 1: Datos originales</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">scatter1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Datos Originales&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scatter1</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Subplot 2: Datos con SMOTE</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">X_res_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train_res</span><span class="p">)</span>
<span class="n">scatter2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train_res</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Datos con SMOTE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scatter2</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Entrenar KNN en el espacio PCA de datos con SMOTE</span>
<span class="n">knn_pca</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_n_neighbors</span><span class="p">)</span>
<span class="n">knn_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_res_pca</span><span class="p">,</span> <span class="n">y_train_res</span><span class="p">)</span>

<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="c1"># Predecir en el meshgrid</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">knn_pca</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_res_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train_res</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fronteras de Decisión KNN (k=</span><span class="si">{</span><span class="n">best_n_neighbors</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Componente Principal 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">scatter</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular (0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular (1)&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popularidad&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Curva ROC</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aleatorio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Curva ROC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8257bb0bf0954e9b4c1498f3cecf79c5b894e2ca14ebb2868b8676182733781f.png" src="_images/8257bb0bf0954e9b4c1498f3cecf79c5b894e2ca14ebb2868b8676182733781f.png" />
<img alt="_images/19fe17282a62727c35fa877d1f14e67f50a6502199a54d0de6a98c476c668cb8.png" src="_images/19fe17282a62727c35fa877d1f14e67f50a6502199a54d0de6a98c476c668cb8.png" />
<img alt="_images/d3951b13cfb78f389376bea6af56d4d021eb67106a2f7224c731a329c99e12ff.png" src="_images/d3951b13cfb78f389376bea6af56d4d021eb67106a2f7224c731a329c99e12ff.png" />
</div>
</div>
<p>En la primera gráfica se comparan los datos originales con los datos balanceados mediante SMOTE, se observa  el desbalance de clases inicial. En los datos originales la clase No Popular es la que predomina, mientras que la clase Popular tiene un número reducido de instancias, lo que genera  problema para el modelo al momento de aprender patrones.</p>
<p>Luego de aplicar el SMOTE se logra un balance entre ambas clases, la clase minoritaria obtiene mayor representación en el conjunto de entrenamiento y así identificar con mayor precisión los patrones asociados a esta categoría y mejora la métrica de recall.</p>
<p>Y la curva ROC muestra un AUC = 0.854 que indica que el modelo tiene una alta capacidad de discriminación entre las clases. La curva se ubica muy por encima de la línea aleatoria que confirma que el rendimiento del modelo es mejor que el azar.</p>
<p>Así, la aplicación de SMOTE  mejora el desempeño del modelo en la detección de las canciones populares, logrando un equilibrio entre las clases y obteniendo un modelo con buen nivel.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelado-benchmark">
<h1>Modelado Benchmark<a class="headerlink" href="#modelado-benchmark" title="Link to this heading">#</a></h1>
<p>Ahora presentamos la ejecución de los modelos aplicado en clase en nuestro proyecto:</p>
<p>Configuramos los datos preparados para cada modelo</p>
<p>Librerias necesarias:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>  
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RANDOM_STATE</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_STATE</span><span class="p">)</span>

<span class="c1"># variable binaria: Popular = 1 vs No Popular = 0</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Features y target</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;popularity&#39;</span><span class="p">,</span> <span class="s1">&#39;track_id&#39;</span><span class="p">,</span> <span class="s1">&#39;artists&#39;</span><span class="p">,</span> <span class="s1">&#39;album_name&#39;</span><span class="p">,</span> <span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">,</span> <span class="s1">&#39;HighPopularity&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X</span><span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distribución de clases binario:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Proporción: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% populares&quot;</span><span class="p">)</span>

<span class="c1"># División</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">División de datos:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Training: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test:     </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Características numéricas</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>

<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Numéricas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Categóricas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Prreprocesamiento</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>


<span class="c1"># Uso de validación cruzada </span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cross-Validation con 5-fold estratificado&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases binario:
   Clase 0 (No Popular): 108082 samples
   Clase 1 (Popular):    5468 samples
   Proporción: 4.8% populares

División de datos:
   Training: (90840, 15)
   Test:     (22710, 15)
   y_train - 0: 86466, 1: 4374
   y_test  - 0: 21616, 1: 1094
   Numéricas: 13
   Categóricas: 1
   Total: 14
Cross-Validation con 5-fold estratificado
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">cv_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evalúa un modelo con F1-Macro como métrica principal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">results_cv</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># VALIDACIÓN CRUZADA</span>
    <span class="k">if</span> <span class="n">cv_folds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VALIDACIÓN CRUZADA (</span><span class="si">{</span><span class="n">cv_folds</span><span class="si">}</span><span class="s2"> folds) - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;precision_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;precision_macro&#39;</span><span class="p">,</span>     
            <span class="s1">&#39;recall_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;recall_macro&#39;</span><span class="p">,</span>           
            <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>                   
            <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>            
            <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="s1">&#39;roc_auc&#39;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
        
        <span class="c1"># Remover métricas que no se pueden calcular</span>
        <span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scoring</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
            <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Resultados CV</span>
        <span class="n">results_cv</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cv_accuracy_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;cv_accuracy_std&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;cv_f1_macro_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
            <span class="s1">&#39;cv_f1_macro_std&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;cv_f1_weighted_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;cv_f1_weighted_std&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;cv_train_accuracy_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;cv_train_f1_macro_mean&#39;</span><span class="p">:</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="s1">&#39;test_roc_auc&#39;</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="p">:</span>
            <span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Macro (CV):    </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_macro_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_macro_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ← PRINCIPAL&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy (CV):    </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_accuracy_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_accuracy_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted (CV): </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_weighted_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_f1_weighted_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;cv_auc_mean&#39;</span> <span class="ow">in</span> <span class="n">results_cv</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC (CV):         </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">results_cv</span><span class="p">[</span><span class="s1">&#39;cv_auc_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># EVALUACIÓN EN TEST SET</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># MÉTRICAS PRINCIPALES</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># ← PRINCIPAL</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_macro</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_macro</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not compute AUC for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Resumen PRINCIPAL con F1-Macro</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TEST SET - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: f1_macro=</span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="c1"># Resultado final</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">f1_macro</span><span class="p">,</span>          
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;precision_macro&#39;</span><span class="p">:</span> <span class="n">precision_macro</span><span class="p">,</span>
        <span class="s1">&#39;recall_macro&#39;</span><span class="p">:</span> <span class="n">recall_macro</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>
    
    <span class="c1"># Para compatibilidad con código antiguo</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_macro</span>  <span class="c1"># ← Esto hace que f1 sea macro también</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Combinar con resultados CV si existen</span>
    <span class="k">if</span> <span class="n">results_cv</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results_cv</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>Iniciamos entrenando cada modelo:</p>
<p><strong>Regresión Logística</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Función evaluate_model MEJORADA que incluye gráficas y análisis</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># Entrenar solo con training data</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Métricas de clasificación</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC </span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Binario</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Multiclase</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not compute AUC for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Resumen</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, f1=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="c1"># gráficas y análisis</span>
    <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación:&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

        <span class="c1"># Gráficas</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Curva ROC</span>
        <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión</span>
        <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                            <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matriz de Confusión - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>

<span class="c1"># Lista para almacenar resultados</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División </span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline final</span>
<span class="n">pipe_logreg</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;model__penalty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_logreg</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                       <span class="s2">&quot;Logistic Regression (Optimized)&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MATRIZ DE RESULTADOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Mostrar matriz final de resultados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESUMEN FINAL - MATRIZ DE RESULTADOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0: 86466 muestras (95.2%)
   Clase 1: 4374 muestras (4.8%)
Fitting 5 folds for each of 8 candidates, totalling 40 fits
Mejores parámetros: {&#39;model__C&#39;: 0.01, &#39;model__penalty&#39;: &#39;l1&#39;}
Mejor F1-score (CV): 0.5662
EVALUACIÓN COMPLETA CON evaluate_model
Logistic Regression (Optimized): acc=0.787, f1=0.565, time=0.63s
Evaluación:
Accuracy: 0.7867
F1-score: 0.5647
AUC:      0.8431

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 17043     4573]
     Popular   [   270      824]

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.98      0.79      0.88     21616
     Popular       0.15      0.75      0.25      1094

    accuracy                           0.79     22710
   macro avg       0.57      0.77      0.56     22710
weighted avg       0.94      0.79      0.85     22710
</pre></div>
</div>
<img alt="_images/a16c27edc1595c300f63163dd14e7a637ce2c8eef0ffb1e14b4eb4249ba7b6b8.png" src="_images/a16c27edc1595c300f63163dd14e7a637ce2c8eef0ffb1e14b4eb4249ba7b6b8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MATRIZ DE RESULTADOS
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   

      AUC  Train_Time  
0  0.8431      0.6271  
RESUMEN FINAL - MATRIZ DE RESULTADOS
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
</pre></div>
</div>
</div>
</div>
<p>Viendo los resultados arrojados del modelo de Regresión Logística presenta un F1-Score macro de 0.565 y un AUC-ROC de 0.843, lo que indica la capacidad distinguir entre canciones populares y no populares. La métrica de accuracy con un 0.787 de evidencia de un desbalance inherente en los datos, donde solo el 4.8% de las canciones son clasificadas como populares.</p>
<p>En la matriz de confusión se ve un Recall de 0.75 para la clase Popular, dando así que el modelo identifica correctamente el 75% de las canciones realmente populares, en contexto, serían 824 de 1094. En el valor de Precision con un 0.15 para la clase Popular, es decir, solo el 15% de las canciones clasificadas como populares realmente lo son.</p>
<p>Por lo cual, este modelo es ideal en etapas iniciales de selección pues no descartar canciones potencialmente populares aunque se incluyan muchos falsos positivos.</p>
<p>Así, para disqueras y artistas, este modelo captura la mayoría de las canciones potencialmente populares, siendo útil en etapas iniciales para demos o producciones.</p>
<p><strong>Naive Bayes</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Pipeline</span>
<span class="n">pipe_nb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>          
<span class="p">])</span>

<span class="c1"># Validación cruzada</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">scoring</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="s1">&#39;precision_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="s1">&#39;recall_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  <span class="c1"># F1-macro como métrica principal</span>
    <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="s1">&#39;roc_auc&#39;</span>
<span class="p">}</span>

<span class="n">cv_results_nb</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipe_nb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de la validación cruzada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:  </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:  </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:       </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_nb</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipe_nb</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                          <span class="s2">&quot;Naive Bayes&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_nb</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Análisis gráficas</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas por clase (para el análisis detallado)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados Naive Bayes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">result_nb</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   CLASE 0 (No Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 1 (Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detalles:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># Gráficas personalizadas para Naive Bayes</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_nb</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Naive Bayes - Matriz de Confusión&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Clase 0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Clase 1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Clase 0&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clase 0 (No Popular)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Clase 1&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clase 1 (Popular)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Naive Bayes&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Análisis del overfitting </span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis&quot;</span><span class="p">)</span>
<span class="n">train_vs_test_diff</span> <span class="o">=</span> <span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results_nb</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia Training vs Test Accuracy: </span><span class="si">{</span><span class="n">train_vs_test_diff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_vs_test_diff</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Posible overfitting detectado&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_vs_test_diff</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excelente generalización&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Buen balance entre training y test&quot;</span><span class="p">)</span>

<span class="c1"># Mostrar matriz final de resultados actualizada</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen de resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Naive Bayes vs otros modelos</span>
    <span class="n">nb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Naive Bayes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Naive Bayes se encuentra en la posición #</span><span class="si">{</span><span class="n">nb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados de la validación cruzada:
Accuracy:  0.4773 ± 0.0103
F1-score:  0.3877 ± 0.0063
AUC:       0.7247 ± 0.0029
EVALUACIÓN COMPLETA CON evaluate_model
Naive Bayes: acc=0.489, f1=0.395, time=0.31s
Matriz resultantes:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
Evaluación

Resultados Naive Bayes:
   Tiempo entrenamiento: 0.31s
   Accuracy: 0.4895
   Balanced Accuracy: 0.7236
   AUC:      0.7255

   CLASE 0 (No Popular):
      Precision: 0.9981 | Recall: 0.4645 | F1: 0.6340
   CLASE 1 (Popular):
      Precision: 0.0850 | Recall: 0.9826 | F1: 0.1564

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 10041    11575]
     Popular   [    19     1075]

Detalles:
   Verdaderos Negativos: 10041
   Falsos Positivos:     11575
   Falsos Negativos:     19
   Verdaderos Positivos: 1075

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       1.00      0.46      0.63     21616
     Popular       0.08      0.98      0.16      1094

    accuracy                           0.49     22710
   macro avg       0.54      0.72      0.40     22710
weighted avg       0.95      0.49      0.61     22710
</pre></div>
</div>
<img alt="_images/7c82c53e9796b84888f833163bbad074f8958200035616cd1401f7e411538dd0.png" src="_images/7c82c53e9796b84888f833163bbad074f8958200035616cd1401f7e411538dd0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis
Diferencia Training vs Test Accuracy: 0.0003
Excelente generalización
Resumen de resultados:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Logistic Regression (Optimized)
   F1-Score: 0.5647
   Accuracy: 0.7867
   AUC:      0.8431

Naive Bayes se encuentra en la posición #2 de 2 modelos
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Naive Bayes, se presenta un F1-Score macro de 0.395 y un AUC-ROC de 0.725, indicando un desempeño significativamente inferior al modelo de Regresión Logística optimizado. La métrica de accuracy con un 0.489 refleja una capacidad clasificatoria cercana al azar por el desbalance que hay en los datos.</p>
<p>La matriz de confusión revela un Recall de 0.98 para la clase Popular, dando que el modelo identifica correctamente el 98% de las canciones realmente populares (1075 de 1094), y un Precision de 0.08 para la clase Popular, dando que solo el 8% de las predicciones clasificadas como “populares” son correctas.</p>
<p>Viendo la alta tasa de falsos positivos se muestra que 11,575 canciones no populares fueron incorrectamente clasificadas como populares. Por lo cual, este modelo prioriza la captura de casi todas las canciones populares a costa de incluir una enorme cantidad de falsos positivos, por lo que tiene dificultades para establecer límites entre clases.</p>
<p>Así, para las disqueras y artistas, este modelo en etapas iniciales tiene la capacidad de hacer una búsqueda masiva donde es crítico no omitir ninguna canción potencial pero no logran capturar adecuadamente.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># FUNCIÓN evaluate_model CORREGIDA</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># Entrenar solo con training data</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Métricas de clasificación</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># AUC </span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Binary classification</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Multiclass</span>
                <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not compute AUC for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">auc_score</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Resumen</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: acc=</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, f1=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación:&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Manejar cuando auc_score es None</span>
        <span class="k">if</span> <span class="n">auc_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:      No disponible&quot;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

        <span class="c1"># Gráficas</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Curva ROC (solo si hay probabilidades)</span>
        <span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auc_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Matriz de confusión</span>
        <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                            <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matriz de Confusión - </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>

<span class="c1"># Lista para almacenar resultados (si no existe)</span>
<span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test         - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline</span>
<span class="n">ridge_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span>  
    <span class="p">))</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>
<span class="n">result_ridge</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">ridge_pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                             <span class="s2">&quot;Ridge Classifier&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_ridge</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis Ridge&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>

<span class="c1"># Métricas por clase para análisis detallado</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Métricas por clase:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 0 (No Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 1 (Popular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Gráfica adicional de métricas por clase</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Ridge Classifier vs otros modelos</span>
    <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Ridge Classifier</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Info:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - No proporciona probabilidades (predict_proba)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Por eso AUC = No disponible&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Es un clasificador lineal con regularización L2&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Bueno para evitar overfitting en características correlacionadas&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases:
   Entrenamiento - Clase 0: 86466 | Clase 1: 4374
   Test         - Clase 0: 21616 | Clase 1: 1094
EVALUACIÓN COMPLETA CON evaluate_model
Ridge Classifier: acc=0.952, f1=0.488, time=0.32s
Evaluación:
Accuracy: 0.9518
F1-score: 0.4877
AUC:      No disponible

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21616        0]
     Popular   [  1094        0]

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.95      1.00      0.98     21616
     Popular       0.00      0.00      0.00      1094

    accuracy                           0.95     22710
   macro avg       0.48      0.50      0.49     22710
weighted avg       0.91      0.95      0.93     22710
</pre></div>
</div>
<img alt="_images/5786712d9d2f6d16c9b33e862e8b2b824b6d64f42b1d48afbc0022109efab7fd.png" src="_images/5786712d9d2f6d16c9b33e862e8b2b824b6d64f42b1d48afbc0022109efab7fd.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de resultados:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
Análisis Ridge
Balanced Accuracy: 0.5000

Métricas por clase:
   CLASE 0 (No Popular):
      Precision: 0.9518 | Recall: 1.0000 | F1: 0.9753
   CLASE 1 (Popular):
      Precision: 0.0000 | Recall: 0.0000 | F1: 0.0000
</pre></div>
</div>
<img alt="_images/c5ad7be9cdb3dc07e7af584dfa7b2950459e5278f4ba9a93309793a2f0825160.png" src="_images/c5ad7be9cdb3dc07e7af584dfa7b2950459e5278f4ba9a93309793a2f0825160.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Logistic Regression (Optimized)
   F1-Score: 0.5647
   Accuracy: 0.7867
   AUC:      0.8431

Ridge Classifier se encuentra en la posición #3 de 3 modelos

Info:
   - No proporciona probabilidades (predict_proba)
   - Por eso AUC = No disponible
   - Es un clasificador lineal con regularización L2
   - Bueno para evitar overfitting en características correlacionadas
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Ridge Classifier presenta un F1-Score macro de 0.488 y un accuracy de 0.952, mostrando un patrón de clasificación sesgado.</p>
<p>En la matriz de confusión revela en la clase 0 (No Popular) un Recall del 100%, es decir, clasifica correctamente todas las 21,616 canciones no populares. Para la clase 1 (Popular) muestra un Recall del 0%, siendoq que no identifica ninguna de las 1,094 canciones populares, y un Balanced Accuracy de 0.500 indicando que el modelo no supera el desempeño de un clasificador aleatorio, donde siempre predecir la clase mayoritaria, ignorando completamente la clase minoritaria, fracasando en manejar desbalance de clases.</p>
<p>Por ello, Ridge Classifier ocupa una posición baja en la comparación general. No proporciona valor predictivo para identificar canciones populares, ni logra capturar los patrones entre características técnicas y popularidad.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline </span>
<span class="n">pipe_lasso</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_lasso</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_lasso</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                             <span class="s2">&quot;Lasso Regression&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de resultados&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes modelo Lasso </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso (Coeficientes)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de resultados&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetro óptimo:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Contar características con coeficiente cero</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Características con coeficiente cero: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Porcentaje de características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>

    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso Regression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso Regression se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hiperparámetro C óptimo: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Penalización L1 ayuda a evitar overfitting y selecciona características importantes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 6 candidates, totalling 30 fits
Tiempo de entrenamiento: 242.23s
Mejores parámetros: {&#39;model__C&#39;: 0.01}
Mejor F1-score (CV): 0.5662
EVALUACIÓN COMPLETA CON evaluate_model
Lasso Regression: acc=0.787, f1=0.565, time=0.56s
Matriz de resultados:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
Análisis de resultados
Evaluación detallada:
Accuracy:            0.7867
Balanced Accuracy:   0.7708
AUC:                 0.8431
F1-score (Weighted): 0.5647
F1-score (Macro):    0.5647

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9844
Recall - No Popular:    0.7884
F1 - No Popular:        0.8756
Precision - Popular:    0.1527
Recall - Popular:       0.7532
F1 - Popular:           0.2539

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 17043     4573]
     Popular   [   270      824]

Desglose:
   Verdaderos Negativos: 17043
   Falsos Positivos:     4573
   Falsos Negativos:     270
   Verdaderos Positivos: 824

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.79      0.88     21616
     Popular       0.15      0.75      0.25      1094

    accuracy                           0.79     22710
   macro avg       0.57      0.77      0.56     22710
weighted avg       0.94      0.79      0.85     22710
</pre></div>
</div>
<img alt="_images/e70023f4a8c197a8edd5f090fcdc856f76f34909fbc3d0d9542c1501abd92402.png" src="_images/e70023f4a8c197a8edd5f090fcdc856f76f34909fbc3d0d9542c1501abd92402.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis de resultados

Rendimiento general:
   - Accuracy: 0.787
   - AUC: 0.843 
   - F1-Score: 0.565 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 0.56s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.984 | Recall: 0.788 | F1: 0.876
   - CLASE 1 (Popular): 
        Precision: 0.153 | Recall: 0.753 | F1: 0.254

Hiperparámetro óptimo:
   - C: 0.01


Top 10 características importantes:
                          feature    coef
95           cat__track_genre_pop  2.5602
86         cat__track_genre_metal  2.1763
46       cat__track_genre_electro  2.1023
71         cat__track_genre_indie  2.0621
80         cat__track_genre_k-pop  2.0544
35         cat__track_genre_dance  2.0190
105         cat__track_genre_rock  1.9871
68         cat__track_genre_house  1.9686
17      cat__track_genre_alt-rock  1.8159
18   cat__track_genre_alternative  1.8141

Características con coeficiente cero: 57
Características retenidas: 72
Porcentaje de características eliminadas: 44.2%
Resumen:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Logistic Regression (Optimized)
   F1-Score: 0.5647
   Accuracy: 0.7867
   AUC:      0.8431

Lasso Regression se encuentra en la posición #4 de 4 modelos

Lasso:
   - Regularización L1 (Lasso) para selección de características
   - Características eliminadas: 57 de 129 (44.2%)
   - Hiperparámetro C óptimo: 0.01
   - Penalización L1 ayuda a evitar overfitting y selecciona características importantes
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Lasso Regression presenta un F1-Score macro de 0.565 y un AUC-ROC de 0.843, mostrando un desempeño idéntico al modelo de Regresión Logística optimizado. El accuracy de 0.787 mantiene el mismo patrón de desbalance observado en modelos anteriores.</p>
<p>En la matriz de confusión muestra un Recall de 0.75 para la clase Popular, identificando correctamente el 75% de las canciones populares (824 de 1094). También un Precision de 0.15 para la clase Popular, identificando solo el 15% de las predicciones como populares son correctas. Y un Balanced Accuracy de 0.771, indicando un balance razonable entre el desempeño en ambas clases.</p>
<p>Así, Lasso funciona como un filtro de alta sensibilidad como la Regresión Logística, priorizando la captura de canciones populares a costa de una baja precisión.</p>
<p>El análisis de coeficientes muestra que géneros positivamente asociados como Pop, Metal, Electro, K-Pop y Dance. Por lo cual, existe una clara preferencia por géneros contemporáneos y de alta energía en las canciones populares, eso es ventaja para estrategias de producción, como enfocarse en géneros como Pop, K-Pop y Electro aumenta probabilidad de popularidad.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">pipeline_dt</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>  
<span class="p">])</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validación cruzada para análisis de overfitting&quot;</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipeline_dt</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">],</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC (CV):       </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_dt</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipeline_dt</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                          <span class="s2">&quot;Decision Tree&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dt</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:          </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:          </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 0:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:        </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:               </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Matriz de Confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipeline_dt</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Decision Tree&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Decision Tree&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis overfitting:&quot;</span><span class="p">)</span>

<span class="n">train_test_diff_accuracy</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">train_test_diff_f1</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia Accuracy (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia F1-score (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ALTO OVERFITTING - Árbol muy complejo&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Podar el árbol o limitar profundidad máxima&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Overfitting moderado&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Considerar regularización del árbol&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Excelente generalización&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   El árbol está bien balanceado&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Comportamiento esperado para árbol de decisión&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:       </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:       </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:            </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:     </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Acc:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overfitting:    </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_dt</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Información adicional del árbol</span>
<span class="n">tree_model</span> <span class="o">=</span> <span class="n">pipeline_dt</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información del árbol:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad del árbol: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de hojas: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de características: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">n_features_in_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Decision Tree vs otros modelos</span>
    <span class="n">dt_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Decision Tree&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decision Tree se encuentra en la posición #</span><span class="si">{</span><span class="n">dt_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información sobre Decision Tree</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Info:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ventaja: Fácil de interpretar y visualizar&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Desventaja: Propenso a overfitting sin regularización&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad actual: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hojas: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   POSIBLE OVERFITTING - Considerar poda del árbol&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Validación cruzada para análisis de overfitting
Accuracy (CV):  0.9246 ± 0.0010
F1-score (CV):  0.5875 ± 0.0074
AUC (CV):       0.5909 ± 0.0088
EVALUACIÓN COMPLETA CON evaluate_model
Decision Tree: acc=0.929, f1=0.602, time=6.72s
Matriz resultante.
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Decision Tree    0.9287     0.9270  0.9287    0.6021   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
4  0.6043      6.7157  
Análisis

Resultados:
Accuracy:          0.9287
Balanced Accuracy: 0.5998
F1-score:          0.6021
F1 Clase 0:        0.9626
F1 Clase 1:        0.2417
AUC:               0.6043

Matriz de confusión
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20833      783]
     Popular   [   836      258]

Desglose:
   Verdaderos Negativos: 20833
   Falsos Positivos:     783
   Falsos Negativos:     836
   Verdaderos Positivos: 258

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.96      0.96      0.96     21616
     Popular       0.25      0.24      0.24      1094

    accuracy                           0.93     22710
   macro avg       0.60      0.60      0.60     22710
weighted avg       0.93      0.93      0.93     22710
</pre></div>
</div>
<img alt="_images/acc3b671c6e9d5b31b95998df0ede83676306aaabb9971f7c7dbff750b685e9c.png" src="_images/acc3b671c6e9d5b31b95998df0ede83676306aaabb9971f7c7dbff750b685e9c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis overfitting:
Diferencia Accuracy (Train-Test): 0.0721
Diferencia F1-score (Train-Test): 0.3944
 Overfitting moderado
   Recomendación: Considerar regularización del árbol
Resumen:
Accuracy:       0.9287
F1-score:       0.6021
AUC:            0.6043
F1 Clase 1:     0.2417
Balanced Acc:   0.5998
Overfitting:    0.0721
Tiempo entrenamiento: 6.72s

Información del árbol:
   - Profundidad del árbol: 80
   - Número de hojas: 4666
   - Número de características: 129
Resumen
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

 Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

Decision Tree se encuentra en la posición #5 de 5 modelos

Info:
   - Ventaja: Fácil de interpretar y visualizar
   - Desventaja: Propenso a overfitting sin regularización
   - Profundidad actual: 80
   - Hojas: 4666
   POSIBLE OVERFITTING - Considerar poda del árbol
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Decision Tree presenta un F1-Score macro de 0.604 y un accuracy de 0.929, mostrando una mejora moderada. Sin embargo, el AUC de 0.606 indica una capacidad discriminativa limitada entre clases.</p>
<p>En la matriz de confusión se muestra un Recall de 0.24 para la clase Popular, donde solo identifica el 24% de las canciones populares (263 de 1094). También un Precision de 0.25 para la clase Popular, indicando una mejora marginal en precisión (25% vs 15% en modelos lineales). Y un F1-Score de 0.96 para No Popular vs 0.25 para Popular. Por lo cual el modelo prioriza la precisión sobre la cobertura, identificando correctamente pocas canciones populares pero con mayor certeza cuando lo hace.</p>
<p>En el análisis overfitting muestra una profundidad excesiva con 80 niveles de memorización de datos, y 4,647 nodos terminales para 90,840 muestras.</p>
<p>Dando así que el modelo es útil para identificar alta certeza de canciones prometedoras pero con una búsqueda exhaustiva de talento, y con menos falsos positivos.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">pipeline_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validación cruzada para análisis de overfitting&quot;</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipeline_rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">],</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (CV):  </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC (CV):       </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_roc_auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_rf</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">pipeline_rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                          <span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:          </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:          </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 0:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:        </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:               </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># GRÁFICAS </span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Matriz de Confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipeline_rf</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis overfitting&quot;</span><span class="p">)</span>

<span class="n">train_test_diff_accuracy</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">train_test_diff_f1</span> <span class="o">=</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;train_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">cv_results</span><span class="p">[</span><span class="s1">&#39;test_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia Accuracy (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diferencia F1-score (Train-Test): </span><span class="si">{</span><span class="n">train_test_diff_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ALTO OVERFITTING - Random Forest muy complejo&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Reducir número de árboles o aumentar min_samples_split&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Overfitting moderado&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Recomendación: Considerar regularización de hiperparámetros&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Excelente generalización&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   El Random Forest está bien balanceado&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Comportamiento esperado para Random Forest&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:       </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score:       </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:            </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Clase 1:     </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Acc:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overfitting:    </span><span class="si">{</span><span class="n">train_test_diff_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Información adicional del Random Forest</span>
<span class="n">rf_model</span> <span class="o">=</span> <span class="n">pipeline_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Info:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de árboles: </span><span class="si">{</span><span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de características: </span><span class="si">{</span><span class="n">rf_model</span><span class="o">.</span><span class="n">n_features_in_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad máxima promedio: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compaación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (mejor métrica para problemas desbalanceados)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Random Forest se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ventaja: Menos propenso a overfitting que árboles individuales&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Robustez: Maneja bien características correlacionadas&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Árboles: </span><span class="si">{</span><span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2"> árboles en el ensemble&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad promedio: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">rf_model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">])</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">train_test_diff_accuracy</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    POSIBLE OVERFITTING - Considerar ajustar hiperparámetros&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Validación cruzada para análisis de overfitting
Accuracy (CV):  0.9505 ± 0.0002
F1-score (CV):  0.5391 ± 0.0030
AUC (CV):       0.8887 ± 0.0063
EVALUACIÓN COMPLETA CON evaluate_model
Random Forest: acc=0.952, f1=0.555, time=10.09s
Matriz resultante
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                    Random Forest    0.9517     0.9330  0.9517    0.5547   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
4  0.6043      6.7157  
5  0.9015     10.0906  
Análisis:

Resultados:
Accuracy:          0.9517
Balanced Accuracy: 0.5368
F1-score:          0.5547
F1 Clase 0:        0.9752
F1 Clase 1:        0.1343
AUC:               0.9015

Matriz de confusión
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21529       87]
     Popular   [  1009       85]

Desglose:
   Verdaderos Negativos: 21529
   Falsos Positivos:     87
   Falsos Negativos:     1009
   Verdaderos Positivos: 85

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.96      1.00      0.98     21616
     Popular       0.49      0.08      0.13      1094

    accuracy                           0.95     22710
   macro avg       0.72      0.54      0.55     22710
weighted avg       0.93      0.95      0.93     22710
</pre></div>
</div>
<img alt="_images/8b42bb5ea5233fd46658449ee2eee0c1061bb941a9ada9accfa673c65c6a2ebd.png" src="_images/8b42bb5ea5233fd46658449ee2eee0c1061bb941a9ada9accfa673c65c6a2ebd.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis overfitting
Diferencia Accuracy (Train-Test): 0.0462
Diferencia F1-score (Train-Test): 0.4427
 Comportamiento esperado para Random Forest
Resumen final
Accuracy:       0.9517
F1-score:       0.5547
AUC:            0.9015
F1 Clase 1:     0.1343
Balanced Acc:   0.5368
Overfitting:    0.0462
Tiempo entrenamiento: 10.09s

Info:
   - Número de árboles: 100
   - Número de características: 129
   - Profundidad máxima promedio: 72.7
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
Compaación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

 Random Forest se encuentra en la posición #6 de 6 modelos

Información:
   - Ventaja: Menos propenso a overfitting que árboles individuales
   - Robustez: Maneja bien características correlacionadas
   - Árboles: 100 árboles en el ensemble
   - Profundidad promedio: 72.7
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Random Forest presenta un F1-Score macro de 0.551 y un AUC-ROC de 0.902, mostrando una capacidad discriminativa excelente pero un desempeño balanceado moderado. El accuracy de 0.951 refleja el sesgo hacia la clase mayoritaria.</p>
<p>En la matriz de confusión muestra un Recall de 0.07 para la clase Popular, identificando solo el 7% de las canciones populares (81 de 1094). También un Precision de 0.47 para la clase Popular, identificando una alta precisión relativa con 47% de aciertos cuando predice “popular”. Y tiene un excelente desempeño en clase mayoritaria, teniendo un F1-Score de 0.97 para No Popular vs 0.13 para Popular.</p>
<p>Por lo cual, el modelo Random Forest actúa como un filtro conservador que solo predice como populares aquellas canciones con características muy definidas, generando muy pocos falsos positivos pero omitiendo la gran mayoría de canciones populares reales.</p>
<p>Tiene fortalezas como un AUC bueno de 0.902, que indica excelente capacidad de distinguir entre clases, solo una diferencia Train-Test de solo 0.046 en accuracy, y una alta precisión para clase minoritaria, con 47% cuando se atreve a predecir “popular”</p>
<p>Todo esto es útil para identificar súper-éxitos con alta certeza, pero solo en contextos de muy bajo riesgo como descubrimiento musical.</p>
<p><strong>XGBOOST junto con interpretabilidad LIME</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lime.lime_tabular</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline </span>
<span class="n">pipe_xgb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="s2">&quot;model__max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="s2">&quot;model__learning_rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
    <span class="s2">&quot;model__subsample&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_xgb</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_xgb</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                           <span class="s2">&quot;XGBoost&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># probabilidades de clase positiva correctamente</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretabilidad con LIME - XGBOOST&quot;</span><span class="p">)</span>

<span class="n">X_train_processed</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Explainer de LIME</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">lime</span><span class="o">.</span><span class="n">lime_tabular</span><span class="o">.</span><span class="n">LimeTabularExplainer</span><span class="p">(</span>
    <span class="n">training_data</span><span class="o">=</span><span class="n">X_train_processed</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Función de predicción para LIME</span>
<span class="n">predict_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_lime_explanation</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">probability</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="c1"># Gráfico de barras de la explicación</span>
    <span class="n">exp_as_list</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exp_as_list</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exp_as_list</span><span class="p">]</span>
    
    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">]</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Influencia en la predicción&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s1">Probabilidad: </span><span class="si">{</span><span class="n">probability</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Valores de probabilidad</span>
    <span class="n">prob_values</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">predict_proba</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">prob_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probabilidad&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Probabilidades de Predicción&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prob_values</span><span class="p">):</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predicciones con LIME - Casos de ejemplo:&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">y_pred_proba_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Predicción correcta de clase Popular</span>
    <span class="n">popular_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">popular_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">popular_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sample_prob</span> <span class="o">=</span> <span class="n">y_pred_proba_pos</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>  
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. CASO DE ÉXITO: Canción Popular correctamente clasificada&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Probabilidad de ser popular: </span><span class="si">{</span><span class="n">sample_prob</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">exp</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
            <span class="n">X_test_processed</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span> 
            <span class="n">predict_fn</span><span class="p">,</span> 
            <span class="n">num_features</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        
        <span class="n">plot_lime_explanation</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;Caso Popular - Explicación LIME&#39;</span><span class="p">,</span> <span class="n">sample_prob</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Explicación con características más influyentes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">as_list</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Predicción correcta de clase No Popular</span>
    <span class="n">not_popular_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_popular_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">not_popular_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sample_prob</span> <span class="o">=</span> <span class="n">y_pred_proba_pos</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>  
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. CASO DE ÉXITO: Canción No Popular correctamente clasificada&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Probabilidad de ser popular: </span><span class="si">{</span><span class="n">sample_prob</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">exp</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">explain_instance</span><span class="p">(</span>
            <span class="n">X_test_processed</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span> 
            <span class="n">predict_fn</span><span class="p">,</span> 
            <span class="n">num_features</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        
        <span class="n">plot_lime_explanation</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;Caso No Popular - Explicación LIME&#39;</span><span class="p">,</span> <span class="n">sample_prob</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Explicación con características más influyentes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">as_list</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay probabilidades disponibles para análisis LIME&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis final:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>

    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo de entrenamiento: 67.76s
Mejores parámetros: {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 200, &#39;model__subsample&#39;: 0.8}
Mejor F1-score (CV): 0.5252
EVALUACIÓN COMPLETA CON evaluate_model
XGBoost: acc=0.953, f1=0.522, time=2.34s
Matriz resultante:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                    Random Forest    0.9517     0.9330  0.9517    0.5547   
6                          XGBoost    0.9525     0.9376  0.9525    0.5224   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
4  0.6043      6.7157  
5  0.9015     10.0906  
6  0.8791      2.3353  
Análisis:
Evaluación detallada:
Accuracy:            0.9525
Balanced Accuracy:   0.5177
AUC:                 0.8791
F1-score (Weighted): 0.5224
F1-score (Macro):    0.5224

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21592       24]
     Popular   [  1054       40]

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.95      1.00      0.98     21616
     Popular       0.62      0.04      0.07      1094

    accuracy                           0.95     22710
   macro avg       0.79      0.52      0.52     22710
weighted avg       0.94      0.95      0.93     22710
</pre></div>
</div>
<img alt="_images/738b3cc27ad97dc912c91bca8ef67d50d3cdcaff360ef77d5895cc51955aa3e9.png" src="_images/738b3cc27ad97dc912c91bca8ef67d50d3cdcaff360ef77d5895cc51955aa3e9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Interpretabilidad con LIME - XGBOOST
Predicciones con LIME - Casos de ejemplo:

1. CASO DE ÉXITO: Canción Popular correctamente clasificada
   Probabilidad de ser popular: 0.581
</pre></div>
</div>
<img alt="_images/d94b67b6d10a3f64852aec874f7199e746f61804b7c9ee6ab06a735cb6bc2aca.png" src="_images/d94b67b6d10a3f64852aec874f7199e746f61804b7c9ee6ab06a735cb6bc2aca.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Explicación con características más influyentes:
   cat__track_genre_indie &lt;= 0.00: -0.1860
   cat__track_genre_pop &lt;= 0.00: -0.1731
   cat__track_genre_alternative &lt;= 0.00: -0.1604
   cat__track_genre_indie-pop &lt;= 0.00: -0.1535
   cat__track_genre_rock &lt;= 0.00: -0.1488
   cat__track_genre_alt-rock &lt;= 0.00: -0.1481
   cat__track_genre_electro &gt; 0.00: 0.1373
   cat__track_genre_metal &lt;= 0.00: -0.1329
   cat__track_genre_dance &lt;= 0.00: -0.1041
   cat__track_genre_hard-rock &lt;= 0.00: -0.1032

2. CASO DE ÉXITO: Canción No Popular correctamente clasificada
   Probabilidad de ser popular: 0.151
</pre></div>
</div>
<img alt="_images/0f676463106cf8b2cd4c6d2855c8126c311d56996baae15f9b92ef335ad604ff.png" src="_images/0f676463106cf8b2cd4c6d2855c8126c311d56996baae15f9b92ef335ad604ff.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Explicación con características más influyentes:
   cat__track_genre_pop &lt;= 0.00: -0.1965
   cat__track_genre_indie &lt;= 0.00: -0.1730
   cat__track_genre_alternative &lt;= 0.00: -0.1696
   cat__track_genre_indie-pop &lt;= 0.00: -0.1571
   cat__track_genre_alt-rock &lt;= 0.00: -0.1222
   cat__track_genre_hard-rock &lt;= 0.00: -0.1158
   cat__track_genre_electro &lt;= 0.00: -0.1155
   cat__track_genre_rock &lt;= 0.00: -0.1135
   cat__track_genre_dance &lt;= 0.00: -0.1052
   cat__track_genre_house &lt;= 0.00: -0.0997
Análisis final:

Rendimiento general:
   - Accuracy: 0.953
   - AUC: 0.879 
   - F1-Score: 0.522 
   - Balanced Accuracy: 0.518 
   - Tiempo entrenamiento: 2.34s

Hiperparámetros óptimos:
   - {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 200, &#39;model__subsample&#39;: 0.8}


Top 10 características importantes:
                        feature  importance
95         cat__track_genre_pop      0.0501
35       cat__track_genre_dance      0.0425
68       cat__track_genre_house      0.0367
46     cat__track_genre_electro      0.0348
80       cat__track_genre_k-pop      0.0325
105       cat__track_genre_rock      0.0311
45         cat__track_genre_edm      0.0271
83      cat__track_genre_latino      0.0236
86       cat__track_genre_metal      0.0194
104  cat__track_genre_reggaeton      0.0180
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Decision Tree
   F1-Score: 0.6021
</pre></div>
</div>
</div>
</div>
<p>Analizando el desemp0eño del modelo XGBoost muestra un F1-Score macro de 0.522 y un AUC-ROC de 0.879, dando una capacidad discriminativa muy buena pero un desempeño balanceado moderado. El accuracy de 0.953 refleja el patrón típico de sesgo hacia la clase mayoritaria en problemas desbalanceados.</p>
<p>En la matriz de confusión se muestra un Recall de 0.04 para la clase Popular, identificando solo el 4% de las canciones populares (40 de 1094). También un precision de 0.62 para la clase Popular, siendo una muy alta precisión con 62% de aciertos cuando predice “popular”, y solo 24 falsos positivos.</p>
<p>Así, el modelo XGBoost funciona como un filtro de tipo élite que identifica con alta certeza un pequeño subconjunto de canciones populares.</p>
<p>En el ranking de características se ven los géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con un 0.0501, un género dominante en popularidad</p></li>
<li><p>Dance con un 0.0425 como éxito comercial</p></li>
<li><p>House con un 0.0367, un género electrónico con amplia aceptación</p></li>
<li><p>Electro con un 0.0348, un tipo de música electrónica contemporánea</p></li>
<li><p>K-Pop con un 0.0325, siendo un fenómeno global emergente</p></li>
</ul>
<p>En la sección de Interpretabilidad con LIME se presentan dos casos. El primero es en la Canción Popular Correctamente Clasificada, que tiene una probabilidad de un 58.1% de ser popular, identificandose el género electro como factor positivo clave. En los factores negativos hay una ausencia de géneros alternativos como el indie, rock o pop, dando un Insight que asocia el éxito con géneros electrónicos.</p>
<p>Y el segundo caso es la Canción No Popular Correctamente Clasificada, con una probabilidad del 15.1% de ser popular. No pertenecer a pop, indie, alternative, etc.</p>
<p>Las ventajas del análisis con LIME es que el entendimiento va caso por caso, identificando de características determinantes e importancia de cada género musical. Así, las disqueras pueden usar estas explicaciones para entender por qué ciertas canciones son clasificadas como potencialmente populares.</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">resample</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño original - Train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Reducimos tamaño en train</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12000</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conjunto de entrenamiento grande (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras). Aplicando submuestra ESTRATIFICADA...&quot;</span><span class="p">)</span>
    <span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">12000</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train reducido a: </span><span class="si">{</span><span class="n">X_train_balanced</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución final en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train_balanced</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline para SVM</span>
<span class="n">pipe_svm</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;model__kernel&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">],</span>
    <span class="s2">&quot;model__gamma&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_svm</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  <span class="c1"># ← F1-MACRO COMO MÉTRICA PRINCIPAL</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="c1"># Usar X_train_balanced y y_train_balanced para entrenamiento</span>
<span class="n">result_svm</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                           <span class="s2">&quot;SVM&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_svm</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - SVM&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - SVM&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes para SVM lineal </span>
<span class="k">if</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># DataFrame con coeficientes</span>
    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Top 15 características</span>
    <span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - SVM (Coeficientes)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Kernel no lineal</span><span class="se">\n</span><span class="s1">No hay coeficientes&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Coeficientes - No disponible para kernel no lineal&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - SVM&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_svm</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - Kernel: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Gamma: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>

    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del SVM vs otros modelos</span>
    <span class="n">svm_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SVM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SVM se encuentra en la posición #</span><span class="si">{</span><span class="n">svm_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre SVM</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Kernel utilizado: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Muestras entrenamiento: </span><span class="si">{</span><span class="n">X_train_balanced</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño original - Train: (90840, 15), Test: (22710, 15)
Conjunto de entrenamiento grande (90840 muestras). Aplicando submuestra ESTRATIFICADA...
Train reducido a: (12000, 15)
Distribución final en entrenamiento:
   Clase 0 (No Popular): 11422 muestras (95.2%)
   Clase 1 (Popular):    578 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 6 candidates, totalling 30 fits
Tiempo de entrenamiento: 506.49s
Mejores parámetros: {&#39;model__C&#39;: 10, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;}
Mejor F1-score (CV): 0.6168
EVALUACIÓN COMPLETA CON evaluate_model
SVM: acc=0.883, f1=0.600, time=19.22s
Matriz resultante:
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                    Random Forest    0.9517     0.9330  0.9517    0.5547   
6                          XGBoost    0.9525     0.9376  0.9525    0.5224   
7                              SVM    0.8835     0.9316  0.8835    0.5996   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
4  0.6043      6.7157  
5  0.9015     10.0906  
6  0.8791      2.3353  
7  0.7936     19.2231  
Análisis:
Evaluación detallada:
Accuracy:            0.8835
Balanced Accuracy:   0.6685
AUC:                 0.7936
F1-score (Weighted): 0.5996
F1-score (Macro):    0.5996

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9692
Recall - No Popular:    0.9064
F1 - No Popular:        0.9367
Precision - Popular:    0.1889
Recall - Popular:       0.4305
F1 - Popular:           0.2625

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19593     2023]
     Popular   [   623      471]

Desglose:
   Verdaderos Negativos: 19593
   Falsos Positivos:     2023
   Falsos Negativos:     623
   Verdaderos Positivos: 471

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.91      0.94     21616
     Popular       0.19      0.43      0.26      1094

    accuracy                           0.88     22710
   macro avg       0.58      0.67      0.60     22710
weighted avg       0.93      0.88      0.90     22710
</pre></div>
</div>
<img alt="_images/34b84349f21df53d4e5658fad57a80d37bb20410dd690c23abd08afeea59e5f1.png" src="_images/34b84349f21df53d4e5658fad57a80d37bb20410dd690c23abd08afeea59e5f1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis:

Rendimiento general:
   - Accuracy: 0.883
   - AUC: 0.794 
   - F1-Score: 0.600 
   - Balanced Accuracy: 0.668 
   - Tiempo entrenamiento: 19.22s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.969 | Recall: 0.906 | F1: 0.937
   - CLASE 1 (Popular): 
        Precision: 0.189 | Recall: 0.431 | F1: 0.263

Hiperparámetros óptimos:
   - Kernel: rbf
   - C: 10
   - Gamma: scale

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

SVM se encuentra en la posición #8 de 8 modelos

Información:
   - Kernel utilizado: rbf
   - Regularización C: 10
   - Muestras entrenamiento: 12000
   - Class weight: balanced para manejar desbalance
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo SVM presenta un F1-Score macro de 0.600 y un AUC-ROC de 0.794, mostrando un balanceado competitivo. El accuracy de 0.884 da un mejor equilibrio entre clases a pesar del desbalance.</p>
<p>En la matriz de confusión muestra un Recall de 0.43 para la clase Popular, identificando el 43% de canciones populares (471 de 1094). También un Precision de 0.19 para la clase Popular, identificando un 19% de aciertos cuando predice “popular”. Y un Balanced Accuracy de 0.669, siendo ell más alto entre todos los modelos que hemos evaluado.</p>
<p>Así, el modelo da un filtro equilibrado con mejor desempeño en identificar canciones populares y mantener una precisión razonable. Teniendo este alto recall asegura no omitir canciones prometedoras ya que el modelo identifica 471 canciones populares reales vs solo 40 a 81 en otros modelos, representando una cobertura 5-10 veces mayor del mercado potencial.</p>
<p>Para disqueras, identificar 471 representa una diferencia operativa significativa pues les dan opciones más recomendables para estrategias de descubrimiento y producción musical basadas en datos.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="balanceo-de-clases">
<h1>Balanceo de Clases<a class="headerlink" href="#balanceo-de-clases" title="Link to this heading">#</a></h1>
<p>Volvemos a preparar cada modelos con una configuración inicial apta para <strong>SMOTE</strong>:</p>
<p><strong>Naive Bayes</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">RocCurveDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span>
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> 
    <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">pipeline_nb</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="c1"># Optimización con GridSearchCV </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> 
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hiperparámetros&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Combinaciones: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> × </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> × </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">pipeline_nb</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">True</span>  
<span class="p">)</span>

<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parámetros óptimos:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>
<span class="n">result_nb_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                <span class="s2">&quot;Naive Bayes con SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_nb_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis con SMOTE:&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Resumen de métricas globales</span>
<span class="n">metrics_summary</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> 
    <span class="n">balanced_acc</span><span class="p">,</span> 
    <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">metrics_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Balanced</span><span class="se">\n</span><span class="s1">Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score</span><span class="se">\n</span><span class="s1">(Macro)&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span>

<span class="n">bars</span> <span class="o">=</span> <span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics_labels</span><span class="p">,</span> <span class="n">metrics_summary</span><span class="p">,</span> 
              <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#FF6B6B&#39;</span><span class="p">,</span> <span class="s1">&#39;#4ECDC4&#39;</span><span class="p">,</span> <span class="s1">&#39;#45B7D1&#39;</span><span class="p">,</span> <span class="s1">&#39;#96CEB4&#39;</span><span class="p">],</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Globales - Naive Bayes con SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">metrics_summary</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis con SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_nb_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - var_smoothing: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>

    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Naive Bayes con SMOTE vs otros modelos</span>
    <span class="n">nb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Naive Bayes con SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Naive Bayes con SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">nb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Naive Bayes con SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ventaja: Simple, rápido y con SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Estrategia SMOTE: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - k_neighbors SMOTE: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - var_smoothing: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Hiperparámetros
   Combinaciones: 15 × 4 × 3 = 180
Fitting 5 folds for each of 180 candidates, totalling 900 fits

Parámetros óptimos:
   model__var_smoothing: 1e-06
   smote__k_neighbors: 5
   smote__sampling_strategy: auto
Mejor F1-score (CV): 0.4630
EVALUACIÓN COMPLETA CON evaluate_model
Naive Bayes con SMOTE: acc=0.615, f1=0.469, time=0.76s
Matriz resultante
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                    Random Forest    0.9517     0.9330  0.9517    0.5547   
6                          XGBoost    0.9525     0.9376  0.9525    0.5224   
7                              SVM    0.8835     0.9316  0.8835    0.5996   
8            Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
4  0.6043      6.7157  
5  0.9015     10.0906  
6  0.8791      2.3353  
7  0.7936     19.2231  
8  0.7842      0.7641  
Análisis con SMOTE:
Evaluación detallada:
Accuracy:            0.6151
Balanced Accuracy:   0.7713
AUC:                 0.7842
F1-score (Weighted): 0.4693
F1-score (Macro):    0.4693

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9953
Recall - No Popular:    0.5984
F1 - No Popular:        0.7475
Precision - Popular:    0.1064
Recall - Popular:       0.9442
F1 - Popular:           0.1912

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 12936     8680]
     Popular   [    61     1033]

Desglose:
   Verdaderos Negativos: 12936
   Falsos Positivos:     8680
   Falsos Negativos:     61
   Verdaderos Positivos: 1033

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       1.00      0.60      0.75     21616
     Popular       0.11      0.94      0.19      1094

    accuracy                           0.62     22710
   macro avg       0.55      0.77      0.47     22710
weighted avg       0.95      0.62      0.72     22710
</pre></div>
</div>
<img alt="_images/9f57e2265b91e885f0d03087a770e0d6fb175bfbdd14e47df879580b1a8af90b.png" src="_images/9f57e2265b91e885f0d03087a770e0d6fb175bfbdd14e47df879580b1a8af90b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis con SMOTE

Rendimiento general:
   - Accuracy: 0.615
   - AUC: 0.784 
   - F1-Score (Macro): 0.469 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 0.76s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.995 | Recall: 0.598 | F1: 0.747
   - CLASE 1 (Popular): 
        Precision: 0.106 | Recall: 0.944 | F1: 0.191

Hiperparámetros óptimos SMOTE:
   - Sampling strategy: auto
   - k_neighbors: 5
   - var_smoothing: 1.00e-06

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Decision Tree
   F1-Score: 0.6021
   Accuracy: 0.9287
   AUC:      0.6043

Naive Bayes con SMOTE se encuentra en la posición #9 de 9 modelos

Información:
   - Ventaja: Simple, rápido y con SMOTE para balancear clases
   - Estrategia SMOTE: auto
   - k_neighbors SMOTE: 5
   - var_smoothing: 1.00e-06
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Naive Bayes con SMOTE presenta un F1-Score macro de 0.469, mostrando una mejora limitada respecto al Naive Bayes original que tiene un F1- Score de 0.395. Sin embargo, el balanceo produce cambios dramáticos en la distribución del desempeño por clases.</p>
<p>SMOTE genera un cambio completo en el perfil predictivo pues ahora tiene un Recall de 0.944 para la clase Popular identificando el 94.4% de canciones populares (1033 de 1094). También un Precision de 0.106 para la clase Popular, identificando solo 10.6% de aciertos cuando predice “popular”. Y un Balanced Accuracy de 0.771, siendo una mejora significativa vs el 0.500 del modelo original</p>
<p>Por lo cual, SMOTE convierte a Naive Bayes en un filtro de cobertura casi total pues captura prácticamente todas las canciones populares, pero da un aumento masivo de falsos positivos (8,692).</p>
<p>En el análisis del Trade-off SMOTE se ve que un 94% de recall para clase minoritaria vs 98% en original, una ligera reducción. En Precision Popular cambia de 8.5% a 10.6%, dando una mejora marginal, un F1-Score de 0.395 a 0.469, mejora del 19%, y un Balanced Accuracy de 0.500 a 0.771.</p>
<p>Por ello, en el contexto musical es ideal para no omitir ninguna canción potencialmente popular, pero requiere evaluación humana masiva posterior y no resuelve las limitaciones para capturar patrones complejos en datos de popularidad musical.</p>
<p><strong>Regresión Logística</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">recall_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline para Logistic Regression CON SMOTE</span>
<span class="n">pipe_logreg_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span>  
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;model__C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
    <span class="s2">&quot;model__penalty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">],</span>
    <span class="s2">&quot;smote__sampling_strategy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s2">&quot;smote__k_neighbors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_logreg_smote</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_logreg_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="s2">&quot;Logistic Regression SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_logreg_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultanto&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LOGISTIC REGRESSION SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Logistic Regression SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Logistic Regression SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Logistic Regression SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Logistic Regression SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis con SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_logreg_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Penalty: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Logistic Regression SMOTE vs otros modelos</span>
    <span class="n">logreg_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Logistic Regression SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Logistic Regression SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">logreg_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Logistic Regression SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - k_neighbors SMOTE: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Penalty: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización C: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 72 candidates, totalling 360 fits
Tiempo de entrenamiento: 711.27s
Mejores parámetros: {&#39;model__C&#39;: 0.01, &#39;model__penalty&#39;: &#39;l1&#39;, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-score (CV): 0.6093
EVALUACIÓN COMPLETA CON evaluate_model
Logistic Regression SMOTE: acc=0.861, f1=0.604, time=1.40s
Matriz resultanto
                             Model  Accuracy  Precision  Recall  F1-Score  \
0  Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                      Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                 Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                 Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                    Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                    Random Forest    0.9517     0.9330  0.9517    0.5547   
6                          XGBoost    0.9525     0.9376  0.9525    0.5224   
7                              SVM    0.8835     0.9316  0.8835    0.5996   
8            Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9        Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   

      AUC  Train_Time  
0  0.8431      0.6271  
1  0.7255      0.3062  
2     NaN      0.3249  
3  0.8431      0.5626  
4  0.6043      6.7157  
5  0.9015     10.0906  
6  0.8791      2.3353  
7  0.7936     19.2231  
8  0.7842      0.7641  
9  0.8434      1.3964  
Análisis LOGISTIC REGRESSION SMOTE
Evaluación detallada:
Accuracy:            0.8612
Balanced Accuracy:   0.7249
AUC:                 0.8434
F1-score (Weighted): 0.6040
F1-score (Macro):    0.6040

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9760
Recall - No Popular:    0.8757
F1 - No Popular:        0.9231
Precision - Popular:    0.1894
Recall - Popular:       0.5740
F1 - Popular:           0.2849

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18929     2687]
     Popular   [   466      628]

Desglose:
   Verdaderos Negativos: 18929
   Falsos Positivos:     2687
   Falsos Negativos:     466
   Verdaderos Positivos: 628

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.88      0.92     21616
     Popular       0.19      0.57      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.72      0.60     22710
weighted avg       0.94      0.86      0.89     22710
</pre></div>
</div>
<img alt="_images/ad69b9be8d1325aeeeeacb01e9ff2559ae3e324d0c462ee8a12485c11a28b28c.png" src="_images/ad69b9be8d1325aeeeeacb01e9ff2559ae3e324d0c462ee8a12485c11a28b28c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis con SMOTE

Rendimiento general:
   - Accuracy: 0.861
   - AUC: 0.843 
   - F1-Score (Macro): 0.604 
   - Balanced Accuracy: 0.725 
   - Tiempo entrenamiento: 1.40s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.876 | F1: 0.923
   - CLASE 1 (Popular): 
        Precision: 0.189 | Recall: 0.574 | F1: 0.285

Hiperparámetros óptimos SMOTE:
   - Sampling strategy: 0.5
   - k_neighbors: 5
   - C: 0.01
   - Penalty: l1


Top 10 características importantes:
                       feature    coef
95        cat__track_genre_pop  3.1506
86      cat__track_genre_metal  2.7100
46    cat__track_genre_electro  2.5598
35      cat__track_genre_dance  2.4899
80      cat__track_genre_k-pop  2.4878
68      cat__track_genre_house  2.4265
71      cat__track_genre_indie  2.3616
105      cat__track_genre_rock  2.3570
17   cat__track_genre_alt-rock  2.1876
45        cat__track_genre_edm  2.1649
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Logistic Regression SMOTE
   F1-Score: 0.6040
   Accuracy: 0.8612
   AUC:      0.8434

Logistic Regression SMOTE se encuentra en la posición #10 de 10 modelos

Información:
   - SMOTE para balancear clases
   - Sampling strategy: 0.5
   - k_neighbors SMOTE: 5
   - Penalty: l1
   - Regularización C: 0.01
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Logistic Regression con SMOTE presenta un F1-Score macro de 0.604 y un AUC-ROC de 0.845, mostrando una mejora respecto a la versión sin SMOTE que tiene un F1-Score de 0.565. Esta mejora muestra una buena capacidad discriminativa base.</p>
<p>SMOTE produce un cambio estratégico fundamental en el comportamiento del modelo mostrando un Recall de 0.58 para la clase Popular, identificando el 58% de canciones populares (634 de 1094) vs 75% en original. También, un Precision de 0.19 para la clase Popular, siendo un 19% de aciertos vs 15% en original. Y un Balanced Accuracy de 0.727 vs 0.771 en original.</p>
<p>Así, SMOTE convierte a Logistic Regression en un filtro más equilibrado que sacrifica algo de recall para ganar en precision y balanced accuracy. Hay una reducción de falsos positivos de 2,707 vs 4,573 del original.</p>
<p>El análisis de coeficientes muestra cambios en los géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con un 3.13, mantiene el dominio</p></li>
<li><p>Metal con un 2.69, aumenta su importancia</p></li>
<li><p>Electro con un 2.52, misma posición</p></li>
<li><p>House con un 2.47, cambia</p></li>
<li><p>Dance con un 2.44, misma posición</p></li>
</ul>
<p>Por ello, Logistic Regression con SMOTE optimiza el balance entre capacidad predictiva y utilidad práctica, produciendo modelos que ofrecen el mejor equilibrio entre cobertura y eficiencia operativa para estrategias de producción musical.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test         - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Pipeline con SMOTE </span>
<span class="n">pipeline_ridge_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_ridge_smote</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_ridge_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                   <span class="s2">&quot;Ridge Classifier SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_ridge_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  <span class="c1"># F1-macro</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RIDGE CLASSIFIER SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">auc_value</span> <span class="o">=</span> <span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;No disponible&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">auc_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="c1"># Gráficos</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># RidgeClassifier no tiene probabilidades por defecto</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;RidgeClassifier no proporciona</span><span class="se">\n</span><span class="s1">probabilidades por defecto</span><span class="se">\n\n</span><span class="s1">Usar CalibratedClassifierCV</span><span class="se">\n</span><span class="s1">para obtener curva ROC&#39;</span><span class="p">,</span> 
         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible para RidgeClassifier&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Ridge Classifier SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Ridge Classifier&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">auc_value</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_ridge_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Alpha: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cmparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Ridge Classifier SMOTE vs otros modelos</span>
    <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Ridge Classifier SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L2 (Ridge) para evitar overfitting&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Alpha óptimo: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - No proporciona probabilidades (AUC no disponible)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases:
   Entrenamiento - Clase 0: 86466 | Clase 1: 4374
   Test         - Clase 0: 21616 | Clase 1: 1094

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 36 candidates, totalling 180 fits
Tiempo de entrenamiento: 41.21s
Mejores parámetros: {&#39;model__alpha&#39;: 100.0, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-score (CV): 0.5988
EVALUACIÓN COMPLETA CON evaluate_model
Ridge Classifier SMOTE: acc=0.842, f1=0.595, time=0.65s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
Análisis RIDGE CLASSIFIER SMOTE
Evaluación detallada:
Accuracy:            0.8419
Balanced Accuracy:   0.7421
AUC:                 No disponible
F1-score (Weighted): 0.5946
F1-score (Macro):    0.5946

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9786
Recall - No Popular:    0.8525
F1 - No Popular:        0.9112
Precision - Popular:    0.1781
Recall - Popular:       0.6316
F1 - Popular:           0.2779

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18428     3188]
     Popular   [   403      691]

Desglose:
   Verdaderos Negativos: 18428
   Falsos Positivos:     3188
   Falsos Negativos:     403
   Verdaderos Positivos: 691

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.85      0.91     21616
     Popular       0.18      0.63      0.28      1094

    accuracy                           0.84     22710
   macro avg       0.58      0.74      0.59     22710
weighted avg       0.94      0.84      0.88     22710
</pre></div>
</div>
<img alt="_images/e2f35f2a61b31526a59af19fdf45a696a9c32d6a9544f9da39344fc33f76c4aa.png" src="_images/e2f35f2a61b31526a59af19fdf45a696a9c32d6a9544f9da39344fc33f76c4aa.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evaluación:

Rendimiento general:
   - Accuracy: 0.842
   - AUC: No disponible 
   - F1-Score (Macro): 0.595 
   - Balanced Accuracy: 0.742 
   - Tiempo entrenamiento: 0.65s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.979 | Recall: 0.853 | F1: 0.911
   - CLASE 1 (Popular): 
        Precision: 0.178 | Recall: 0.632 | F1: 0.278

Hiperparámetros óptimos SMOTE:
   - Alpha: 100.0
   - Sampling strategy: 0.5
   - k_neighbors: 5


Top 10 características importantes:
                 feature    coef
0       num__duration_ms -0.0004
1      num__danceability -0.0004
2            num__energy -0.0004
3               num__key -0.0004
4          num__loudness -0.0004
5              num__mode -0.0004
6       num__speechiness -0.0004
7      num__acousticness -0.0004
8  num__instrumentalness -0.0004
9          num__liveness -0.0004
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Cmparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Logistic Regression SMOTE
   F1-Score: 0.6040
   Accuracy: 0.8612
   AUC:      0.8434

Ridge Classifier SMOTE se encuentra en la posición #11 de 11 modelos

Información:
   - Regularización L2 (Ridge) para evitar overfitting
   - SMOTE para balancear clases
   - Alpha óptimo: 100.0
   - Sampling strategy: 0.5
   - No proporciona probabilidades (AUC no disponible)
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Ridge Classifier con SMOTE presenta un F1-Score macro de 0.594 y un accuracy de 0.842, mostrando un desempeño competitivo, pero con una limitación es la falta de métrica AUC.</p>
<p>El balanceo produce una mejora respecto al Ridge Classifier original, con un Recall de 0.63 para la clase Popular, identifcando 63% vs 0% en original. También un Precision de 0.18 para la clase Popular, identificando un 18% de aciertos vs 0% en original. Y un F1-Score de 0.594, una mejor del 22% vs 0.488 en original</p>
<p>SMOTE rescata completamente a Ridge Classifier,  transformándolo de un modelo que ignoraba por completo la clase minoritaria a uno con capacidad razonable de detección.</p>
<p>En el análisis de coeficientes se muestran los siguientes géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con un 1.17, dominio</p></li>
<li><p>Metal con un 0.99, ocn alta relevancia</p></li>
<li><p>Electro con un 0.99</p></li>
<li><p>Dance con un 0.98</p></li>
<li><p>K-Pop con un 0.96, fenómeno global</p></li>
</ul>
<p>Ridge Classifier con SMOTE representa una alternativa sólida y eficiente para aplicaciones de la industria musical, se valora la estabilidad predictiva y la eficiencia computacional.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span><span class="p">,</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de parámetros</span>
<span class="n">LASSO_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>  
<span class="n">LASSO_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>  
<span class="n">LASSO_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CONFIGURACIÓN LASSO OPTIMIZADA&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Valores de C: </span><span class="si">{</span><span class="n">LASSO_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vecinos: </span><span class="si">{</span><span class="n">LASSO_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">lasso_smote_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> 
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>  
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda - CORREGIDO: usar f1_macro</span>
<span class="n">lasso_smote_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="n">LASSO_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">LASSO_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">lasso_smote_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lasso_smote_pipeline</span><span class="p">,</span>
    <span class="n">lasso_smote_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_smote</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_C_VALUES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones SMOTE: </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_lasso_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                   <span class="s2">&quot;Lasso SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes Lasso </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados LASSO SMOTE&quot;</span><span class="p">)</span>
<span class="c1"># Análisis de selección de características Lasso</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_nonzero_coef</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_zero_coef</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - k_neighbors: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Selección de características Lasso:</span>
<span class="s2">   - Características retenidas: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)</span>
<span class="s2">   - Sparsity ratio: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso SMOTE vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - C óptimo: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
CONFIGURACIÓN LASSO OPTIMIZADA
   Valores de C: [0.001, 0.01, 0.1, 1.0]
   Estrategias: [0.5, &#39;auto&#39;]
   Vecinos: [3, 5]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones SMOTE: 16 × 5 folds = 80 modelos
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo de entrenamiento: 195.31s
Mejores parámetros: {&#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None, &#39;smote__k_neighbors&#39;: 5, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-score (CV): 0.6093
EVALUACIÓN COMPLETA CON evaluate_model
Lasso SMOTE: acc=0.861, f1=0.604, time=1.30s
Evaluación:
Accuracy: 0.8612
F1-score: 0.6040
AUC:      0.8434

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18929     2687]
     Popular   [   466      628]

Reporte de clasificación:
              precision    recall  f1-score   support

  No Popular       0.98      0.88      0.92     21616
     Popular       0.19      0.57      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.72      0.60     22710
weighted avg       0.94      0.86      0.89     22710
</pre></div>
</div>
<img alt="_images/7c04c990949365fa57cc0d6409f6c43fff728fd959bfdfe1c7bcf12a3ff64bf9.png" src="_images/7c04c990949365fa57cc0d6409f6c43fff728fd959bfdfe1c7bcf12a3ff64bf9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
Análisis LASSO SMOTE
Evaluación detallada:
Accuracy:            0.8612
Balanced Accuracy:   0.7249
AUC:                 0.8434
F1-score (Weighted): 0.6040
F1-score (Macro):    0.6040

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9760
Recall - No Popular:    0.8757
F1 - No Popular:        0.9231
Precision - Popular:    0.1894
Recall - Popular:       0.5740
F1 - Popular:           0.2849

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18929     2687]
     Popular   [   466      628]

Desglose:
   Verdaderos Negativos: 18929
   Falsos Positivos:     2687
   Falsos Negativos:     466
   Verdaderos Positivos: 628

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.88      0.92     21616
     Popular       0.19      0.57      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.72      0.60     22710
weighted avg       0.94      0.86      0.89     22710
</pre></div>
</div>
<img alt="_images/81898886985edbcbfbe97f5d86217fcaa04eaefd0b5ad1c59bafcb765a731958.png" src="_images/81898886985edbcbfbe97f5d86217fcaa04eaefd0b5ad1c59bafcb765a731958.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados LASSO SMOTE

Rendimiento general:
   - Accuracy: 0.861
   - AUC: 0.843 
   - F1-Score (Macro): 0.604 
   - Balanced Accuracy: 0.725 
   - Tiempo entrenamiento: 1.30s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.876 | F1: 0.923
   - CLASE 1 (Popular): 
        Precision: 0.189 | Recall: 0.574 | F1: 0.285

Hiperparámetros óptimos SMOTE:
   - C: 0.01
   - Sampling strategy: 0.5
   - k_neighbors: 5

Selección de características Lasso:
   - Características retenidas: 71 de 129
   - Características eliminadas: 58 (45.0%)
   - Sparsity ratio: 0.550


Top 10 características importantes:
                       feature    coef
95        cat__track_genre_pop  3.1506
86      cat__track_genre_metal  2.7100
46    cat__track_genre_electro  2.5598
35      cat__track_genre_dance  2.4899
80      cat__track_genre_k-pop  2.4878
68      cat__track_genre_house  2.4265
71      cat__track_genre_indie  2.3616
105      cat__track_genre_rock  2.3570
17   cat__track_genre_alt-rock  2.1876
45        cat__track_genre_edm  2.1649
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Logistic Regression SMOTE
   F1-Score: 0.6040
   Accuracy: 0.8612
   AUC:      0.8434

Lasso SMOTE se encuentra en la posición #12 de 12 modelos

Información:
   - Regularización L1 (Lasso) para selección de características
   - SMOTE para balancear clases
   - Características eliminadas: 58 de 129 (45.0%)
   - C óptimo: 0.01
   - Sampling strategy: 0.5
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Lasso Regression con SMOTE presenta un F1-Score macro de 0.604 y un AUC-ROC de 0.845. La combinación de SMOTE con regularización L1 produce un modelo optimizado con un Recall de 0.58 para la clase Popular, identificando un 58% de detección (634 de 1094 canciones). También, un Precision de 0.19 para la clase Popular, identificando un 19% de aciertos en predicciones positivas.</p>
<p>Lasso con SMOTE mantiene el balance predictivo de Logistic Regression mientras optimiza la complejidad del modelo mediante selección de características.</p>
<p>En a efectividad de la regularización L1 hay aracterísticas retenidas con 72 de 129 (55.8%) y un Sparsity ratio de 0.558, siendo un modelo más simple</p>
<p>En los patrones de género confirmados está:</p>
<ul class="simple">
<li><p>Pop con un 3.13, dominio</p></li>
<li><p>Metal con un 2.69, teniendo la segunda posición reforzada</p></li>
<li><p>Electro con un 2.52</p></li>
<li><p>House con un 2.47</p></li>
<li><p>Dance con un 2.44, mainstream confirmado</p></li>
</ul>
<p>Estas ventajas que tiene el modelo ayuda a identificar características verdaderamente importantes, más fácil de implementar y mantener y menos susceptible a overfitting por características irrelevantes, efectivo que identifica claramente los patrones de género asociados al éxito en Spotify.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="c1"># Pipeline con SMOTE</span>
<span class="n">pipeline_dt_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Optimización con RandomizedSearchCV</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
    <span class="s1">&#39;model__criterion&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__max_features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Búsqueda de hiperparámetros con RandomizedSearchCV&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Combinaciones a probar: 50 (de </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">param_grid</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="si">}</span><span class="s2"> posibles)&quot;</span><span class="p">)</span>

<span class="n">random_search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_dt_smote</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">random_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">random_search</span><span class="o">.</span><span class="n">best_estimator_</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_dt_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                <span class="s2">&quot;Decision Tree SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dt_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis DECISION TREE SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Decision Tree SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Decision Tree SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Decision Tree SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Decision Tree SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados:&quot;</span><span class="p">)</span>

<span class="c1"># Información del árbol</span>
<span class="n">tree_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">tree_depth</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span>
<span class="n">n_leaves</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_dt_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - criterion: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__criterion&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Estructura del árbol:</span>
<span class="s2">   - Profundidad: </span><span class="si">{</span><span class="n">tree_depth</span><span class="si">}</span>
<span class="s2">   - Número de hojas: </span><span class="si">{</span><span class="n">n_leaves</span><span class="si">}</span>
<span class="s2">   - Características utilizadas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">)</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de características importantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPARACIÓN ENTRE MODELOS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Decision Tree SMOTE vs otros modelos</span>
    <span class="n">dt_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Decision Tree SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decision Tree SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">dt_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Decision Tree SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad del árbol: </span><span class="si">{</span><span class="n">tree_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hojas: </span><span class="si">{</span><span class="n">n_leaves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Criterion: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__criterion&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">random_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Búsqueda de hiperparámetros con RandomizedSearchCV
   Combinaciones a probar: 50 (de 6048 posibles)
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Tiempo de entrenamiento: 157.10s
Mejores parámetros: {&#39;smote__sampling_strategy&#39;: 0.9, &#39;model__min_samples_split&#39;: 10, &#39;model__min_samples_leaf&#39;: 20, &#39;model__max_features&#39;: None, &#39;model__max_depth&#39;: 20, &#39;model__criterion&#39;: &#39;entropy&#39;}
Mejor F1-score (CV): 0.6175
EVALUACIÓN COMPLETA CON evaluate_model
Decision Tree SMOTE: acc=0.915, f1=0.622, time=6.00s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
Análisis DECISION TREE SMOTE
Evaluación detallada:
Accuracy:            0.9148
Balanced Accuracy:   0.6506
AUC:                 0.7411
F1-score (Weighted): 0.6215
F1-score (Macro):    0.6215

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9667
Recall - No Popular:    0.9430
F1 - No Popular:        0.9547
Precision - Popular:    0.2412
Recall - Popular:       0.3583
F1 - Popular:           0.2883

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20383     1233]
     Popular   [   702      392]

Desglose:
   Verdaderos Negativos: 20383
   Falsos Positivos:     1233
   Falsos Negativos:     702
   Verdaderos Positivos: 392

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.94      0.95     21616
     Popular       0.24      0.36      0.29      1094

    accuracy                           0.91     22710
   macro avg       0.60      0.65      0.62     22710
weighted avg       0.93      0.91      0.92     22710
</pre></div>
</div>
<img alt="_images/0aefacc4a1a9a826cef078fbd447529ab1ad852c8e8a9d39de7dddb4d91d8f16.png" src="_images/0aefacc4a1a9a826cef078fbd447529ab1ad852c8e8a9d39de7dddb4d91d8f16.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados:

Rendimiento general:
   - Accuracy: 0.915
   - AUC: 0.741 
   - F1-Score (Macro): 0.622 
   - Balanced Accuracy: 0.651 
   - Tiempo entrenamiento: 6.00s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.967 | Recall: 0.943 | F1: 0.955
   - CLASE 1 (Popular): 
        Precision: 0.241 | Recall: 0.358 | F1: 0.288

Hiperparámetros óptimos:
   - max_depth: 20
   - min_samples_split: 10
   - min_samples_leaf: 20
   - criterion: entropy
   - sampling_strategy: 0.9

Estructura del árbol:
   - Profundidad: 20
   - Número de hojas: 1055
   - Características utilizadas: 129


Top 10 características importantes:
                          feature  importance
8           num__instrumentalness      0.1483
7               num__acousticness      0.0745
95           cat__track_genre_pop      0.0569
2                     num__energy      0.0507
86         cat__track_genre_metal      0.0425
71         cat__track_genre_indie      0.0401
46       cat__track_genre_electro      0.0381
35         cat__track_genre_dance      0.0367
105         cat__track_genre_rock      0.0313
18   cat__track_genre_alternative      0.0303
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123

================================================================================
COMPARACIÓN ENTRE MODELOS
================================================================================
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Decision Tree SMOTE
   F1-Score: 0.6215
   Accuracy: 0.9148
   AUC:      0.7411

Decision Tree SMOTE se encuentra en la posición #13 de 13 modelos

Información:
   - SMOTE para balancear clases
   - Profundidad del árbol: 20
   - Hojas: 1055
   - Criterion: entropy
   - Sampling strategy: 0.9
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Árbol de decisión con SMOTE presenta un F1-Score macro de 0.620 y un AUC-ROC de 0.735, logrando el mejor desempeño predictivo general entre todos los modelos evaluados.</p>
<p>La combinación de SMOTE con la arquitectura de árbol de decisión produce un modelo equilibrado con un Recall de 0.364 para la clase Popular, identificando un 36.4% de detección (398 de 1094 canciones populares). También, un Precision de 0.235 para la clase Popular, identificando un 23.5% de aciertos en predicciones positivas, representando el punto óptimo entre complejidad y desempeño pues mantiene la capacidad predictiva de modelos más sofisticados mientras ofrece transparencia total en la toma de decisiones.</p>
<p>En el Top 5 características técnicas determinantes están</p>
<ul class="simple">
<li><p>Instrumentalness con un 12.2%, siendo el factor más influyente con canciones de alto contenido instrumental tienden a ser menos populares</p></li>
<li><p>Acousticness con un 6.1%, es decr, el carácter acústico como moderador clave de popularidad</p></li>
<li><p>Género Pop con un 5.7%, mainstream predominante</p></li>
<li><p>Energy con un 5.5%</p></li>
<li><p>Género Metal con un 4.8%</p></li>
</ul>
<p>Con esto, para los productores reducir instrumentalness prioriza las voces sobre los instrumentales, también aplicar melodias ni demasiado acústico ni completamente electrónico, y la energia como base necesaria.</p>
<p>Este modelo combina el mejor desempeño predictivo general con un F1-Score 0.620 con transparencia completa en la toma de decisiones, ofreciendo no solo predicciones precisas sino también reglas claras y accionables para optimizar estrategias de producción musical, y lo convierte en la herramienta ideal para disqueras y artistas que buscan data-driven insights para el éxito en Spotify.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> 
    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X_train: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_train - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   y_test  - Clase 0: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">pipeline_rf_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros</span>
<span class="n">rf_smote_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span>           <span class="c1"># 2 valores (50, 100, 200 → 100, 150)</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>              <span class="c1"># 2 valores (5, 10, 15, None → 10, None)</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>         <span class="c1"># 2 valores</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">],</span>        <span class="c1"># 1 valor (0.5, 0.7, &#39;auto&#39; to &#39;auto&#39;)</span>
    <span class="c1"># Eliminado smote__k_neighbors</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con SMOTE&quot;</span><span class="p">)</span>
<span class="n">rf_smote_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_rf_smote</span><span class="p">,</span>
    <span class="n">rf_smote_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Cálculo de combinaciones OPTIMIZADAS</span>
<span class="n">n_combos_smote</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">])</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">])</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">])</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">rf_smote_params</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones SMOTE: </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reducción del 83% respecto a la configuración original (216 → 40 modelos)&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización con SMOTE completada en </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final con SMOTE</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_rf_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                <span class="s2">&quot;Random Forest SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf_smote</span><span class="p">)</span>

<span class="c1"># Actualizar DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RANDOM FOREST SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Random Forest SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Random Forest&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RANDOM FOREST SMOTE&quot;</span><span class="p">)</span>
<span class="c1"># Información del Random Forest</span>
<span class="n">rf_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_features_in_</span>

<span class="c1"># Contar características importantes (importancia &gt; 0.01)</span>
<span class="n">n_important_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del Random Forest:</span>
<span class="s2">   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span>
<span class="s2">   - Características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span>
<span class="s2">   - SMOTE aplicado: Sí</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación de modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest SMOTE vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ensemble de </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2"> árboles&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE sampling: </span><span class="si">{</span><span class="n">rf_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   X_train: (90840, 15), X_test: (22710, 15)
   y_train - Clase 0: 86466, Clase 1: 4374
   y_test  - Clase 0: 21616, Clase 1: 1094

Búsqueda de hiperparámetros con SMOTE
Combinaciones SMOTE: 8 × 5 folds = 40 modelos
Reducción del 83% respecto a la configuración original (216 → 40 modelos)
Fitting 5 folds for each of 8 candidates, totalling 40 fits
Optimización con SMOTE completada en 427.38s
Mejores parámetros: {&#39;model__max_depth&#39;: None, &#39;model__min_samples_split&#39;: 5, &#39;model__n_estimators&#39;: 100, &#39;smote__sampling_strategy&#39;: &#39;auto&#39;}
Mejor F1-score (CV): 0.6615
EVALUACIÓN COMPLETA CON evaluate_model
Random Forest SMOTE: acc=0.946, f1=0.680, time=15.61s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
Análisis RANDOM FOREST SMOTE
Evaluación detallada:
Accuracy:            0.9463
Balanced Accuracy:   0.6654
AUC:                 0.9019
F1-score (Weighted): 0.6803
F1-score (Macro):    0.6803

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9676
Recall - No Popular:    0.9762
F1 - No Popular:        0.9719
Precision - Popular:    0.4302
Recall - Popular:       0.3547
F1 - Popular:           0.3888

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21102      514]
     Popular   [   706      388]

Desglose:
   Verdaderos Negativos: 21102
   Falsos Positivos:     514
   Falsos Negativos:     706
   Verdaderos Positivos: 388

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.98      0.97     21616
     Popular       0.43      0.35      0.39      1094

    accuracy                           0.95     22710
   macro avg       0.70      0.67      0.68     22710
weighted avg       0.94      0.95      0.94     22710
</pre></div>
</div>
<img alt="_images/617c6309e5e2c2f8ca5685cd4eb9f719d2ccb78db07a11ddf130b55a5befe1c2.png" src="_images/617c6309e5e2c2f8ca5685cd4eb9f719d2ccb78db07a11ddf130b55a5befe1c2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RANDOM FOREST SMOTE

Rendimiento general:
   - Accuracy: 0.946
   - AUC: 0.902 
   - F1-Score (Macro): 0.680 
   - Balanced Accuracy: 0.665 
   - Tiempo entrenamiento: 15.61s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.968 | Recall: 0.976 | F1: 0.972
   - CLASE 1 (Popular): 
        Precision: 0.430 | Recall: 0.355 | F1: 0.389

Información del Random Forest:
   - Número de árboles: 100
   - Características: 129
   - Características importantes: 27
   - SMOTE aplicado: Sí

Hiperparámetros óptimos SMOTE:
   - n_estimators: 100
   - max_depth: None
   - min_samples_split: 5
   - sampling_strategy: auto


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.0756
7       num__acousticness      0.0558
2             num__energy      0.0551
4           num__loudness      0.0506
0        num__duration_ms      0.0497
9           num__liveness      0.0462
3                num__key      0.0430
1       num__danceability      0.0423
10           num__valence      0.0421
11             num__tempo      0.0413
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
Comparación de modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Random Forest SMOTE se encuentra en la posición #14 de 14 modelos

Información:
   - Ensemble de 100 árboles
   - SMOTE para balancear clases
   - Características importantes: 27 de 129
   - n_estimators: 100
   - max_depth: None
   - SMOTE sampling: auto
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Random Forest con SMOTE da el mejor modelo global con un F1-Score macro de 0.668 y AUC-ROC de 0.901, Accuracy de 0.942, Balanced Accuracy de 0.661, AUC de 0.901 y F1-Score de 0.668, siendo el mejor desempeño predictivo global</p>
<p>Para la clase 0 (No Popular) se presenta un Precision de 0.967, solo 3% de falsos positivos, un Recall de 0.972 donde cubre 97% de canciones no populares, al igual que un F1 de 0.969.</p>
<p>Para la clase 1 (Popular) se presenta un Precision de 0.385, identificando un 39% de predicciones positivas correctas. También un Recall de 0.350 donde detecta 35% de canciones populares reales, y un F1 de 0.367 con un mejor balance en clase minoritaria.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones:</p>
<p>Verdaderos Negativos: 21,005 (92.5%)
Falsos Positivos: 611 (2.7%)<br />
Falsos Negativos: 711 (3.1%)
Verdaderos Positivos: 383 (1.7%)</p>
<p>Ahí se evidencia que solo 611 falsos positivos mejor que todos los modelos. 711 canciones populares no detectadas y 383 de 1,094 populares reales.</p>
<p>En el Top Características Técnicas Más Influyentes se muestra:</p>
<ul class="simple">
<li><p>Instrumentalness con un 0.071</p></li>
<li><p>Acousticness con un 0.055</p></li>
<li><p>Energy con un 0.053</p></li>
<li><p>Loudness con un 0.049</p></li>
<li><p>Duration_ms con un 0.048</p></li>
</ul>
<p>Algunos patrones de Género Identificados son :</p>
<ul class="simple">
<li><p>Dance, género dominante</p></li>
<li><p>Metal</p></li>
<li><p>Electro</p></li>
<li><p>Pop</p></li>
</ul>
<p>Así, da estrategias de producción basadas en estos hallazgos, como dar un enfoque en instrumentalidad, optimizar acústica, control de energía y volumen, y duración estratégica para dar un engagement.</p>
<p>Por ello, Random Forest con SMOTE es el modelo recomendado para estrategias de producción musical basadas en datos. Su combinación de mejor desempeño predictivo global, excelente capacidad discriminativa, mínima tasa de falsos positivos, su alta interpretabilidad de características influyentes, balance óptimo entre clases mayoritaria y minoritaria ño convierte en la herramienta ideal para disqueras y artistas que buscan maximizar el impacto de sus producciones en Spotify.</p>
<p><strong>XGBoost con Hyperparameter Tuning</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaño del entrenamiento: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
        <span class="p">]),</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="p">]),</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con SMOTE</span>
<span class="n">pipeline_xgb_smote</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">],</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
    <span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;model__subsample&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
    <span class="s1">&#39;model__colsample_bytree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_xgb_smote</span><span class="p">,</span> 
    <span class="n">param_grid</span><span class="p">,</span> 
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ejecutando GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_xgb_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;XGBoost SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb_smote</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  <span class="c1"># ← Este es F1-macro</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis XGBOOST SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados XGBOOST SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - learning_rate: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - scale_pos_weight: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de características importantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del XGBoost SMOTE vs otros modelos</span>
    <span class="n">xgb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XGBoost SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">XGBoost SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">xgb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre XGBoost SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE para balancear clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - learning_rate: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - scale_pos_weight: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características con importancia &gt; 0: </span><span class="si">{</span><span class="p">(</span><span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tamaño del entrenamiento: (90840, 15)
Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Ejecutando GridSearchCV
Fitting 5 folds for each of 128 candidates, totalling 640 fits
Tiempo de entrenamiento: 790.25s
Mejores parámetros: {&#39;model__colsample_bytree&#39;: 0.9, &#39;model__learning_rate&#39;: 0.2, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 150, &#39;model__scale_pos_weight&#39;: 2, &#39;model__subsample&#39;: 0.9, &#39;smote__sampling_strategy&#39;: 0.5}
Mejor F1-score (CV): 0.6377
EVALUACIÓN COMPLETA CON evaluate_model
XGBoost SMOTE: acc=0.904, f1=0.631, time=3.01s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
Análisis XGBOOST SMOTE
Evaluación detallada:
Accuracy:            0.9042
Balanced Accuracy:   0.6915
AUC:                 0.8636
F1-score (Weighted): 0.6315
F1-score (Macro):    0.6315

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9712
Recall - No Popular:    0.9269
F1 - No Popular:        0.9485
Precision - Popular:    0.2399
Recall - Popular:       0.4561
F1 - Popular:           0.3144

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20035     1581]
     Popular   [   595      499]

Desglose:
   Verdaderos Negativos: 20035
   Falsos Positivos:     1581
   Falsos Negativos:     595
   Verdaderos Positivos: 499

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.93      0.95     21616
     Popular       0.24      0.46      0.31      1094

    accuracy                           0.90     22710
   macro avg       0.61      0.69      0.63     22710
weighted avg       0.94      0.90      0.92     22710
</pre></div>
</div>
<img alt="_images/87f24ea403cb8844001eaa1c0bcccc5ddec1520e2eab92e08842ae2e1beadaeb.png" src="_images/87f24ea403cb8844001eaa1c0bcccc5ddec1520e2eab92e08842ae2e1beadaeb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados XGBOOST SMOTE

Rendimiento general:
   - Accuracy: 0.904
   - AUC: 0.864 
   - F1-Score (Macro): 0.631 
   - Balanced Accuracy: 0.691 
   - Tiempo entrenamiento: 3.01s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.971 | Recall: 0.927 | F1: 0.948
   - CLASE 1 (Popular): 
        Precision: 0.240 | Recall: 0.456 | F1: 0.314

Hiperparámetros óptimos:
   - n_estimators: 150
   - max_depth: 6
   - learning_rate: 0.2
   - scale_pos_weight: 2
   - sampling_strategy: 0.5


Top 10 características importantes:
                         feature  importance
80        cat__track_genre_k-pop      0.0260
35        cat__track_genre_dance      0.0249
68        cat__track_genre_house      0.0244
45          cat__track_genre_edm      0.0234
46      cat__track_genre_electro      0.0228
95          cat__track_genre_pop      0.0218
83       cat__track_genre_latino      0.0217
104   cat__track_genre_reggaeton      0.0209
117  cat__track_genre_songwriter      0.0195
105        cat__track_genre_rock      0.0186
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

XGBoost SMOTE se encuentra en la posición #15 de 15 modelos

Información:
   - SMOTE para balancear clases
   - n_estimators: 150
   - max_depth: 6
   - learning_rate: 0.2
   - scale_pos_weight: 2
   - Características con importancia &gt; 0: 128
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo XGBoost con SMOTE y Hyperparameter Tuning establece un nuevo récord en el benchmark con un F1-Score macro de 0.637. El modelo logra avances críticos en la clase minoritaria, con un Recall de 0.453 para Popular (45.3% de detección). Hubo un 496 canciones populares correctamente identificadas vs 398 del modelo anterior, tiene la capacidad de identificar 98 canciones populares adicionales detectadas que antes se clasificaban incorrectamente, y un AUC de 0.863 representa una capacidad sobresaliente para distinguir entre canciones populares y no populares</p>
<p>Viendo el top 5 Géneros Influyentes podemos clasificar:</p>
<ul class="simple">
<li><p>Dance con un 2.66%, nuevo en el top</p></li>
<li><p>House con un 2.40%</p></li>
<li><p>Latino con un 2.38%, que tiene un influencia global emergente</p></li>
<li><p>K-Pop con un 2.35%, sigue siendo un fenómeno internacional</p></li>
<li><p>Reggaeton con un 2.20%, género urbano con impacto significativo</p></li>
</ul>
<p>Para los productores musicales pueden aplicar un enfoque en géneros emergentes como Dance, House, Latino o K-Pop y noo depender exclusivamente del pop.</p>
<p>Este modelo representa el estado del arte en predicción de popularidad, combinando el máximo desempeño predictivo con eficiencia computacional y insights estratégicos accionables. Su capacidad para identificar patrones complejos a través de múltiples géneros y características técnicas lo convierte en la herramienta más poderosa para disqueras y artistas que buscan maximizar su éxito en la era digital de la música.</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para SVM</span>
<span class="n">SVM_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">SVM_KERNEL</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
<span class="n">SVM_GAMMA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">SMOTE_SAMPLING</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">SMOTE_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPTIMIZACIÓN SVM CON SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para SVM con SMOTE</span>
<span class="n">svm_smote_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;smote&#39;</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">svm_smote_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SVM_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__kernel&#39;</span><span class="p">:</span> <span class="n">SVM_KERNEL</span><span class="p">,</span>
    <span class="s1">&#39;model__gamma&#39;</span><span class="p">:</span> <span class="n">SVM_GAMMA</span><span class="p">,</span>
    <span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">SMOTE_SAMPLING</span><span class="p">,</span>
    <span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">:</span> <span class="n">SMOTE_NEIGHBORS</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para SVM con SMOTE&quot;</span><span class="p">)</span>
<span class="n">svm_smote_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">svm_smote_pipeline</span><span class="p">,</span>
    <span class="n">svm_smote_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_smote</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SVM_C_VALUES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_KERNEL</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_GAMMA</span><span class="p">)</span> <span class="o">*</span> 
                  <span class="nb">len</span><span class="p">(</span><span class="n">SMOTE_SAMPLING</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SMOTE_NEIGHBORS</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones SMOTE: </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_smote</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">smote_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización SMOTE completada en </span><span class="si">{</span><span class="n">smote_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final SVM con SMOTE</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model</span>
<span class="n">result_svm_smote</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;SVM SMOTE&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_svm_smote</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MATRIZ DE RESULTADOS ACTUALIZADA&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis SVM SMOTE&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - SVM SMOTE&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - SVM SMOTE&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes para SVM lineal (si aplica)</span>
<span class="k">if</span> <span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># DataFrame con coeficientes</span>
    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Top 15 características</span>
    <span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - SVM (Coeficientes)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Kernel: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__kernel&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">No hay coeficientes</span><span class="se">\n</span><span class="s1">para kernel no lineal&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Coeficientes - No disponible para kernel no lineal&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - SVM SMOTE&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados SVM SMOTE&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_svm_smote</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos SVM:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Kernel: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Gamma: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Max iterations: 500</span>

<span class="s2">Hiperparámetros óptimos SMOTE:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - K neighbors: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Mostrar coeficientes si es kernel lineal</span>
<span class="k">if</span> <span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del SVM SMOTE vs otros modelos</span>
    <span class="n">svm_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SVM SMOTE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SVM SMOTE se encuentra en la posición #</span><span class="si">{</span><span class="n">svm_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre SVM SMOTE</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Kernel utilizado: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización C: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Gamma: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE sampling: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - SMOTE neighbors: </span><span class="si">{</span><span class="n">svm_smote_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;smote__k_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Cache size: 1000 para optimización&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
OPTIMIZACIÓN SVM CON SMOTE

Búsqueda de hiperparámetros para SVM con SMOTE
Combinaciones SMOTE: 16 × 5 folds = 80 modelos
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Optimización SMOTE completada en 2498.23s
Mejores parámetros: {&#39;model__C&#39;: 10, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;, &#39;smote__k_neighbors&#39;: 3, &#39;smote__sampling_strategy&#39;: &#39;auto&#39;}
Mejor F1-score (CV): 0.4802
SVM SMOTE: acc=0.761, f1=0.498, time=109.75s

================================================================================
MATRIZ DE RESULTADOS ACTUALIZADA
================================================================================
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
Análisis SVM SMOTE
Evaluación detallada:
Accuracy:            0.7609
Balanced Accuracy:   0.5845
AUC:                 0.6443
F1-score (Weighted): 0.4984
F1-score (Macro):    0.4984

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9619
Recall - No Popular:    0.7797
F1 - No Popular:        0.8613
Precision - Popular:    0.0821
Recall - Popular:       0.3894
F1 - Popular:           0.1356

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 16854     4762]
     Popular   [   668      426]

Desglose:
   Verdaderos Negativos: 16854
   Falsos Positivos:     4762
   Falsos Negativos:     668
   Verdaderos Positivos: 426

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.96      0.78      0.86     21616
     Popular       0.08      0.39      0.14      1094

    accuracy                           0.76     22710
   macro avg       0.52      0.58      0.50     22710
weighted avg       0.92      0.76      0.83     22710
</pre></div>
</div>
<img alt="_images/c0922fbe0100eec9b892161f90a8ea9637344f385a358bbd404296d19265a1c3.png" src="_images/c0922fbe0100eec9b892161f90a8ea9637344f385a358bbd404296d19265a1c3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados SVM SMOTE

Rendimiento general:
   - Accuracy: 0.761
   - AUC: 0.644 
   - F1-Score (Macro): 0.498 
   - Balanced Accuracy: 0.585 
   - Tiempo entrenamiento: 109.75s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.962 | Recall: 0.780 | F1: 0.861
   - CLASE 1 (Popular): 
        Precision: 0.082 | Recall: 0.389 | F1: 0.136

Hiperparámetros óptimos SVM:
   - C: 10
   - Kernel: rbf
   - Gamma: scale
   - Max iterations: 500

Hiperparámetros óptimos SMOTE:
   - Sampling strategy: auto
   - K neighbors: 3

Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

SVM SMOTE se encuentra en la posición #16 de 16 modelos

Información:
   - Kernel utilizado: rbf
   - Regularización C: 10
   - Gamma: scale
   - SMOTE sampling: auto
   - SMOTE neighbors: 3
   - Cache size: 1000 para optimización
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo SVM con SMOTE muestra un F1-Score de 0.478, AUC de 0.629, Accuracy de 0.719 y Balanced Accuracy de 0.570.</p>
<p>En la clase 0 (No Popular) hay un Precision de 0.961, Recall de 0.735 y F1 de 0.833
En la clase 1 (Popular) hay un Precision de 0.072, Recall de 0.405 y F1 de 0.122
Se muestra que solo 7% de predicciones positivas son correctas y menos de la mitad de éxitos detectados.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones</p>
<p>Verdaderos Negativos: 15,896 (70.0%)
Falsos Positivos: 5,720 (25.2%)<br />
Falsos Negativos: 651 (2.9%)<br />
Verdaderos Positivos: 443 (2.0%)</p>
<p>Muestra que 5,720 falsos positivos, siendo el 25% del dataset mal clasificado, solo 443 verdaderos positivos done captura solo 40% de éxitos reales, y 28.1% de predicciones incorrectas.</p>
<p>Esto da que no ofrece ventajas sobre modelos más simples o complejos, inefectividad con kernels no lineales en datos musicales, alto costo computacional sin beneficio predictivo y pobre escalabilidad con grandes volúmenes de datos.</p>
<p>Por lo cual, SVM con SMOTE no es recomendable para aplicaciones en la industria musical debido a su pobre desempeño predictivo, excesivo costo computacional y nula capacidad interpretativa, donde el 7% de precision en identificación de éxitos, es decir, 13 de cada 14 recomendaciones son erróneas. También, 184 segundos de entrenamiento vs 1-10 segundos de alternativas efectivas, al igual que 25% de falsos positivos que da imposibilidad de optimizar estrategias.</p>
<p>Ahora con la técnica de balanceo <strong>Adasyn</strong></p>
<p><strong>KNN</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesador </span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KNN con ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">knn_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Optimización de hiperparámetros</span>
<span class="n">knn_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="s1">&#39;model__weights&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">knn_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">knn_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">knn_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_knn_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                  <span class="s2">&quot;KNN ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_knn_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis KNN ADASYN&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - KNN ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - KNN ADASYN&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;KNN no proporciona</span><span class="se">\n</span><span class="s1">importancia de características</span><span class="se">\n\n</span><span class="s1">Parámetros óptimos:</span><span class="se">\n</span><span class="s1">&#39;</span>
         <span class="sa">f</span><span class="s1">&#39;n_neighbors: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__n_neighbors&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
         <span class="sa">f</span><span class="s1">&#39;weights: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__weights&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
         <span class="sa">f</span><span class="s1">&#39;ADASYN n_neighbors: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;adasyn__n_neighbors&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Información del Modelo - KNN ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - KNN ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados KNN ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_knn_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - n_neighbors (KNN): </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - weights: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__weights&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors (ADASYN): </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del KNN ADASYN vs otros modelos</span>
    <span class="n">knn_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;KNN ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">KNN ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">knn_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre KNN ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors KNN: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - weights: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__weights&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - sampling_strategy: </span><span class="si">{</span><span class="n">knn_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
KNN con ADASYN

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 36 candidates, totalling 180 fits
Tiempo de entrenamiento: 1385.36s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__n_neighbors&#39;: 3, &#39;model__weights&#39;: &#39;distance&#39;}
Mejor F1-score (CV): 0.6152
EVALUACIÓN COMPLETA CON evaluate_model
KNN ADASYN: acc=0.890, f1=0.635, time=1.83s
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
Análisis KNN ADASYN
Evaluación detallada:
Accuracy:            0.8900
Balanced Accuracy:   0.7344
AUC:                 0.7895
F1-score (Weighted): 0.6350
F1-score (Macro):    0.6350

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9761
Recall - No Popular:    0.9066
F1 - No Popular:        0.9401
Precision - Popular:    0.2334
Recall - Popular:       0.5622
F1 - Popular:           0.3298

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19596     2020]
     Popular   [   479      615]

Desglose:
   Verdaderos Negativos: 19596
   Falsos Positivos:     2020
   Falsos Negativos:     479
   Verdaderos Positivos: 615

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.91      0.94     21616
     Popular       0.23      0.56      0.33      1094

    accuracy                           0.89     22710
   macro avg       0.60      0.73      0.63     22710
weighted avg       0.94      0.89      0.91     22710
</pre></div>
</div>
<img alt="_images/c3590d0d34b556af95a41ff971b29f2169c6154ea4c85a6d0d5f06f6334e16ff.png" src="_images/c3590d0d34b556af95a41ff971b29f2169c6154ea4c85a6d0d5f06f6334e16ff.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados KNN ADASYN

Rendimiento general:
   - Accuracy: 0.890
   - AUC: 0.790 
   - F1-Score (Macro): 0.635 
   - Balanced Accuracy: 0.734 
   - Tiempo entrenamiento: 1.83s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.907 | F1: 0.940
   - CLASE 1 (Popular): 
        Precision: 0.233 | Recall: 0.562 | F1: 0.330

Hiperparámetros óptimos ADASYN:
   - n_neighbors (KNN): 3
   - weights: distance
   - n_neighbors (ADASYN): 3
   - sampling_strategy: 0.5

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

KNN ADASYN se encuentra en la posición #17 de 17 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - n_neighbors KNN: 3
   - weights: distance
   - n_neighbors ADASYN: 3
   - sampling_strategy: 0.5
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo KNN con ADASYN establece un nuevo récord canciones populares, logrando un recall de todos los modelos con un 55.9% de efectividad, es decir, 612 canciones populares correctamente identificadas. Así, ADASYN genera muestras enfocadas en ejemplos difíciles de aprender, superando el enfoque de SMOTE.</p>
<p>En cuanto a la Precision en Popular con 0.234, y un Accuracy general de 0.890, muestra que KNN ADASYN prioriza la captura máxima de verdaderos positivos, aceptando más falsas alarmas como costo estratégico.</p>
<p>Escenarios ideales para KNN ADASYN puede usarse en la primera fase de screening en disqueras grandes y en plataformas de descubrimiento de nuevos talentos.</p>
<p>Por lo cual, KNN con ADASYN emerge como el modelo especialista en descubrimiento máximo, su capacidad para identificar canciones populares con un 55.9% de recall lo convierte en la herramienta para disqueras que priorizan la cobertura sobre la precisión perfecta.</p>
<p><strong>Naive Bayes</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_validate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Pipeline con ADASYN</span>
<span class="n">nb_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="c1"># Optimización de hiperparámetros con ADASYN </span>
<span class="n">nb_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">nb_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">nb_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">nb_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_nb_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Naive Bayes ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_nb_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis NAIVE BAYES ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Naive Bayes ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Naive Bayes ADASYN&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Naive Bayes no proporciona</span><span class="se">\n</span><span class="s1">importancia de características</span><span class="se">\n\n</span><span class="s1">Parámetros óptimos:</span><span class="se">\n</span><span class="s1">&#39;</span>
         <span class="sa">f</span><span class="s1">&#39;var_smoothing: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__var_smoothing&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
         <span class="sa">f</span><span class="s1">&#39;ADASYN n_neighbors: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;adasyn__n_neighbors&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
         <span class="sa">f</span><span class="s1">&#39;sampling_strategy: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;adasyn__sampling_strategy&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Información del Modelo - Naive Bayes ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Naive Bayes ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados: NAIVE BAYES ADASYN&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_nb_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - var_smoothing: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span>
<span class="s2">   - n_neighbors (ADASYN): </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cmparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Naive Bayes ADASYN vs otros modelos</span>
    <span class="n">nb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Naive Bayes ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Naive Bayes ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">nb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Naive Bayes ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - var_smoothing: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__var_smoothing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - sampling_strategy: </span><span class="si">{</span><span class="n">nb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 96 candidates, totalling 480 fits
Tiempo de entrenamiento: 457.20s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 7, &#39;adasyn__sampling_strategy&#39;: &#39;auto&#39;, &#39;model__var_smoothing&#39;: np.float64(1e-06)}
Mejor F1-score (CV): 0.4546
EVALUACIÓN COMPLETA CON evaluate_model
Naive Bayes ADASYN: acc=0.611, f1=0.467, time=2.37s
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
Análisis NAIVE BAYES ADASYN
Evaluación detallada:
Accuracy:            0.6112
Balanced Accuracy:   0.7702
AUC:                 0.7874
F1-score (Weighted): 0.4671
F1-score (Macro):    0.4671

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9954
Recall - No Popular:    0.5943
F1 - No Popular:        0.7442
Precision - Popular:    0.1056
Recall - Popular:       0.9461
F1 - Popular:           0.1899

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 12846     8770]
     Popular   [    59     1035]

Desglose:
   Verdaderos Negativos: 12846
   Falsos Positivos:     8770
   Falsos Negativos:     59
   Verdaderos Positivos: 1035

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       1.00      0.59      0.74     21616
     Popular       0.11      0.95      0.19      1094

    accuracy                           0.61     22710
   macro avg       0.55      0.77      0.47     22710
weighted avg       0.95      0.61      0.72     22710
</pre></div>
</div>
<img alt="_images/cf6c427e227c95232c0803656181db2f7f3c74fa4b771cb2111cb21891456992.png" src="_images/cf6c427e227c95232c0803656181db2f7f3c74fa4b771cb2111cb21891456992.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados: NAIVE BAYES ADASYN

Rendimiento general:
   - Accuracy: 0.611
   - AUC: 0.787 
   - F1-Score (Macro): 0.467 
   - Balanced Accuracy: 0.770 
   - Tiempo entrenamiento: 2.37s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.995 | Recall: 0.594 | F1: 0.744
   - CLASE 1 (Popular): 
        Precision: 0.106 | Recall: 0.946 | F1: 0.190

Hiperparámetros óptimos ADASYN:
   - var_smoothing: 1.00e-06
   - n_neighbors (ADASYN): 7
   - sampling_strategy: auto

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
Cmparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Naive Bayes ADASYN se encuentra en la posición #18 de 18 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - var_smoothing: 1.00e-06
   - n_neighbors ADASYN: 7
   - sampling_strategy: auto
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Naive Bayes con ADASYN logra un recall del 95.1% en la clase popular, detectando 1040 de 1094 canciones populares correctamente. Presenta un Precision en Popular de un 0.105, es decir, solo 10.5% de aciertos en predicciones positivas, así, prioriza la seguridad absoluta contra pérdida de oportunidades, clasificando como “popular” cualquier canción con mínima probabilidad.</p>
<p>Para las disqueras y productores evidencia el costo de perder un hit potencial es alto, dispone de recursos para filtrar manualmente falsos positivos y, para la fase inicial de descubrimiento, es más crítica que la eficiencia.</p>
<p>Por lo cual, Naive Bayes con ADASYN representa el especialista en cobertura máxima. Su capacidad para detectar el 95% de las canciones populares lo convierte en la herramienta para scenarios donde perder oportunidades es inaceptable. Para disqueras que operan en entornos de alta incertidumbre y valor potencial ilimitado, el modelo ofrece seguridad contra algún tipo de error.</p>
<p><strong>Regresión Logística L1 y L2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESIÓN LOGÍSTICA CON ADASYN - L1 Y L2&quot;</span><span class="p">)</span>
<span class="c1"># Configuración para ambos modelos</span>
<span class="n">techniques_to_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADASYN&#39;</span><span class="p">]</span>
<span class="n">results_lr_adasyn</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESIÓN LOGÍSTICA L1 CON ADASYN&quot;</span><span class="p">)</span>

<span class="n">l1_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> 
                               <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">l1_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">l1_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">l1_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">l1_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L1</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">l1_training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L1: </span><span class="si">{</span><span class="n">l1_training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L1: </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L1 (CV): </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L1</span>
<span class="n">final_model_l1</span> <span class="o">=</span> <span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación L1 con ADASYN&quot;</span><span class="p">)</span>
<span class="n">result_l1_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l1</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Logistic Regression L1 ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l1_adasyn</span><span class="p">)</span>
<span class="n">results_lr_adasyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l1_adasyn</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESIÓN LOGÍSTICA L2 CON ADASYN&quot;</span><span class="p">)</span>

<span class="n">l2_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">l2_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">l2_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">l2_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">l2_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1">#  5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L2</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">l2_training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L2: </span><span class="si">{</span><span class="n">l2_training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L2: </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L2 (CV): </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L2</span>
<span class="n">final_model_l2</span> <span class="o">=</span> <span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluación L2 con ADASYN&quot;</span><span class="p">)</span>
<span class="n">result_l2_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l2</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Logistic Regression L2 ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l2_adasyn</span><span class="p">)</span>
<span class="n">results_lr_adasyn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l2_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis comparativo - L1 vs L2 CON ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones de ambos modelos</span>
<span class="n">y_pred_l1</span> <span class="o">=</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l1</span> <span class="o">=</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>
<span class="n">y_pred_l2</span> <span class="o">=</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l2</span> <span class="o">=</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Extraer probabilidades de clase positiva correctamente</span>
<span class="k">if</span> <span class="n">y_pred_proba_l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred_proba_l1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_l1_pos</span> <span class="o">=</span> <span class="n">y_pred_proba_l1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_l1_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">y_pred_proba_l2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred_proba_l2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">y_pred_proba_l2_pos</span> <span class="o">=</span> <span class="n">y_pred_proba_l2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_pred_proba_l2_pos</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Métricas </span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">):</span>
    <span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;balanced_acc&#39;</span><span class="p">:</span> <span class="n">balanced_acc</span><span class="p">,</span>
        <span class="s1">&#39;precision_0&#39;</span><span class="p">:</span> <span class="n">precision_0</span><span class="p">,</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_0&#39;</span><span class="p">:</span> <span class="n">recall_0</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_0&#39;</span><span class="p">:</span> <span class="n">f1_0</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">f1_macro</span>
    <span class="p">}</span>

<span class="n">metrics_l1</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l1</span><span class="p">,</span> <span class="n">y_pred_proba_l1_pos</span><span class="p">)</span>
<span class="n">metrics_l2</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l2</span><span class="p">,</span> <span class="n">y_pred_proba_l2_pos</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPARACIÓN DETALLADA:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L1 ADASYN:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1-Macro: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Balanced Acc: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L2 ADASYN:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1-Macro: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Balanced Acc: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ANÁLISIS DE SELECCIÓN DE CARACTERÍSTICAS - L1&quot;</span><span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef_l1</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes L1</span>
<span class="n">coef_df_l1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef_l1</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Análisis de sparsity L1</span>
<span class="n">n_zero_coef_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef_l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_nonzero_coef_l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_zero_coef_l1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características con coeficiente cero (L1): </span><span class="si">{</span><span class="n">n_zero_coef_l1</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas (L1): </span><span class="si">{</span><span class="n">n_nonzero_coef_l1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_nonzero_coef_l1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes (L1):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curvas ROC comparativas</span>
<span class="k">if</span> <span class="n">y_pred_proba_l1_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_pred_proba_l2_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l1_pos</span><span class="p">)</span>  <span class="c1"># ← Ahora es 1D</span>
    <span class="n">roc_auc_l1</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">)</span>
    <span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l2_pos</span><span class="p">)</span>  <span class="c1"># ← Ahora es 1D</span>
    <span class="n">roc_auc_l2</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L1 ADASYN (AUC = </span><span class="si">{</span><span class="n">roc_auc_l1</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L2 ADASYN (AUC = </span><span class="si">{</span><span class="n">roc_auc_l2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC Comparativas - L1 vs L2 con ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Métricas comparativas</span>
<span class="n">metrics_comparison</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Macro&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">,</span> <span class="s1">&#39;Balanced Acc&#39;</span><span class="p">]</span>
<span class="n">l1_values</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">l2_values</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;balanced_acc&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_comparison</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l1_values</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L1 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l2_values</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L2 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Globales Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">metrics_comparison</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Coeficientes L1 </span>
<span class="n">top_features_l1</span> <span class="o">=</span> <span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - L1 ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase comparativas</span>
<span class="n">metrics_class_l1</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>
<span class="n">metrics_class_l2</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>

<span class="n">x_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width_class</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_class</span> <span class="o">-</span> <span class="n">width_class</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_l1</span><span class="p">,</span> <span class="n">width_class</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L1 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_class</span> <span class="o">+</span> <span class="n">width_class</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_l2</span><span class="p">,</span> <span class="n">width_class</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L2 ADASYN&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Clase Popular (1) Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_class</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final REGRESIÓN LOGÍSTICA CON ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># el mejor modelo</span>
<span class="k">if</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]:</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="s2">&quot;Logistic Regression L1 ADASYN&quot;</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="s2">&quot;Logistic Regression L2 ADASYN&quot;</span> 
    <span class="n">best_f1</span> <span class="o">=</span> <span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">best_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">COMPARACIÓN L1 vs L2:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L1 ADASYN - F1-Macro: </span><span class="si">{</span><span class="n">result_l1_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Características: </span><span class="si">{</span><span class="n">n_nonzero_coef_l1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L2 ADASYN - F1-Macro: </span><span class="si">{</span><span class="n">result_l2_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Todas las características utilizadas&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">HIPERPARÁMETROS ÓPTIMOS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L1 - C: </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Sampling: </span><span class="si">{</span><span class="n">l1_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   L2 - C: </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Sampling: </span><span class="si">{</span><span class="n">l2_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre todos los modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre todos los modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo global</span>
    <span class="n">best_model_global</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>REGRESIÓN LOGÍSTICA CON ADASYN - L1 Y L2
Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
REGRESIÓN LOGÍSTICA L1 CON ADASYN
Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 12 candidates, totalling 60 fits
Tiempo de entrenamiento L1: 214.85s
Mejores parámetros L1: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None}
Mejor F1-score L1 (CV): 0.6095

Evaluación L1 con ADASYN
Logistic Regression L1 ADASYN: acc=0.856, f1=0.600, time=2.90s
REGRESIÓN LOGÍSTICA L2 CON ADASYN
Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 12 candidates, totalling 60 fits
Tiempo de entrenamiento L2: 91.09s
Mejores parámetros L2: {&#39;adasyn__n_neighbors&#39;: 5, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None}
Mejor F1-score L2 (CV): 0.6070

Evaluación L2 con ADASYN
Logistic Regression L2 ADASYN: acc=0.857, f1=0.600, time=3.37s
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
Análisis comparativo - L1 vs L2 CON ADASYN
COMPARACIÓN DETALLADA:

L1 ADASYN:
   Accuracy: 0.8558 | F1-Macro: 0.6000
   AUC: 0.8455 | Balanced Acc: 0.7260
   Clase 1 - Precision: 0.1844, Recall: 0.5823, F1: 0.2801

L2 ADASYN:
   Accuracy: 0.8570 | F1-Macro: 0.6004
   AUC: 0.8535 | Balanced Acc: 0.7244
   Clase 1 - Precision: 0.1849, Recall: 0.5777, F1: 0.2801
ANÁLISIS DE SELECCIÓN DE CARACTERÍSTICAS - L1
Características con coeficiente cero (L1): 50 de 129
Características retenidas (L1): 79 (61.2%)

Top 10 características más importantes (L1):
                        feature    coef
95         cat__track_genre_pop  2.9679
86       cat__track_genre_metal  2.5520
46     cat__track_genre_electro  2.4200
68       cat__track_genre_house  2.3323
35       cat__track_genre_dance  2.2187
71       cat__track_genre_indie  2.1942
80       cat__track_genre_k-pop  2.1937
105       cat__track_genre_rock  2.1830
62   cat__track_genre_hard-rock  2.0522
45         cat__track_genre_edm  2.0209
</pre></div>
</div>
<img alt="_images/c3e7160e9650aabbed53b72ce92fc822d643caa36e22024d7872b8f19f4652f4.png" src="_images/c3e7160e9650aabbed53b72ce92fc822d643caa36e22024d7872b8f19f4652f4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen final REGRESIÓN LOGÍSTICA CON ADASYN
Mejor modelo: Logistic Regression L2 ADASYN
   F1-Score (Macro): 0.6004

COMPARACIÓN L1 vs L2:
   L1 ADASYN - F1-Macro: 0.6000, Características: 79/129
   L2 ADASYN - F1-Macro: 0.6004, Todas las características utilizadas

HIPERPARÁMETROS ÓPTIMOS:
   L1 - C: 0.01, Sampling: 0.5
   L2 - C: 0.01, Sampling: 0.5
Matriz final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
Comparación entre todos los modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019
</pre></div>
</div>
</div>
</div>
<p>Analizando las Regresiones Logísticas con ADASYN muestran el punto óptimo entre transparencia y capacidad predictiva, logrando un F1-Score de aprox. 0.600 con coeficientes interpretables.</p>
<p>Comparando L1 vs L2, L2 con ADASYN lidera con un F1-Score de 0.6005 y un AUC de 0.8535, dando una excelente capacidad discriminativa. L1 con ADASYN sería un seleccionador eficiente pero no mejora el desempeño en este caso.</p>
<p>En el top 5 Géneros Más Influyentes con L1 se encuentran:</p>
<ul class="simple">
<li><p>Pop con 2.9536, lider</p></li>
<li><p>Metal con 2.5607</p></li>
<li><p>Electro con 2.4366</p></li>
<li><p>House con 2.3209</p></li>
<li><p>Dance con 2.2267</p></li>
</ul>
<p>Se ve un comportamiento donde cada unidad de aumento en la probabilidad del género pop aumenta 2.95 veces de ser popular.</p>
<p>Para los roductores musicales se puede aprender un enfoque cuantificable pues el Pop aporta 2.95x, Metal 2.56x y Electro 2.44x.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de parámetros</span>
<span class="n">REDUCED_ALPHAS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
<span class="n">REDUCED_SOLVERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;svd&#39;</span><span class="p">]</span>
<span class="n">REDUCED_SAMPLING</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">REDUCED_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">ridge_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">ridge_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">REDUCED_SAMPLING</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">REDUCED_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__alpha&#39;</span><span class="p">:</span> <span class="n">REDUCED_ALPHAS</span><span class="p">,</span>
    <span class="s1">&#39;model__solver&#39;</span><span class="p">:</span> <span class="n">REDUCED_SOLVERS</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">ridge_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">ridge_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">ridge_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_ridge_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="s2">&quot;Ridge Classifier ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_ridge_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RIDGE CLASSIFIER ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># RidgeClassifier no tiene AUC por defecto</span>
<span class="n">auc_value</span> <span class="o">=</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;No disponible&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">auc_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;RidgeClassifier no proporciona</span><span class="se">\n</span><span class="s1">probabilidades por defecto</span><span class="se">\n\n</span><span class="s1">Usar CalibratedClassifierCV</span><span class="se">\n</span><span class="s1">para obtener curva ROC&#39;</span><span class="p">,</span> 
         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible para RidgeClassifier&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Ridge Classifier ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo (ANÁLISIS ESPECÍFICO DE RIDGE)</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Ridge Classifier ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RIDGE CLASSIFIER ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">auc_value</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_ridge_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - Alpha: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Solver: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Ridge Classifier ADASYN vs otros modelos</span>
    <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Ridge Classifier ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L2 (Ridge) para evitar overfitting&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Alpha óptimo: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Solver: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">ridge_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - No proporciona probabilidades (AUC no disponible)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 32 candidates, totalling 160 fits
Tiempo de entrenamiento: 237.59s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 5, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__alpha&#39;: 10.0, &#39;model__solver&#39;: &#39;auto&#39;}
Mejor F1-score (CV): 0.5919
EVALUACIÓN COMPLETA CON evaluate_model
Ridge Classifier ADASYN: acc=0.828, f1=0.587, time=2.27s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
Análisis RIDGE CLASSIFIER ADASYN
Evaluación detallada:
Accuracy:            0.8280
Balanced Accuracy:   0.7499
AUC:                 No disponible
F1-score (Weighted): 0.5867
F1-score (Macro):    0.5867

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9800
Recall - No Popular:    0.8363
F1 - No Popular:        0.9025
Precision - Popular:    0.1702
Recall - Popular:       0.6636
F1 - Popular:           0.2709

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18077     3539]
     Popular   [   368      726]

Desglose:
   Verdaderos Negativos: 18077
   Falsos Positivos:     3539
   Falsos Negativos:     368
   Verdaderos Positivos: 726

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.84      0.90     21616
     Popular       0.17      0.66      0.27      1094

    accuracy                           0.83     22710
   macro avg       0.58      0.75      0.59     22710
weighted avg       0.94      0.83      0.87     22710
</pre></div>
</div>
<img alt="_images/34fe7307b396d18e301413393c1a85f97baa1195328cdec76abaed84258131f4.png" src="_images/34fe7307b396d18e301413393c1a85f97baa1195328cdec76abaed84258131f4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RIDGE CLASSIFIER ADASYN

Rendimiento general:
   - Accuracy: 0.828
   - AUC: No disponible 
   - F1-Score (Macro): 0.587 
   - Balanced Accuracy: 0.750 
   - Tiempo entrenamiento: 2.27s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.980 | Recall: 0.836 | F1: 0.902
   - CLASE 1 (Popular): 
        Precision: 0.170 | Recall: 0.664 | F1: 0.271

Hiperparámetros óptimos ADASYN:
   - Alpha: 10.0
   - Solver: auto
   - Sampling strategy: 0.5
   - n_neighbors: 5


Top 10 características importantes:
                 feature    coef
0       num__duration_ms -0.0014
1      num__danceability -0.0014
2            num__energy -0.0014
3               num__key -0.0014
4          num__loudness -0.0014
5              num__mode -0.0014
6       num__speechiness -0.0014
7      num__acousticness -0.0014
8  num__instrumentalness -0.0014
9          num__liveness -0.0014
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Ridge Classifier ADASYN se encuentra en la posición #21 de 21 modelos

Información:
   - Regularización L2 (Ridge) para evitar overfitting
   - ADASYN para balanceo adaptativo de clases
   - Alpha óptimo: 10.0
   - Solver: auto
   - Sampling strategy: 0.5
   - No proporciona probabilidades (AUC no disponible)
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Ridge Classifier con ADASYN muestra un recall del 67.2% en la clase popular con regularización fuerte, teniendo un alpha de 10.0. Identifica 735 canciones populares correctamente identificadas.</p>
<p>En el Top 5 Coeficientes se muestra:</p>
<ul class="simple">
<li><p>Pop con 1.1823</p></li>
<li><p>Metal con 1.0262</p></li>
<li><p>Electro con 1.0192</p></li>
<li><p>House con 0.9894</p></li>
<li><p>Dance con 0.9785</p></li>
</ul>
<p>Escenarios ideales en las producciones musicales usando Ridge ADASYN se puede utilizar en la primera fase de screening en disqueras grandes. Aunque no lidera en métricas puras, su enfoque práctico y robustez lo posicionan como solución valiosa para disqueras que procesan grandes volúmenes de contenido y priorizan la cobertura exhaustiva sobre la precisión perfecta.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Configuración de hiperparámetros</span>
<span class="n">LASSO_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span> 
<span class="n">LASSO_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span> 
<span class="n">LASSO_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración Lasso con ADASYN:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Valores de C: </span><span class="si">{</span><span class="n">LASSO_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vecinos: </span><span class="si">{</span><span class="n">LASSO_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">lasso_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda</span>
<span class="n">lasso_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">LASSO_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">LASSO_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">lasso_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lasso_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">lasso_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_C_VALUES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_lasso_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="s2">&quot;Lasso ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de selección de características LASSO&quot;</span><span class="p">)</span>

<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span><span class="p">,</span>
    <span class="s1">&#39;abs_coef&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;abs_coef&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Análisis de sparsity Lasso</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_nonzero_coef</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_zero_coef</span>
<span class="n">sparsity_ratio</span> <span class="o">=</span> <span class="n">n_zero_coef</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características con coeficiente cero: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity ratio: </span><span class="si">{</span><span class="n">sparsity_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sparsity_ratio</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% eliminadas)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes:&quot;</span><span class="p">)</span>
<span class="n">top_10</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_10</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">influence</span> <span class="o">=</span> <span class="s2">&quot;POSITIVA&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;NEGATIVA&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">influence</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes Lasso </span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>

<span class="s2">Selección de características Lasso:</span>
<span class="s2">   - Características retenidas: </span><span class="si">{</span><span class="n">n_nonzero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span>
<span class="s2">   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)</span>
<span class="s2">   - Sparsity ratio: </span><span class="si">{</span><span class="n">sparsity_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso ADASYN vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - C óptimo: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">lasso_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Configuración Lasso con ADASYN:
   Valores de C: [0.001, 0.01, 0.1, 1.0]
   Estrategias: [0.5, &#39;auto&#39;]
   Vecinos: [3, 5]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones ADASYN: 16 × 5 folds = 80 modelos
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Tiempo de entrenamiento: 252.99s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__C&#39;: 0.01, &#39;model__class_weight&#39;: None}
Mejor F1-score (CV): 0.6095
EVALUACIÓN COMPLETA CON evaluate_model
Lasso ADASYN: acc=0.856, f1=0.600, time=2.85s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
Análisis LASSO ADASYN
Evaluación detallada:
Accuracy:            0.8558
Balanced Accuracy:   0.7260
AUC:                 0.8455
F1-score (Weighted): 0.6000
F1-score (Macro):    0.6000

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9763
Recall - No Popular:    0.8697
F1 - No Popular:        0.9199
Precision - Popular:    0.1844
Recall - Popular:       0.5823
F1 - Popular:           0.2801

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 18799     2817]
     Popular   [   457      637]

Desglose:
   Verdaderos Negativos: 18799
   Falsos Positivos:     2817
   Falsos Negativos:     457
   Verdaderos Positivos: 637

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.87      0.92     21616
     Popular       0.18      0.58      0.28      1094

    accuracy                           0.86     22710
   macro avg       0.58      0.73      0.60     22710
weighted avg       0.94      0.86      0.89     22710

Análisis de selección de características LASSO
Características con coeficiente cero: 50 de 129
Características retenidas: 79 (61.2%)
Sparsity ratio: 0.388 (38.8% eliminadas)

Top 10 características más importantes:
   cat__track_genre_pop: 2.9679 (POSITIVA)
   cat__track_genre_metal: 2.5520 (POSITIVA)
   cat__track_genre_electro: 2.4200 (POSITIVA)
   cat__track_genre_house: 2.3323 (POSITIVA)
   cat__track_genre_dance: 2.2187 (POSITIVA)
   cat__track_genre_indie: 2.1942 (POSITIVA)
   cat__track_genre_k-pop: 2.1937 (POSITIVA)
   cat__track_genre_rock: 2.1830 (POSITIVA)
   cat__track_genre_hard-rock: 2.0522 (POSITIVA)
   cat__track_genre_edm: 2.0209 (POSITIVA)
</pre></div>
</div>
<img alt="_images/d5b11e7446ce976eb6c36ffbbaa43d473fbb1c4f610bf20b801bfd50279a813d.png" src="_images/d5b11e7446ce976eb6c36ffbbaa43d473fbb1c4f610bf20b801bfd50279a813d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis LASSO ADASYN

Rendimiento general:
   - Accuracy: 0.856
   - AUC: 0.845 
   - F1-Score (Macro): 0.600 
   - Balanced Accuracy: 0.726 
   - Tiempo entrenamiento: 2.85s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.976 | Recall: 0.870 | F1: 0.920
   - CLASE 1 (Popular): 
        Precision: 0.184 | Recall: 0.582 | F1: 0.280

Hiperparámetros óptimos ADASYN:
   - C: 0.01
   - Sampling strategy: 0.5
   - n_neighbors: 3

Selección de características Lasso:
   - Características retenidas: 79 de 129
   - Características eliminadas: 50 (38.8%)
   - Sparsity ratio: 0.388

Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Lasso ADASYN se encuentra en la posición #22 de 22 modelos

Información:
   - Regularización L1 (Lasso) para selección de características
   - ADASYN para balanceo adaptativo de clases
   - Características eliminadas: 50 de 129 (38.8%)
   - C óptimo: 0.01
   - Sampling strategy: 0.5
   - n_neighbors ADASYN: 3
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo Lasso con ADASYN logra un F1-Score de 0.600 mientras elimina 41.1% de las características, con un  Recall de 0.580 para Popular, 635 canciones populares detectadas y 76 características vs 129 originales.</p>
<p>En el análisis de coeficientes Lasso revela el ranking:</p>
<ul class="simple">
<li><p>Pop con 2.9536 lider</p></li>
<li><p>Metal con 2.5607</p></li>
<li><p>Electro con 2.4366</p></li>
<li><p>House: 2.3209</p></li>
<li><p>Dance: 2.2267</p></li>
</ul>
<p>Cada unidad de aumento en género pop multiplica por 2.95 de ser popular.</p>
<p>Por lo cual, Lasso con ADASYN emerge como el modelo para decisiones estratégicas basadas en transparencia pues combina el desempeño competitivo con selección automática de características y coeficientes completamente interpretables lo convierte en la herramienta para disqueras que priorizan la comprensión sobre ganancias.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_decision_tree</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">technique_name</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluando: </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># pipeline</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span> 
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas </span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="c1"># Análisis de overfitting </span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;named_steps&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;get_depth&#39;</span><span class="p">):</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train Time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Profundidad del árbol: </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;technique&#39;</span><span class="p">:</span> <span class="n">technique_name</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;precision_0&#39;</span><span class="p">:</span> <span class="n">precision_0</span><span class="p">,</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_0&#39;</span><span class="p">:</span> <span class="n">recall_0</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_0&#39;</span><span class="p">:</span> <span class="n">f1_0</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="p">,</span>
        <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;y_pred_proba&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span><span class="p">,</span>
        <span class="s1">&#39;tree_depth&#39;</span><span class="p">:</span> <span class="n">depth</span>
    <span class="p">}</span>

<span class="c1"># Hiperparámetros reducidos</span>
<span class="n">DT_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  
<span class="n">DT_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>  
<span class="n">DT_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>  
<span class="n">DT_CRITERION</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>
<span class="n">DT_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">DT_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Max Depth: </span><span class="si">{</span><span class="n">DT_MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Min Samples Split: </span><span class="si">{</span><span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Min Samples Leaf: </span><span class="si">{</span><span class="n">DT_MIN_SAMPLES_LEAF</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Criterion: </span><span class="si">{</span><span class="n">DT_CRITERION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">dt_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">dt_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">DT_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">DT_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">DT_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">,</span>
    <span class="s1">&#39;model__criterion&#39;</span><span class="p">:</span> <span class="n">DT_CRITERION</span>
<span class="p">}</span>

<span class="n">dt_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">dt_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">dt_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 3 folds</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DT_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">DT_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_CRITERION</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 3 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dt_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">adasyn_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización ADASYN completada en </span><span class="si">{</span><span class="n">adasyn_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mejores parámetros: </span><span class="si">{</span><span class="n">dt_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">dt_adasyn_best</span> <span class="o">=</span> <span class="n">dt_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">results_dt_adasyn</span> <span class="o">=</span> <span class="n">evaluate_decision_tree</span><span class="p">(</span><span class="n">dt_adasyn_best</span><span class="p">,</span> <span class="s2">&quot;Árbol + ADASYN&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="c1"># resultados</span>
<span class="n">dt_all_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">results_dt_adasyn</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">techniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dt_all_results</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;lightblue&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">metrics_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_1&#39;</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_to_plot</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">technique</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">techniques</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt_all_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_to_plot</span><span class="p">]</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">technique</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Árbol de Decisión - Métricas de Rendimiento&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Profundidad de árbol</span>
<span class="n">depths</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;tree_depth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;tree_depth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dt_all_results</span><span class="p">]</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">techniques</span><span class="p">,</span> <span class="n">depths</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Profundidad del Árbol&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Complejidad del Modelo - Profundidad&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol + &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">techniques</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">depths</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1">#Tiempos de entrenamiento</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dt_all_results</span><span class="p">]</span>
<span class="n">bars</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">techniques</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tiempo (segundos)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tiempos de Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol + &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Árbol &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">techniques</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">time_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_val</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Curva ROC comparativas</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clasificador Aleatorio&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dt_all_results</span><span class="p">):</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;y_pred_proba&#39;</span><span class="p">])</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC - Comparativa Árbol de Decisión&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">best_technique_dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dt_all_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Profundidad: </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;tree_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión </span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión - </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="n">best_pipeline_dt</span> <span class="o">=</span> <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;pipeline&#39;</span><span class="p">]</span>
<span class="n">y_pred_best</span> <span class="o">=</span> <span class="n">best_pipeline_dt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">best_pipeline_dt</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Árbol de Decisión - </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s2">&quot;technique&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_class_0</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;precision_0&#39;</span><span class="p">],</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;recall_0&#39;</span><span class="p">],</span> 
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;f1_0&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">metrics_class_1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span>
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> 
    <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_class_1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Mejor Técnica&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Análisis - </span><span class="si">{</span><span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

<span class="n">best_pipeline</span> <span class="o">=</span> <span class="n">best_technique_dt</span><span class="p">[</span><span class="s1">&#39;pipeline&#39;</span><span class="p">]</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
    
    <span class="c1"># DataFrame con importancias</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes:&quot;</span><span class="p">)</span>
    <span class="n">top_10</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_10</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Características menos importantes:&quot;</span><span class="p">)</span>
    <span class="n">bottom_5</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bottom_5</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configuración
   Max Depth: [5, 10, 15, None]
   Min Samples Split: [10, 20, 50]
   Min Samples Leaf: [5, 10, 20]
   Criterion: [&#39;gini&#39;, &#39;entropy&#39;]
Combinaciones ADASYN: 288 × 3 folds = 864 modelos
Fitting 3 folds for each of 288 candidates, totalling 864 fits
Optimización ADASYN completada en 1404.32s
   Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 5, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__criterion&#39;: &#39;entropy&#39;, &#39;model__max_depth&#39;: 10, &#39;model__min_samples_leaf&#39;: 20, &#39;model__min_samples_split&#39;: 10}

Evaluando: Árbol + ADASYN
Resultados Árbol + ADASYN:
   Train Time: 4.83s
   Accuracy: 0.9313 | F1-Weighted: 0.9287
   AUC: 0.7190
   Clase 1 - Precision: 0.2495, Recall: 0.2121, F1: 0.2292
   Profundidad del árbol: 10
</pre></div>
</div>
<img alt="_images/7448a304b36b387080e3ada5696222938f004f5c8338c842999f89aea4a9890b.png" src="_images/7448a304b36b387080e3ada5696222938f004f5c8338c842999f89aea4a9890b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados: Árbol + ADASYN
   F1-Score: 0.9287
   Recall Clase 1: 0.2121
   AUC: 0.7190
   Tiempo: 4.83s
   Profundidad: 10

Matriz de confusión - Árbol + ADASYN:
</pre></div>
</div>
<img alt="_images/302bd7f5fda9811c63c1540bb9aa42b23dde09fa32b30deff44a06e2e54c2440.png" src="_images/302bd7f5fda9811c63c1540bb9aa42b23dde09fa32b30deff44a06e2e54c2440.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis - Árbol + ADASYN:

Top 10 características más importantes:
   num__instrumentalness: 0.2468
   cat__track_genre_pop: 0.1030
   num__acousticness: 0.0852
   cat__track_genre_metal: 0.0707
   cat__track_genre_electro: 0.0637
   num__energy: 0.0599
   cat__track_genre_dance: 0.0533
   cat__track_genre_house: 0.0495
   cat__track_genre_indie: 0.0462
   cat__track_genre_k-pop: 0.0301

Características menos importantes:
   cat__track_genre_techno: 0.0000
   cat__track_genre_trance: 0.0000
   cat__track_genre_trip-hop: 0.0000
   cat__track_genre_turkish: 0.0000
   cat__track_genre_world-music: 0.0000
</pre></div>
</div>
</div>
</div>
<p>En el Árbol de Decisión con ADASYN muestra una profundidad máxima de solo 5 niveles y un recall muy bajo de 12.5% para la clase popular, indicando sobre-regularización del modelo.</p>
<p>La combinación ADASYN y el criterio de parada produce un árbol excesivamente simple que no logra capturar la complejidad de los patrones de popularidad, dando métricas engañosas con un Accuracy de 93.7%, un F1-Weighted de 92.9%, dando un buen desempeño en clase mayoritaria, y F1 Clase Popular con 16.1%, mostrando solo 137 canciones populares detectadas de 1094.</p>
<p>En el top de características más importantes está:</p>
<ul class="simple">
<li><p>Instrumentalness con 26.6%, factor dominante en decisiones del árbol</p></li>
<li><p>Género Pop con 19.8%</p></li>
<li><p>Acousticness con 12.7%</p></li>
<li><p>Energy con 10.3%</p></li>
</ul>
<p>Para la industria musical pudiera ser un riesgo el 86% de canciones potencialmente populares no detectadas, dandon pérdida masiva de oportunidades de negocio.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Hiperparámetros reducidos </span>
<span class="n">RF_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>           
<span class="n">RF_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>         
<span class="n">RF_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>       
<span class="n">RF_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>         
<span class="n">RF_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span> 
<span class="n">RF_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>                    

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">RF_N_ESTIMATORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">RF_MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   min_samples_split: </span><span class="si">{</span><span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   min_samples_leaf: </span><span class="si">{</span><span class="n">RF_MIN_SAMPLES_LEAF</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">RF_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vecinos: </span><span class="si">{</span><span class="n">RF_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline</span>
<span class="n">rf_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">rf_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">RF_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">RF_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">RF_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">RF_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_LEAF</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="c1"># GridSearchCV con F1-macro</span>
<span class="n">rf_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">rf_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">rf_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RF_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">RF_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_LEAF</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">adasyn_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización ADASYN completada en </span><span class="si">{</span><span class="n">adasyn_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_rf_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                 <span class="s2">&quot;Random Forest ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz actualizada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RANDOM FOREST ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Random Forest ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Random Forest ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RANDOM FOREST ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - sampling_strategy: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de características importantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest ADASYN vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ensemble de árboles para robustez&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - sampling_strategy: </span><span class="si">{</span><span class="n">rf_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configuración
   n_estimators: [50, 100]
   max_depth: [10, 15, None]
   min_samples_split: [10, 20]
   min_samples_leaf: [5, 10]
   Estrategias: [0.5, &#39;auto&#39;]
   Vecinos: [3]
Combinaciones ADASYN: 48 × 5 folds = 240 modelos
Fitting 5 folds for each of 48 candidates, totalling 240 fits
Optimización ADASYN completada en 1591.11s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: &#39;auto&#39;, &#39;model__class_weight&#39;: None, &#39;model__max_depth&#39;: None, &#39;model__min_samples_leaf&#39;: 5, &#39;model__min_samples_split&#39;: 10, &#39;model__n_estimators&#39;: 100}
Mejor F1-score (CV): 0.6604
EVALUACIÓN COMPLETA CON evaluate_model
Random Forest ADASYN: acc=0.928, f1=0.664, time=19.69s
Matriz actualizada:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
Análisis RANDOM FOREST ADASYN
Evaluación detallada:
Accuracy:            0.9284
Balanced Accuracy:   0.6916
AUC:                 0.8908
F1-score (Weighted): 0.6641
F1-score (Macro):    0.6641

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9706
Recall - No Popular:    0.9536
F1 - No Popular:        0.9620
Precision - Popular:    0.3191
Recall - Popular:       0.4296
F1 - Popular:           0.3662

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20613     1003]
     Popular   [   624      470]

Desglose:
   Verdaderos Negativos: 20613
   Falsos Positivos:     1003
   Falsos Negativos:     624
   Verdaderos Positivos: 470

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.95      0.96     21616
     Popular       0.32      0.43      0.37      1094

    accuracy                           0.93     22710
   macro avg       0.64      0.69      0.66     22710
weighted avg       0.94      0.93      0.93     22710
</pre></div>
</div>
<img alt="_images/c7a88b556f3db4cac048cd1d36c70261d81f0c8ef7ecff86577820fcbf8e6659.png" src="_images/c7a88b556f3db4cac048cd1d36c70261d81f0c8ef7ecff86577820fcbf8e6659.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RANDOM FOREST ADASYN

Rendimiento general:
   - Accuracy: 0.928
   - AUC: 0.891 
   - F1-Score (Macro): 0.664 
   - Balanced Accuracy: 0.692 
   - Tiempo entrenamiento: 19.69s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.971 | Recall: 0.954 | F1: 0.962
   - CLASE 1 (Popular): 
        Precision: 0.319 | Recall: 0.430 | F1: 0.366

Hiperparámetros óptimos ADASYN:
   - n_estimators: 100
   - max_depth: None
   - min_samples_split: 10
   - min_samples_leaf: 5
   - sampling_strategy: auto
   - n_neighbors: 3


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.0883
7       num__acousticness      0.0566
2             num__energy      0.0545
0        num__duration_ms      0.0483
4           num__loudness      0.0465
9           num__liveness      0.0438
3                num__key      0.0396
95   cat__track_genre_pop      0.0384
10           num__valence      0.0377
1       num__danceability      0.0374
Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Random Forest ADASYN se encuentra en la posición #23 de 23 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - Ensemble de árboles para robustez
   - n_estimators: 100
   - max_depth: None
   - sampling_strategy: auto
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Random Forest tiene un F1-Score de 0.661, un AUC de 0.891, Accuracy de 92.8% y un Recall Popular de 42.4% sin sacrificar precisión. Hubo 464 canciones populares detectadas, 630 falsos negativos dando un buen control de oportunidades perdidas, y 1013 falsos positivos con un manejo razonable de falsas alarmas.</p>
<p>En el top 5 Características Más Influyentes se muestra:</p>
<ul class="simple">
<li><p>Instrumentalness con un 8.2%, factor crítico</p></li>
<li><p>Energy con un 5.5%</p></li>
<li><p>Acousticness con un 5.5%</p></li>
<li><p>Duration_ms con un 4.9%</p></li>
<li><p>Loudness con un 4.8%, importante en la mezcla</p></li>
</ul>
<p>Para los productores musicales se puede dar un enfoque en características técnicas como Instrumentalness, Energy o Acousticness. Y para las disqueras se les da un 42% de efectividad en identificar hits y menos falsos negativos.</p>
<p>Así, Random Forest con ADASYN como el modelo definitivo para la industria musical moderna. Su combinación de balanceo y potencia de ensemble produce el mejor desempeño predictivo general, aunque requiere mayor inversión computacional. Su capacidad para identificar patrones complejos de popularidad lo convierte en la herramienta para disqueras.</p>
<p><strong>XGBOOST</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test         - Clase 0: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Clase 1: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_test</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros optimizados </span>
<span class="n">XGB_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>          
<span class="n">XGB_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>                
<span class="n">XGB_LEARNING_RATE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>        
<span class="n">XGB_SUBSAMPLE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>             
<span class="n">XGB_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>
<span class="n">XGB_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>                   

<span class="n">scale_pos_weight_value</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scale_pos_weight calculado: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">XGB_N_ESTIMATORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">XGB_MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   learning_rate: </span><span class="si">{</span><span class="n">XGB_LEARNING_RATE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   subsample: </span><span class="si">{</span><span class="n">XGB_SUBSAMPLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   scale_pos_weight: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Estrategias: </span><span class="si">{</span><span class="n">XGB_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline con ADASYN</span>
<span class="n">xgb_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">xgb_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">XGB_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">XGB_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">XGB_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">XGB_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="n">XGB_LEARNING_RATE</span><span class="p">,</span>
    <span class="s1">&#39;model__subsample&#39;</span><span class="p">:</span> <span class="n">XGB_SUBSAMPLE</span><span class="p">,</span>
    <span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">xgb_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">xgb_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">xgb_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XGB_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">XGB_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">XGB_LEARNING_RATE</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_SUBSAMPLE</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_xgb_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                  <span class="s2">&quot;XGBoost ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis XGBOOST ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados XGBOOST ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - learning_rate: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - subsample: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__subsample&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de características importantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del XGBoost ADASYN vs otros modelos</span>
    <span class="n">xgb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XGBoost ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">XGBoost ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">xgb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre XGBoost ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">xgb_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases:
   Entrenamiento - Clase 0: 86466 | Clase 1: 4374
   Test         - Clase 0: 21616 | Clase 1: 1094
scale_pos_weight calculado: 19.77
Configuración:
   n_estimators: [50, 100]
   max_depth: [3, 6]
   learning_rate: [0.1, 0.01]
   subsample: [0.8, 1.0]
   scale_pos_weight: 19.77
   Estrategias: [0.5, &#39;auto&#39;]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones ADASYN: 32 × 5 folds = 160 modelos
Fitting 5 folds for each of 32 candidates, totalling 160 fits
Tiempo de entrenamiento: 308.90s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: 0.5, &#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 100, &#39;model__scale_pos_weight&#39;: 1, &#39;model__subsample&#39;: 0.8}
Mejor F1-score (CV): 0.6255
EVALUACIÓN COMPLETA CON evaluate_model
XGBoost ADASYN: acc=0.934, f1=0.621, time=4.26s
Matriz resultante:
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
Análisis XGBOOST ADASYN
Evaluación detallada:
Accuracy:            0.9343
Balanced Accuracy:   0.6145
AUC:                 0.8210
F1-score (Weighted): 0.6211
F1-score (Macro):    0.6211

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9628
Recall - No Popular:    0.9684
F1 - No Popular:        0.9656
Precision - Popular:    0.2947
Recall - Popular:       0.2605
F1 - Popular:           0.2766

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20934      682]
     Popular   [   809      285]

Desglose:
   Verdaderos Negativos: 20934
   Falsos Positivos:     682
   Falsos Negativos:     809
   Verdaderos Positivos: 285

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.96      0.97      0.97     21616
     Popular       0.29      0.26      0.28      1094

    accuracy                           0.93     22710
   macro avg       0.63      0.61      0.62     22710
weighted avg       0.93      0.93      0.93     22710
</pre></div>
</div>
<img alt="_images/1817569c195d96c85022c752ab67c630f5d51da85ad6af4f5ef229f31eb1d9d9.png" src="_images/1817569c195d96c85022c752ab67c630f5d51da85ad6af4f5ef229f31eb1d9d9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados XGBOOST ADASYN

Rendimiento general:
   - Accuracy: 0.934
   - AUC: 0.821 
   - F1-Score (Macro): 0.621 
   - Balanced Accuracy: 0.614 
   - Tiempo entrenamiento: 4.26s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.963 | Recall: 0.968 | F1: 0.966
   - CLASE 1 (Popular): 
        Precision: 0.295 | Recall: 0.261 | F1: 0.277

Hiperparámetros óptimos ADASYN:
   - Sampling strategy: 0.5
   - n_neighbors: 3
   - n_estimators: 100
   - max_depth: 6
   - learning_rate: 0.1
   - subsample: 0.8


Top 10 características importantes:
                        feature  importance
68       cat__track_genre_house      0.0262
14           cat__explicit_True      0.0236
46     cat__track_genre_electro      0.0229
35       cat__track_genre_dance      0.0226
80       cat__track_genre_k-pop      0.0219
45         cat__track_genre_edm      0.0219
104  cat__track_genre_reggaeton      0.0218
83      cat__track_genre_latino      0.0211
71       cat__track_genre_indie      0.0207
23       cat__track_genre_blues      0.0196
Resumen final
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

XGBoost ADASYN se encuentra en la posición #24 de 24 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - Sampling strategy: 0.5
   - n_neighbors ADASYN: 3
   - n_estimators: 100
   - max_depth: 6
</pre></div>
</div>
</div>
</div>
<p>El modelo XGBoost con ADASYN logra un F1-Score macro de 0.617 y AUC-ROC de 0.812, demostró ser efectivo para manejar el desbalance extremo inicial. Teniendo un Accuracy de 0.895 y un Balanced Accuracy de 0.682 refleja mejor el desempeño real</p>
<p>Para la clase 0 (No Popular) se tiene un Precision de 0.970, es decir, casi no hay falsos positivos, un Recall de 0.918, dando un buen cubrimiento de canciones no populares, y un F1 de 0.943 siendo un desempeño casi perfecto.</p>
<p>Para la clase 1 (Popular) se tiene un Precision de 0.216, identificando solo un 22% de predicciones positivas son correctas, al igual que un Recall de 0.446, detectando un 45% de canciones populares reales, y un F1 de 0.291 siendo un punto crítico de mejora.</p>
<p>En la Matriz de Confusión se ven los siguientes patrones:
Verdaderos Negativos: 19,843 (87.4%)
Falsos Positivos: 1,773 (7.8%)
Falsos Negativos: 606 (2.7%)
Verdaderos Positivos: 488 (2.1%)</p>
<p>Vemos que 1,773 canciones predichas como populares que no lo fueron, 606 canciones populares no detectadas, siendo oportunidades perdidas, y 488 de 1,094 populares reales (44.6%).</p>
<p>En cuanto al Top de Características se muestran los géneros clave del éxito:</p>
<ul class="simple">
<li><p>Dance con 0.0238</p></li>
<li><p>Electro con 0.0212</p></li>
<li><p>House con 0.0208</p></li>
<li><p>EDM con 0.0207</p></li>
</ul>
<p>En géneros con potencial están:</p>
<ul class="simple">
<li><p>K-Pop con 0.0187</p></li>
<li><p>Reggaeton con 0.0178</p></li>
<li><p>Explicit Content con 0.0214</p></li>
</ul>
<p>Y géneros de poco impacto:</p>
<ul class="simple">
<li><p>Songwriter con 0.0196</p></li>
<li><p>Folk con 0.0173</p></li>
<li><p>Dancehall con 0.0167</p></li>
</ul>
<p>Por lo cual, XGBoost con ADASYN capta estrategias de producción musical basadas, combinando un buen desempeño predictivo, eficiencia computacional y claridad interpretativa para identificar géneros con mayor potencial de éxito, optimizar asignación de recursos de producción, desarrollar estrategias de artistas basadas en datos y anticipar tendencias del mercado musical</p>
<p>También muestra la dominancia de los géneros electrónicos mientras revela oportunidades en fenómenos globales como K-Pop y Reggaeton, proporcionando un mapa estratégico claro para disqueras y artistas que buscan maximizar su impacto en Spotify.</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span> <span class="k">as</span> <span class="n">ImbPipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="c1"># Definir características </span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo </span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># Subconjunto balanceado para entrenamiento más rápido</span>
<span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># 25%</span>
    <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Usando subconjunto balanceado: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_balanced</span><span class="p">)</span><span class="si">}</span><span class="s2"> instancias&quot;</span><span class="p">)</span>

<span class="c1"># Configuración</span>
<span class="n">SVM_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>           <span class="c1"># 3 valores de C</span>
<span class="n">SVM_KERNEL</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">]</span>        <span class="c1"># 2 kernels</span>
<span class="n">SVM_GAMMA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>                 <span class="c1"># 1 gamma para RBF</span>
<span class="n">SVM_SAMPLING_STRATEGIES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>  <span class="c1"># 2 estrategias</span>
<span class="n">SVM_NEIGHBORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>                <span class="c1"># 2 valores de vecinos</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   C: </span><span class="si">{</span><span class="n">SVM_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   kernel: </span><span class="si">{</span><span class="n">SVM_KERNEL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   gamma: </span><span class="si">{</span><span class="n">SVM_GAMMA</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   sampling_strategy: </span><span class="si">{</span><span class="n">SVM_SAMPLING_STRATEGIES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   neighbors: </span><span class="si">{</span><span class="n">SVM_NEIGHBORS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para SVM con ADASYN</span>
<span class="n">svm_adasyn_pipeline</span> <span class="o">=</span> <span class="n">ImbPipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;adasyn&#39;</span><span class="p">,</span> <span class="n">ADASYN</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para búsqueda </span>
<span class="n">svm_adasyn_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">:</span> <span class="n">SVM_SAMPLING_STRATEGIES</span><span class="p">,</span>
    <span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">:</span> <span class="n">SVM_NEIGHBORS</span><span class="p">,</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SVM_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__kernel&#39;</span><span class="p">:</span> <span class="n">SVM_KERNEL</span><span class="p">,</span>
    <span class="s1">&#39;model__gamma&#39;</span><span class="p">:</span> <span class="n">SVM_GAMMA</span><span class="p">,</span>
    <span class="s1">&#39;model__class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">svm_adasyn_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">svm_adasyn_pipeline</span><span class="p">,</span>
    <span class="n">svm_adasyn_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_adasyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_SAMPLING_STRATEGIES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_NEIGHBORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_C_VALUES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_KERNEL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones ADASYN: </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_adasyn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_balanced</span><span class="p">,</span> <span class="n">y_train_balanced</span><span class="p">)</span>
<span class="n">adasyn_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ADASYN completado en </span><span class="si">{</span><span class="n">adasyn_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>

<span class="n">result_svm_adasyn</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                  <span class="s2">&quot;SVM ADASYN&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_svm_adasyn</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis SVM ADASYN&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - SVM ADASYN&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - SVM ADASYN&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes para SVM lineal</span>
<span class="k">if</span> <span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># DataFrame con coeficientes</span>
    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Top 15 características</span>
    <span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - SVM ADASYN (Coeficientes)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Kernel </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__kernel&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">No hay coeficientes lineales&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Coeficientes - No disponible para kernel no lineal&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - SVM ADASYN&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados SVM ADASYN&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_svm_adasyn</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos ADASYN:</span>
<span class="s2">   - Kernel: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Gamma: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Sampling strategy: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - n_neighbors: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del SVM ADASYN vs otros modelos</span>
    <span class="n">svm_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SVM ADASYN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SVM ADASYN se encuentra en la posición #</span><span class="si">{</span><span class="n">svm_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre SVM ADASYN</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - ADASYN para balanceo adaptativo de clases&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Kernel: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización C: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Sampling strategy: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__sampling_strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_neighbors ADASYN: </span><span class="si">{</span><span class="n">svm_adasyn_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;adasyn__n_neighbors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Usando subconjunto balanceado: 22710 instancias
Configuración:
   C: [0.1, 1, 10]
   kernel: [&#39;linear&#39;, &#39;rbf&#39;]
   gamma: [&#39;scale&#39;]
   sampling_strategy: [0.5, &#39;auto&#39;]
   neighbors: [3, 5]

Búsqueda de hiperparámetros con GridSearchCV
Combinaciones ADASYN: 24 × 5 folds = 120 modelos
Fitting 5 folds for each of 24 candidates, totalling 120 fits
ADASYN completado en 757.64s
Mejores parámetros: {&#39;adasyn__n_neighbors&#39;: 3, &#39;adasyn__sampling_strategy&#39;: &#39;auto&#39;, &#39;model__C&#39;: 10, &#39;model__class_weight&#39;: None, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;}
Mejor F1-score (CV): 0.5095
EVALUACIÓN COMPLETA CON evaluate_model
SVM ADASYN: acc=0.668, f1=0.464, time=151.04s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
Análisis SVM ADASYN
Evaluación detallada:
Accuracy:            0.6675
Balanced Accuracy:   0.6023
AUC:                 0.6538
F1-score (Weighted): 0.4638
F1-score (Macro):    0.4638

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9659
Recall - No Popular:    0.6745
F1 - No Popular:        0.7943
Precision - Popular:    0.0762
Recall - Popular:       0.5302
F1 - Popular:           0.1332

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 14580     7036]
     Popular   [   514      580]

Desglose:
   Verdaderos Negativos: 14580
   Falsos Positivos:     7036
   Falsos Negativos:     514
   Verdaderos Positivos: 580

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.67      0.79     21616
     Popular       0.08      0.53      0.13      1094

    accuracy                           0.67     22710
   macro avg       0.52      0.60      0.46     22710
weighted avg       0.92      0.67      0.76     22710
</pre></div>
</div>
<img alt="_images/79bdac63e0325875bd9977d55dbb5a95fcf95329bef83a875f9dcf88bf580ba4.png" src="_images/79bdac63e0325875bd9977d55dbb5a95fcf95329bef83a875f9dcf88bf580ba4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados SVM ADASYN

Rendimiento general:
   - Accuracy: 0.668
   - AUC: 0.654 
   - F1-Score (Macro): 0.464 
   - Balanced Accuracy: 0.602 
   - Tiempo entrenamiento: 151.04s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.966 | Recall: 0.675 | F1: 0.794
   - CLASE 1 (Popular): 
        Precision: 0.076 | Recall: 0.530 | F1: 0.133

Hiperparámetros óptimos ADASYN:
   - Kernel: rbf
   - C: 10
   - Gamma: scale
   - Sampling strategy: auto
   - n_neighbors: 3

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

SVM ADASYN se encuentra en la posición #25 de 25 modelos

Información:
   - ADASYN para balanceo adaptativo de clases
   - Kernel: rbf
   - Regularización C: 10
   - Sampling strategy: auto
   - n_neighbors ADASYN: 3
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo SVM con ADASYN muestra un F1-Score macro de 0.480 y AUC-ROC de 0.655, dando un desempeño inferior a otros. Teniendo un Accuracy de 0.710, una cifra baja debido a mala clasificación de ambas clases, al igual que un Balanced Accuracy de 0.594, indicando una dificultad para equilibrar predicciones, y un AUC de 0.655 dando una capacidad discriminativa apenas superior al azar.</p>
<p>Para la clase 0 (No Popular) hay un Precision de 0.964, dando pocos falsos positivos, y un Recall de 0.723, donde 28% de canciones no populares mal clasificadas.</p>
<p>Para la clase 1 (Popular) hay un Precision de 0.078 donde solo 8% de predicciones positivas son correctas, también un Recall de 0.464, donde se detecta un 46% de canciones populares reales. Y un F1 de 0.134, el peor entre todos los modelos.</p>
<p>En la matriz de Confusión se muestran los siguientes patrones:</p>
<p>Verdaderos Negativos: 15,624 (68.8%)
Falsos Positivos: 5,992 (26.4%)<br />
Falsos Negativos: 586 (2.6%)
Verdaderos Positivos: 508 (2.2%)</p>
<p>Esto muestra que 5,992 falsos positivos, es decir, un 26% del dataset está mal clasificado como popular.</p>
<p>En la Curva ROC el AUC de 0.655 indica una pobre separación entre clases populares y no populares, e incapacidad para establecer umbrales efectivos.</p>
<p>Algunas limitaciones puede ser que dado un Precision de 8% en clase popular hace inviable su uso práctico, la alta tasa de falsos positivos generaría recomendaciones erróneas, por lo cual, no se pueden identificar géneros o características influyentes junto con un alto costo computacional.</p>
<p>Por lo tanto, SVM con ADASYN no es recomendable para estrategias de producción musical debido a su pobre desempeño predictivo, alta complejidad computacional y nula capacidad interpretativa.</p>
<p>Ahora analizamos con la métrica <strong>Class Weight</strong></p>
<p><strong>Regresión Logística L1 y L2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPTIMIZACIÓN L1 CON CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para L1 con class_weight</span>
<span class="n">pipeline_l1</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> 
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para L1</span>
<span class="n">params_l1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para L1&quot;</span><span class="p">)</span>
<span class="n">grid_l1</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_l1</span><span class="p">,</span>
    <span class="n">params_l1</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L1</span>
<span class="n">start_time_l1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_l1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time_l1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_l1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L1: </span><span class="si">{</span><span class="n">training_time_l1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L1: </span><span class="si">{</span><span class="n">grid_l1</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L1 (CV): </span><span class="si">{</span><span class="n">grid_l1</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L1</span>
<span class="n">final_model_l1</span> <span class="o">=</span> <span class="n">grid_l1</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">result_l1_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l1</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;L1 Regression Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l1_classweight</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPTIMIZACIÓN L2 CON CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para L2 con class_weight</span>
<span class="n">pipeline_l2</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> 
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Hiperparámetros para L2</span>
<span class="n">params_l2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para L2&quot;</span><span class="p">)</span>
<span class="n">grid_l2</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipeline_l2</span><span class="p">,</span>
    <span class="n">params_l2</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros L2</span>
<span class="n">start_time_l2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_l2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time_l2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time_l2</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento L2: </span><span class="si">{</span><span class="n">training_time_l2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros L2: </span><span class="si">{</span><span class="n">grid_l2</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score L2 (CV): </span><span class="si">{</span><span class="n">grid_l2</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final L2</span>
<span class="n">final_model_l2</span> <span class="o">=</span> <span class="n">grid_l2</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">result_l2_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model_l2</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;L2 Regression Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_l2_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis L1 vs L2 CON CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones de ambos modelos</span>
<span class="n">y_pred_l1</span> <span class="o">=</span> <span class="n">result_l1_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l1</span> <span class="o">=</span> <span class="n">result_l1_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>
<span class="n">y_pred_l2</span> <span class="o">=</span> <span class="n">result_l2_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba_l2</span> <span class="o">=</span> <span class="n">result_l2_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_detailed_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
    <span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">:</span> <span class="n">balanced_acc</span><span class="p">,</span>
        <span class="s1">&#39;precision_0&#39;</span><span class="p">:</span> <span class="n">precision_0</span><span class="p">,</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_0&#39;</span><span class="p">:</span> <span class="n">recall_0</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_0&#39;</span><span class="p">:</span> <span class="n">f1_0</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">f1_macro</span>
    <span class="p">}</span>

<span class="n">metrics_l1</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l1</span><span class="p">,</span> <span class="n">y_pred_proba_l1</span><span class="p">,</span> <span class="s2">&quot;L1 Class Weight&quot;</span><span class="p">)</span>
<span class="n">metrics_l2</span> <span class="o">=</span> <span class="n">get_detailed_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_l2</span><span class="p">,</span> <span class="n">y_pred_proba_l2</span><span class="p">,</span> <span class="s2">&quot;L2 Class Weight&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L1 Regression Class Weight:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1 Clase 1:       </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1:   </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Balanced Acc:     </span><span class="si">{</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L2 Regression Class Weight:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1 Clase 1:       </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1:   </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Balanced Acc:     </span><span class="si">{</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Determinar el mejor modelo</span>
<span class="k">if</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]:</span>
    <span class="n">best_model_name</span> <span class="o">=</span> <span class="s2">&quot;L1 Regression Class Weight&quot;</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">final_model_l1</span>
    <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">metrics_l1</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">best_model_name</span> <span class="o">=</span> <span class="s2">&quot;L2 Regression Class Weight&quot;</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">final_model_l2</span>
    <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">metrics_l2</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (Macro): </span><span class="si">{</span><span class="n">best_metrics</span><span class="p">[</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curvas ROC comparativas</span>
<span class="k">if</span> <span class="n">y_pred_proba_l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_pred_proba_l2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_l2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">roc_auc_l1</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">)</span>
    <span class="n">roc_auc_l2</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l1</span><span class="p">,</span> <span class="n">tpr_l1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L1 (AUC = </span><span class="si">{</span><span class="n">roc_auc_l1</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_l2</span><span class="p">,</span> <span class="n">tpr_l2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;L2 (AUC = </span><span class="si">{</span><span class="n">roc_auc_l2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC - L1 vs L2 con Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase comparativas</span>
<span class="n">metrics_l1_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l1</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>
<span class="n">metrics_l2_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;precision_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span> <span class="n">metrics_l2</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_l1_data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L1 Class Weight&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_l2_data</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;L2 Class Weight&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas Clase Popular - L1 vs L2&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Coeficientes L1 </span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef_l1</span> <span class="o">=</span> <span class="n">final_model_l1</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">coef_df_l1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef_l1</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_features_l1</span> <span class="o">=</span> <span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features_l1</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Características - L1 (Selección)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Coeficientes L2 </span>
<span class="n">coef_l2</span> <span class="o">=</span> <span class="n">final_model_l2</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">coef_df_l2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef_l2</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">top_features_l2</span> <span class="o">=</span> <span class="n">coef_df_l2</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features_l2</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features_l2</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Características - L2 (Todas)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis de selección de características L1&quot;</span><span class="p">)</span>


<span class="n">n_zero_coef_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef_l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características con coeficiente cero en L1: </span><span class="si">{</span><span class="n">n_zero_coef_l1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Características retenidas en L1: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_zero_coef_l1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Porcentaje eliminado por L1: </span><span class="si">{</span><span class="n">n_zero_coef_l1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coef_l1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características más importantes (L1):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df_l1</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre todos los modelos</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre todos los modelos&quot;</span><span class="p">)</span>
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo global</span>
    <span class="n">best_model_global</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model_global</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
OPTIMIZACIÓN L1 CON CLASS WEIGHT

Búsqueda de hiperparámetros para L1
Fitting 5 folds for each of 4 candidates, totalling 20 fits
Tiempo de entrenamiento L1: 105.76s
Mejores parámetros L1: {&#39;model__C&#39;: 0.01}
Mejor F1-score L1 (CV): 0.5662
L1 Regression Class Weight: acc=0.787, f1=0.565, time=0.54s
OPTIMIZACIÓN L2 CON CLASS WEIGHT

Búsqueda de hiperparámetros para L2
Fitting 5 folds for each of 4 candidates, totalling 20 fits
Tiempo de entrenamiento L2: 10.81s
Mejores parámetros L2: {&#39;model__C&#39;: 0.01}
Mejor F1-score L2 (CV): 0.5478
L2 Regression Class Weight: acc=0.760, f1=0.551, time=0.85s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
25  0.8431      0.5433  
26  0.8535      0.8531  
Análisis L1 vs L2 CON CLASS WEIGHT
Comparación:

L1 Regression Class Weight:
   F1-Score (Macro): 0.5647
   F1 Clase 1:       0.2539
   Recall Clase 1:   0.7532
   Balanced Acc:     0.7708

L2 Regression Class Weight:
   F1-Score (Macro): 0.5511
   F1 Clase 1:       0.2452
   Recall Clase 1:   0.8108
   Balanced Acc:     0.7839

Mejor modelo: L1 Regression Class Weight
   F1-Score (Macro): 0.5647
</pre></div>
</div>
<img alt="_images/7298a7782851afe2a1ef91fa43671556a5aa9418f7f7b1657fd918a2af41373b.png" src="_images/7298a7782851afe2a1ef91fa43671556a5aa9418f7f7b1657fd918a2af41373b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis de selección de características L1
Características con coeficiente cero en L1: 57
Características retenidas en L1: 72
Porcentaje eliminado por L1: 44.2%

Top 10 características más importantes (L1):
                          feature    coef
95           cat__track_genre_pop  2.5602
86         cat__track_genre_metal  2.1763
46       cat__track_genre_electro  2.1023
71         cat__track_genre_indie  2.0621
80         cat__track_genre_k-pop  2.0544
35         cat__track_genre_dance  2.0190
105         cat__track_genre_rock  1.9871
68         cat__track_genre_house  1.9686
17      cat__track_genre_alt-rock  1.8159
18   cat__track_genre_alternative  1.8141
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
Comparación entre todos los modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019
</pre></div>
</div>
</div>
</div>
<p>Analizando los modelos L1 y L2 con Class Weight combinan una regularización para selección de características con balanceo de clases logrando un F1-Score de 0.565, AUC de 0.843 y Accuracy de 0.787 en L1, y F1-Score de 0.551, AUC de 0.854 y Accuracy de 0.760 en L2, dando que el mejor modelo es L1 por superioridad en F1-Score.</p>
<p>En las métricas por clase para L1 se ve en la clase 0 (No Popular) un Precision de 0.944, un Recall de 0.787 y un F1 de 0.859. Y en la clase 1 (Popular) un Precision de 0.191, Recall de 0.753 y un F1 de 0.254, dando un buen equilibrio entre clases.</p>
<p>En el Top Características Identificadas por L1 se muestran los siguientes géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con 2.569</p></li>
<li><p>Metal con 2.176, influencia del rock pesado</p></li>
<li><p>Electro con 2.102</p></li>
<li><p>Indie con 2.062</p></li>
<li><p>K-Pop con 2.054</p></li>
<li><p>Dance con 2.019</p></li>
<li><p>Rock con 1.987</p></li>
<li><p>House con 1.969</p></li>
<li><p>Alt-Rock con 1.816</p></li>
<li><p>Alternative con 1.814</p></li>
</ul>
<p>En la Matriz de Confusión se muestra un alto recall en clase popular donde detecta la mayoría de canciones exitosas, al igual que una baja precision con muchas falsas alarmas, por lo que el modelo da una alerta temprana donde es mejor tener falsos positivos que perder oportunidades reales.</p>
<p>Por lo cual, Regresión Logística L1 con Class Weight da la solución óptima para aplicaciones que priorizan la detección temprana sobre la precision exacta, también un recall del 75% en detección de canciones populares y simplicidad operativa para implementación en producción.</p>
<p><strong>Ridge Classifier</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Calcular class weights</span>
<span class="n">class_weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span>
    <span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
    <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>

<span class="c1"># Usar con sample_weight</span>
<span class="n">class_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">weight</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_weights</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class weights calculados: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Proporción de clases: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Custom Ridge Classifier con class weights</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RidgeClassifierWithWeights</span><span class="p">(</span><span class="n">RidgeClassifier</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># usar los pesos calculados</span>
        <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">class_idx</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">class_weight_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sample_weight</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="n">class_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

<span class="c1"># Pipeline principal</span>
<span class="n">pipe_ridge</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RidgeClassifierWithWeights</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Optimización de hiperparámetros </span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
    <span class="s1">&#39;model__solver&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;svd&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesky&#39;</span><span class="p">,</span> <span class="s1">&#39;lsqr&#39;</span><span class="p">,</span> <span class="s1">&#39;sparse_cg&#39;</span><span class="p">,</span> <span class="s1">&#39;sag&#39;</span><span class="p">,</span> <span class="s1">&#39;saga&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros con GridSearchCV&quot;</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_ridge</span><span class="p">,</span> 
    <span class="n">param_grid</span><span class="p">,</span> 
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span> 
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Búsqueda de hiperparámetros</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo de entrenamiento: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUACIÓN COMPLETA CON evaluate_model&quot;</span><span class="p">)</span>
<span class="n">result_ridge_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                         <span class="s2">&quot;Ridge Classifier Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_ridge_classweight</span><span class="p">)</span>

<span class="c1"># DataFrame con los resultados</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RIDGE CLASSIFIER CLASS WEIGHT&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="n">auc_value</span> <span class="o">=</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">auc_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;AUC:                 No disponible&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;RidgeClassifier no proporciona</span><span class="se">\n</span><span class="s1">probabilidades por defecto</span><span class="se">\n\n</span><span class="s1">Class weights aplicados:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> 
         <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Clase </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">class_weight_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span> 
         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ridge Classifier con Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Ridge Classifier Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Ridge Classifier&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Ridge Classifier Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados RIDGE CLASSIFIER CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="s1">&#39;No disponible&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_ridge_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - Alpha: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Solver: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Class weights: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Resumen de coeficientes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;   AUC:      No disponible&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Ridge Classifier Class Weight vs otros modelos</span>
    <span class="n">ridge_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ridge Classifier Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ridge Classifier Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">ridge_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Ridge Classifier Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Custom implementation con class weights&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Alpha óptimo: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__alpha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Solver: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__solver&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weights aplicados: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Class weights calculados: {0: np.float64(0.5252931788217334), 1: np.float64(10.3840877914952)}
   Proporción de clases: [0.95184941 0.04815059]

Búsqueda de hiperparámetros con GridSearchCV
Fitting 5 folds for each of 42 candidates, totalling 210 fits
Tiempo de entrenamiento: 142.90s
Mejores parámetros: {&#39;model__alpha&#39;: 100.0, &#39;model__solver&#39;: &#39;lsqr&#39;}
Mejor F1-score (CV): 0.5425
EVALUACIÓN COMPLETA CON evaluate_model
Ridge Classifier Class Weight: acc=0.744, f1=0.543, time=0.64s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
27    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
25  0.8431      0.5433  
26  0.8535      0.8531  
27     NaN      0.6373  
Análisis RIDGE CLASSIFIER CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.7440
Balanced Accuracy:   0.7891
AUC:                 No disponible
F1-score (Weighted): 0.5430
F1-score (Macro):    0.5430

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9891
Recall - No Popular:    0.7392
F1 - No Popular:        0.8461
Precision - Popular:    0.1400
Recall - Popular:       0.8391
F1 - Popular:           0.2400

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 15978     5638]
     Popular   [   176      918]

Desglose:
   Verdaderos Negativos: 15978
   Falsos Positivos:     5638
   Falsos Negativos:     176
   Verdaderos Positivos: 918

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.99      0.74      0.85     21616
     Popular       0.14      0.84      0.24      1094

    accuracy                           0.74     22710
   macro avg       0.56      0.79      0.54     22710
weighted avg       0.95      0.74      0.82     22710
</pre></div>
</div>
<img alt="_images/97bb4655d527e417cf747d5fe7b2be4f5a62a1dd588bf1d5d74cc5415456c7dd.png" src="_images/97bb4655d527e417cf747d5fe7b2be4f5a62a1dd588bf1d5d74cc5415456c7dd.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados RIDGE CLASSIFIER CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.744
   - AUC: No disponible 
   - F1-Score (Macro): 0.543 
   - Balanced Accuracy: 0.789 
   - Tiempo entrenamiento: 0.64s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.989 | Recall: 0.739 | F1: 0.846
   - CLASE 1 (Popular): 
        Precision: 0.140 | Recall: 0.839 | F1: 0.240

Hiperparámetros óptimos:
   - Alpha: 100.0
   - Solver: lsqr
   - Class weights: {0: np.float64(0.5252931788217334), 1: np.float64(10.3840877914952)}


Top 10 características importantes:
                 feature    coef
0       num__duration_ms  0.0008
1      num__danceability  0.0008
2            num__energy  0.0008
3               num__key  0.0008
4          num__loudness  0.0008
5              num__mode  0.0008
6       num__speechiness  0.0008
7      num__acousticness  0.0008
8  num__instrumentalness  0.0008
9          num__liveness  0.0008
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Ridge Classifier Class Weight se encuentra en la posición #28 de 28 modelos

Información:
   - Custom implementation con class weights
   - Alpha óptimo: 100.0
   - Solver: lsqr
   - Class weights aplicados: {0: np.float64(0.5252931788217334), 1: np.float64(10.3840877914952)}
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Ridge Classifier con Class Weight implementa una estrategia de regularización L2 combinada con balanceo agresivo de clases, logrando un F1-Score de 0.543 y un alpha de 100.0 con alta regularización</p>
<p>En la clase 0 (No Popular) da un Precision de 0.989, Recall de 0.739 y F1 de 0.846.
En la clase 1 (Popular) da un Precision de 0.140, Recall de 0.839 y F1 de 0.240.</p>
<p>En recall del 84% en clase popular es el más alto de todos los modelos, un Precision bajo del 14%, dando así un alto costo en falsos positivos</p>
<p>En la Matriz de Confusión se muestra el siguiente comportamiento</p>
<p>Verdaderos Negativos: 15,978 (70.4%)
Falsos Positivos: 5,638 (24.8%)<br />
Falsos Negativos: 176 (0.8%)<br />
Verdaderos Positivos: 918 (4.0%)</p>
<p>Esto muestra que solo 176 falsos negativos, es decir, prácticamente no se pierden canciones populares, 5,638 falsos positivos y 918 de 1,094 populares reales.</p>
<p>En el Top de Características se muestran los siguientes patrones de géneros más influyentes:</p>
<ul class="simple">
<li><p>Pop con 1.011</p></li>
<li><p>Metal con 0.909</p></li>
<li><p>Electro con 0.891</p></li>
<li><p>K-Pop con 0.884</p></li>
<li><p>Indie con 0.881</p></li>
<li><p>Dance con 0.877</p></li>
<li><p>Rock con 0.876</p></li>
<li><p>House con 0.862</p></li>
<li><p>Alternative con 0.809</p></li>
<li><p>Alt-Rock con 0.808</p></li>
</ul>
<p>Esto muestra que enfocarse en géneros como Pop, Metal, Electro, K-Pop confirmados puede desarrollar estrategias cross-género.</p>
<p>Así, Ridge Classifier con Class Weight es la solución óptima para aplicaciones que priorizan la cobertura máxima sobre la precision exacta con el recall del 84% para no perder oportunidades.</p>
<p><strong>Lasso</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir valores de C para Lasso</span>
<span class="n">LASSO_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

<span class="c1"># Pipeline para Lasso con class_weight</span>
<span class="n">lasso_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span> 
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">lasso_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">LASSO_C_VALUES</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para Lasso con Class Weight&quot;</span><span class="p">)</span>
<span class="n">lasso_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">lasso_classweight_pipeline</span><span class="p">,</span>
    <span class="n">lasso_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LASSO_C_VALUES</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final Lasso con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="n">result_lasso_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                         <span class="s2">&quot;Lasso Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_lasso_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis LASSO CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Lasso Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Lasso Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes del modelo</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># DataFrame con coeficientes</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Lasso Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Lasso Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados LASSO CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Contar características con coeficiente cero</span>
<span class="n">n_zero_coef</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">n_total_coef</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_lasso_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Penalty: L1 (Lasso)</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Selección de características:</span>
<span class="s2">   - Características con coeficiente cero: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span>
<span class="s2">   - Características retenidas: </span><span class="si">{</span><span class="n">n_total_coef</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_zero_coef</span><span class="si">}</span>
<span class="s2">   - Porcentaje de características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="n">n_total_coef</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Lasso Class Weight vs otros modelos</span>
    <span class="n">lasso_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Lasso Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lasso Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">lasso_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Lasso Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización L1 (Lasso) para selección de características&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características eliminadas: </span><span class="si">{</span><span class="n">n_zero_coef</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_total_coef</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_zero_coef</span><span class="o">/</span><span class="n">n_total_coef</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hiperparámetro C óptimo: </span><span class="si">{</span><span class="n">lasso_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros para Lasso con Class Weight
Combinaciones Class Weight: 6 × 5 folds = 30 modelos
Fitting 5 folds for each of 6 candidates, totalling 30 fits
Optimización Class Weight completada en 250.16s
Mejores parámetros: {&#39;model__C&#39;: 0.01}
Mejor F1-score (CV): 0.5662
Lasso Class Weight: acc=0.787, f1=0.565, time=0.62s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
27    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
28               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
25  0.8431      0.5433  
26  0.8535      0.8531  
27     NaN      0.6373  
28  0.8431      0.6202  
Análisis LASSO CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.7867
Balanced Accuracy:   0.7708
AUC:                 0.8431
F1-score (Weighted): 0.5647
F1-score (Macro):    0.5647

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9844
Recall - No Popular:    0.7884
F1 - No Popular:        0.8756
Precision - Popular:    0.1527
Recall - Popular:       0.7532
F1 - Popular:           0.2539

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 17043     4573]
     Popular   [   270      824]

Desglose:
   Verdaderos Negativos: 17043
   Falsos Positivos:     4573
   Falsos Negativos:     270
   Verdaderos Positivos: 824

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.79      0.88     21616
     Popular       0.15      0.75      0.25      1094

    accuracy                           0.79     22710
   macro avg       0.57      0.77      0.56     22710
weighted avg       0.94      0.79      0.85     22710
</pre></div>
</div>
<img alt="_images/ff0652ee511954a2cd045d7d914d35c2fcd3764ba25b13160a66c78edc2ec080.png" src="_images/ff0652ee511954a2cd045d7d914d35c2fcd3764ba25b13160a66c78edc2ec080.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados LASSO CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.787
   - AUC: 0.843 
   - F1-Score (Macro): 0.565 
   - Balanced Accuracy: 0.771 
   - Tiempo entrenamiento: 0.62s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.984 | Recall: 0.788 | F1: 0.876
   - CLASE 1 (Popular): 
        Precision: 0.153 | Recall: 0.753 | F1: 0.254

Hiperparámetros óptimos:
   - C: 0.01
   - Penalty: L1 (Lasso)
   - Class weight: balanced

Selección de características:
   - Características con coeficiente cero: 57
   - Características retenidas: 72
   - Porcentaje de características eliminadas: 44.2%


Top 10 características importantes:
                          feature    coef
95           cat__track_genre_pop  2.5602
86         cat__track_genre_metal  2.1763
46       cat__track_genre_electro  2.1023
71         cat__track_genre_indie  2.0621
80         cat__track_genre_k-pop  2.0544
35         cat__track_genre_dance  2.0190
105         cat__track_genre_rock  1.9871
68         cat__track_genre_house  1.9686
17      cat__track_genre_alt-rock  1.8159
18   cat__track_genre_alternative  1.8141
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Lasso Class Weight se encuentra en la posición #29 de 29 modelos

Información:
   - Regularización L1 (Lasso) para selección de características
   - Class weight: balanced para manejar desbalance
   - Características eliminadas: 57 de 129 (44.2%)
   - Hiperparámetro C óptimo: 0.01
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Lasso con Class Weight combina la regularización L1 para selección de características con balanceo de clases logrando un F1-Score de 0.565, un AUC de 0.843 dando buena capacidad discriminativa y un Accuracy de 0.787.</p>
<p>En la clase 0 (No Popular) se da un Precision de 0.984, un Recall de 0.788 y un F1 de 0.876.
En la clase 1 (Popular) se da un Precision de 0.153, un Recall de 0.753 y un F1 de 0.254.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones:</p>
<p>Verdaderos Negativos: 17,043 (75.0%)
Falsos Positivos: 4,573 (20.1%)<br />
Falsos Negativos: 270 (1.2%)<br />
Verdaderos Positivos: 824 (3.6%)</p>
<p>Mostrando solo 270 falsos negativos, donde prácticamente no se pierden oportunidades, 4,573 falsos positivos, y 824 de 1,094 populares reales.</p>
<p>En el Top Características Identificadas se muestran los siguientes géneros Más Influyentes:</p>
<ul class="simple">
<li><p>Pop con 2.560</p></li>
<li><p>Metal con 2.176</p></li>
<li><p>Electro con 2.102</p></li>
<li><p>Indie con 2.062</p></li>
<li><p>K-Pop con 2.054</p></li>
<li><p>Dance con 2.019</p></li>
<li><p>Rock con 1.987</p></li>
<li><p>House con 1.969</p></li>
<li><p>Alt-Rock con 1.816</p></li>
<li><p>Alternative con 1.814</p></li>
</ul>
<p>Esto muestra una segmentación de mercado por géneros de alto impacto, una planificación de producción basada en datos y evaluación de tendencias con métricas cuantificables.</p>
<p>Por lo cual, Lasso con Class Weight emerge como la solución óptima para implementaciones prácticas en la industria musical que priorizan eficiencia, interpretabilidad y velocidad sobre máxima precision. Permite a las disqueras y artistas optimizar inversiones en producción al enfocarse en géneros probados como Pop, Metal y Electro, mientras reduce riesgos mediante decisiones basadas en datos comprobables en lugar de la intuición, todo con una implementación rápida y costo-eficiente que maximiza el retorno comercial.</p>
<p><strong>Árbol de Decisión</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para Decision Tree</span>
<span class="n">DT_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">DT_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">DT_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">DT_CRITERION</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización Decision Tree con Class Weight&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para Decision Tree con class_weight</span>
<span class="n">dt_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>  
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">dt_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">DT_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">,</span>
    <span class="s1">&#39;model__criterion&#39;</span><span class="p">:</span> <span class="n">DT_CRITERION</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para Decision Tree con Class Weight&quot;</span><span class="p">)</span>
<span class="n">dt_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">dt_classweight_pipeline</span><span class="p">,</span>
    <span class="n">dt_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DT_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> 
                        <span class="nb">len</span><span class="p">(</span><span class="n">DT_MIN_SAMPLES_LEAF</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">DT_CRITERION</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final Decision Tree con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model</span>
<span class="n">result_dt_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;Decision Tree Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dt_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis DECISION TREE CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Decision Tree Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Decision Tree Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Decision Tree&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Decision Tree Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados DECISION TREE CLASS WEIGHT&quot;</span><span class="p">)</span>
<span class="c1"># Información del árbol</span>
<span class="n">tree_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">tree_depth</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">get_depth</span><span class="p">()</span>
<span class="n">n_leaves</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">get_n_leaves</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_dt_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del árbol:</span>
<span class="s2">   - Profundidad: </span><span class="si">{</span><span class="n">tree_depth</span><span class="si">}</span>
<span class="s2">   - Número de hojas: </span><span class="si">{</span><span class="n">n_leaves</span><span class="si">}</span>
<span class="s2">   - Criterio: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">criterion</span><span class="si">}</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - criterion: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__criterion&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Decision Tree Class Weight vs otros modelos</span>
    <span class="n">dt_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Decision Tree Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Decision Tree Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">dt_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Decision Tree Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Profundidad óptima: </span><span class="si">{</span><span class="n">tree_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Hojas: </span><span class="si">{</span><span class="n">n_leaves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Criterio: </span><span class="si">{</span><span class="n">tree_model</span><span class="o">.</span><span class="n">criterion</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - min_samples_split: </span><span class="si">{</span><span class="n">dt_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Optimización Decision Tree con Class Weight

Búsqueda de hiperparámetros para Decision Tree con Class Weight
Combinaciones Class Weight: 224 × 5 folds = 1120 modelos
Fitting 5 folds for each of 224 candidates, totalling 1120 fits
Optimización Class Weight completada en 618.65s
Mejores parámetros: {&#39;model__criterion&#39;: &#39;gini&#39;, &#39;model__max_depth&#39;: None, &#39;model__min_samples_leaf&#39;: 2, &#39;model__min_samples_split&#39;: 2}
Mejor F1-score (CV): 0.6392
Decision Tree Class Weight: acc=0.918, f1=0.617, time=3.96s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
27    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
28               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
29       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
25  0.8431      0.5433  
26  0.8535      0.8531  
27     NaN      0.6373  
28  0.8431      0.6202  
29  0.6399      3.9580  
Análisis DECISION TREE CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.9181
Balanced Accuracy:   0.6376
AUC:                 0.6399
F1-score (Weighted): 0.6172
F1-score (Macro):    0.6172

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9653
Recall - No Popular:    0.9480
F1 - No Popular:        0.9566
Precision - Popular:    0.2414
Recall - Popular:       0.3272
F1 - Popular:           0.2778

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20491     1125]
     Popular   [   736      358]

Desglose:
   Verdaderos Negativos: 20491
   Falsos Positivos:     1125
   Falsos Negativos:     736
   Verdaderos Positivos: 358

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.95      0.96     21616
     Popular       0.24      0.33      0.28      1094

    accuracy                           0.92     22710
   macro avg       0.60      0.64      0.62     22710
weighted avg       0.93      0.92      0.92     22710
</pre></div>
</div>
<img alt="_images/37a4c941a62c9c52251e54e3e2c1a2e9a7b4423989304b0e8ed2c55d2fd03311.png" src="_images/37a4c941a62c9c52251e54e3e2c1a2e9a7b4423989304b0e8ed2c55d2fd03311.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados DECISION TREE CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.918
   - AUC: 0.640 
   - F1-Score (Macro): 0.617 
   - Balanced Accuracy: 0.638 
   - Tiempo entrenamiento: 3.96s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.965 | Recall: 0.948 | F1: 0.957
   - CLASE 1 (Popular): 
        Precision: 0.241 | Recall: 0.327 | F1: 0.278

Información del árbol:
   - Profundidad: 70
   - Número de hojas: 5070
   - Criterio: gini
   - Class weight: balanced

Hiperparámetros óptimos:
   - max_depth: None
   - min_samples_split: 2
   - min_samples_leaf: 2
   - criterion: gini


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.1026
7       num__acousticness      0.0856
2             num__energy      0.0720
11             num__tempo      0.0673
9           num__liveness      0.0640
6        num__speechiness      0.0625
0        num__duration_ms      0.0624
4           num__loudness      0.0590
1       num__danceability      0.0550
10           num__valence      0.0537
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest SMOTE
   F1-Score: 0.6803
   Accuracy: 0.9463
   AUC:      0.9019

Decision Tree Class Weight se encuentra en la posición #30 de 30 modelos

Información:
   - Class weight: balanced para manejar desbalance
   - Profundidad óptima: 70
   - Hojas: 5070
   - Criterio: gini
   - max_depth: None
   - min_samples_split: 2
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Árbol de Decisión con Class Weight logra un F1-Score de 0.616 y un Accuracy de 0.917</p>
<p>En la clase 0 (No Popular) da un Precision de 0.965, Recall de 0.947 y F1 0.956.
En la clase 1 (Popular) da un Precision de 0.238, Recall de 0.327 y F1 de 0.276.</p>
<p>En la Matriz de Confusión se muestran los siguientes patrones:
Verdaderos Negativos: 20,471 (90.1%)
Falsos Positivos: 1,145 (5.0%)<br />
Falsos Negativos: 736 (3.2%)<br />
Verdaderos Positivos: 358 (1.6%)</p>
<p>Muestra solo 1,145 falsos positivos, falsos negativos moderados y 358 de 1,094 populares reales</p>
<p>En el Top de Características Técnicas Más Importantes se muestra:</p>
<ul class="simple">
<li><p>Instrumentalness con 0.102</p></li>
<li><p>Acousticness con 0.085</p></li>
<li><p>Energy con 0.073</p></li>
<li><p>Tempo con 0.068</p></li>
<li><p>Liveness con 0.065</p></li>
</ul>
<p>Se ven géneros como Electro, Indie, Metal y Pop.</p>
<p>Por lo cual, el modelo Árbol de Decisión con Class Weight es la solución óptima para aplicaciones que priorizan la transparencia, eficiencia operativa y minimización de falsos positivos sobre la cobertura máxima. Para la industria musical, representa la herramienta ideal para sistemas de preselección automatizada donde cada falso positivo tiene un costo operativo tangible, permitiendo a equipos de A&amp;R enfocarse en material genuinamente prometedor mientras mantiene total transparencia en el proceso de decision-making.</p>
<p><strong>Random Forest</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para Random Forest</span>
<span class="n">RF_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">RF_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">RF_MIN_SAMPLES_SPLIT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">RF_MIN_SAMPLES_LEAF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización Random Forest con Class Weight&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline para Random Forest con class_weight</span>
<span class="n">rf_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
        <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">rf_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">RF_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">RF_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">,</span>
    <span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">:</span> <span class="n">RF_MIN_SAMPLES_LEAF</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para Random Forest con Class Weight&quot;</span><span class="p">)</span>
<span class="n">rf_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">rf_classweight_pipeline</span><span class="p">,</span>
    <span class="n">rf_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RF_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                        <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_SPLIT</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">RF_MIN_SAMPLES_LEAF</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final Random Forest con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model</span>
<span class="n">result_rf_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                      <span class="s2">&quot;Random Forest Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_rf_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis RANDOM FOREST CLASS WEIGHT&quot;</span><span class="p">)</span>
<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - Random Forest Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Random Forest Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - Random Forest&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - Random Forest Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reultados RANDOM FOREST CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Información del Random Forest</span>
<span class="n">rf_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_estimators</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">n_features_in_</span>

<span class="c1"># características importantes </span>
<span class="n">n_important_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_rf_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del Random Forest:</span>
<span class="s2">   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span>
<span class="s2">   - Características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span>
<span class="s2">   - Class weight: balanced</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_split: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_split&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - min_samples_leaf: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__min_samples_leaf&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del Random Forest Class Weight vs otros modelos</span>
    <span class="n">rf_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Random Forest Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">rf_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre Random Forest Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Ensemble de </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2"> árboles&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - n_estimators: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - max_depth: </span><span class="si">{</span><span class="n">rf_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Bootstrap: True&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
Optimización Random Forest con Class Weight

Búsqueda de hiperparámetros para Random Forest con Class Weight
Combinaciones Class Weight: 135 × 5 folds = 675 modelos
Fitting 5 folds for each of 135 candidates, totalling 675 fits
Optimización Class Weight completada en 2934.15s
Mejores parámetros: {&#39;model__max_depth&#39;: None, &#39;model__min_samples_leaf&#39;: 4, &#39;model__min_samples_split&#39;: 10, &#39;model__n_estimators&#39;: 200}
Mejor F1-score (CV): 0.6942
Random Forest Class Weight: acc=0.939, f1=0.697, time=15.14s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
27    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
28               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
29       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   
30       Random Forest Class Weight    0.9395     0.9447  0.9395    0.6966   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
25  0.8431      0.5433  
26  0.8535      0.8531  
27     NaN      0.6373  
28  0.8431      0.6202  
29  0.6399      3.9580  
30  0.9127     15.1356  
Análisis RANDOM FOREST CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.9395
Balanced Accuracy:   0.7139
AUC:                 0.9127
F1-score (Weighted): 0.6966
F1-score (Macro):    0.6966

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9726
Recall - No Popular:    0.9635
F1 - No Popular:        0.9681
Precision - Popular:    0.3920
Recall - Popular:       0.4644
F1 - Popular:           0.4251

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 20828      788]
     Popular   [   586      508]

Desglose:
   Verdaderos Negativos: 20828
   Falsos Positivos:     788
   Falsos Negativos:     586
   Verdaderos Positivos: 508

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.96      0.97     21616
     Popular       0.39      0.46      0.43      1094

    accuracy                           0.94     22710
   macro avg       0.68      0.71      0.70     22710
weighted avg       0.94      0.94      0.94     22710
</pre></div>
</div>
<img alt="_images/9f4b75f89804b7bb609483c5d67f4d8d3030b4954146bcef3f062963125cff63.png" src="_images/9f4b75f89804b7bb609483c5d67f4d8d3030b4954146bcef3f062963125cff63.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reultados RANDOM FOREST CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.939
   - AUC: 0.913 
   - F1-Score (Macro): 0.697 
   - Balanced Accuracy: 0.714 
   - Tiempo entrenamiento: 15.14s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.973 | Recall: 0.964 | F1: 0.968
   - CLASE 1 (Popular): 
        Precision: 0.392 | Recall: 0.464 | F1: 0.425

Información del Random Forest:
   - Número de árboles: 200
   - Características: 129
   - Características importantes: 16
   - Class weight: balanced

Hiperparámetros óptimos:
   - n_estimators: 200
   - max_depth: None
   - min_samples_split: 10
   - min_samples_leaf: 4


Top 10 características importantes:
                  feature  importance
8   num__instrumentalness      0.0862
2             num__energy      0.0761
7       num__acousticness      0.0727
4           num__loudness      0.0715
0        num__duration_ms      0.0689
9           num__liveness      0.0661
10           num__valence      0.0594
1       num__danceability      0.0588
6        num__speechiness      0.0578
11             num__tempo      0.0570
Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   15.135563
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   15.135563
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: Random Forest Class Weight
   F1-Score: 0.6966
   Accuracy: 0.9395
   AUC:      0.9127

Random Forest Class Weight se encuentra en la posición #31 de 31 modelos

Información:
   - Ensemble de 200 árboles
   - Class weight: balanced para manejar desbalance
   - Características importantes: 16 de 129
   - n_estimators: 200
   - max_depth: None
   - Bootstrap: True
</pre></div>
</div>
</div>
</div>
<p>Analizando el modelo Random Forest Class Weight muestra un F1-Score de 0.6966, AUC de 0.9127 con capacidad discriminativa, Accuracy de 93.95%, y un Balanced Accuracy de 0.714</p>
<p>En la clase 0 (No Popular) hay un Precision de 97.3%, Recall de 96.4% y F1 de 96.8%
En la clase 1 (Popular) hay un Precision de 39.2%, Recall de 46.4%, y F1 de 42.5%</p>
<p>En la Matriz de Confusión se muestra que 20,828 no populares correctos, 508 populares correctos, 586 falsos negativos (populares no detectados), y 788 falsos positivos, por lo cual detecta una cantidad de canciones populares sin generar demasiados falsos positivos.</p>
<p>En el Top 10 Características se identifica que:</p>
<ul class="simple">
<li><p>instrumentalness con 0.0862</p></li>
<li><p>energy con 0.0761</p></li>
<li><p>acousticness con 0.0727</p></li>
<li><p>loudness con 0.0715</p></li>
<li><p>duration_ms con 0.0689</p></li>
<li><p>liveness con 0.0661</p></li>
<li><p>valence con 0.0594</p></li>
<li><p>danceability con 0.0588</p></li>
<li><p>speechiness con 0.0578</p></li>
<li><p>tempo con 0.0570</p></li>
</ul>
<p>Para los artistas y productoras ayud a detectar un 46% de canciones populares con buena confianza, donde solo 39% de falsos positivos. Puede identificar patrones musicales que funcionan, dando un balance ideal entre detección y precisión</p>
<p>Así, el modelo Random Forest con Class Weight pueden invertir en canciones con alto instrumentalness y energy, optimizar mezcla basado en características importantes, asignar presupuestos de marketing a canciones predichas como populares y guiar decisiones de producción musical</p>
<p>En <strong>XGBOOST</strong> usamos <strong>Scale_Pos_Weight</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;División de datos:&quot;</span><span class="p">)</span>

<span class="c1"># Primero dividir train+val vs test</span>
<span class="n">X_temp</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="c1"># Luego dividir train vs validation</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_temp</span>  <span class="c1"># 0.25 * 0.8 = 0.2 para val</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tamaños finales:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train:      </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Validation: </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test:       </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para XGBoost</span>
<span class="n">XGB_N_ESTIMATORS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">]</span>
<span class="n">XGB_MAX_DEPTH</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="n">XGB_LEARNING_RATE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>
<span class="n">XGB_SUBSAMPLE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

<span class="c1"># Calcular scale_pos_weight solo con training data</span>
<span class="n">scale_pos_weight_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scale pos weight calculado (solo train): </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización XGBOOST&quot;</span><span class="p">)</span>
<span class="c1"># Pipeline para XGBoost con scale_pos_weight</span>
<span class="n">xgb_weight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">scale_pos_weight</span><span class="o">=</span><span class="n">scale_pos_weight_value</span> 
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">xgb_weight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="n">XGB_N_ESTIMATORS</span><span class="p">,</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="n">XGB_MAX_DEPTH</span><span class="p">,</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="n">XGB_LEARNING_RATE</span><span class="p">,</span>
    <span class="s1">&#39;model__subsample&#39;</span><span class="p">:</span> <span class="n">XGB_SUBSAMPLE</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros (sin Data Leakage)&quot;</span><span class="p">)</span>
<span class="n">xgb_weight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">xgb_weight_pipeline</span><span class="p">,</span>
    <span class="n">xgb_weight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">n_combos_weight</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XGB_N_ESTIMATORS</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_MAX_DEPTH</span><span class="p">)</span> <span class="o">*</span> 
                   <span class="nb">len</span><span class="p">(</span><span class="n">XGB_LEARNING_RATE</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">XGB_SUBSAMPLE</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones: </span><span class="si">{</span><span class="n">n_combos_weight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Entrenamiento con GridSearchCV correctamente&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cada fold de CV tendrá su propio preprocesamiento sin leakage&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">weight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización completada en </span><span class="si">{</span><span class="n">weight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verificar que no hay superposición</span>
<span class="n">train_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">test_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">val_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_val</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Verificación de particiones:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train ∩ Test:    </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">test_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train ∩ Val:     </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">val_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test ∩ Val:      </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_indices</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">val_indices</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total únicos:    </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">test_indices</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">val_indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación final:&quot;</span><span class="p">)</span>
<span class="c1"># Modelo final </span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model CON TEST SET AISLADO</span>
<span class="n">result_xgb_weight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                  <span class="s2">&quot;XGBoost Scale Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_xgb_weight</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis XGBOOST SCALE WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - XGBoost Scale Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost Scale Weight&#39;</span><span class="p">)</span>

<span class="c1"># Importancia de características</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># DataFrame con importancias</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Top 15 características</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - XGBoost&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - XGBoost Scale Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados XGBOOST SCALE WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Información del XGBoost</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">n_estimators</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">n_features_in_</span>

<span class="c1"># características importantes</span>
<span class="n">n_important_features</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_xgb_weight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Información del XGBoost:</span>
<span class="s2">   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span>
<span class="s2">   - Características: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span>
<span class="s2">   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span>
<span class="s2">   - Scale pos weight: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - n_estimators: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - max_depth: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - learning_rate: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - subsample: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__subsample&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Data_Leakage&#39;</span><span class="p">:</span> <span class="s1">&#39;0%&#39;</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score </span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del XGBoost Scale Weight vs otros modelos</span>
    <span class="n">xgb_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;XGBoost Scale Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">XGBoost Scale Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">xgb_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre XGBoost Scale Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Gradient Boosting optimizado&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Scale pos weight: </span><span class="si">{</span><span class="n">scale_pos_weight_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Número de árboles: </span><span class="si">{</span><span class="n">n_estimators</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Características importantes: </span><span class="si">{</span><span class="n">n_important_features</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Learning rate: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Max depth: </span><span class="si">{</span><span class="n">xgb_weight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - DATA LEAKAGE: 0% - Evaluación limpia&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>División de datos:
Tamaños finales:
   Train:      68130 muestras
   Validation: 22710 muestras
   Test:       22710 muestras

Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 64849 muestras (95.2%)
   Clase 1 (Popular):    3281 muestras (4.8%)

Scale pos weight calculado (solo train): 19.77
Optimización XGBOOST

Búsqueda de hiperparámetros (sin Data Leakage)
Combinaciones: 81 × 5 folds = 405 modelos

Entrenamiento con GridSearchCV correctamente
Cada fold de CV tendrá su propio preprocesamiento sin leakage
Fitting 5 folds for each of 81 candidates, totalling 405 fits
Optimización completada en 327.37s
Mejores parámetros: {&#39;model__learning_rate&#39;: 0.2, &#39;model__max_depth&#39;: 9, &#39;model__n_estimators&#39;: 300, &#39;model__subsample&#39;: 0.8}
Mejor F1-score (CV): 0.7415

Verificación de particiones:
   Train ∩ Test:    0
   Train ∩ Val:     0
   Test ∩ Val:      0
   Total únicos:    113550 / 113550
Evaluación final:
XGBoost Scale Weight: acc=0.953, f1=0.755, time=3.53s
Análisis XGBOOST SCALE WEIGHT
Evaluación detallada:
Accuracy:            0.9530
Balanced Accuracy:   0.7662
AUC:                 0.9062
F1-score (Weighted): 0.7548
F1-score (Macro):    0.7548

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9776
Recall - No Popular:    0.9729
F1 - No Popular:        0.9753
Precision - Popular:    0.5113
Recall - Popular:       0.5594
F1 - Popular:           0.5343

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 21031      585]
     Popular   [   482      612]

Desglose:
   Verdaderos Negativos: 21031
   Falsos Positivos:     585
   Falsos Negativos:     482
   Verdaderos Positivos: 612

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.98      0.97      0.98     21616
     Popular       0.51      0.56      0.53      1094

    accuracy                           0.95     22710
   macro avg       0.74      0.77      0.75     22710
weighted avg       0.96      0.95      0.95     22710
</pre></div>
</div>
<img alt="_images/5ee6c934b6742d3ae31cb91a6988f3c416f627f931ac878118240b47488b4e24.png" src="_images/5ee6c934b6742d3ae31cb91a6988f3c416f627f931ac878118240b47488b4e24.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados XGBOOST SCALE WEIGHT

Rendimiento general:
   - Accuracy: 0.953
   - AUC: 0.906 
   - F1-Score (Macro): 0.755 
   - Balanced Accuracy: 0.766 
   - Tiempo entrenamiento: 3.53s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.978 | Recall: 0.973 | F1: 0.975
   - CLASE 1 (Popular): 
        Precision: 0.511 | Recall: 0.559 | F1: 0.534

Información del XGBoost:
   - Número de árboles: 300
   - Características: 129
   - Características importantes: 37
   - Scale pos weight: 19.77

Hiperparámetros óptimos:
   - n_estimators: 300
   - max_depth: 9
   - learning_rate: 0.2
   - subsample: 0.8


Top 10 características importantes:
                          feature  importance
81          cat__track_genre_kids      0.0219
76        cat__track_genre_j-idol      0.0197
24        cat__track_genre_brazil      0.0191
50         cat__track_genre_forro      0.0189
86         cat__track_genre_metal      0.0188
29      cat__track_genre_children      0.0188
56          cat__track_genre_goth      0.0178
65   cat__track_genre_heavy-metal      0.0169
89           cat__track_genre_mpb      0.0168
112    cat__track_genre_sertanejo      0.0166
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
27    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
28               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
29       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   
30       Random Forest Class Weight    0.9395     0.9447  0.9395    0.6966   
31             XGBoost Scale Weight    0.9530     0.9551  0.9530    0.7548   

       AUC  Train_Time Data_Leakage  
0   0.8431      0.6271           0%  
1   0.7255      0.3062           0%  
2      NaN      0.3249           0%  
3   0.8431      0.5626           0%  
4   0.6043      6.7157           0%  
5   0.9015     10.0906           0%  
6   0.8791      2.3353           0%  
7   0.7936     19.2231           0%  
8   0.7842      0.7641           0%  
9   0.8434      1.3964           0%  
10     NaN      0.6501           0%  
11  0.8434      1.2955           0%  
12  0.7411      5.9971           0%  
13  0.9019     15.6061           0%  
14  0.8636      3.0140           0%  
15  0.6443    109.7535           0%  
16  0.7895      1.8340           0%  
17  0.7874      2.3736           0%  
18  0.8455      2.9009           0%  
19  0.8535      3.3687           0%  
20     NaN      2.2659           0%  
21  0.8455      2.8532           0%  
22  0.8908     19.6922           0%  
23  0.8210      4.2617           0%  
24  0.6538    151.0416           0%  
25  0.8431      0.5433           0%  
26  0.8535      0.8531           0%  
27     NaN      0.6373           0%  
28  0.8431      0.6202           0%  
29  0.6399      3.9580           0%  
30  0.9127     15.1356           0%  
31  0.9062      3.5308           0%  
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time Data_Leakage
           XGBoost Scale Weight  0.953016   0.955131 0.953016  0.754762 0.906217    3.530824           0%
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   15.135563           0%
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062           0%
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176           0%
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965           0%
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028           0%
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123           0%
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749           0%
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015           0%
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368           0%
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548           0%
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671           0%
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656           0%
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222           0%
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931           0%
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081           0%
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142           0%
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856           0%
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213           0%
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312           0%
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129           0%
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608           0%
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616           0%
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106           0%
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271           0%
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257           0%
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539           0%
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935           0%
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103           0%
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638           0%
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608           0%
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190           0%

Mejor modelo: XGBoost Scale Weight
   F1-Score: 0.7548
   Accuracy: 0.9530
   AUC:      0.9062

XGBoost Scale Weight se encuentra en la posición #32 de 32 modelos

Información:
   - Gradient Boosting optimizado
   - Scale pos weight: 19.77 para manejar desbalance
   - Número de árboles: 300
   - Características importantes: 37 de 129
   - Learning rate: 0.2
   - Max depth: 9
   - DATA LEAKAGE: 0% - Evaluación limpia
</pre></div>
</div>
</div>
</div>
<p>Analizando el desempeño del modelo XGBoost Scale Weight con un F1-Score de 0.7683, AUC de  0.9226, Accuracy de 95.15%, y un Balanced Accuracy: 0.766 - Muy buen balance entre clases</p>
<p>En la clase 0 (No Popular) hay un Precision de 97.7%, Recall de 97.3%, y F1 de 97.5%.
En clase 1 (Popular) hay un Precision 51.1%, Recall de 55.9%, y F1 de 53.4%.</p>
<p>En la Matriz de Confusión se muestra 21,031 no populares correctos (97.3% de recall), 612 populares correctos, 482 falsos negativos y 585 falsos positivos, lo cual máxima detección de canciones populares con mínimos falsos positivos.</p>
<p>En el Top 10 Características del XGBoost se muestra:</p>
<ul class="simple">
<li><p>track_genre_kids (0.0219)</p></li>
<li><p>track_genre_j-idol (0.0197)</p></li>
<li><p>track_genre_brazil (0.0191)</p></li>
<li><p>track_genre_forro (0.0189)</p></li>
<li><p>track_genre_metal (0.0188)</p></li>
<li><p>track_genre_children (0.0188)</p></li>
<li><p>track_genre_goth (0.0178)</p></li>
<li><p>track_genre_heavy-metal (0.0169)</p></li>
<li><p>track_genre_mpb (0.0168)</p></li>
<li><p>track_genre_sertanejo (0.0166)</p></li>
</ul>
<p>Así, géneros regionales como brazil, forro, sertanejo o mpb son muy importantes, y géneros temáticos como kids, children y goth son clave, donde la popularidad depende más de audiencias específicas y leales que de características musicales universales.</p>
<p>Para los artistas y productoras se puede implementar este modelo pues etecta 56% de canciones populares, olo 51% de falsos positivos e identifica nichos de mercado específicos</p>
<p>También, la popularidad en Spotify está más determinada por géneros de nicho con audiencias leales que por características musicales universales o géneros mainstream.”</p>
<p><strong>Máquina de Soporte Vectorial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> 
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
    <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">balanced_accuracy_score</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="c1"># Definir características</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="s1">&#39;danceability&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;loudness&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;speechiness&#39;</span><span class="p">,</span> <span class="s1">&#39;acousticness&#39;</span><span class="p">,</span> <span class="s1">&#39;instrumentalness&#39;</span><span class="p">,</span> <span class="s1">&#39;liveness&#39;</span><span class="p">,</span>
    <span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;tempo&#39;</span><span class="p">,</span> <span class="s1">&#39;time_signature&#39;</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;track_genre&#39;</span><span class="p">]</span>

<span class="c1"># Variable objetivo</span>
<span class="n">dataset_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;popularity&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataset_clean</span><span class="p">[</span><span class="s1">&#39;HighPopularity&#39;</span><span class="p">]</span>

<span class="c1"># División train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Preprocesadores</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Definir parámetros para SVM</span>
<span class="n">SVM_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">SVM_KERNEL</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">]</span>
<span class="n">SVM_GAMMA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span>

<span class="c1"># Pipeline para SVM con class_weight</span>
<span class="n">svm_classweight_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">svm_classweight_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SVM_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__kernel&#39;</span><span class="p">:</span> <span class="n">SVM_KERNEL</span><span class="p">,</span>
    <span class="s1">&#39;model__gamma&#39;</span><span class="p">:</span> <span class="n">SVM_GAMMA</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Búsqueda de hiperparámetros para SVM con Class Weight&quot;</span><span class="p">)</span>
<span class="n">svm_classweight_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">svm_classweight_pipeline</span><span class="p">,</span>
    <span class="n">svm_classweight_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>  <span class="c1"># 5 FOLDS</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">n_combos_classweight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_C_VALUES</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_KERNEL</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">SVM_GAMMA</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones Class Weight: </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="si">}</span><span class="s2"> × 5 folds = </span><span class="si">{</span><span class="n">n_combos_classweight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">classweight_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización Class Weight completada en </span><span class="si">{</span><span class="n">classweight_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejores parámetros: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Modelo final SVM con Class Weight</span>
<span class="n">final_model</span> <span class="o">=</span> <span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># USAR LA FUNCIÓN evaluate_model</span>
<span class="n">result_svm_classweight</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                       <span class="s2">&quot;SVM Class Weight&quot;</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_svm_classweight</span><span class="p">)</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
    <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span>  <span class="c1"># ← Este es F1-macro</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Train_Time&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz resultante&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis SVM CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="c1"># Obtener predicciones del resultado</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;probabilities&#39;</span><span class="p">]</span>

<span class="c1"># Métricas adicionales (para el análisis detallado)</span>
<span class="n">balanced_acc</span> <span class="o">=</span> <span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación detallada:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:            </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balanced Accuracy:   </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC:                 </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Weighted): </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-score (Macro):    </span><span class="si">{</span><span class="n">f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MÉTRICAS POR CLASE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - No Popular: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - No Popular:    </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - No Popular:        </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision - Popular:    </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall - Popular:       </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 - Popular:           </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión:&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">tn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">fp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">fn</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">tp</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Desglose:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Negativos: </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Positivos:     </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Falsos Negativos:     </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Verdaderos Positivos: </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación completo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Curva ROC</span>
<span class="k">if</span> <span class="n">y_pred_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">y_pred_proba_pos</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_pos</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Línea base&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - SVM Class Weight&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No hay probabilidades</span><span class="se">\n</span><span class="s1">para calcular ROC&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curva ROC - No disponible&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - SVM Class Weight&#39;</span><span class="p">)</span>

<span class="c1"># Coeficientes para SVM lineal </span>
<span class="k">if</span> <span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># DataFrame con coeficientes</span>
    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;coef&#39;</span><span class="p">:</span> <span class="n">coef</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Top 15 características</span>
    <span class="n">top_features</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Coeficiente&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Características Más Importantes - SVM (Coeficientes)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Kernel: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s2">&quot;model__kernel&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">No hay coeficientes</span><span class="se">\n</span><span class="s1">para kernel no lineal&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Coeficientes - No disponible para kernel no lineal&#39;</span><span class="p">)</span>

<span class="c1"># Métricas por clase</span>
<span class="n">metrics_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;No Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_0</span><span class="p">,</span> <span class="n">recall_0</span><span class="p">,</span> <span class="n">f1_0</span><span class="p">],</span>
    <span class="s1">&#39;Popular&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">[</span><span class="s1">&#39;Popular&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Popular&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Métricas por Clase - SVM Class Weight&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultados SVM CLASS WEIGHT&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Rendimiento general:</span>
<span class="s2">   - Accuracy: </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - AUC: </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - F1-Score (Macro): </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Balanced Accuracy: </span><span class="si">{</span><span class="n">balanced_acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">   - Tiempo entrenamiento: </span><span class="si">{</span><span class="n">result_svm_classweight</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="s2">Análisis por clases:</span>
<span class="s2">   - CLASE 0 (No Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>
<span class="s2">   - CLASE 1 (Popular): </span>
<span class="s2">        Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span>

<span class="s2">Hiperparámetros óptimos:</span>
<span class="s2">   - C: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Kernel: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Gamma: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   - Class weight: balanced</span>
<span class="s2">   - Max iterations: 500</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Mostrar coeficientes si es kernel lineal</span>
<span class="k">if</span> <span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 características importantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">coef_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resumen final:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Comparación entre modelos si hay más de uno</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparación entre modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ordenar por F1-Score (F1-macro como métrica principal)</span>
    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
    <span class="c1"># Mostrar el mejor modelo</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejor modelo: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">best_model</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Análisis del SVM Class Weight vs otros modelos</span>
    <span class="n">svm_position</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SVM Class Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SVM Class Weight se encuentra en la posición #</span><span class="si">{</span><span class="n">svm_position</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> modelos&quot;</span><span class="p">)</span>
    
    <span class="c1"># Información específica sobre SVM Class Weight</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Información:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Kernel utilizado: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__kernel&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Regularización C: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Gamma: </span><span class="si">{</span><span class="n">svm_classweight_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__gamma&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Class weight: balanced para manejar desbalance&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Cache size: 1000 para optimización&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)

Búsqueda de hiperparámetros para SVM con Class Weight
Combinaciones Class Weight: 16 × 5 folds = 80 modelos
Fitting 5 folds for each of 16 candidates, totalling 80 fits
Optimización Class Weight completada en 1082.91s
Mejores parámetros: {&#39;model__C&#39;: 100, &#39;model__gamma&#39;: &#39;scale&#39;, &#39;model__kernel&#39;: &#39;rbf&#39;}
Mejor F1-score (CV): 0.4730
SVM Class Weight: acc=0.688, f1=0.477, time=47.72s
Matriz resultante
                              Model  Accuracy  Precision  Recall  F1-Score  \
0   Logistic Regression (Optimized)    0.7867     0.9443  0.7867    0.5647   
1                       Naive Bayes    0.4895     0.9541  0.4895    0.3952   
2                  Ridge Classifier    0.9518     0.9060  0.9518    0.4877   
3                  Lasso Regression    0.7867     0.9443  0.7867    0.5647   
4                     Decision Tree    0.9287     0.9270  0.9287    0.6021   
5                     Random Forest    0.9517     0.9330  0.9517    0.5547   
6                           XGBoost    0.9525     0.9376  0.9525    0.5224   
7                               SVM    0.8835     0.9316  0.8835    0.5996   
8             Naive Bayes con SMOTE    0.6151     0.9525  0.6151    0.4693   
9         Logistic Regression SMOTE    0.8612     0.9381  0.8612    0.6040   
10           Ridge Classifier SMOTE    0.8419     0.9400  0.8419    0.5946   
11                      Lasso SMOTE    0.8612     0.9381  0.8612    0.6040   
12              Decision Tree SMOTE    0.9148     0.9318  0.9148    0.6215   
13              Random Forest SMOTE    0.9463     0.9417  0.9463    0.6803   
14                    XGBoost SMOTE    0.9042     0.9359  0.9042    0.6315   
15                        SVM SMOTE    0.7609     0.9195  0.7609    0.4984   
16                       KNN ADASYN    0.8900     0.9404  0.8900    0.6350   
17               Naive Bayes ADASYN    0.6112     0.9526  0.6112    0.4671   
18    Logistic Regression L1 ADASYN    0.8558     0.9381  0.8558    0.6000   
19    Logistic Regression L2 ADASYN    0.8570     0.9379  0.8570    0.6004   
20          Ridge Classifier ADASYN    0.8280     0.9410  0.8280    0.5867   
21                     Lasso ADASYN    0.8558     0.9381  0.8558    0.6000   
22             Random Forest ADASYN    0.9284     0.9392  0.9284    0.6641   
23                   XGBoost ADASYN    0.9343     0.9306  0.9343    0.6211   
24                       SVM ADASYN    0.6675     0.9231  0.6675    0.4638   
25       L1 Regression Class Weight    0.7867     0.9443  0.7867    0.5647   
26       L2 Regression Class Weight    0.7595     0.9469  0.7595    0.5511   
27    Ridge Classifier Class Weight    0.7440     0.9482  0.7440    0.5430   
28               Lasso Class Weight    0.7867     0.9443  0.7867    0.5647   
29       Decision Tree Class Weight    0.9181     0.9305  0.9181    0.6172   
30       Random Forest Class Weight    0.9395     0.9447  0.9395    0.6966   
31             XGBoost Scale Weight    0.9530     0.9551  0.9530    0.7548   
32                 SVM Class Weight    0.6885     0.9254  0.6885    0.4770   

       AUC  Train_Time  
0   0.8431      0.6271  
1   0.7255      0.3062  
2      NaN      0.3249  
3   0.8431      0.5626  
4   0.6043      6.7157  
5   0.9015     10.0906  
6   0.8791      2.3353  
7   0.7936     19.2231  
8   0.7842      0.7641  
9   0.8434      1.3964  
10     NaN      0.6501  
11  0.8434      1.2955  
12  0.7411      5.9971  
13  0.9019     15.6061  
14  0.8636      3.0140  
15  0.6443    109.7535  
16  0.7895      1.8340  
17  0.7874      2.3736  
18  0.8455      2.9009  
19  0.8535      3.3687  
20     NaN      2.2659  
21  0.8455      2.8532  
22  0.8908     19.6922  
23  0.8210      4.2617  
24  0.6538    151.0416  
25  0.8431      0.5433  
26  0.8535      0.8531  
27     NaN      0.6373  
28  0.8431      0.6202  
29  0.6399      3.9580  
30  0.9127     15.1356  
31  0.9062      3.5308  
32  0.6782     47.7155  
Análisis SVM CLASS WEIGHT
Evaluación detallada:
Accuracy:            0.6885
Balanced Accuracy:   0.6207
AUC:                 0.6782
F1-score (Weighted): 0.4770
F1-score (Macro):    0.4770

MÉTRICAS POR CLASE:
Precision - No Popular: 0.9680
Recall - No Popular:    0.6957
F1 - No Popular:        0.8096
Precision - Popular:    0.0832
Recall - Popular:       0.5457
F1 - Popular:           0.1444

Matriz de confusión:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 15038     6578]
     Popular   [   497      597]

Desglose:
   Verdaderos Negativos: 15038
   Falsos Positivos:     6578
   Falsos Negativos:     497
   Verdaderos Positivos: 597

Reporte de clasificación completo:
              precision    recall  f1-score   support

  No Popular       0.97      0.70      0.81     21616
     Popular       0.08      0.55      0.14      1094

    accuracy                           0.69     22710
   macro avg       0.53      0.62      0.48     22710
weighted avg       0.93      0.69      0.78     22710
</pre></div>
</div>
<img alt="_images/8f2b0f035c48344e4a0908b82840f9d9f7556990dacff94d36d40cfded64c7b0.png" src="_images/8f2b0f035c48344e4a0908b82840f9d9f7556990dacff94d36d40cfded64c7b0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados SVM CLASS WEIGHT

Rendimiento general:
   - Accuracy: 0.688
   - AUC: 0.678 
   - F1-Score (Macro): 0.477 
   - Balanced Accuracy: 0.621 
   - Tiempo entrenamiento: 47.72s

Análisis por clases:
   - CLASE 0 (No Popular): 
        Precision: 0.968 | Recall: 0.696 | F1: 0.810
   - CLASE 1 (Popular): 
        Precision: 0.083 | Recall: 0.546 | F1: 0.144

Hiperparámetros óptimos:
   - C: 100
   - Kernel: rbf
   - Gamma: scale
   - Class weight: balanced
   - Max iterations: 500

Resumen final:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   15.135563
           XGBoost Scale Weight  0.953016   0.955131 0.953016  0.754762 0.906217    3.530824
               SVM Class Weight  0.688463   0.925384 0.688463  0.476978 0.678226   47.715541
Comparación entre modelos
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
           XGBoost Scale Weight  0.953016   0.955131 0.953016  0.754762 0.906217    3.530824
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   15.135563
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               SVM Class Weight  0.688463   0.925384 0.688463  0.476978 0.678226   47.715541
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

Mejor modelo: XGBoost Scale Weight
   F1-Score: 0.7548
   Accuracy: 0.9530
   AUC:      0.9062

SVM Class Weight se encuentra en la posición #33 de 33 modelos

Información:
   - Kernel utilizado: rbf
   - Regularización C: 100
   - Gamma: scale
   - Class weight: balanced para manejar desbalance
   - Cache size: 1000 para optimización
</pre></div>
</div>
</div>
</div>
<p>En el análisis de métricas del modelo SVM con Class Weightn F1-Score de 0.4770, AUC de 0.6782, Accuracy de 68.85%, y uun Balanced Accuracy de 0.621, siendo muy bajas métricas</p>
<p>En la clase 0 (No Popular) hay un Precision de 96.8%, Recall de 69.6%, y F1 de 81.0%
En la clase 1 (Popular) hay un Precision de 8.3%, Recall de 54.6%, y F1 de 14.4%</p>
<p>En la Matriz de Confusión se muestra que 15,938 no populares correctos, 597 populares correctos, 6,578 falsos positivos y 497 falsos negativos. Por lo cual modelo genera demasiados falsos positivos, clasificando incorrectamente 6,578 canciones no populares como populares.</p>
<p>Así, para las disqueras, solo 8.3% de precisión para canciones populares, hay 6,578 falsos positivos, siendo mucho “ruido” en las predicciones, y un costo muy alto de implementación por baja calidad</p>
<p>Tampoco es confiable para decisiones de inversión, generaría muchas pérdidas por falsos positivos y no identifica patrones útiles para producción musical</p>
<p>Por lo tanto, SVM con Class Weight es el peor modelo evaluado para aplicaciones prácticas en la industria musical.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="optimizacion-computacional">
<h1>Optimización Computacional<a class="headerlink" href="#optimizacion-computacional" title="Link to this heading">#</a></h1>
<p>La siguiente sección del trabajo es ejercer otras formas de ejecutar y visualizar los modelos con mejores funciones optimizadas para comparar resultados</p>
<p><strong>KNN con KD-TREES</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>

<span class="c1"># Extraer métricas del mejor modelo </span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
<span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">]</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">]</span>
<span class="n">auc_score</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span>
<span class="n">train_time</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span>
<span class="n">cv_time</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;cv_time&#39;</span><span class="p">]</span>
<span class="n">best_pipeline</span> <span class="o">=</span> <span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;pipeline&#39;</span><span class="p">]</span>

<span class="c1"># Predicciones y probabilidades</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">best_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Barras de métricas principales </span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;F1 Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">auc_score</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;violet&#39;</span><span class="p">]</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Métricas de Rendimiento - </span><span class="si">{</span><span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars1</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de Confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">best_pipeline</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matriz de Confusión - </span><span class="si">{</span><span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Curva ROC</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aleatorio&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC - </span><span class="si">{</span><span class="n">best_technique</span><span class="p">[</span><span class="s2">&quot;technique&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resumen - </span><span class="si">{</span><span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">85</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">   • Técnica: </span><span class="si">{</span><span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   • Tiempo total (CV + Entrenamiento): </span><span class="si">{</span><span class="n">cv_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Configuración óptima: </span><span class="si">{</span><span class="n">best_pipeline</span><span class="o">.</span><span class="n">get_params</span><span class="p">()[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   • Accuracy:      </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • F1-Weighted:   </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Recall Clase 1:</span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • AUC:           </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Validación cruzada: </span><span class="si">{</span><span class="n">cv_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Entrenamiento final: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>

<span class="si">{</span><span class="n">best_technique</span><span class="p">[</span><span class="s1">&#39;technique&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - producido</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/60482159370e01fc55031447154c50ed8515923232d4c1d1fe431ffafd983d66.png" src="_images/60482159370e01fc55031447154c50ed8515923232d4c1d1fe431ffafd983d66.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resumen - KNN + Weights=&#39;distance&#39;
=====================================================================================

   • Técnica: KNN + Weights=&#39;distance&#39;
   • Tiempo total (CV + Entrenamiento): 197.75s
   • Configuración óptima: KNeighborsClassifier(n_jobs=-1, n_neighbors=3, weights=&#39;distance&#39;)
   • Accuracy:      0.9490
   • F1-Weighted:   0.9428
   • Recall Clase 1:0.2697
   • AUC:           0.7550
   • Validación cruzada: 197.58s
   • Entrenamiento final: 0.17s

KNN + Weights=&#39;distance&#39; - producido
</pre></div>
</div>
</div>
</div>
<p>El modelo KNN con KD-Tree optimizado muestra un alto accuracy pero problemas graves para detectar canciones populares.
Teniendo un Accuracy de 94.90% puede predecir correctamente en general, un F1-Weighted de 94.28%, es decir, un buen balance entre precision y recall considerando todas las clases, y un AUC de 0.755, dando la capacidad para distinguir entre clases
En la Matriz de Confusión se muestra que 21,457 canciones no populares correctamente identificadas, 295 canciones populares correctamente detectadas, 799 canciones populares no detectadas (siendo falsos negativos), y 359 falsos positivos, dando que el modelo está clasificando casi todo como “no popular”.</p>
<p>Para las disqueras, este modelo no es confiable para identificar canciones potencialmente populares pues solo captura 1 de cada 4 hits potenciales, dando una pérdida del 73% de oportunidades y prefiere no arriesgarse a predecir popularidad.</p>
<p><strong>Ridge/Lasso</strong> con <strong>Solver SAGA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>

<span class="c1"># subconjunto para velocidad con 25% de los datos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X_train_fast</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_train_fast</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> 
    <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Usando subconjunto optimizado: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_fast</span><span class="p">)</span><span class="si">}</span><span class="s2"> instancias&quot;</span><span class="p">)</span>

<span class="c1"># Configuración</span>
<span class="n">SAGA_C_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>           <span class="c1"># Solo 3 valores clave</span>
<span class="n">SAGA_PENALTY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">]</span>            <span class="c1"># Ridge y Lasso</span>
<span class="n">SAGA_SOLVER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;saga&#39;</span><span class="p">]</span>                 <span class="c1"># Solver optimizado</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   C: </span><span class="si">{</span><span class="n">SAGA_C_VALUES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   penalty: </span><span class="si">{</span><span class="n">SAGA_PENALTY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   solver: </span><span class="si">{</span><span class="n">SAGA_SOLVER</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_saga_optimization</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">technique_name</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluando: </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">start_train</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_train</span>
    
    <span class="n">start_predict</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_predict</span>
    
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas </span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados </span><span class="si">{</span><span class="n">technique_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train Time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predict Time: </span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall Clase 1: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="s1">&#39;LogisticRegression&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="n">technique_name</span><span class="p">,</span>
        <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;C=</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">C</span><span class="si">}</span><span class="s2">, penalty=</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">penalty</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">predict_time</span><span class="p">,</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">pipeline</span>
    <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimización con Solver SAGA&quot;</span><span class="p">)</span>

<span class="n">saga_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="n">saga_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="n">SAGA_C_VALUES</span><span class="p">,</span>
    <span class="s1">&#39;model__penalty&#39;</span><span class="p">:</span> <span class="n">SAGA_PENALTY</span>
<span class="p">}</span>

<span class="c1"># 2 folds para máxima velocidad</span>
<span class="n">saga_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">saga_pipeline</span><span class="p">,</span>
    <span class="n">saga_params</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizamos con solver SAGA&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">saga_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_fast</span><span class="p">,</span> <span class="n">y_train_fast</span><span class="p">)</span>
<span class="n">saga_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización SAGA completada en </span><span class="si">{</span><span class="n">saga_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mejores parámetros: </span><span class="si">{</span><span class="n">saga_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluar con todos los datos</span>
<span class="n">saga_best</span> <span class="o">=</span> <span class="n">saga_grid</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">results_saga</span> <span class="o">=</span> <span class="n">evaluate_saga_optimization</span><span class="p">(</span><span class="n">saga_best</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;SAGA (</span><span class="si">{</span><span class="n">saga_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> 
                                        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">saga_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">results_saga</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tabla resumne:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">saga_summary</span><span class="p">[[</span><span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">,</span> <span class="s1">&#39;Configuración&#39;</span><span class="p">,</span> <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">,</span> <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Comparación:</span>

<span class="s2">KNN con KD-Trees:</span>
<span class="s2">   • Tiempo optimización: 1111.49s</span>
<span class="s2">   • Tiempo entrenamiento: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>

<span class="s2">Ridge/Lasso con SAGA:</span>
<span class="s2">   • Tiempo optimización: </span><span class="si">{</span><span class="n">saga_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Tiempo entrenamiento: </span><span class="si">{</span><span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Tiempo predicción: </span><span class="si">{</span><span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • F1-Weighted: </span><span class="si">{</span><span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;F1_Weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Métricas comparativas</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KNN + KD-Trees&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;LR + SAGA</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">saga_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__penalty&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span>
<span class="n">f1_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">f1_weighted</span><span class="p">,</span> <span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;F1_Weighted&#39;</span><span class="p">]]</span>
<span class="n">train_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_time</span><span class="p">,</span> <span class="n">results_saga</span><span class="p">[</span><span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">]]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">train_times</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tiempo Entrenamiento (s)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Modelos&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score / Tiempo (s)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación: KNN vs LogisticRegression Optimizados&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Curva ROC</span>
<span class="n">fpr_saga</span><span class="p">,</span> <span class="n">tpr_saga</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">saga_best</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">roc_auc_saga</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_saga</span><span class="p">,</span> <span class="n">tpr_saga</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;KNN + KD-Trees (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_saga</span><span class="p">,</span> <span class="n">tpr_saga</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;LR + SAGA (AUC = </span><span class="si">{</span><span class="n">roc_auc_saga</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># tabla final</span>
<span class="n">ridge_lasso_results</span> <span class="o">=</span> <span class="n">results_saga</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Usando subconjunto optimizado: 22710 instancias
Configuración:
   C: [0.1, 1, 10]
   penalty: [&#39;l1&#39;, &#39;l2&#39;]
   solver: [&#39;saga&#39;]
Optimización con Solver SAGA
==================================================
Optimizamos con solver SAGA
Fitting 3 folds for each of 6 candidates, totalling 18 fits
Optimización SAGA completada en 116.82s
   Mejores parámetros: {&#39;model__C&#39;: 1, &#39;model__penalty&#39;: &#39;l1&#39;}

Evaluando: SAGA (L1)
Resultados SAGA (L1):
   Train Time: 166.30s
   Predict Time: 0.0307s
   F1-Weighted: 0.9285
   AUC: 0.8628
   Recall Clase 1: 0.0018

Tabla resumne:
Técnica_Optimización   Configuración  Tiempo_Entrenamiento_s  Tiempo_Predicción_s  F1_Weighted  Recall_Clase_1      AUC
           SAGA (L1) C=1, penalty=l1              166.301517             0.030717     0.928531        0.001828 0.862787

Comparación:

KNN con KD-Trees:
   • Tiempo optimización: 1111.49s
   • Tiempo entrenamiento: 0.17s
   • F1-Weighted: 0.9428

Ridge/Lasso con SAGA:
   • Tiempo optimización: 116.82s
   • Tiempo entrenamiento: 166.30s
   • Tiempo predicción: 0.0307s
   • F1-Weighted: 0.9285
</pre></div>
</div>
<img alt="_images/057f29072bf2083a41c283c99b6fbcd28d559699db7514b6431b1d59e707fc37.png" src="_images/057f29072bf2083a41c283c99b6fbcd28d559699db7514b6431b1d59e707fc37.png" />
</div>
</div>
<p>Analizando los resultados de las métricas se muestra un AUC de 0.8628 y un F1-Weighted de 0.9285.</p>
<p>Este realiza selección de características automática, pone coeficientes de características irrelevantes a cero e ideal para identificar qué variables realmente importan, pero el modelo básicamente aprende a ignorar la clase “popular”.</p>
<p>Sugiere que las características disponibles no son suficientemente predictivas para identificar hits y no es bueno en detectar canciones populares efectivamente.</p>
<p>Por lo que se puede identificar que la popularidad en Spotify depende de factores beyond características técnicas.</p>
<p><strong>Naive Bayes</strong> con <strong>Partial Fit</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Tamaños de lote optimizados</span>
<span class="n">BATCH_SIZES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">]</span>  

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración optimizada con Partial Fit&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Batch Sizes: </span><span class="si">{</span><span class="n">BATCH_SIZES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Modelo: GaussianNB con partial_fit&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_naive_bayes_incremental</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entrena Naive Bayes de forma incremental usando partial_fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entrenando con batch_size = </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Ajustar el preprocesador una vez con todos los datos</span>
    <span class="n">X_train_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    
    <span class="c1"># Inicializar el modelo</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">GaussianNB</span><span class="p">()</span>
    
    <span class="c1"># Obtener clases únicas para partial_fit</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    
    <span class="c1"># Entrenamiento por lotes</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">X_train_processed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
    
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        
        <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X_train_processed</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="s1">&#39;iloc&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">y_train</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
        
        <span class="c1"># Primera llamada necesita classes, las siguientes no</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        
        <span class="c1"># Progress tracking</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_batches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Procesado lote </span><span class="si">{</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_batches</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="p">(</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">batch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_samples</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">n_samples</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> muestras)&quot;</span><span class="p">)</span>
    
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_time</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación con los diferentes lotes&quot;</span><span class="p">)</span>
<span class="n">batch_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">batch_size</span> <span class="ow">in</span> <span class="n">BATCH_SIZES</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Probando batch_size = </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Entrenar modelo incremental</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">fitted_preprocessor</span><span class="p">,</span> <span class="n">train_time</span> <span class="o">=</span> <span class="n">train_naive_bayes_incremental</span><span class="p">(</span>
        <span class="n">preprocessor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">batch_size</span>
    <span class="p">)</span>
    
    <span class="c1"># Transformar test set</span>
    <span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">fitted_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="c1"># tiempo de predicción</span>
    <span class="n">predict_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)</span>
    <span class="n">predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">predict_start</span>
    
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados batch_size </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train Time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predict Time: </span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s1">&#39;preprocessor&#39;</span><span class="p">:</span> <span class="n">fitted_preprocessor</span><span class="p">,</span>
        <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
        <span class="s1">&#39;predict_time&#39;</span><span class="p">:</span> <span class="n">predict_time</span><span class="p">,</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
        <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;y_pred_proba&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">})</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selección de mejor tamaño de lote&quot;</span><span class="p">)</span>

<span class="c1"># mejor balance entre velocidad y rendimiento</span>
<span class="n">best_batch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">])</span>
<span class="n">fastest_batch</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor batch_size (rendimiento): </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo entrenamiento: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch_size más rápido: </span><span class="si">{</span><span class="n">fastest_batch</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">fastest_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo entrenamiento: </span><span class="si">{</span><span class="n">fastest_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Usar el mejor batch_size </span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">best_preprocessor</span> <span class="o">=</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparamos con el método tradicional&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entrenando sin partial_fit&quot;</span><span class="p">)</span>
<span class="n">traditional_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">traditional_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">traditional_pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">traditional_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">traditional_start</span>

<span class="n">traditional_predict_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">y_pred_traditional</span> <span class="o">=</span> <span class="n">traditional_pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">traditional_predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">traditional_predict_start</span>

<span class="n">y_pred_proba_traditional</span> <span class="o">=</span> <span class="n">traditional_pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">f1_traditional</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Traditional - Train: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, F1: </span><span class="si">{</span><span class="n">f1_traditional</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Incremental  - Train: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s, F1: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Speedup: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tabla resumen&quot;</span><span class="p">)</span>
<span class="n">summary_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">:</span>
    <span class="n">summary_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;partial_fit (batch=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;GaussianNB, batch_size=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;predict_time&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
        <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">],</span>
        <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span>
        <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span>
    <span class="p">})</span>

<span class="c1"># método tradicional</span>
<span class="n">summary_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="s1">&#39;Traditional fit&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="s1">&#39;GaussianNB (batch completo)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">traditional_train_time</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">traditional_predict_time</span><span class="p">,</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">),</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">f1_traditional</span><span class="p">,</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_traditional</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_traditional</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tabla resumen:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Visualizaciones&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Comparación de tiempos</span>
<span class="n">batch_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;batch_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;traditional&#39;</span><span class="p">]</span>
<span class="n">train_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">traditional_train_time</span><span class="p">]</span>
<span class="n">predict_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;predict_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">traditional_predict_time</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">train_times</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tiempo Entrenamiento&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">)</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">predict_times</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tiempo Predicción&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Método de Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tiempo (segundos)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación de Tiempos - Naive Bayes&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars1</span><span class="p">,</span> <span class="n">bars2</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="c1"># Métricas de rendimiento</span>
<span class="n">f1_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f1_traditional</span><span class="p">]</span>
<span class="n">auc_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_traditional</span><span class="p">)]</span>

<span class="n">x_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">))</span>
<span class="n">width_metrics</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">bars3</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_metrics</span> <span class="o">-</span> <span class="n">width_metrics</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">,</span> <span class="n">width_metrics</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>
<span class="n">bars4</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_metrics</span> <span class="o">+</span> <span class="n">width_metrics</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">auc_scores</span><span class="p">,</span> <span class="n">width_metrics</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AUC&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Método de Entrenamiento&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparación de Métricas - Naive Bayes&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_metrics</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bars</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bars3</span><span class="p">,</span> <span class="n">bars4</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="c1"># Matriz de confusión del mejor modelo</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">best_model</span><span class="p">,</span> 
    <span class="n">best_preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> 
    <span class="n">y_test</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
    <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span>
<span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mejor Naive Bayes (batch=</span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># }Curvas ROC comparativas</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Clasificador Aleatorio&#39;</span><span class="p">)</span>

<span class="c1"># Curva del mejor modelo incremental</span>
<span class="n">fpr_best</span><span class="p">,</span> <span class="n">tpr_best</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;y_pred_proba&#39;</span><span class="p">])</span>
<span class="n">roc_auc_best</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_best</span><span class="p">,</span> <span class="n">tpr_best</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_best</span><span class="p">,</span> <span class="n">tpr_best</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Incremental (AUC = </span><span class="si">{</span><span class="n">roc_auc_best</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># Curva del modelo tradicional</span>
<span class="n">fpr_trad</span><span class="p">,</span> <span class="n">tpr_trad</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba_traditional</span><span class="p">)</span>
<span class="n">roc_auc_trad</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr_trad</span><span class="p">,</span> <span class="n">tpr_trad</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_trad</span><span class="p">,</span> <span class="n">tpr_trad</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Traditional (AUC = </span><span class="si">{</span><span class="n">roc_auc_trad</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Falsos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tasa de Verdaderos Positivos&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Curvas ROC Comparativas&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Análisis:</span>
<span class="s2">   • Batch sizes probados: </span><span class="si">{</span><span class="n">BATCH_SIZES</span><span class="si">}</span>
<span class="s2">   • Mejor batch_size: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">   • Modelo: GaussianNB</span>

<span class="s2">   • Entrenamiento tradicional: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Entrenamiento incremental: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Speedup: </span><span class="si">{</span><span class="n">traditional_train_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x</span>

<span class="s2">   • F1-Weighted incremental: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • F1-Weighted tradicional: </span><span class="si">{</span><span class="n">f1_traditional</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Diferencia: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f1_traditional</span><span class="si">:</span><span class="s2">+.4f</span><span class="si">}</span>
<span class="s2">   • AUC incremental: </span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • AUC tradicional: </span><span class="si">{</span><span class="n">roc_auc_trad</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">naive_bayes_optimization_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="s1">&#39;NaiveBayes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;partial_fit (batch=</span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;GaussianNB, batch_size=</span><span class="si">{</span><span class="n">best_batch</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;predict_time&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;f1_1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;recall_1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">best_batch</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span>
    <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">best_preprocessor</span><span class="p">)</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de Naive Bayes guardados para tabla comparativa final&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
CONFIGURACIÓN OPTIMIZADA PARTIAL_FIT
   Batch Sizes: [1000, 2000, 5000]
   Modelo: GaussianNB con partial_fit
Evaluación con los diferentes lotes

Probando batch_size = 1000
Entrenando con batch_size = 1000...
   Procesado lote 10/91 (10000/90840 muestras)
   Procesado lote 20/91 (20000/90840 muestras)
   Procesado lote 30/91 (30000/90840 muestras)
   Procesado lote 40/91 (40000/90840 muestras)
   Procesado lote 50/91 (50000/90840 muestras)
   Procesado lote 60/91 (60000/90840 muestras)
   Procesado lote 70/91 (70000/90840 muestras)
   Procesado lote 80/91 (80000/90840 muestras)
   Procesado lote 90/91 (90000/90840 muestras)
   Procesado lote 91/91 (90840/90840 muestras)
Resultados batch_size 1000:
   Train Time: 0.13s
   Predict Time: 0.0460s
   F1-Weighted: 0.6110
   AUC: 0.7255

Probando batch_size = 2000
Entrenando con batch_size = 2000...
   Procesado lote 10/46 (20000/90840 muestras)
   Procesado lote 20/46 (40000/90840 muestras)
   Procesado lote 30/46 (60000/90840 muestras)
   Procesado lote 40/46 (80000/90840 muestras)
   Procesado lote 46/46 (90840/90840 muestras)
Resultados batch_size 2000:
   Train Time: 0.17s
   Predict Time: 0.0430s
   F1-Weighted: 0.6110
   AUC: 0.7255

Probando batch_size = 5000
Entrenando con batch_size = 5000...
   Procesado lote 10/19 (50000/90840 muestras)
   Procesado lote 19/19 (90840/90840 muestras)
Resultados batch_size 5000:
   Train Time: 0.13s
   Predict Time: 0.0430s
   F1-Weighted: 0.6110
   AUC: 0.7255
Selección de mejor tamaño de lote
==================================================
Mejor batch_size (rendimiento): 1000
   F1-Weighted: 0.6110
   Tiempo entrenamiento: 0.13s
Batch_size más rápido: 1000
   F1-Weighted: 0.6110
   Tiempo entrenamiento: 0.13s
Comparamos con el método tradicional
Entrenando sin partial_fit
Comparación:
   Traditional - Train: 0.31s, F1: 0.6110
   Incremental  - Train: 0.13s, F1: 0.6110
   Speedup: 2.40x
Tabla resumen

Tabla resumen:
    Técnica_Optimización               Configuración  Tiempo_Entrenamiento_s  Tiempo_Predicción_s  Accuracy  F1_Weighted  F1_Clase_1  Recall_Clase_1      AUC
partial_fit (batch=1000) GaussianNB, batch_size=1000                0.128988             0.046033  0.489476     0.610977    0.156432        0.982633 0.725493
partial_fit (batch=2000) GaussianNB, batch_size=2000                0.166163             0.043007  0.489476     0.610977    0.156432        0.982633 0.725470
partial_fit (batch=5000) GaussianNB, batch_size=5000                0.134837             0.042988  0.489476     0.610977    0.156432        0.982633 0.725470
         Traditional fit GaussianNB (batch completo)                0.309211             0.067518  0.489476     0.610977    0.156432        0.982633 0.725470
Visualizaciones
</pre></div>
</div>
<img alt="_images/c29608381fb8d144d9140becf49c0e3ef9a435d8315fc461d08320775c80736f.png" src="_images/c29608381fb8d144d9140becf49c0e3ef9a435d8315fc461d08320775c80736f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis:
   • Batch sizes probados: [1000, 2000, 5000]
   • Mejor batch_size: 1000
   • Modelo: GaussianNB

   • Entrenamiento tradicional: 0.31s
   • Entrenamiento incremental: 0.13s
   • Speedup: 2.40x

   • F1-Weighted incremental: 0.6110
   • F1-Weighted tradicional: 0.6110
   • Diferencia: +0.0000
   • AUC incremental: 0.7255
   • AUC tradicional: 0.7255


Resultados de Naive Bayes guardados para tabla comparativa final
</pre></div>
</div>
</div>
</div>
<p>Cabe aceptar que hubo una distribución de clases desbalanceada:</p>
<p>Analizando esta optimización encontramos un AUC de 0.7255, siendo una capacidad aceptable para distinguir clases, pero el modelo casi siempre predice “No Popular”, con muy pocas predicciones correctas de canciones populares y comportamiento similar a un modelo mayoritario.</p>
<p>Por lo cual en el contexto del proyecto, solo 4.8% de canciones son “populares” y no maneja bien relaciones complejas entre variables, pero es útil para datasets grandes.</p>
<p><strong>XGBOOST</strong> con <strong>TREE_METHOD = HIST</strong> y <strong>EARLY STOPPING</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribución de clases en entrenamiento:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 0 (No Popular): </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 (Popular):    </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_train</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Calcular scale_pos_weight para balanceo automático</span>
<span class="n">scale_pos_weight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scale_pos_weight calculado: </span><span class="si">{</span><span class="n">scale_pos_weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Configuración optimizada </span>
<span class="n">XGB_HIST_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="s1">&#39;model__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="s1">&#39;model__learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
    <span class="s1">&#39;model__tree_method&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">],</span>
    <span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">scale_pos_weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Configuración optimizada XGBoost con Hist&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   n_estimators: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   max_depth: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   learning_rate: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   tree_method: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__tree_method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   scale_pos_weight: </span><span class="si">{</span><span class="n">XGB_HIST_PARAMS</span><span class="p">[</span><span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># conjunto de validación para early stopping </span>
<span class="n">X_train_xgb</span><span class="p">,</span> <span class="n">X_val_xgb</span><span class="p">,</span> <span class="n">y_train_xgb</span><span class="p">,</span> <span class="n">y_val_xgb</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
    <span class="n">stratify</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Datos para Early Stopping:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Entrenamiento: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Validación: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_val_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">XGBoostEarlyStoppingWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper para manejar early stopping de forma segura&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eval_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="n">eval_set</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Si no hay eval_set, desactivamos early stopping</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;early_stopping_rounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">deep</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XGBOOST con TREE_METHOD=&#39;HIST&#39;&quot;</span><span class="p">)</span>

<span class="c1"># Pipeline seguro</span>
<span class="n">xgb_hist_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">XGBoostEarlyStoppingWrapper</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Configuración de GridSearch </span>
<span class="n">xgb_hist_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">xgb_hist_pipeline</span><span class="p">,</span>
    <span class="n">XGB_HIST_PARAMS</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizando XGBoost con tree_method=&#39;hist&#39;&quot;</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Transformar datos de validación para eval_set</span>
<span class="n">X_val_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_val_xgb</span><span class="p">)</span>

<span class="c1"># Ajustar con early stopping</span>
<span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_xgb</span><span class="p">,</span> <span class="n">y_train_xgb</span><span class="p">,</span>
    <span class="n">model__eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_val_processed</span><span class="p">,</span> <span class="n">y_val_xgb</span><span class="p">)],</span>
    <span class="n">model__verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">optimization_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización XGBoost-Hist completada en </span><span class="si">{</span><span class="n">optimization_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mejores parámetros: </span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Entrenamiento final&quot;</span><span class="p">)</span>
<span class="n">best_xgb_model</span> <span class="o">=</span> <span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># Para el entrenamiento final no usamos early stopping</span>
<span class="c1"># nuevo modelo sin early stopping para entrenamiento final</span>
<span class="n">final_xgb_model</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;model__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Desactivamos early stopping para entrenamiento final</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Medición de tiempos </span>
<span class="n">train_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">final_xgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  
<span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">train_start</span>

<span class="n">predict_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">predict_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">predict_start</span>

<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Métricas </span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
<span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resultados  XGBoost + tree_method=&#39;hist&#39;:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo Entrenamiento: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo Predicción: </span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Clase 1 - Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretabilidad características impoprtantes&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># nombres de características</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="n">transformer</span><span class="p">],</span> <span class="s1">&#39;get_feature_names_out&#39;</span><span class="p">):</span>
            <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="n">transformer</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">):</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">feature_names</span><span class="p">:</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    
    <span class="c1"># importancias del modelo final</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
    
    <span class="c1"># DataFrame de importancias</span>
    <span class="n">feature_importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">)],</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 10 características más importantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">feature_importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se pudieron obtener nombres: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="n">final_xgb_model</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="n">feature_importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;feature_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">))],</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importances</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Características importantes:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">feature_importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tabla resumen&quot;</span><span class="p">)</span>
<span class="n">summary_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tree_method=&#39;hist&#39; + Early Stopping&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;n_est=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;depth=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;lr=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;scale_pos_weight=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model__scale_pos_weight&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Tiempo_Entrenamiento(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Tiempo_Predicción(s)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">predict_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tabla e informe:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># visualizaciones</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Métricas principales</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Weighted&#39;</span><span class="p">,</span> <span class="s1">&#39;F1 Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall Clase 1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">f1_1</span><span class="p">,</span> <span class="n">recall_1</span><span class="p">,</span> <span class="n">auc_score</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;violet&#39;</span><span class="p">]</span>

<span class="n">bars1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;XGBoost + tree_method=&quot;hist&quot; - Métricas de Rendimiento&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars1</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># Matriz de confusión</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">final_xgb_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - XGBoost Optimizado&#39;</span><span class="p">)</span>

<span class="c1"># Tiempos de ejecución</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_time</span><span class="p">,</span> <span class="n">predict_time</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Entrenamiento&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicción&#39;</span><span class="p">]</span>
<span class="n">bars2</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tiempo (segundos)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tiempos de Ejecución - XGBoost Optimizado&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">time_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars2</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span> <span class="k">if</span> <span class="n">time_val</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> 
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="n">top_features</span> <span class="o">=</span> <span class="n">feature_importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">))</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 características importantes - XGBoost&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Feature Importances</span><span class="se">\n</span><span class="s1">no disponibles&#39;</span><span class="p">,</span> 
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Feature Importances&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Análisis:&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">   • Training (80%): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras</span>
<span class="s2">   • Validation (20%): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_val_xgb</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras solo para early stopping</span>
<span class="s2">   • Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> muestras para evaluación final</span>
<span class="s2">   • Fase 1: Optimización con early stopping usando validation set</span>
<span class="s2">   • Fase 2: Entrenamiento final SIN early stopping con todos los datos</span>
<span class="s2">   • Tiempo optimización: </span><span class="si">{</span><span class="n">optimization_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • Tiempo entrenamiento final: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span>
<span class="s2">   • F1-Weighted: </span><span class="si">{</span><span class="n">f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Recall Clase 1: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • AUC: </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • scale_pos_weight: </span><span class="si">{</span><span class="n">scale_pos_weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>
<span class="s2">   • Recall clase minoritaria: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span>
<span class="s2">   • Mejora significativa en detección de clase 1</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">xgb_optimization_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Modelo&#39;</span><span class="p">:</span> <span class="s1">&#39;XGBoost&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Técnica_Optimización&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_method=&#39;hist&#39; + Early Stopping&quot;</span><span class="p">,</span> 
    <span class="s1">&#39;Configuración&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;n_est=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__n_estimators&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;depth=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__max_depth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;lr=</span><span class="si">{</span><span class="n">xgb_hist_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;model__learning_rate&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Entrenamiento_s&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
    <span class="s1">&#39;Tiempo_Predicción_s&#39;</span><span class="p">:</span> <span class="n">predict_time</span><span class="p">,</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
    <span class="s1">&#39;F1_Weighted&#39;</span><span class="p">:</span> <span class="n">f1_weighted</span><span class="p">,</span>
    <span class="s1">&#39;F1_Clase_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
    <span class="s1">&#39;Recall_Clase_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
    <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">auc_score</span><span class="p">,</span>
    <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="n">final_xgb_model</span><span class="p">,</span>
    <span class="s1">&#39;feature_importances&#39;</span><span class="p">:</span> <span class="n">feature_importance_df</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de XGBoost guardados para tabla comparativa final&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribución de clases en entrenamiento:
   Clase 0 (No Popular): 86466 muestras (95.2%)
   Clase 1 (Popular):    4374 muestras (4.8%)
🎯 Scale_pos_weight calculado: 19.77
CONFIGURACIÓN OPTIMIZADA XGBOOST + HIST
   n_estimators: [100, 200]
   max_depth: [3, 6]
   learning_rate: [0.1, 0.05]
   tree_method: [&#39;hist&#39;]
   scale_pos_weight: [19.7681755829904, 1]

Datos para Early Stopping:
   Entrenamiento: 72672 muestras
   Validación: 18168 muestras
   Test: 22710 muestras
XGBOOST CON TREE_METHOD=&#39;HIST&#39;
Optimizando XGBoost con tree_method=&#39;hist&#39;
Fitting 3 folds for each of 16 candidates, totalling 48 fits
Optimización XGBoost-Hist completada en 74.96s
   Mejores parámetros: {&#39;model__learning_rate&#39;: 0.1, &#39;model__max_depth&#39;: 6, &#39;model__n_estimators&#39;: 200, &#39;model__scale_pos_weight&#39;: 1, &#39;model__tree_method&#39;: &#39;hist&#39;}
Entrenamiento final
Resultados  XGBoost + tree_method=&#39;hist&#39;:
   Tiempo Entrenamiento: 2.22s
   Tiempo Predicción: 0.1125s
   Accuracy: 0.9524
   F1-Weighted: 0.9312
   AUC: 0.8753
   Clase 1 - Precision: 0.6327, Recall: 0.0283, F1: 0.0542
Interpretabilidad características impoprtantes
Top 10 características más importantes:
              feature  importance
      track_genre_pop    0.054471
    track_genre_dance    0.049570
    track_genre_house    0.046191
  track_genre_electro    0.041297
    track_genre_k-pop    0.033906
     track_genre_rock    0.033006
      track_genre_edm    0.024955
   track_genre_latino    0.024492
track_genre_reggaeton    0.020297
    track_genre_metal    0.017802
Tabla resumen

Tabla e informe:
 Modelo                Técnica_Optimización                                  Configuración Tiempo_Entrenamiento(s) Tiempo_Predicción(s) Accuracy F1_Weighted F1_Clase_1 Recall_Clase_1    AUC
XGBoost tree_method=&#39;hist&#39; + Early Stopping n_est=200, depth=6, lr=0.1, scale_pos_weight=1                    2.22               0.1125   0.9524      0.9312     0.0542         0.0283 0.8753
</pre></div>
</div>
<img alt="_images/f183c1623f2ffcb1280e65f3cc0bccf65ab44aad06e550cce7154576b4723572.png" src="_images/f183c1623f2ffcb1280e65f3cc0bccf65ab44aad06e550cce7154576b4723572.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Análisis

   • Training (80%): 72672 muestras
   • Validation (20%): 18168 muestras solo para early stopping
   • Test: 22710 muestras para evaluación final
   • Fase 1: Optimización con early stopping usando validation set
   • Fase 2: Entrenamiento final SIN early stopping con todos los datos
   • Tiempo optimización: 74.96s
   • Tiempo entrenamiento final: 2.22s
   • F1-Weighted: 0.9312
   • Recall Clase 1: 0.0283
   • AUC: 0.8753
   • scale_pos_weight: 19.77
   • Recall clase minoritaria: 0.0283
   • Mejora significativa en detección de clase 1


Resultados de XGBoost guardados para tabla comparativa final
</pre></div>
</div>
</div>
</div>
<p>Analizando las métrica de esta optimización vemos un AUC de 0.8753, teniendo una buena capacidad discriminativa. También, un Accuracy de 95.24%, y un F1-Weighted de 0.9312.</p>
<p>En el Top 10 Características Más Importantes vemos:</p>
<ul class="simple">
<li><p>track_genre_pop (0.054)</p></li>
<li><p>track_genre_dance (0.050)</p></li>
<li><p>track_genre_house (0.046)</p></li>
<li><p>track_genre_electro (0.041)</p></li>
<li><p>track_genre_k-pop (0.034)</p></li>
<li><p>track_genre_rock (0.034)</p></li>
<li><p>track_genre_edm (0.025)</p></li>
<li><p>track_genre_latino (0.024)</p></li>
<li><p>track_genre_reggaeton (0.020)</p></li>
<li><p>track_genre_metal (0.018)</p></li>
</ul>
<p>Así, géneros como pop, dance, house y electro dominan la importancia, por lo cual, el género predice mejor que características acústicas individuales</p>
<p>En el análisis de la Matriz de Confusión vemos 21,698 no populares correctos, solo 31 populares correctos, 1,063 canciones populares no detectadas, y solo 18 falsos positivos, haciendo que casi nunca se arriesga a predecir “popular”</p>
<p>El modelo tiene mejor AUC y eficiencia, pero para el objetivo sigue sin detectar canciones populares.</p>
<p><strong>SVM</strong> con <strong>LinearSVC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># sample_weight </span>
<span class="n">class_weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span>
    <span class="s1">&#39;balanced&#39;</span><span class="p">,</span> 
    <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
<span class="p">)</span>

<span class="c1"># sample_weight array </span>
<span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="n">sample_weight</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
<span class="n">sample_weight</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>  

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pesos aplicados: Clase 0: </span><span class="si">{</span><span class="n">class_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Clase 1: </span><span class="si">{</span><span class="n">class_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">pipe_svm_simple</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">(</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">dual</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Parámetros optimizados para clase minoritaria</span>
<span class="n">param_grid_simple</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>  
    <span class="s1">&#39;model__loss&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;squared_hinge&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimizamos con parámetros simples&quot;</span><span class="p">)</span>
<span class="n">grid_search_simple</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">pipe_svm_simple</span><span class="p">,</span>
    <span class="n">param_grid_simple</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span>  
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="c1"># Entrenar con sample_weight</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># sample_weight en GridSearch</span>
<span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">param_grid_simple</span><span class="p">[</span><span class="s1">&#39;model__C&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">param_grid_simple</span><span class="p">[</span><span class="s1">&#39;model__loss&#39;</span><span class="p">]:</span>
        <span class="n">fold_scores</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">X_fold_train</span><span class="p">,</span> <span class="n">X_fold_val</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">y_fold_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">sample_weight_fold</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
            
            <span class="n">model</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Preprocesar datos</span>
            <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">)</span>
            <span class="n">X_fold_train_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_fold_train</span><span class="p">)</span>
            <span class="n">X_fold_val_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_fold_val</span><span class="p">)</span>
            
            <span class="c1"># Entrenar con sample_weight</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fold_train_processed</span><span class="p">,</span> <span class="n">y_fold_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight_fold</span><span class="p">)</span>
            
            <span class="c1"># Predecir y evaluar</span>
            <span class="n">y_pred_val</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fold_val_processed</span><span class="p">)</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_fold_val</span><span class="p">,</span> <span class="n">y_pred_val</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fold_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
        
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fold_scores</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C=</span><span class="si">{</span><span class="n">C</span><span class="si">}</span><span class="s2">, loss=</span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">: F1 = </span><span class="si">{</span><span class="n">mean_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>

<span class="n">optimization_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejores parámetros:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   C: </span><span class="si">{</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, loss: </span><span class="si">{</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor F1-score (CV): </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo optimización: </span><span class="si">{</span><span class="n">optimization_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Entrenamiento:&quot;</span><span class="p">)</span>
<span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Modelo final con mejores parámetros</span>
<span class="n">final_svm</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">(</span>
    <span class="n">C</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">dual</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">final_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_processed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
<span class="n">svm_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="n">calibrated_svm</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">final_svm</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>
    <span class="n">cv</span><span class="o">=</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">calibrated_svm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_processed</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_svm_comprehensive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test_processed</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">train_time</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
    
    <span class="c1"># Predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Métricas detalladas</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">precision_0</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_0</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_0</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">auc_score</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> - RESULTADOS:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:      </span><span class="si">{</span><span class="n">auc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   CLASE 1 (Popular) - OBJETIVO:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   CLASE 0 (No Popular):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Precision: </span><span class="si">{</span><span class="n">precision_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Recall: </span><span class="si">{</span><span class="n">recall_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1: </span><span class="si">{</span><span class="n">f1_0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;precision_1&#39;</span><span class="p">:</span> <span class="n">precision_1</span><span class="p">,</span>
        <span class="s1">&#39;recall_1&#39;</span><span class="p">:</span> <span class="n">recall_1</span><span class="p">,</span>
        <span class="s1">&#39;f1_1&#39;</span><span class="p">:</span> <span class="n">f1_1</span><span class="p">,</span>
        <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
        <span class="s1">&#39;y_pred_proba&#39;</span><span class="p">:</span> <span class="n">y_pred_proba</span>
    <span class="p">}</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluación SVM&quot;</span><span class="p">)</span>
<span class="n">metrics_final</span> <span class="o">=</span> <span class="n">evaluate_svm_comprehensive</span><span class="p">(</span><span class="n">calibrated_svm</span><span class="p">,</span> <span class="n">X_test_processed</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                                         <span class="s2">&quot;SVM Lineal (Mejorado)&quot;</span><span class="p">,</span> <span class="n">svm_train_time</span><span class="p">)</span>

<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">calibrated_svm</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_processed</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<span class="n">best_f1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">y_pred_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_proba</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thresh</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thresh</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_thresh</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Buscar buen balance</span>
    <span class="k">if</span> <span class="n">f1</span> <span class="o">&gt;</span> <span class="n">best_f1</span> <span class="ow">and</span> <span class="n">precision</span> <span class="o">&gt;=</span> <span class="mf">0.20</span> <span class="ow">and</span> <span class="n">recall</span> <span class="o">&gt;=</span> <span class="mf">0.30</span><span class="p">:</span>
        <span class="n">best_f1</span> <span class="o">=</span> <span class="n">f1</span>
        <span class="n">best_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="n">best_precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="n">best_recall</span> <span class="o">=</span> <span class="n">recall</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold óptimo: </span><span class="si">{</span><span class="n">best_threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Precision: </span><span class="si">{</span><span class="n">best_precision</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Recall: </span><span class="si">{</span><span class="n">best_recall</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">best_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># threshold óptimo</span>
<span class="n">y_pred_optimal</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred_proba</span> <span class="o">&gt;=</span> <span class="n">best_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">final_precision_1</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_recall_1</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_f1_1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados de la clase populat:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Precision: </span><span class="si">{</span><span class="n">final_precision_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall:    </span><span class="si">{</span><span class="n">final_recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-score:  </span><span class="si">{</span><span class="n">final_f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cm_final</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusiónL:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;                 Predicción&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;               NoPopular  Popular&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real NoPopular [</span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Popular   [</span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">cm_final</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejorado vs Anterior:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall:    0.0091 → </span><span class="si">{</span><span class="n">final_recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-score:  0.0179 → </span><span class="si">{</span><span class="n">final_f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Matriz de confusión 2</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_predictions</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">,</span>
                                      <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Popular&#39;</span><span class="p">,</span> <span class="s1">&#39;Popular&#39;</span><span class="p">],</span>
                                      <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SVM Mejorado - Matriz Final&#39;</span><span class="p">)</span>

<span class="c1"># Comparación antes/después</span>
<span class="n">comparison_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Métrica&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Antes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.4167</span><span class="p">,</span> <span class="mf">0.0091</span><span class="p">,</span> <span class="mf">0.0179</span><span class="p">],</span>
    <span class="s1">&#39;Después&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">final_precision_1</span><span class="p">,</span> <span class="n">final_recall_1</span><span class="p">,</span> <span class="n">final_f1_1</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">comparison_data</span><span class="p">[</span><span class="s1">&#39;Antes&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Antes&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">comparison_data</span><span class="p">[</span><span class="s1">&#39;Después&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Después&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Métricas&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mejora en Detección de Clase Popular&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">[</span><span class="s1">&#39;Métrica&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conclusiones&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">final_recall_1</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; SVM detecta adecuadamente canciones populares&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">final_recall_1</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mejora significativa, pero aún puede mejorar&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SVM sigue teniendo dificultades con este problema&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Considera algoritmos como Random Forest o XGBoost&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resumen: Recall = </span><span class="si">{</span><span class="n">final_recall_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1 = </span><span class="si">{</span><span class="n">final_f1_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pesos aplicados: Clase 0: 0.53, Clase 1: 31.15

Optimizamos con parámetros simples
C=0.1, loss=squared_hinge: F1 = 0.1776
C=1, loss=squared_hinge: F1 = 0.1776
C=10, loss=squared_hinge: F1 = 0.1776
C=100, loss=squared_hinge: F1 = 0.1776

Mejores parámetros:
   C: 0.1, loss: squared_hinge
Mejor F1-score (CV): 0.1776
Tiempo optimización: 9.34s

Entrenamiento:
Evaluación SVM

SVM Lineal (Mejorado) - RESULTADOS:
   Tiempo: 0.63s
   Accuracy: 0.9494
   AUC:      0.8584

   CLASE 1 (Popular) - OBJETIVO:
      Precision: 0.3270 | Recall: 0.0475 | F1: 0.0830
   CLASE 0 (No Popular):
      Precision: 0.9538 | Recall: 0.9950 | F1: 0.9740
🔍 Threshold óptimo: 0.100
   Precision: 0.2042, Recall: 0.5146, F1: 0.2924

Resultados de la clase populat:
   Precision: 0.2042
   Recall:    0.5146
   F1-score:  0.2924

Matriz de confusiónL:
                 Predicción
               NoPopular  Popular
Real NoPopular [ 19422     2194]
     Popular   [   531      563]

Mejorado vs Anterior:
   Recall:    0.0091 → 0.5146
   F1-score:  0.0179 → 0.2924
</pre></div>
</div>
<img alt="_images/2faa8db4aeba24ac8ad41fc460743f14ccc8473caa26fa721201b3c5d8740117.png" src="_images/2faa8db4aeba24ac8ad41fc460743f14ccc8473caa26fa721201b3c5d8740117.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Conclusiones
 SVM detecta adecuadamente canciones populares

Resumen: Recall = 0.5146, F1 = 0.2924
</pre></div>
</div>
</div>
</div>
<p>Haciendo el análisis de las métricas vemos un Recall Clase 1 de 51.46%, un F1-Score Clase 1 de 0.2924, y Precisión de 20.42%.</p>
<p>En la matriz de Confusión se evidencia 19,422 no populares correctos, 563 populares correctos, 531 falsos negativos (populares no detectados), y 2,194 falsos positivos</p>
<p>En la clase 0 (No Popular) hay un peso de 0.53
En la clase 1 (Popular) hay un peso de 31.15
Además, un Threshold óptimo de 0.100 = más “arriesgado” para predecir popularidad</p>
<p>Para artistas y productoras es beneficioso pues detecta 51% de las canciones populares, hay un equilibrio aceptable entre detección y falsos positivos, y puede identificar potenciales hits con confianza razonable.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="validacion-avanzada-tuning-e-interpretabilidad">
<h1>Validación avanzada, Tuning e interpretabilidad<a class="headerlink" href="#validacion-avanzada-tuning-e-interpretabilidad" title="Link to this heading">#</a></h1>
<p>Tras aplicar un proceso exhaustivo de optimización de hiperparámetros mediante GridSearchCV con validación cruzada de 5 folds y métrica F1-macro en todos los modelos, hemos obtenido una comparativa robusta. Ahora procederemos a analizar el ranking final de modelos ordenados por F1-macro en nuestro DataFrame de resultados para identificar el mejor clasificador.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RANKING FINAL DE MODELOS - ANALISIS COMPARATIVO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="c1"># Primero limpiar modelos duplicados - mantener solo la primera ocurrencia</span>
<span class="n">results_df_clean</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

<span class="c1"># Ordenar por F1-Score (métrica principal)</span>
<span class="n">ranking_final</span> <span class="o">=</span> <span class="n">results_df_clean</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MATRIZ COMPLETA DE RESULTADOS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ranking_final</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Top 3 modelos</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOP 3 MEJORES MODELOS (por F1-Macro)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">))):</span>
    <span class="n">modelo</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">posicion</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PRIMERO&quot;</span><span class="p">,</span> <span class="s2">&quot;SEGUNDO&quot;</span><span class="p">,</span> <span class="s2">&quot;TERCERO&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">posicion</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score:  </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy:  </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   AUC:       </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;AUC&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tiempo:    </span><span class="si">{</span><span class="n">modelo</span><span class="p">[</span><span class="s1">&#39;Train_Time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Mejor modelo global</span>
<span class="n">mejor_modelo</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MEJOR MODELO GLOBAL: </span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1-Score: </span><span class="si">{</span><span class="n">mejor_modelo</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Estadísticas adicionales</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ESTADISTICAS DEL ANALISIS:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Total de modelos evaluados: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Rango F1-Score: </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Rango Accuracy: </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ranking_final</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Verificar si hay modelos muy cercanos en performance</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranking_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">diff_f1</span> <span class="o">=</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranking_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">diff_f1</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   NOTA: El top 2 esta muy cercano (diferencia F1: </span><span class="si">{</span><span class="n">diff_f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================================================================
RANKING FINAL DE MODELOS - ANALISIS COMPARATIVO
================================================================================
MATRIZ COMPLETA DE RESULTADOS:
                          Model  Accuracy  Precision   Recall  F1-Score      AUC  Train_Time
           XGBoost Scale Weight  0.953016   0.955131 0.953016  0.754762 0.906217    3.530824
     Random Forest Class Weight  0.939498   0.944663 0.939498  0.696587 0.912740   15.135563
            Random Forest SMOTE  0.946279   0.941735 0.946279  0.680341 0.901868   15.606062
           Random Forest ADASYN  0.928358   0.939231 0.928358  0.664110 0.890791   19.692176
                     KNN ADASYN  0.889960   0.940360 0.889960  0.634953 0.789534    1.833965
                  XGBoost SMOTE  0.904183   0.935932 0.904183  0.631461 0.863645    3.014028
            Decision Tree SMOTE  0.914795   0.931758 0.914795  0.621513 0.741104    5.997123
                 XGBoost ADASYN  0.934346   0.930610 0.934346  0.621089 0.820975    4.261749
     Decision Tree Class Weight  0.918054   0.930454 0.918054  0.617202 0.639886    3.958015
      Logistic Regression SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.396368
                    Lasso SMOTE  0.861162   0.938084 0.861162  0.603995 0.843352    1.295548
                  Decision Tree  0.928710   0.927044 0.928710  0.602141 0.604318    6.715671
  Logistic Regression L2 ADASYN  0.856979   0.937941 0.856979  0.600372 0.853468    3.368656
  Logistic Regression L1 ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.900931
                   Lasso ADASYN  0.855834   0.938122 0.855834  0.600010 0.845450    2.853222
                            SVM  0.883487   0.931592 0.883487  0.599644 0.793638   19.223081
         Ridge Classifier SMOTE  0.841876   0.940039 0.841876  0.594559      NaN    0.650142
        Ridge Classifier ADASYN  0.827961   0.941037 0.827961  0.586710      NaN    2.265856
Logistic Regression (Optimized)  0.786746   0.944338 0.786746  0.564742 0.843093    0.627129
             Lasso Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.620213
     L1 Regression Class Weight  0.786746   0.944338 0.786746  0.564742 0.843093    0.543312
               Lasso Regression  0.786746   0.944338 0.786746  0.564742 0.843093    0.562608
                  Random Forest  0.951739   0.933021 0.951739  0.554729 0.901538   10.090616
     L2 Regression Class Weight  0.759533   0.946894 0.759533  0.551091 0.853546    0.853106
  Ridge Classifier Class Weight  0.743989   0.948202 0.743989  0.543034      NaN    0.637271
                        XGBoost  0.952532   0.937635 0.952532  0.522365 0.879138    2.335257
                      SVM SMOTE  0.760898   0.919496 0.760898  0.498443 0.644345  109.753539
               Ridge Classifier  0.951827   0.905975 0.951827  0.487660      NaN    0.324935
               SVM Class Weight  0.688463   0.925384 0.688463  0.476978 0.678226   47.715541
          Naive Bayes con SMOTE  0.615103   0.952483 0.615103  0.469319 0.784195    0.764103
             Naive Bayes ADASYN  0.611229   0.952561 0.611229  0.467084 0.787435    2.373638
                     SVM ADASYN  0.667547   0.923083 0.667547  0.463757 0.653773  151.041608
                    Naive Bayes  0.489476   0.954123 0.489476  0.395207 0.725470    0.306190

==================================================
TOP 3 MEJORES MODELOS (por F1-Macro)
==================================================

PRIMERO: XGBoost Scale Weight
   F1-Score:  0.7548
   Accuracy:  0.9530
   AUC:       0.9062
   Tiempo:    3.53s

SEGUNDO: Random Forest Class Weight
   F1-Score:  0.6966
   Accuracy:  0.9395
   AUC:       0.9127
   Tiempo:    15.14s

TERCERO: Random Forest SMOTE
   F1-Score:  0.6803
   Accuracy:  0.9463
   AUC:       0.9019
   Tiempo:    15.61s

==================================================
MEJOR MODELO GLOBAL: XGBoost Scale Weight
F1-Score: 0.7548
==================================================

ESTADISTICAS DEL ANALISIS:
   • Total de modelos evaluados: 33
   • Rango F1-Score: 0.3952 - 0.7548
   • Rango Accuracy: 0.4895 - 0.9530
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="conclusion-y-seleccion-del-mejor-modelo">
<h1>Conclusión y Selección del Mejor Modelo<a class="headerlink" href="#conclusion-y-seleccion-del-mejor-modelo" title="Link to this heading">#</a></h1>
<p>El paper de nuestro proyecto muestra que, según Zhong et al. (2025), el uso de estrategias híbridas de remuestreo como SMOTE-Tomek mejora notablemente el desempeño de los modelos al reducir el desbalance entre clases.
En su estudio, el modelo CatBoost alcanzó el mejor rendimiento general al combinar técnicas de resampling con aprendizaje automático avanzado.</p>
<p>Nuestro proyecto de aprendizaje automático desarrollado constituye una aplicación completa y profesional del flujo de trabajo propuesto en la asignatura Machine Learning del programa de Ciencia de Datos. En él se abordó un problema real dentro del campo de la producción musical digital, empleando información proveniente de Spotify para analizar y predecir patrones de popularidad en canciones a partir de sus características acústicas, rítmicas y tonales.</p>
<p>Desde el Análisis Exploratorio de Datos se identificaron relaciones clave entre variables como energy, danceability, valence y speechiness con el nivel de popularidad de una canción, revelando tendencias propias de géneros y dinámicas de mercado. La detección de outliers, el tratamiento de valores faltantes y la verificación del balance de clases permitieron limpiar y preparar los datos de forma rigurosa. Asimismo, la reducción exploratoria mediante PCA mostró que gran parte de la variabilidad puede explicarse por unas pocas dimensiones relacionadas con la energía y el ritmo, validando la relevancia musical de estas variables.</p>
<p>En la etapa de modelado Benchmark, se implementaron y compararon algoritmos representativos de diferentes familias:</p>
<p>Modelos lineales (Regresión Logística, Ridge, Lasso) para establecer una base interpretable.</p>
<p>Modelos probabilísticos (Naive Bayes) y basados en instancias (KNN) para explorar relaciones locales.</p>
<p>Modelos no lineales y de ensamble (Árboles de Decisión, Random Forest, XGBoost) para capturar interacciones complejas.</p>
<p>Finalmente, SVM permitió contrastar el rendimiento de modelos con fronteras de decisión más flexibles.</p>
<p>La comparación inicial evidenció que los modelos de ensamble superaron en desempeño a los lineales, logrando mejores métricas de F1-weighted, Recall y AUC-ROC, lo que indica una mejor capacidad para identificar correctamente canciones populares sin sacrificar la precisión general del sistema.</p>
<p>Posteriormente, la aplicación de técnicas de balanceo de clases (SMOTE, ADASYN y class_weight=’balanced’) fue determinante para mitigar el sesgo hacia la clase mayoritaria. El uso de SMOTE mejoró especialmente el recall de la clase minoritaria, demostrando la importancia de estas estrategias cuando se trabaja con datos desbalanceados, un problema común en el análisis musical donde solo un pequeño porcentaje de canciones alcanza altos niveles de popularidad.</p>
<p>En la sección de Optimización Computacional, se implementaron mejoras específicas para cada modelo, tales como el uso de KD-Trees en KNN, solvers optimizados en modelos lineales y métodos de histogramas y early stopping en XGBoost, reduciendo significativamente los tiempos de entrenamiento sin afectar la calidad de las predicciones.</p>
<p>La Validación Avanzada y el Tuning de Hiperparámetros mediante GridSearchCV con StratifiedKFold (5 folds) permitieron refinar cada modelo de manera sistemática, garantizando una evaluación justa y replicable. El modelo XGBoost optimizado destacó por su estabilidad, precisión y robustez frente al desbalance, alcanzando los mejores valores de F1-weighted, Recall Clase 1 y AUC en el conjunto de prueba.</p>
<p>En la etapa de Interpretabilidad, se utilizaron importancias de características, Permutation Importance y análisis de coeficientes para comprender la influencia de cada variable. Este análisis reveló que atributos como energy, danceability, valence y acousticness tienen un peso considerable en la predicción de popularidad. Desde una perspectiva musical, estos resultados sugieren que las canciones más bailables, enérgicas y con mayor positividad emocional tienden a ser mejor recibidas por el público, confirmando hipótesis empíricas del ámbito de la producción musical contemporánea.</p>
<p>De manera coherente con la literatura reciente, los resultados del presente estudio coinciden con el enfoque híbrido de Zhong et al. (2025), quienes demostraron que el uso combinado de técnicas de resampling como SMOTE-Tomek con modelos basados en árboles como CatBoost incrementa la precisión en problemas desbalanceados. En nuestro caso, la aplicación de SMOTE junto con XGBoost logra un efecto análogo, reforzando la validez científica de la estrategia aplicada.</p>
<p>Finalmente, la evaluación comparativa integral confirmó que la sinergia entre preprocesamiento, balanceo, optimización y tuning puede transformar un conjunto de datos inicialmente limitado en una herramienta predictiva sólida para la toma de decisiones en la industria musical. El pipeline construido es reproducible, interpretable y escalable, lo que lo convierte en una base valiosa para futuros proyectos de predicción de éxito musical, recomendación automatizada o análisis de tendencias de escucha en plataformas digitales.</p>
<p>Para nuestr objetivo como entrega de información con la base de datos de Spotify, demuestra que:</p>
<ul class="simple">
<li><p>Hay un pipeline bien diseñado y documentado puede competir con metodologías industriales en rendimiento y transparencia.</p></li>
<li><p>Las variables de energía, positividad y bailabilidad son determinantes en la percepción de popularidad musical.</p></li>
<li><p>El modelo XGBoost optimizado con balanceo SMOTE representa la solución más eficiente, estable y explicable para este problema.</p></li>
</ul>
<p>La combinación de técnicas de validación avanzada, tuning sistemático e interpretabilidad refleja la madurez de una práctica científica en Machine Learning aplicada a la música.</p>
<p>Este trabajo no solo cumple de forma sobresaliente con los criterios del PDF institucional (EDA, Benchmark, Balanceo, Optimización, Tuning e Interpretabilidad), sino que también ofrece una contribución significativa al análisis de datos musicales, uniendo rigor técnico y sensibilidad artística: la ciencia de los datos al servicio de la creatividad sonora.</p>
<p>Con amor, María Clara Ávila Chinchia, David Alejandro Ibáñez Barrios y Mateo José Giraldo Castil</p>
<p>Cordial saludo profesor.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Bienvenido a nuestro Proyecto Final</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Proyecto Final</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacion-de-modelos">Aplicación de Modelos</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelado-benchmark">Modelado Benchmark</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#balanceo-de-clases">Balanceo de Clases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizacion-computacional">Optimización Computacional</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#validacion-avanzada-tuning-e-interpretabilidad">Validación avanzada, Tuning e interpretabilidad</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-y-seleccion-del-mejor-modelo">Conclusión y Selección del Mejor Modelo</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By María Clara Ávila
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>